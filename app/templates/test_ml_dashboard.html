<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Dashboard Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        canvas { max-width: 100%; height: 300px; width: 100% !important; }
    </style>
</head>
<body>
    <h1>ML Dashboard Test</h1>
    
    <div class="test-section">
        <h2>1. API Test</h2>
        <button onclick="testAPI()">API Testen</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Chart Test</h2>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="testChart"></canvas>
        </div>
        <button onclick="testChart()">Chart Testen</button>
        <div id="chartResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Vollständiger Test</h2>
        <button onclick="fullTest()">Vollständiger Test</button>
        <div id="fullResult"></div>
    </div>

    <script>
        let myTestChart = null;
        
        function testAPI() {
            console.log('testAPI aufgerufen');
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'Teste API...';
            
            fetch('/api/ml/price-forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data);
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">✅ API funktioniert!<br>
                        Forecast-Daten: ${data.data.forecast.length} Einträge<br>
                        Modell-Genauigkeit: ${data.data.model_accuracy}<br>
                        Erste Prognose: ${data.data.forecast[0].price_eur_mwh} €/MWh</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ API Fehler: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('API Fehler:', error);
                resultDiv.innerHTML = `<div class="error">❌ Netzwerk-Fehler: ${error.message}</div>`;
            });
        }
        
        function testChart() {
            console.log('testChart aufgerufen');
            const resultDiv = document.getElementById('chartResult');
            resultDiv.innerHTML = 'Teste Chart...';
            
            try {
                const ctx = document.getElementById('testChart').getContext('2d');
                console.log('Canvas Context:', ctx);
                
                if (myTestChart && typeof myTestChart.destroy === 'function') {
                    console.log('Zerstöre vorherigen Chart');
                    myTestChart.destroy();
                }
                
                console.log('Erstelle neuen Chart...');
                myTestChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['00:00', '06:00', '12:00', '18:00'],
                        datasets: [{
                            label: 'Test-Daten',
                            data: [30, 45, 60, 40],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
                
                console.log('Chart erfolgreich erstellt:', myTestChart);
                resultDiv.innerHTML = '<div class="success">✅ Chart funktioniert!</div>';
            } catch (error) {
                console.error('Chart Fehler:', error);
                console.error('myTestChart:', myTestChart);
                console.error('Chart.js verfügbar:', typeof Chart);
                resultDiv.innerHTML = `<div class="error">❌ Chart-Fehler: ${error.message}</div>`;
            }
        }
        
        function fullTest() {
            console.log('fullTest aufgerufen');
            const resultDiv = document.getElementById('fullResult');
            resultDiv.innerHTML = 'Führe vollständigen Test durch...';
            
            // 1. API Test
            fetch('/api/ml/price-forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Full Test API Response:', data);
                
                if (!data.success) {
                    throw new Error(`API Fehler: ${data.error}`);
                }
                
                const forecast = data.data.forecast;
                
                // 2. Chart Test mit echten Daten
                const ctx = document.getElementById('testChart').getContext('2d');
                
                if (myTestChart && typeof myTestChart.destroy === 'function') {
                    myTestChart.destroy();
                }
                
                myTestChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: forecast.map(p => new Date(p.timestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})),
                        datasets: [{
                            label: 'Prognostizierter Preis (€/MWh)',
                            data: forecast.map(p => p.price_eur_mwh),
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Preis (€/MWh)'
                                }
                            }
                        }
                    }
                });
                
                resultDiv.innerHTML = `<div class="success">✅ Vollständiger Test erfolgreich!<br>
                    API: ✅ Funktioniert<br>
                    Chart: ✅ Funktioniert<br>
                    Daten: ${forecast.length} Prognose-Punkte<br>
                    Durchschnittspreis: ${(forecast.reduce((sum, p) => sum + p.price_eur_mwh, 0) / forecast.length).toFixed(2)} €/MWh</div>`;
            })
            .catch(error => {
                console.error('Full Test Fehler:', error);
                resultDiv.innerHTML = `<div class="error">❌ Test fehlgeschlagen: ${error.message}</div>`;
            });
        }
        
        // Automatischer Test beim Laden
        window.onload = function() {
            console.log('Test-Seite geladen');
            console.log('Chart.js verfügbar:', typeof Chart !== 'undefined');
            
            // Test ob die Funktionen verfügbar sind
            console.log('testAPI verfügbar:', typeof testAPI);
            console.log('testChart verfügbar:', typeof testChart);
            console.log('fullTest verfügbar:', typeof fullTest);
        };
        
        // Debug: Test ob die Funktionen global verfügbar sind
        window.testAPI = testAPI;
        window.testChart = testChart;
        window.fullTest = fullTest;
        
        // Zusätzliche Debug-Info
        console.log('Funktionen definiert:', {
            testAPI: typeof testAPI,
            testChart: typeof testChart,
            fullTest: typeof fullTest
        });
    </script>
</body>
</html>
