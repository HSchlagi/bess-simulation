{% extends "base.html" %}

{% block title %}aWattar API Integration - BESS Simulation{% endblock %}

{% block extra_css %}
<style>
    .price-chart {
        height: 300px;
        width: 100% !important;
    }
    .status-card {
        transition: transform 0.2s ease-in-out;
    }
    .status-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">aWattar API Integration</h1>
                <p class="mt-2 text-lg text-gray-600">Österreichische Strompreise in Echtzeit</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="px-4 py-2 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                    Live Integration
                </span>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- API Status -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">API Verbindung</p>
                    <p class="text-lg font-semibold text-gray-900" id="api-status">Lädt...</p>
                </div>
            </div>
        </div>

        <!-- Database Records -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-database text-blue-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Datenbank Records</p>
                    <p class="text-lg font-semibold text-gray-900" id="db-records">Lädt...</p>
                </div>
            </div>
        </div>

        <!-- Last 24h -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Letzte 24h</p>
                    <p class="text-lg font-semibold text-gray-900" id="last-24h">Lädt...</p>
                </div>
            </div>
        </div>

        <!-- Latest Price -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-euro-sign text-purple-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Neuester Preis</p>
                    <p class="text-lg font-semibold text-gray-900" id="latest-price">Lädt...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Section -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">aWattar-Daten importieren</h2>
            <p class="text-sm text-gray-500 mt-1">Holen Sie aktuelle österreichische Strompreise von der aWattar API</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Startdatum</label>
                    <input type="date" id="start-date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enddatum</label>
                    <input type="date" id="end-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button id="import-btn" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-download mr-2"></i>
                    <span id="import-text">Daten importieren</span>
                </button>
                
                <button id="test-btn" 
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>
                    Integration testen
                </button>
                
                <button id="status-btn" 
                        class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Status aktualisieren
                </button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="bg-white rounded-lg shadow mb-8" style="display: none;">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Import-Ergebnis</h2>
        </div>
        <div class="p-6">
            <div id="success-result" class="bg-green-50 border border-green-200 rounded-md p-4" style="display: none;">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Import erfolgreich</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <p id="success-message"></p>
                            <div id="success-data" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4" style="display: none;">
                                <div>
                                    <span class="font-medium">Gespeichert:</span>
                                    <span id="saved-count">0</span>
                                </div>
                                <div>
                                    <span class="font-medium">Übersprungen:</span>
                                    <span id="skipped-count">0</span>
                                </div>
                                <div>
                                    <span class="font-medium">Fehler:</span>
                                    <span id="error-count">0</span>
                                </div>
                                <div>
                                    <span class="font-medium">Verarbeitet:</span>
                                    <span id="total-processed">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error-result" class="bg-red-50 border border-red-200 rounded-md p-4" style="display: none;">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Import fehlgeschlagen</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p id="error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Chart -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Preisverlauf (letzte 24 Stunden)</h2>
            <p class="text-sm text-gray-500 mt-1">Österreichische Strompreise von aWattar</p>
        </div>
        <div class="p-6">
            <div class="price-chart">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    console.log('aWattar Integration Script loaded');
    
    // Echte Daten laden
    await refreshStatus();
    await loadRealChart();
    
    // Event Listeners
    document.getElementById('import-btn').addEventListener('click', importData);
    document.getElementById('test-btn').addEventListener('click', testIntegration);
    document.getElementById('status-btn').addEventListener('click', refreshStatus);
    
    function showResult(success, message, data = null) {
        const resultsSection = document.getElementById('results-section');
        const successResult = document.getElementById('success-result');
        const errorResult = document.getElementById('error-result');
        
        resultsSection.style.display = 'block';
        
        if (success) {
            successResult.style.display = 'block';
            errorResult.style.display = 'none';
            document.getElementById('success-message').textContent = message;
            
            if (data) {
                document.getElementById('success-data').style.display = 'grid';
                document.getElementById('saved-count').textContent = data.saved_count || 0;
                document.getElementById('skipped-count').textContent = data.skipped_count || 0;
                document.getElementById('error-count').textContent = data.error_count || 0;
                document.getElementById('total-processed').textContent = data.total_processed || 0;
            }
        } else {
            successResult.style.display = 'none';
            errorResult.style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
    }
    
    function setLoading(buttonId, loading) {
        const button = document.getElementById(buttonId);
        const text = document.getElementById(buttonId.replace('-btn', '-text'));
        
        if (loading) {
            button.disabled = true;
            if (text) text.textContent = 'Lädt...';
        } else {
            button.disabled = false;
            if (text) text.textContent = 'Daten importieren';
        }
    }
    
    async function importData() {
        console.log('Starting import...');
        setLoading('import-btn', true);
        
        try {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            console.log('Import dates:', startDate, 'to', endDate);
            
            const response = await fetch('/api/awattar/fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: startDate + 'T00:00:00Z',
                    end_date: endDate + 'T23:59:59Z'
                })
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                showResult(true, data.message, data.data);
                // Grafik für den importierten Datumsbereich aktualisieren
                await loadChartForDateRange(startDate, endDate);
            } else {
                showResult(false, data.error);
            }
        } catch (error) {
            console.error('Import error:', error);
            showResult(false, 'Fehler beim Importieren: ' + error.message);
        } finally {
            setLoading('import-btn', false);
        }
    }
    
    async function testIntegration() {
        console.log('Starting test...');
        setLoading('test-btn', true);
        
        try {
            const response = await fetch('/api/awattar/test');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showResult(true, data.message, data.test_results);
            } else {
                showResult(false, data.error);
            }
        } catch (error) {
            console.error('Test error:', error);
            showResult(false, 'Test fehlgeschlagen: ' + error.message);
        } finally {
            setLoading('test-btn', false);
        }
    }
    
    async function refreshStatus() {
        console.log('Refreshing status...');
        
        try {
            const response = await fetch('/api/awattar/status');
            const data = await response.json();
            
            console.log('Status response:', data);
            
            if (data.success) {
                // Status-Elemente aktualisieren
                const apiStatus = document.getElementById('api-status');
                const dbRecords = document.getElementById('db-records');
                const last24h = document.getElementById('last-24h');
                const latestPrice = document.getElementById('latest-price');
                
                if (apiStatus) apiStatus.textContent = data.status.api_connection || 'OK';
                if (dbRecords) dbRecords.textContent = data.status.database_records || '0';
                if (last24h) last24h.textContent = data.status.last_24h || '0';
                if (latestPrice) latestPrice.textContent = data.status.latest_price || 'N/A';
                
                console.log('Status updated successfully');
            } else {
                console.error('Status API returned error:', data.error);
                // Status auf Fehler setzen
                const apiStatus = document.getElementById('api-status');
                const dbRecords = document.getElementById('db-records');
                const last24h = document.getElementById('last-24h');
                const latestPrice = document.getElementById('latest-price');
                
                if (apiStatus) apiStatus.textContent = 'Fehler';
                if (dbRecords) dbRecords.textContent = 'N/A';
                if (last24h) last24h.textContent = 'N/A';
                if (latestPrice) latestPrice.textContent = 'N/A';
            }
        } catch (error) {
            console.error('Status error:', error);
            // Status auf Fehler setzen
            const apiStatus = document.getElementById('api-status');
            const dbRecords = document.getElementById('db-records');
            const last24h = document.getElementById('last-24h');
            const latestPrice = document.getElementById('latest-price');
            
            if (apiStatus) apiStatus.textContent = 'Fehler';
            if (dbRecords) dbRecords.textContent = 'N/A';
            if (last24h) last24h.textContent = 'N/A';
            if (latestPrice) latestPrice.textContent = 'N/A';
        }
    }
    
    async function loadRealChart() {
        console.log('Loading real chart data...');
        
        try {
            const response = await fetch('/api/awattar/latest?hours=24');
            const data = await response.json();
            
            console.log('Chart data response:', data);
            
            if (data.success && data.data && data.data.length > 0) {
                console.log(`Creating chart with ${data.data.length} data points`);
                createRealChart(data.data);
            } else {
                console.log('No data available, creating empty chart');
                createEmptyChart();
            }
        } catch (error) {
            console.error('Chart loading error:', error);
            createEmptyChart();
        }
    }
    
    async function loadChartForDateRange(startDate, endDate) {
        console.log(`Loading chart data for range: ${startDate} to ${endDate}`);
        
        try {
            // API-Endpunkt für spezifischen Datumsbereich erstellen
            const response = await fetch(`/api/awattar/range?start_date=${startDate}&end_date=${endDate}`);
            const data = await response.json();
            
            console.log('Range chart data response:', data);
            
            if (data.success && data.data && data.data.length > 0) {
                console.log(`Creating chart with ${data.data.length} data points for range`);
                createRealChart(data.data);
            } else {
                console.log('No data available for range, creating empty chart');
                createEmptyChart();
            }
        } catch (error) {
            console.error('Range chart loading error:', error);
            // Fallback auf letzte 24h
            await loadRealChart();
        }
    }
    
    function createRealChart(priceData) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        // Chart löschen falls vorhanden
        if (window.priceChart && typeof window.priceChart.destroy === 'function') {
            window.priceChart.destroy();
        }
        
        // Daten chronologisch sortieren (falls nicht bereits sortiert)
        const sortedData = [...priceData].sort((a, b) => 
            new Date(a.timestamp) - new Date(b.timestamp)
        );
        
        // Labels mit Datum und Uhrzeit für bessere Lesbarkeit
        const labels = sortedData.map(p => {
            const date = new Date(p.timestamp);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const isYesterday = date.toDateString() === new Date(now.getTime() - 24*60*60*1000).toDateString();
            
            if (isToday) {
                return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            } else if (isYesterday) {
                return 'Gestern ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) + ' ' + 
                       date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            }
        });
        
        const data = sortedData.map(p => p.price_eur_mwh);
        
        window.priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Strompreis (€/MWh)',
                    data: data,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1.2, // Höhere Grafik für bessere Y-Achsen-Lesbarkeit
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Preis (€/MWh)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value + ' €/MWh';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Zeit'
                        }
                    }
                }
            }
        });
    }
    
    function createEmptyChart() {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        // Chart löschen falls vorhanden
        if (window.priceChart && typeof window.priceChart.destroy === 'function') {
            window.priceChart.destroy();
        }
        
        window.priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Keine Daten'],
                datasets: [{
                    label: 'Strompreis (€/MWh)',
                    data: [0],
                    borderColor: 'rgb(156, 163, 175)',
                    backgroundColor: 'rgba(156, 163, 175, 0.1)',
                    tension: 0.1
                }]
            },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 1.2, // Höhere Grafik für bessere Y-Achsen-Lesbarkeit
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Preis (€/MWh)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    },
                                    ticks: {
                                        font: {
                                            size: 12
                                        },
                                        callback: function(value) {
                                            return value + ' €/MWh';
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Zeit'
                                    }
                                }
                            }
                        }
        });
    }
    
    // Standard-Daten setzen: Letzte 7 Tage
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('start-date').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('end-date').value = today.toISOString().split('T')[0];
    });
});
</script>
{% endblock %}
