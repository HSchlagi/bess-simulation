{% extends "base.html" %}
{% block title %}Climate Impact Dashboard - BESS-Simulation{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .metric-card-green {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-card-blue {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .metric-card-orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-leaf mr-3"></i>
                        Climate Impact Dashboard
                    </h1>
                    <p class="text-blue-100 mt-2">Umweltauswirkungen und Nachhaltigkeits-Metriken</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="currentDateTime"></div>
                    <div class="text-blue-100" id="projectName">Projekt auswählen</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Projektauswahl -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-project-diagram mr-2"></i>
                Projektauswahl
            </h2>
            <div class="flex flex-wrap gap-4">
                <select id="projectSelect" class="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Projekt auswählen...</option>
                </select>
                <button onclick="loadClimateData()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Daten laden
                </button>
                <button onclick="exportClimateReport()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Bericht exportieren
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Lade Klimadaten...</p>
        </div>

        <!-- Hauptdashboard -->
        <div id="dashboardContent" class="hidden">
            <!-- Übersichtskarten -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- CO₂-Einsparungen -->
                <div class="metric-card-green text-white rounded-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">CO₂-Einsparungen</p>
                            <p class="text-3xl font-bold" id="totalCo2Savings">0</p>
                            <p class="text-green-100 text-sm">Tonnen CO₂</p>
                        </div>
                        <i class="fas fa-leaf text-4xl text-green-200"></i>
                    </div>
                </div>

                <!-- Carbon Credits -->
                <div class="metric-card text-white rounded-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-pink-100 text-sm font-medium">Carbon Credits</p>
                            <p class="text-3xl font-bold" id="carbonCredits">0</p>
                            <p class="text-pink-100 text-sm">Generiert</p>
                        </div>
                        <i class="fas fa-certificate text-4xl text-pink-200"></i>
                    </div>
                </div>

                <!-- Green Finance -->
                <div class="metric-card-blue text-white rounded-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Green Finance</p>
                            <p class="text-3xl font-bold" id="greenFinanceValue">0</p>
                            <p class="text-blue-100 text-sm">EUR Portfolio</p>
                        </div>
                        <i class="fas fa-chart-line text-4xl text-blue-200"></i>
                    </div>
                </div>

                <!-- ESG-Score -->
                <div class="metric-card-orange text-white rounded-lg p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">ESG-Score</p>
                            <p class="text-3xl font-bold" id="esgScore">0</p>
                            <p class="text-orange-100 text-sm">Nachhaltigkeit</p>
                        </div>
                        <i class="fas fa-star text-4xl text-orange-200"></i>
                    </div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- CO₂-Trend Chart -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>
                        CO₂-Einsparungen Trend
                    </h3>
                    <canvas id="co2TrendChart" width="400" height="200"></canvas>
                </div>

                <!-- Carbon Credits Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2"></i>
                        Carbon Credits Aufschlüsselung
                    </h3>
                    <canvas id="carbonCreditsChart" width="400" height="200"></canvas>
                </div>

                <!-- Green Finance Performance -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Green Finance Performance
                    </h3>
                    <canvas id="greenFinanceChart" width="400" height="200"></canvas>
                </div>

                <!-- ESG Score Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-radar mr-2"></i>
                        ESG Score Aufschlüsselung
                    </h3>
                    <canvas id="esgScoreChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Detaillierte Metriken -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Umwelt-Metriken -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-seedling mr-2 text-green-600"></i>
                        Umwelt-Metriken
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">CO₂-Einsparungen</span>
                            <span class="font-bold text-green-600" id="envCo2Savings">0 t</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Erneuerbare Energie</span>
                            <span class="font-bold text-green-600" id="envRenewableShare">0%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Carbon Credits</span>
                            <span class="font-bold text-green-600" id="envCarbonCredits">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Energieeffizienz</span>
                            <span class="font-bold text-green-600" id="envEfficiency">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Sozial-Metriken -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-users mr-2 text-blue-600"></i>
                        Sozial-Metriken
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Kosteneinsparungen</span>
                            <span class="font-bold text-blue-600" id="socialCostSavings">0 EUR</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Green Finance</span>
                            <span class="font-bold text-blue-600" id="socialGreenFinance">0 EUR</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Portfolio Performance</span>
                            <span class="font-bold text-blue-600" id="socialPortfolioPerf">0%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Nachhaltigkeits-Rating</span>
                            <span class="font-bold text-blue-600" id="socialSustainabilityRating">-</span>
                        </div>
                    </div>
                </div>

                <!-- Governance-Metriken -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-balance-scale mr-2 text-purple-600"></i>
                        Governance-Metriken
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Compliance Status</span>
                            <span class="font-bold text-purple-600" id="govCompliance">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Risiko-Score</span>
                            <span class="font-bold text-purple-600" id="govRiskScore">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Transparenz</span>
                            <span class="font-bold text-purple-600" id="govTransparency">0%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Reporting</span>
                            <span class="font-bold text-purple-600" id="govReporting">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empfehlungen -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-lightbulb mr-2 text-yellow-600"></i>
                    Klimaschutz-Empfehlungen
                </h3>
                <div id="recommendationsList" class="space-y-3">
                    <!-- Empfehlungen werden hier dynamisch eingefügt -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = null;
        let charts = {};

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            loadProjects();
            initializeCharts();
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString('de-DE');
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Projekt auswählen...</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (${project.location || 'Kein Standort'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Fehler beim Laden der Projekte:', error);
            }
        }

        function initializeCharts() {
            // CO₂-Trend Chart
            const co2Ctx = document.getElementById('co2TrendChart').getContext('2d');
            charts.co2Trend = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO₂-Einsparungen (t)',
                        data: [],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Tonnen CO₂'
                            }
                        }
                    }
                }
            });

            // Carbon Credits Chart
            const carbonCtx = document.getElementById('carbonCreditsChart').getContext('2d');
            charts.carbonCredits = new Chart(carbonCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Generiert', 'Verkauft', 'Verfügbar'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10B981', '#F59E0B', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Green Finance Chart
            const financeCtx = document.getElementById('greenFinanceChart').getContext('2d');
            charts.greenFinance = new Chart(financeCtx, {
                type: 'bar',
                data: {
                    labels: ['Investiert', 'Aktueller Wert', 'Rendite'],
                    datasets: [{
                        label: 'EUR',
                        data: [0, 0, 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'EUR'
                            }
                        }
                    }
                }
            });

            // ESG Score Chart
            const esgCtx = document.getElementById('esgScoreChart').getContext('2d');
            charts.esgScore = new Chart(esgCtx, {
                type: 'radar',
                data: {
                    labels: ['Environmental', 'Social', 'Governance'],
                    datasets: [{
                        label: 'ESG Score',
                        data: [0, 0, 0],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3B82F6',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadClimateData() {
            const projectSelect = document.getElementById('projectSelect');
            const projectId = projectSelect.value;
            
            if (!projectId) {
                alert('Bitte wählen Sie ein Projekt aus');
                return;
            }
            
            currentProjectId = projectId;
            document.getElementById('projectName').textContent = projectSelect.selectedOptions[0].textContent;
            
            showLoading();
            
            try {
                // Klimadaten laden
                const [co2Data, carbonCreditData, greenFinanceData, esgData] = await Promise.all([
                    fetch(`/api/climate/co2-data/${projectId}`).then(r => r.json()),
                    fetch(`/api/climate/carbon-credits/${projectId}`).then(r => r.json()),
                    fetch(`/api/climate/green-finance/${projectId}`).then(r => r.json()),
                    fetch(`/api/climate/esg-data/${projectId}`).then(r => r.json())
                ]);
                
                updateDashboard(co2Data, carbonCreditData, greenFinanceData, esgData);
                hideLoading();
                
            } catch (error) {
                console.error('Fehler beim Laden der Klimadaten:', error);
                hideLoading();
                alert('Fehler beim Laden der Klimadaten');
            }
        }

        function updateDashboard(co2Data, carbonCreditData, greenFinanceData, esgData) {
            // Übersichtskarten aktualisieren
            document.getElementById('totalCo2Savings').textContent = (co2Data.total_co2_saved_kg / 1000).toFixed(1);
            document.getElementById('carbonCredits').textContent = carbonCreditData.credits_generated || 0;
            document.getElementById('greenFinanceValue').textContent = (greenFinanceData.total_value_eur || 0).toLocaleString();
            document.getElementById('esgScore').textContent = esgData.overall_esg_score || 0;
            
            // Detaillierte Metriken aktualisieren
            document.getElementById('envCo2Savings').textContent = (co2Data.total_co2_saved_kg / 1000).toFixed(1) + ' t';
            document.getElementById('envRenewableShare').textContent = (co2Data.renewable_share_percent || 0).toFixed(1) + '%';
            document.getElementById('envCarbonCredits').textContent = carbonCreditData.credits_generated || 0;
            document.getElementById('envEfficiency').textContent = (co2Data.energy_efficiency_percent || 0).toFixed(1) + '%';
            
            document.getElementById('socialCostSavings').textContent = (co2Data.cost_savings_eur || 0).toLocaleString() + ' EUR';
            document.getElementById('socialGreenFinance').textContent = (greenFinanceData.total_value_eur || 0).toLocaleString() + ' EUR';
            document.getElementById('socialPortfolioPerf').textContent = (greenFinanceData.total_returns_percent || 0).toFixed(1) + '%';
            document.getElementById('socialSustainabilityRating').textContent = esgData.sustainability_rating || '-';
            
            document.getElementById('govCompliance').textContent = esgData.compliance_status || '-';
            document.getElementById('govRiskScore').textContent = (greenFinanceData.risk_score || 0).toFixed(1);
            document.getElementById('govTransparency').textContent = '95%'; // Simuliert
            document.getElementById('govReporting').textContent = 'Aktuell'; // Simuliert
            
            // Charts aktualisieren
            updateCharts(co2Data, carbonCreditData, greenFinanceData, esgData);
            
            // Empfehlungen generieren
            generateRecommendations(co2Data, carbonCreditData, greenFinanceData, esgData);
            
            // Dashboard anzeigen
            document.getElementById('dashboardContent').classList.remove('hidden');
        }

        function updateCharts(co2Data, carbonCreditData, greenFinanceData, esgData) {
            // CO₂-Trend Chart
            const co2Labels = co2Data.monthly_data?.map(d => d.month) || [];
            const co2Values = co2Data.monthly_data?.map(d => d.co2_saved_kg / 1000) || [];
            charts.co2Trend.data.labels = co2Labels;
            charts.co2Trend.data.datasets[0].data = co2Values;
            charts.co2Trend.update();
            
            // Carbon Credits Chart
            charts.carbonCredits.data.datasets[0].data = [
                carbonCreditData.credits_generated || 0,
                carbonCreditData.credits_sold || 0,
                (carbonCreditData.credits_generated || 0) - (carbonCreditData.credits_sold || 0)
            ];
            charts.carbonCredits.update();
            
            // Green Finance Chart
            charts.greenFinance.data.datasets[0].data = [
                greenFinanceData.total_invested_eur || 0,
                greenFinanceData.total_portfolio_value_eur || 0,
                greenFinanceData.total_returns_eur || 0
            ];
            charts.greenFinance.update();
            
            // ESG Score Chart
            charts.esgScore.data.datasets[0].data = [
                esgData.environmental_score || 0,
                esgData.social_score || 0,
                esgData.governance_score || 0
            ];
            charts.esgScore.update();
        }

        function generateRecommendations(co2Data, carbonCreditData, greenFinanceData, esgData) {
            const recommendations = [];
            
            if ((co2Data.total_co2_saved_kg / 1000) < 10) {
                recommendations.push({
                    icon: 'fas fa-leaf',
                    color: 'text-green-600',
                    title: 'CO₂-Einsparungen erhöhen',
                    description: 'Optimieren Sie die BESS-Nutzung für höhere CO₂-Einsparungen'
                });
            }
            
            if ((carbonCreditData.credits_sold || 0) === 0 && (carbonCreditData.credits_generated || 0) > 0) {
                recommendations.push({
                    icon: 'fas fa-certificate',
                    color: 'text-blue-600',
                    title: 'Carbon Credits verkaufen',
                    description: 'Monetarisieren Sie Ihre CO₂-Einsparungen durch Carbon Credit Verkauf'
                });
            }
            
            if ((greenFinanceData.total_value_eur || 0) === 0) {
                recommendations.push({
                    icon: 'fas fa-chart-line',
                    color: 'text-purple-600',
                    title: 'Green Finance Portfolio aufbauen',
                    description: 'Investieren Sie in Green Bonds für nachhaltige Renditen'
                });
            }
            
            if ((esgData.overall_esg_score || 0) < 70) {
                recommendations.push({
                    icon: 'fas fa-star',
                    color: 'text-yellow-600',
                    title: 'ESG-Score verbessern',
                    description: 'Fokussieren Sie auf Umwelt- und Sozial-Metriken für bessere ESG-Bewertung'
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'fas fa-check-circle',
                    color: 'text-green-600',
                    title: 'Ausgezeichnete Performance!',
                    description: 'Ihr Projekt zeigt hervorragende Nachhaltigkeits-Performance'
                });
            }
            
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = recommendations.map(rec => `
                <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                    <i class="${rec.icon} ${rec.color} text-xl mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-gray-800">${rec.title}</h4>
                        <p class="text-gray-600 text-sm">${rec.description}</p>
                    </div>
                </div>
            `).join('');
        }

        async function exportClimateReport() {
            if (!currentProjectId) {
                alert('Bitte wählen Sie zuerst ein Projekt aus');
                return;
            }
            
            try {
                const response = await fetch(`/api/climate/export-report/${currentProjectId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `climate_report_project_${currentProjectId}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Fehler beim Exportieren des Berichts');
                }
            } catch (error) {
                console.error('Fehler beim Export:', error);
                alert('Fehler beim Exportieren des Berichts');
            }
        }

        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }
    </script>
{% endblock %}
