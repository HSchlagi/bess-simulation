{% extends "base.html" %}

{% block title %}Dashboard - BESS Simulation{% endblock %}

{% block head %}
<!-- Zusätzliche Dashboard-spezifische Styles -->
<style>
    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Dashboard Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
            <i class="fas fa-chart-line mr-3"></i>Advanced Dashboard
        </h1>
        <p class="text-xl text-gray-600">
            Professionelle Übersicht und Analysen Ihrer BESS-Simulationsprojekte
        </p>
    </div>

    <!-- Mobile Navigation Toggle -->
    <div class="md:hidden mb-4">
        <button id="mobileMenuToggle" class="mobile-btn bg-blue-600 text-white">
            <i class="fas fa-bars mr-2"></i>Menü öffnen
        </button>
    </div>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="mobile-sidebar">
        <div class="p-4 border-b">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">BESS Simulation</h3>
                <button id="closeMobileMenu" class="text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <nav class="p-4">
            <a href="{{ url_for('main.dashboard') }}" class="block py-3 px-4 bg-blue-100 text-blue-700 rounded-lg mb-2">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </a>
            <a href="{{ url_for('main.projects') }}" class="block py-3 px-4 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                <i class="fas fa-project-diagram mr-2"></i>Projekte
            </a>
            <a href="{{ url_for('main.new_project') }}" class="block py-3 px-4 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                <i class="fas fa-plus mr-2"></i>Neues Projekt
            </a>
            <a href="{{ url_for('main.data_import_center') }}" class="block py-3 px-4 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                <i class="fas fa-cloud-upload-alt mr-2"></i>Daten importieren
            </a>
            <a href="{{ url_for('main.bess_peak_shaving_analysis') }}" class="block py-3 px-4 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                <i class="fas fa-chart-bar mr-2"></i>Analysen
            </a>
            <a href="{{ url_for('export.export_center') }}" class="block py-3 px-4 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                <i class="fas fa-download mr-2"></i>Export
            </a>
        </nav>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>

    <!-- Key Metrics Cards - Kompakt -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 mobile-grid">
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-2 rounded-md">
                        <i class="fas fa-folder text-blue-600 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs font-medium text-gray-600">Projekte</p>
                        <p class="text-lg font-bold text-gray-900" id="projectsCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-green-100 p-2 rounded-md">
                        <i class="fas fa-check-circle text-green-600 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs font-medium text-gray-600">Aktiv</p>
                        <p class="text-lg font-bold text-gray-900" id="activeCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-2 rounded-md">
                        <i class="fas fa-users text-purple-600 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs font-medium text-gray-600">Kunden</p>
                        <p class="text-lg font-bold text-gray-900" id="customersCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-orange-100 p-2 rounded-md">
                        <i class="fas fa-database text-orange-600 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs font-medium text-gray-600">Datensätze</p>
                        <p class="text-lg font-bold text-gray-900" id="datasetsCount">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 mobile-grid">
        <!-- Projekt-Wachstum Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-chart-line mr-2"></i>Projekt-Wachstum
                </h3>
                <div class="flex space-x-2">
                    <button onclick="updateChartPeriod('month')" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">Monat</button>
                    <button onclick="updateChartPeriod('quarter')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Quartal</button>
                    <button onclick="updateChartPeriod('year')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Jahr</button>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="projectGrowthChart"></canvas>
            </div>
        </div>

        <!-- BESS vs PV Kapazität Chart -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-pie mr-2"></i>Kapazitäts-Verteilung
            </h3>
            <div class="relative h-64">
                <canvas id="capacityDistributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Performance Metrics Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 mobile-grid">
        <!-- Durchschnittliche Stromkosten Trend -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-euro-sign mr-2"></i>Stromkosten-Trend
            </h3>
            <div class="relative h-48">
                <canvas id="electricityCostChart"></canvas>
            </div>
        </div>

        <!-- Projekt-Aktivität nach Region -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-map-marker-alt mr-2"></i>Regionale Verteilung
            </h3>
            <div class="relative h-48">
                <canvas id="regionalDistributionChart"></canvas>
            </div>
        </div>

        <!-- System-Performance -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-tachometer-alt mr-2"></i>System-Performance
            </h3>
            <div class="relative h-48">
                <canvas id="systemPerformanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Interaktive Standort-Karte -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-map mr-2"></i>Projekt-Standorte
            </h3>
            <div class="flex space-x-2">
                <button onclick="toggleMapView('all')" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200">Alle</button>
                <button onclick="toggleMapView('active')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Aktiv</button>
                <button onclick="toggleMapView('recent')" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">Neu</button>
            </div>
        </div>
        <div id="projectMap" class="relative h-64 bg-gray-100 rounded-lg overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-map-marked-alt text-gray-400 text-4xl mb-2"></i>
                    <p class="text-gray-600">Interaktive Karte wird geladen...</p>
                </div>
            </div>
        </div>
        <div id="mapLegend" class="mt-4 grid grid-cols-3 gap-4 text-sm">
            <div class="flex items-center">
                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                <span>BESS-Projekte</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                <span>PV-Projekte</span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                <span>Hybrid-Projekte</span>
            </div>
        </div>
    </div>

    <!-- Erweiterte Statistiken -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mobile-grid">
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-blue-100 p-3 rounded-lg inline-block mb-3">
                    <i class="fas fa-battery-half text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">BESS-Kapazität</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalBessCapacity">0</p>
                <p class="text-sm text-gray-600">kWh Gesamt</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-yellow-100 p-3 rounded-lg inline-block mb-3">
                    <i class="fas fa-solar-panel text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">PV-Kapazität</h3>
                <p class="text-3xl font-bold text-yellow-600" id="totalPvCapacity">0</p>
                <p class="text-sm text-gray-600">kW Gesamt</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-green-100 p-3 rounded-lg inline-block mb-3">
                    <i class="fas fa-euro-sign text-green-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Ø Stromkosten</h3>
                <p class="text-3xl font-bold text-green-600" id="avgElectricityCost">0</p>
                <p class="text-sm text-gray-600">Ct/kWh</p>
            </div>
        </div>
    </div>

    <!-- Recent Activities Section -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-clock mr-2"></i>Letzte Aktivitäten
            </h2>
            <a href="{{ url_for('main.projects') }}" class="text-blue-600 hover:text-blue-800">
                Alle Projekte →
            </a>
        </div>
        
        <div id="recentProjects" class="text-center py-8">
            <i class="fas fa-folder text-gray-400 text-6xl mb-4"></i>
            <p class="text-gray-600 mb-2">Keine Projekte vorhanden</p>
            <p class="text-sm text-gray-500 mb-4">Erstellen Sie Ihr erstes BESS-Simulationsprojekt</p>
            <a href="{{ url_for('main.new_project') }}" 
               class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md">
                <i class="fas fa-plus mr-2"></i>+ Neues Projekt erstellen
            </a>
        </div>
    </div>

    <!-- Action Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mobile-grid">
        <!-- New Project Card -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-blue-100 p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-plus text-blue-600 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Neues Projekt</h3>
                <p class="text-gray-600 mb-4">
                    Erstellen Sie ein neues BESS-Simulationsprojekt mit allen notwendigen Komponenten.
                </p>
                <a href="{{ url_for('main.new_project') }}" 
                   class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Projekt erstellen
                </a>
            </div>
        </div>

        <!-- Import Data Card -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-green-100 p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-cloud-upload-alt text-green-600 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Daten importieren</h3>
                <p class="text-gray-600 mb-4">
                    Importieren Sie Lastprofile, Wetterdaten und andere Simulationsdaten.
                </p>
                <a href="{{ url_for('main.data_import_center') }}" 
                   class="inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                    Daten importieren
                </a>
            </div>
        </div>

        <!-- Analyses Card -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 hover:shadow-lg transition-shadow">
            <div class="text-center">
                <div class="bg-purple-100 p-4 rounded-full inline-block mb-4">
                    <i class="fas fa-chart-bar text-purple-600 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Analysen</h3>
                <p class="text-gray-600 mb-4">
                    Analysieren Sie Ihre Simulationsergebnisse und erstellen Sie Berichte.
                </p>
                <a href="{{ url_for('main.bess_peak_shaving_analysis') }}" 
                   class="inline-block bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md">
                    Analysen anzeigen
                </a>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-list mr-2"></i>Systemstatus
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Server: <span class="font-medium text-green-600">Online</span></span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Datenbank: <span class="font-medium text-blue-600">Verbunden</span></span>
            </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Simulationen: <span class="font-medium text-yellow-600">Bereit</span></span>
            </div>
        </div>
    </div>
</div>

<script>
// Chart.js Konfiguration
Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
Chart.defaults.color = '#6B7280';

let projectGrowthChart, capacityDistributionChart, electricityCostChart, regionalDistributionChart, systemPerformanceChart;
let currentChartPeriod = 'month';

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Dashboard wird initialisiert...');
    
    // Prüfe ob Chart.js verfügbar ist
    if (typeof Chart === 'undefined') {
        console.error('❌ Chart.js ist nicht verfügbar!');
        alert('Chart.js konnte nicht geladen werden. Bitte laden Sie die Seite neu.');
        return;
    }
    
    console.log('✅ Chart.js ist verfügbar');
    
    // Mobile Features initialisieren
    initializeMobileNavigation();
    initializeTouchGestures();
    handleResize();
    
    // Event Listener für Resize
    window.addEventListener('resize', handleResize);
    
    // Dashboard Features
    loadDashboardData();
    initializeCharts();
    initializeProjectMap();
    startRealTimeUpdates();
});

function loadDashboardData() {
    // Lade Dashboard-Statistiken
    fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(stats => {
            // Haupt-Metriken
            document.getElementById('projectsCount').textContent = stats.projects_count;
            document.getElementById('activeCount').textContent = stats.active_projects_count;
            document.getElementById('customersCount').textContent = stats.customers_count;
            document.getElementById('datasetsCount').textContent = stats.load_profiles_count;
            
            // Erweiterte Statistiken
            document.getElementById('totalBessCapacity').textContent = stats.total_bess_capacity.toLocaleString('de-DE');
            document.getElementById('totalPvCapacity').textContent = stats.total_pv_capacity.toLocaleString('de-DE');
            document.getElementById('avgElectricityCost').textContent = stats.avg_electricity_cost;
            
            // Letzte Aktivitäten anzeigen
            if (stats.recent_activities && stats.recent_activities.length > 0) {
                displayRecentActivities(stats.recent_activities);
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Dashboard-Statistiken:', error);
            loadProjectsFallback();
        });
    
    // Lade Chart-Daten
    loadChartDataFromAPI();
    
    // Lade Performance-Metriken
    loadPerformanceMetrics();
}

function initializeCharts() {
    console.log('📊 Initialisiere Charts...');
    
    // Mobile Chart-Konfiguration
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
    
    const mobileOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: !isMobile,
                position: isMobile ? 'bottom' : 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        size: isMobile ? 10 : 12
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        size: isMobile ? 10 : 12
                    },
                    maxRotation: isMobile ? 45 : 0
                }
            }
        },
        interaction: {
            mode: isMobile ? 'nearest' : 'index',
            intersect: false
        }
    };
    
    // Projekt-Wachstum Chart
    const projectGrowthCtx = document.getElementById('projectGrowthChart');
    if (!projectGrowthCtx) {
        console.error('❌ projectGrowthChart Canvas nicht gefunden!');
        return;
    }
    console.log('✅ projectGrowthChart Canvas gefunden');
    const ctx = projectGrowthCtx.getContext('2d');
    projectGrowthChart = new Chart(projectGrowthCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun'],
            datasets: [{
                label: 'Neue Projekte',
                data: [12, 19, 15, 25, 22, 30],
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: isMobile ? 4 : 6,
                pointHoverRadius: isMobile ? 6 : 8
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                ...mobileOptions.plugins,
                legend: {
                    display: false
                }
            }
        }
    });

    // Kapazitäts-Verteilung Chart
    const capacityDistributionCtx = document.getElementById('capacityDistributionChart');
    if (!capacityDistributionCtx) {
        console.error('❌ capacityDistributionChart Canvas nicht gefunden!');
        return;
    }
    console.log('✅ capacityDistributionChart Canvas gefunden');
    const capacityCtx = capacityDistributionCtx.getContext('2d');
    capacityDistributionChart = new Chart(capacityDistributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['BESS-Kapazität', 'PV-Kapazität'],
            datasets: [{
                data: [65, 35],
                backgroundColor: ['#3B82F6', '#F59E0B'],
                borderWidth: 0
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                ...mobileOptions.plugins,
                legend: {
                    position: isMobile ? 'bottom' : 'right',
                    labels: {
                        font: {
                            size: isMobile ? 10 : 12
                        }
                    }
                }
            }
        }
    });

    // Stromkosten-Trend Chart
    const electricityCostCtx = document.getElementById('electricityCostChart');
    if (!electricityCostCtx) {
        console.error('❌ electricityCostChart Canvas nicht gefunden!');
        return;
    }
    console.log('✅ electricityCostChart Canvas gefunden');
    const electricityCtx = electricityCostCtx.getContext('2d');
    electricityCostChart = new Chart(electricityCostCtx, {
        type: 'bar',
        data: {
            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
            datasets: [{
                label: 'Ø Stromkosten (Ct/kWh)',
                data: [28.5, 29.2, 31.1, 30.8],
                backgroundColor: '#10B981',
                borderRadius: isMobile ? 2 : 4
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                ...mobileOptions.plugins,
                legend: {
                    display: false
                }
            }
        }
    });

    // Regionale Verteilung Chart
    const regionalDistributionCtx = document.getElementById('regionalDistributionChart');
    if (!regionalDistributionCtx) {
        console.error('❌ regionalDistributionChart Canvas nicht gefunden!');
        return;
    }
    console.log('✅ regionalDistributionChart Canvas gefunden');
    const regionalCtx = regionalDistributionCtx.getContext('2d');
    regionalDistributionChart = new Chart(regionalDistributionCtx, {
        type: 'bar',
        data: {
            labels: ['OÖ', 'NÖ', 'W', 'S', 'T', 'V'],
            datasets: [{
                label: 'Projekte',
                data: [45, 32, 28, 15, 12, 8],
                backgroundColor: '#8B5CF6',
                borderRadius: isMobile ? 2 : 4
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                ...mobileOptions.plugins,
                legend: {
                    display: false
                }
            }
        }
    });

    // System-Performance Chart
    const systemPerformanceCtx = document.getElementById('systemPerformanceChart');
    if (!systemPerformanceCtx) {
        console.error('❌ systemPerformanceChart Canvas nicht gefunden!');
        return;
    }
    console.log('✅ systemPerformanceChart Canvas gefunden');
    const systemCtx = systemPerformanceCtx.getContext('2d');
    systemPerformanceChart = new Chart(systemPerformanceCtx, {
        type: 'radar',
        data: {
            labels: ['Verfügbarkeit', 'Performance', 'Sicherheit', 'Skalierbarkeit', 'Benutzerfreundlichkeit'],
            datasets: [{
                label: 'Aktuelle Performance',
                data: [95, 88, 92, 85, 90],
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                pointBackgroundColor: '#EF4444',
                pointRadius: isMobile ? 3 : 5,
                pointHoverRadius: isMobile ? 5 : 7
            }]
        },
        options: {
            ...mobileOptions,
            plugins: {
                ...mobileOptions.plugins,
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: isMobile ? 10 : 12
                        }
                    },
                    pointLabels: {
                        font: {
                            size: isMobile ? 10 : 12
                        }
                    }
                }
            }
        }
    });
    
    console.log('✅ Alle Charts erfolgreich initialisiert!');
}

// Mobile Navigation
function initializeMobileNavigation() {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const closeMobileMenu = document.getElementById('closeMobileMenu');
    
    if (mobileMenuToggle && mobileSidebar && mobileOverlay && closeMobileMenu) {
        // Menü öffnen
        mobileMenuToggle.addEventListener('click', () => {
            mobileSidebar.classList.add('active');
            mobileOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        
        // Menü schließen
        const closeMenu = () => {
            mobileSidebar.classList.remove('active');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = '';
        };
        
        closeMobileMenu.addEventListener('click', closeMenu);
        mobileOverlay.addEventListener('click', closeMenu);
        
        // Swipe-Gesten für mobile Navigation
        let startX = 0;
        let startY = 0;
        
        mobileSidebar.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        
        mobileSidebar.addEventListener('touchmove', (e) => {
            if (!startX || !startY) return;
            
            const diffX = startX - e.touches[0].clientX;
            const diffY = startY - e.touches[0].clientY;
            
            // Horizontale Swipe erkannt
            if (Math.abs(diffX) > Math.abs(diffY) && diffX > 50) {
                closeMenu();
            }
        });
        
        mobileSidebar.addEventListener('touchend', () => {
            startX = 0;
            startY = 0;
        });
    }
}

// Touch-Gesten für Charts
function initializeTouchGestures() {
    const charts = document.querySelectorAll('canvas');
    
    charts.forEach(canvas => {
        let startX = 0;
        let startY = 0;
        
        canvas.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if (!startX || !startY) return;
            
            const diffX = startX - e.touches[0].clientX;
            const diffY = startY - e.touches[0].clientY;
            
            // Vertikale Swipe für Zoom
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 50) {
                e.preventDefault();
            }
        });
    });
}

// Responsive Chart-Updates
function handleResize() {
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
    
    // Charts neu zeichnen bei Größenänderung
    if (projectGrowthChart) {
        projectGrowthChart.resize();
    }
    if (capacityDistributionChart) {
        capacityDistributionChart.resize();
    }
    if (electricityCostChart) {
        electricityCostChart.resize();
    }
    if (regionalDistributionChart) {
        regionalDistributionChart.resize();
    }
    if (systemPerformanceChart) {
        systemPerformanceChart.resize();
    }
    
    // Mobile Navigation anpassen
    if (isMobile) {
        document.body.classList.add('mobile-view');
    } else {
        document.body.classList.remove('mobile-view');
    }
}

function updateChartPeriod(period) {
    currentChartPeriod = period;
    
    // Update Button Styles
    document.querySelectorAll('[onclick^="updateChartPeriod"]').forEach(btn => {
        btn.className = 'px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200';
    });
    event.target.className = 'px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200';
    
    // Lade neue Daten für den gewählten Zeitraum
    loadChartData(period);
}

function loadChartData(period) {
    // Lade echte Daten von der API
    fetch('/api/dashboard/charts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChartsWithRealData(data, period);
            } else {
                // Fallback zu Demo-Daten
                loadDemoChartData(period);
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Chart-Daten:', error);
            loadDemoChartData(period);
        });
}

function loadDemoChartData(period) {
    // Demo-Daten als Fallback
    const demoData = {
        month: [12, 19, 15, 25, 22, 30, 35, 28, 32, 40, 38, 45],
        quarter: [46, 77, 105, 123],
        year: [150, 280, 420, 580]
    };
    
    const labels = {
        month: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
        quarter: ['Q1', 'Q2', 'Q3', 'Q4'],
        year: ['2021', '2022', '2023', '2024']
    };
    
    projectGrowthChart.data.labels = labels[period];
    projectGrowthChart.data.datasets[0].data = demoData[period];
    projectGrowthChart.update();
}

function updateChartsWithRealData(data, period) {
    // Projekt-Wachstum Chart aktualisieren
    if (data.project_growth && data.project_growth.length > 0) {
        const growthData = data.project_growth;
        const labels = growthData.map(item => {
            const date = new Date(item.month + '-01');
            return date.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
        });
        const values = growthData.map(item => item.count);
        
        projectGrowthChart.data.labels = labels;
        projectGrowthChart.data.datasets[0].data = values;
        projectGrowthChart.update();
    }
    
    // Kapazitäts-Verteilung Chart aktualisieren
    if (data.capacity_distribution) {
        const bessCapacity = data.capacity_distribution.bess || 0;
        const pvCapacity = data.capacity_distribution.pv || 0;
        const total = bessCapacity + pvCapacity;
        
        if (total > 0) {
            capacityDistributionChart.data.datasets[0].data = [
                (bessCapacity / total) * 100,
                (pvCapacity / total) * 100
            ];
            capacityDistributionChart.update();
        }
    }
    
    // Regionale Verteilung Chart aktualisieren
    if (data.regional_distribution && data.regional_distribution.length > 0) {
        const regions = data.regional_distribution.slice(0, 6); // Top 6 Regionen
        const labels = regions.map(item => item.region.substring(0, 3).toUpperCase());
        const values = regions.map(item => item.count);
        
        regionalDistributionChart.data.labels = labels;
        regionalDistributionChart.data.datasets[0].data = values;
        regionalDistributionChart.update();
    }
    
    // Stromkosten-Trend Chart aktualisieren
    if (data.electricity_cost_trend && data.electricity_cost_trend.length > 0) {
        const trendData = data.electricity_cost_trend;
        const labels = trendData.map(item => item.quarter);
        const values = trendData.map(item => parseFloat(item.avg_cost).toFixed(1));
        
        electricityCostChart.data.labels = labels;
        electricityCostChart.data.datasets[0].data = values;
        electricityCostChart.update();
    }
}

function loadChartDataFromAPI() {
    // Lade initiale Chart-Daten
    loadChartData(currentChartPeriod);
}

function loadPerformanceMetrics() {
    fetch('/api/dashboard/performance')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.performance_metrics) {
                updatePerformanceChart(data.performance_metrics);
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Performance-Metriken:', error);
        });
}

function updatePerformanceChart(metrics) {
    const labels = ['Verfügbarkeit', 'Performance', 'Sicherheit', 'Skalierbarkeit', 'Benutzerfreundlichkeit'];
    const values = [
        metrics.availability,
        metrics.performance,
        metrics.security,
        metrics.scalability,
        metrics.user_friendliness
    ];
    
    systemPerformanceChart.data.datasets[0].data = values;
    systemPerformanceChart.update();
}

function startRealTimeUpdates() {
    // Aktualisiere Charts alle 30 Sekunden
    setInterval(() => {
        updateChartsWithRealData();
    }, 30000);
}

function updateChartsWithRealData() {
    // Aktualisiere alle Charts mit echten Daten
    Promise.all([
        fetch('/api/dashboard/stats'),
        fetch('/api/dashboard/charts'),
        fetch('/api/dashboard/performance')
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([stats, charts, performance]) => {
        // Aktualisiere Kapazitäts-Verteilung
        if (stats.total_bess_capacity !== undefined && stats.total_pv_capacity !== undefined) {
            const bessCapacity = stats.total_bess_capacity || 0;
            const pvCapacity = stats.total_pv_capacity || 0;
            const total = bessCapacity + pvCapacity;
            
            if (total > 0) {
                capacityDistributionChart.data.datasets[0].data = [
                    (bessCapacity / total) * 100,
                    (pvCapacity / total) * 100
                ];
                capacityDistributionChart.update();
            }
        }
        
        // Aktualisiere Performance-Chart
        if (performance.success && performance.performance_metrics) {
            updatePerformanceChart(performance.performance_metrics);
        }
        
        // Zeige Update-Status
        showUpdateStatus('Charts aktualisiert');
    })
    .catch(error => {
        console.error('Fehler beim Aktualisieren der Charts:', error);
        showUpdateStatus('Update fehlgeschlagen', 'error');
    });
}

function showUpdateStatus(message, type = 'success') {
    // Erstelle oder aktualisiere Status-Meldung
    let statusElement = document.getElementById('updateStatus');
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = 'updateStatus';
        statusElement.className = 'fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm z-50';
        document.body.appendChild(statusElement);
    }
    
    statusElement.textContent = message;
    statusElement.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    
    // Verstecke nach 3 Sekunden
    setTimeout(() => {
        statusElement.style.opacity = '0';
        setTimeout(() => {
            if (statusElement.parentNode) {
                statusElement.parentNode.removeChild(statusElement);
            }
        }, 300);
    }, 3000);
}

// Interaktive Karte Funktionen
let currentMapView = 'all';
let projectLocations = [];

function initializeProjectMap() {
    loadProjectLocations();
}

function loadProjectLocations() {
    fetch('/api/dashboard/locations')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                projectLocations = data.locations;
                renderProjectMap();
            } else {
                console.error('Fehler beim Laden der Projekt-Standorte:', data.error);
                renderProjectMapFallback();
            }
        })
        .catch(error => {
            console.error('Fehler beim Laden der Projekt-Standorte:', error);
            renderProjectMapFallback();
        });
}

function renderProjectMap() {
    const mapContainer = document.getElementById('projectMap');
    
    if (projectLocations.length === 0) {
        mapContainer.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-map-marked-alt text-gray-400 text-4xl mb-2"></i>
                    <p class="text-gray-600">Keine Standorte verfügbar</p>
                    <p class="text-sm text-gray-500">Erstellen Sie Projekte mit Standortangaben</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Erstelle eine einfache SVG-Karte von Österreich
    const svgMap = createAustriaMap();
    mapContainer.innerHTML = svgMap;
    
    // Füge Projekt-Marker hinzu
    addProjectMarkers();
}

function createAustriaMap() {
    return `
        <svg viewBox="0 0 400 300" class="w-full h-full">
            <!-- Österreich Umriss (vereinfacht) -->
            <path d="M 50 50 L 350 50 L 350 250 L 50 250 Z" 
                  fill="none" stroke="#E5E7EB" stroke-width="2"/>
            
            <!-- Bundesländer (vereinfacht) -->
            <g id="bundeslaender">
                <!-- Oberösterreich -->
                <rect x="100" y="80" width="80" height="60" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="140" y="115" text-anchor="middle" class="text-xs fill-gray-600">OÖ</text>
                
                <!-- Niederösterreich -->
                <rect x="180" y="100" width="60" height="80" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="210" y="145" text-anchor="middle" class="text-xs fill-gray-600">NÖ</text>
                
                <!-- Wien -->
                <rect x="200" y="80" width="20" height="20" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="210" y="92" text-anchor="middle" class="text-xs fill-gray-600">W</text>
                
                <!-- Steiermark -->
                <rect x="180" y="180" width="80" height="60" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="220" y="215" text-anchor="middle" class="text-xs fill-gray-600">ST</text>
                
                <!-- Tirol -->
                <rect x="50" y="100" width="50" height="80" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="75" y="145" text-anchor="middle" class="text-xs fill-gray-600">T</text>
                
                <!-- Vorarlberg -->
                <rect x="20" y="120" width="30" height="40" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
                <text x="35" y="142" text-anchor="middle" class="text-xs fill-gray-600">V</text>
            </g>
            
            <!-- Projekt-Marker werden hier hinzugefügt -->
            <g id="project-markers"></g>
        </svg>
    `;
}

function addProjectMarkers() {
    const markersGroup = document.querySelector('#project-markers');
    if (!markersGroup) return;
    
    // Filtere Projekte basierend auf der aktuellen Ansicht
    let filteredProjects = projectLocations;
    if (currentMapView === 'active') {
        filteredProjects = projectLocations.filter(p => p.has_load_profile);
    } else if (currentMapView === 'recent') {
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        filteredProjects = projectLocations.filter(p => new Date(p.created_at) > oneMonthAgo);
    }
    
    // Erstelle Marker für jedes Projekt
    filteredProjects.forEach((project, index) => {
        const marker = createProjectMarker(project, index);
        markersGroup.appendChild(marker);
    });
}

function createProjectMarker(project, index) {
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
    // Bestimme Position basierend auf Standort
    const position = getLocationPosition(project.location);
    
    // Bestimme Farbe basierend auf Projekt-Typ
    const color = getProjectColor(project);
    
    marker.innerHTML = `
        <circle cx="${position.x}" cy="${position.y}" r="6" fill="${color}" stroke="white" stroke-width="2"/>
        <circle cx="${position.x}" cy="${position.y}" r="8" fill="none" stroke="${color}" stroke-width="1" opacity="0.5">
            <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.5;0;0.5" dur="2s" repeatCount="indefinite"/>
        </circle>
    `;
    
    // Tooltip
    const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'title');
    tooltip.textContent = `${project.name} - ${project.location}`;
    marker.appendChild(tooltip);
    
    return marker;
}

function getLocationPosition(location) {
    // Vereinfachte Positionierung basierend auf Standort
    const positions = {
        'Oberösterreich': { x: 140, y: 110 },
        'OÖ': { x: 140, y: 110 },
        'Niederösterreich': { x: 210, y: 140 },
        'NÖ': { x: 210, y: 140 },
        'Wien': { x: 210, y: 90 },
        'W': { x: 210, y: 90 },
        'Steiermark': { x: 220, y: 210 },
        'ST': { x: 220, y: 210 },
        'Tirol': { x: 75, y: 140 },
        'T': { x: 75, y: 140 },
        'Vorarlberg': { x: 35, y: 140 },
        'V': { x: 35, y: 140 }
    };
    
    for (const [key, pos] of Object.entries(positions)) {
        if (location.includes(key)) {
            return pos;
        }
    }
    
    // Fallback: zufällige Position
    return {
        x: 100 + Math.random() * 200,
        y: 80 + Math.random() * 120
    };
}

function getProjectColor(project) {
    if (project.bess_size && project.pv_power) {
        return '#8B5CF6'; // Hybrid (Lila)
    } else if (project.pv_power) {
        return '#10B981'; // PV (Grün)
    } else {
        return '#3B82F6'; // BESS (Blau)
    }
}

function toggleMapView(view) {
    currentMapView = view;
    
    // Update Button Styles
    document.querySelectorAll('[onclick^="toggleMapView"]').forEach(btn => {
        btn.className = 'px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200';
    });
    event.target.className = 'px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200';
    
    // Aktualisiere Karte
    renderProjectMap();
}

function renderProjectMapFallback() {
    const mapContainer = document.getElementById('projectMap');
    mapContainer.innerHTML = `
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-yellow-400 text-4xl mb-2"></i>
                <p class="text-gray-600">Karte konnte nicht geladen werden</p>
                <p class="text-sm text-gray-500">Versuchen Sie es später erneut</p>
            </div>
        </div>
    `;
}

function loadProjectsFallback() {
    // Fallback-Methode falls die Statistiken-API nicht funktioniert
    fetch('/api/projects')
        .then(response => response.json())
        .then(projects => {
            document.getElementById('projectsCount').textContent = projects.length;
            document.getElementById('activeCount').textContent = projects.length;
            
            if (projects.length > 0) {
                displayRecentProjects(projects.slice(0, 3));
            }
        })
        .catch(error => console.error('Fehler beim Laden der Projekte:', error));
}

function displayRecentProjects(projects) {
    const projectsHtml = projects.map(project => `
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-100 transition-colors">
            <div class="flex justify-between items-center">
                <div>
                    <h4 class="font-medium text-gray-900">${project.name}</h4>
                    <p class="text-sm text-gray-600">${project.location || 'Kein Standort angegeben'}</p>
                </div>
                <a href="/view_project?id=${project.id}" 
                   class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm">
                    <i class="fas fa-eye mr-1"></i>Anzeigen
                </a>
            </div>
        </div>
    `).join('');
    
    document.getElementById('recentProjects').innerHTML = `
        <div class="space-y-3">
            ${projectsHtml}
        </div>
    `;
}

function displayRecentActivities(activities) {
    const activitiesHtml = activities.map(activity => `
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-100 transition-colors">
            <div class="flex justify-between items-center">
                <div>
                    <h4 class="font-medium text-gray-900">${activity.name}</h4>
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>${activity.location || 'Kein Standort'}
                        ${activity.customer_name ? `<br><i class="fas fa-user mr-1"></i>${activity.customer_name}` : ''}
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-calendar mr-1"></i>Erstellt: ${activity.created_at || 'Unbekannt'}
                    </p>
                </div>
                <div class="text-right">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-plus mr-1"></i>Neues Projekt
                    </span>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('recentProjects').innerHTML = `
        <div class="space-y-3">
            ${activitiesHtml}
        </div>
    `;
}
</script>
{% endblock %} 