{% extends "base.html" %}

{% block title %}Datenimport-Center{% endblock %}

{% block content %}
<!-- CSRF-Token f√ºr AJAX-Requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">
            <i class="fas fa-database text-blue-600 mr-3"></i>
            Intelligentes Datenimport-Center
        </h1>
        <p class="text-gray-600">Importiere und verarbeite verschiedene Energie- und Umweltdaten intelligent und effizient.</p>
    </div>

    <!-- Projekt-Auswahl -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-project-diagram text-green-600 mr-2"></i>
            Projekt ausw√§hlen
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Projekt</label>
                <select id="projectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Projekt ausw√§hlen...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Importierte Datens√§tze</label>
                <div id="importedData" class="text-sm text-gray-600">
                    <div class="grid grid-cols-2 gap-2">
                        <div>Lastprofile: <span id="loadCount">0</span></div>
                        <div>Einstrahlung: <span id="solarCount">0</span></div>
                        <div>Pegelst√§nde: <span id="hydroCount">0</span></div>
                        <div>Wetterdaten: <span id="weatherCount">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datenarten-Tabs -->
    <div class="bg-white rounded-lg shadow-md mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button onclick="showTab('load')" id="tab-load" class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                    <i class="fas fa-chart-line mr-2"></i>Lastprofile
                </button>
                <button onclick="showTab('solar')" id="tab-solar" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-sun mr-2"></i>Einstrahlung
                </button>
                <button onclick="showTab('hydro')" id="tab-hydro" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-water mr-2"></i>Pegelst√§nde
                </button>
                <button onclick="showTab('pvsol')" id="tab-pvsol" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-solar-panel mr-2"></i>PVSol Export
                </button>
                <button onclick="showTab('weather')" id="tab-weather" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-cloud mr-2"></i>Wetterdaten
                </button>
            </nav>
        </div>

        <!-- Lastprofile Tab -->
        <div id="tab-content-load" class="tab-content p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- CSV Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="csv" data-data-type="load">
                    <i class="fas fa-file-csv text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">CSV-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Standard CSV mit Zeitstempel und Lastwerten</p>
                    <p class="text-xs text-blue-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="loadCsvFile" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('loadCsvFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        CSV ausw√§hlen
                    </button>
                </div>

                <!-- Excel Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="excel" data-data-type="load">
                    <i class="fas fa-file-excel text-4xl text-green-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Excel-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Daten aus mehreren Z√§hlpunkten m√∂glich</p>
                    <p class="text-xs text-green-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="loadExcelFile" accept=".xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('loadExcelFile').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Excel ausw√§hlen
                    </button>
                </div>

                <!-- Manuelle Eingabe -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <i class="fas fa-keyboard text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Manuelle Eingabe</h3>
                    <p class="text-sm text-gray-600 mb-4">Einzelne Werte hinzuf√ºgen</p>
                    
                    <div class="space-y-3">
                        <input type="datetime-local" id="loadDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <input type="number" id="loadValue" step="0.01" placeholder="Last (kW)" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <button onclick="addLoadValue()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                            Wert hinzuf√ºgen
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Einstrahlung Tab -->
        <div id="tab-content-solar" class="tab-content p-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- CSV Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="csv" data-data-type="solar">
                    <i class="fas fa-sun text-4xl text-yellow-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">CSV-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Einstrahlungsdaten mit Zeitstempel</p>
                    <p class="text-xs text-blue-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="solarCsvFile" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('solarCsvFile').click()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md">
                        CSV ausw√§hlen
                    </button>
                </div>

                <!-- Excel Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="excel" data-data-type="solar">
                    <i class="fas fa-file-excel text-4xl text-green-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Excel-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Mehrere Einstrahlungsmesspunkte</p>
                    <p class="text-xs text-green-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="solarExcelFile" accept=".xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('solarExcelFile').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Excel ausw√§hlen
                    </button>
                </div>

                <!-- Intelligente Vorschau -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <i class="fas fa-chart-area text-4xl text-purple-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Intelligente Vorschau</h3>
                    <p class="text-sm text-gray-600 mb-4">Automatische Spalten-Erkennung</p>
                    <div id="solarPreview" class="text-sm text-gray-500">
                        Keine Daten geladen
                    </div>
                </div>
            </div>
        </div>

        <!-- Pegelst√§nde Tab -->
        <div id="tab-content-hydro" class="tab-content p-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- CSV Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="csv" data-data-type="hydro">
                    <i class="fas fa-water text-4xl text-blue-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">CSV-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Wasserstandsdaten mit Zeitstempel</p>
                    <p class="text-xs text-blue-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="hydroCsvFile" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('hydroCsvFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        CSV ausw√§hlen
                    </button>
                </div>

                <!-- Excel Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="excel" data-data-type="hydro">
                    <i class="fas fa-file-excel text-4xl text-green-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Excel-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Mehrere Pegelstandsmesspunkte</p>
                    <p class="text-xs text-green-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="hydroExcelFile" accept=".xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('hydroExcelFile').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Excel ausw√§hlen
                    </button>
                </div>

                <!-- Intelligente Vorschau -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <i class="fas fa-chart-line text-4xl text-cyan-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Intelligente Vorschau</h3>
                    <p class="text-sm text-gray-600 mb-4">Automatische Pegelstand-Erkennung</p>
                    <div id="hydroPreview" class="text-sm text-gray-500">
                        Keine Daten geladen
                    </div>
                </div>
            </div>
        </div>

        <!-- PVSol Export Tab -->
        <div id="tab-content-pvsol" class="tab-content p-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- PVSol Datei Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="pvsol" data-data-type="pvsol">
                    <i class="fas fa-solar-panel text-4xl text-orange-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">PVSol Export</h3>
                    <p class="text-sm text-gray-600 mb-4">Direkte PVSol-Datei-Integration</p>
                    <p class="text-xs text-orange-600 mb-4">üìÅ PVSol-Datei hier hineinziehen</p>
                    <input type="file" id="pvsolFile" accept=".txt,.csv,.xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('pvsolFile').click()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md">
                        PVSol ausw√§hlen
                    </button>
                </div>

                <!-- Excel Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="excel" data-data-type="pvsol">
                    <i class="fas fa-file-excel text-4xl text-green-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Excel-Export</h3>
                    <p class="text-sm text-gray-600 mb-4">PVSol-Daten aus Excel</p>
                    <p class="text-xs text-green-600 mb-4">üìÅ Excel-Datei hier hineinziehen</p>
                    <input type="file" id="pvsolExcelFile" accept=".xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('pvsolExcelFile').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Excel ausw√§hlen
                    </button>
                </div>

                <!-- Intelligente Vorschau -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <i class="fas fa-chart-bar text-4xl text-red-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">PVSol Vorschau</h3>
                    <p class="text-sm text-gray-600 mb-4">Solar-Ertragsdaten Analyse</p>
                    <div id="pvsolPreview" class="text-sm text-gray-500">
                        Keine PVSol-Daten geladen
                    </div>
                </div>
            </div>
        </div>

        <!-- Wetterdaten Tab -->
        <div id="tab-content-weather" class="tab-content p-6 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- CSV Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="csv" data-data-type="weather">
                    <i class="fas fa-cloud text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">CSV-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Wetterdaten mit Zeitstempel</p>
                    <p class="text-xs text-blue-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="weatherCsvFile" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('weatherCsvFile').click()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                        CSV ausw√§hlen
                    </button>
                </div>

                <!-- Excel Import -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drag-drop-area" 
                     data-file-type="excel" data-data-type="weather">
                    <i class="fas fa-file-excel text-4xl text-green-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Excel-Datei</h3>
                    <p class="text-sm text-gray-600 mb-4">Mehrere Wetterparameter</p>
                    <p class="text-xs text-green-600 mb-4">üìÅ Datei hier hineinziehen oder klicken</p>
                    <input type="file" id="weatherExcelFile" accept=".xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('weatherExcelFile').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Excel ausw√§hlen
                    </button>
                </div>

                <!-- Intelligente Vorschau -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <i class="fas fa-thermometer-half text-4xl text-indigo-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Wetter Vorschau</h3>
                    <p class="text-sm text-gray-600 mb-4">Temperatur, Luftfeuchtigkeit, etc.</p>
                    <div id="weatherPreview" class="text-sm text-gray-500">
                        Keine Wetterdaten geladen
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Intelligente Verarbeitung -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-brain text-purple-600 mr-2"></i>
            Intelligente Datenverarbeitung
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Zeitintervall</label>
                <select id="timeInterval" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="15">15 Minuten</option>
                    <option value="30">30 Minuten</option>
                    <option value="60">1 Stunde</option>
                    <option value="1440">1 Tag</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Datum-Format</label>
                <select id="dateFormat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="auto">Automatisch erkennen</option>
                    <option value="DD.MM.YYYY">DD.MM.YYYY</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Datenkombination</label>
                <select id="dataCombination" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="sum">Summe</option>
                    <option value="max">Maximum</option>
                    <option value="average">Durchschnitt</option>
                    <option value="weighted">Gewichtet</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Qualit√§tspr√ºfung</label>
                <select id="qualityCheck" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="strict">Streng</option>
                    <option value="normal">Normal</option>
                    <option value="loose">Locker</option>
                </select>
            </div>
        </div>

        <!-- Vorschau -->
        <div id="dataPreview" class="hidden">
            <h3 class="text-lg font-medium text-gray-800 mb-4">Datenvorschau</h3>
            <div class="bg-gray-50 p-4 rounded-lg overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr id="previewHeader" class="border-b border-gray-200"></tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Import-Button -->
        <div class="mt-6 text-center">
            <button id="importButton" onclick="importData()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-md text-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-upload mr-2"></i>
                Daten intelligent importieren
            </button>
        </div>
    </div>

    <!-- Status-Anzeige -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
            Import-Status
        </h2>
        
        <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-blue-800">
                <i class="fas fa-check-circle mr-2"></i>
                Datenimport-Center bereit f√ºr neue Importe
            </p>
            <p class="text-sm text-blue-600 mt-2">
                W√§hlen Sie ein Projekt und eine Datenart aus, um mit dem Import zu beginnen.
            </p>
        </div>
    </div>
</div>

<script>
let currentProjectId = null;
let currentDataType = 'load';
let importedData = {
    load: [],
    solar: [],
    hydro: [],
    pvsol: [],
    weather: []
};

// Tab-Funktionalit√§t
function showTab(dataType) {
    // Alle Tabs ausblenden
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Alle Tab-Buttons zur√ºcksetzen
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Gew√§hlten Tab anzeigen
    document.getElementById(`tab-content-${dataType}`).classList.remove('hidden');
    document.getElementById(`tab-${dataType}`).classList.add('active', 'border-blue-500', 'text-blue-600');
    
    currentDataType = dataType;
}

// Projekte laden
async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const select = document.getElementById('projectSelect');
        select.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Projekte:', error);
    }
}

// Datei-Upload-Handler
document.addEventListener('DOMContentLoaded', function() {
    // Lastprofile
    document.getElementById('loadCsvFile').addEventListener('change', handleFileUpload);
    document.getElementById('loadExcelFile').addEventListener('change', handleFileUpload);
    
    // Einstrahlung
    document.getElementById('solarCsvFile').addEventListener('change', handleFileUpload);
    document.getElementById('solarExcelFile').addEventListener('change', handleFileUpload);
    
    // Pegelst√§nde
    document.getElementById('hydroCsvFile').addEventListener('change', handleFileUpload);
    document.getElementById('hydroExcelFile').addEventListener('change', handleFileUpload);
    
    // PVSol Export
    document.getElementById('pvsolFile').addEventListener('change', handleFileUpload);
    document.getElementById('pvsolExcelFile').addEventListener('change', handleFileUpload);
    
    // Wetterdaten
    document.getElementById('weatherCsvFile').addEventListener('change', handleFileUpload);
    document.getElementById('weatherExcelFile').addEventListener('change', handleFileUpload);
    
    // Drag & Drop f√ºr alle Bereiche
    setupDragAndDrop();
    
    loadProjects();
});

// Drag & Drop Setup
function setupDragAndDrop() {
    const dragAreas = document.querySelectorAll('.drag-drop-area');
    
    dragAreas.forEach(area => {
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        area.addEventListener('dragleave', (e) => {
            e.preventDefault();
            area.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const dataType = area.getAttribute('data-data-type');
                handleFileUpload({ target: { files: [file] } }, dataType);
            }
        });
    });
}

// Datei-Upload behandeln
function handleFileUpload(event, dataType = null) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Datenart aus dem Event oder dem Drag-Drop-Bereich ermitteln
    const actualDataType = dataType || event.target.closest('.drag-drop-area')?.getAttribute('data-data-type') || 'load';
    
    console.log('üìÅ Datei-Upload gestartet:', {
        name: file.name,
        size: file.size,
        type: file.type,
        dataType: actualDataType
    });
    
    const fileExtension = file.name.split('.').pop().toLowerCase();
    
    if (fileExtension === 'csv') {
        // CSV-Datei verarbeiten
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvData = e.target.result;
            const data = parseCSVData(csvData, actualDataType);
            
            if (data.length > 0) {
                showDataPreview(data, file.name, actualDataType);
                showNotification(`CSV-Datei erfolgreich geladen: ${data.length} Datens√§tze`, 'success');
            } else {
                showNotification('Keine g√ºltigen Daten in der CSV-Datei gefunden', 'error');
            }
        };
        reader.readAsText(file);
        
    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
        // Excel-Datei verarbeiten
        processExcelFile(file, actualDataType)
            .then(data => {
                if (data.length > 0) {
                    showDataPreview(data, file.name, actualDataType);
                    showNotification(`Excel-Datei erfolgreich geladen: ${data.length} Datens√§tze`, 'success');
                } else {
                    showNotification('Keine g√ºltigen Daten in der Excel-Datei gefunden', 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Excel-Import-Fehler:', error);
                showNotification(`Excel-Import-Fehler: ${error.message}`, 'error');
            });
        
    } else if (fileExtension === 'txt' && actualDataType === 'pvsol') {
        // PVSol-Textdatei verarbeiten
        const reader = new FileReader();
        reader.onload = function(e) {
            const textData = e.target.result;
            const data = parsePVSolData(textData);
            
            if (data.length > 0) {
                showDataPreview(data, file.name, actualDataType);
                showNotification(`PVSol-Datei erfolgreich geladen: ${data.length} Datens√§tze`, 'success');
            } else {
                showNotification('Keine g√ºltigen PVSol-Daten gefunden', 'error');
            }
        };
        reader.readAsText(file);
        
    } else {
        showNotification('Nicht unterst√ºtztes Dateiformat. Bitte verwenden Sie CSV, Excel oder PVSol-Dateien.', 'error');
    }
}

// CSV parsen
function parseCSV(csvText, dataType) {
    const lines = csvText.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {
            const values = line.split(',').map(v => v.trim());
            const row = {};
            
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            
            data.push(row);
        }
    }
    
    return processData(data, dataType);
}

// Excel parsen
function parseExcel(workbook, dataType) {
    const data = [];
    
    // Alle Bl√§tter verarbeiten
    workbook.SheetNames.forEach(sheetName => {
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (jsonData.length > 1) {
            const headers = jsonData[0];
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = jsonData[i][index] || '';
                });
                data.push(row);
            }
        }
    });
    
    return processData(data, dataType);
}

// Daten verarbeiten
function processData(rawData, dataType) {
    const processedData = [];
    
    rawData.forEach(row => {
        const processedRow = {
            timestamp: parseDateTime(row.Datum || row.Zeitstempel || row.Time),
            data_type: dataType
        };
        
        switch (dataType) {
            case 'load':
                processedRow.value = parseFloat(row.kWh || row.Load || row['Last (kW)'] || 0);
                processedRow.unit = 'kW';
                break;
            case 'solar':
                processedRow.value = parseFloat(row['Globalstrahlung (W/m¬≤)'] || row.Irradiation || row['Einstrahlung'] || 0);
                processedRow.unit = 'W/m¬≤';
                break;
            case 'hydro':
                processedRow.value = parseFloat(row['Wasserstand (m)'] || row.Level || row['Pegel'] || 0);
                processedRow.unit = 'm';
                break;
            case 'pvsol':
                processedRow.value = parseFloat(row['Leistung (kW)'] || row.Power || row['PV-Leistung'] || 0);
                processedRow.unit = 'kW';
                break;
            case 'weather':
                processedRow.value = parseFloat(row['Temperatur (¬∞C)'] || row.Temperature || row['Temp'] || 0);
                processedRow.unit = '¬∞C';
                break;
        }
        
        if (processedRow.timestamp && !isNaN(processedRow.value)) {
            processedData.push(processedRow);
        }
    });
    
    return processedData;
}

// Datum/Zeit parsen
function parseDateTime(value) {
    if (!value) return null;
    
    try {
        // Verschiedene Formate versuchen
        if (value.includes('T')) {
            return new Date(value);
        } else if (value.includes('.')) {
            // DD.MM.YYYY Format
            const parts = value.split('.');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
        } else if (value.includes('-')) {
            return new Date(value);
        } else if (value.includes('/')) {
            const parts = value.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[0] - 1, parts[1]);
            }
        }
        
        return new Date(value);
    } catch (error) {
        console.error('Fehler beim Parsen des Datums:', value, error);
        return null;
    }
}

// Excel-Datum-Korrektur f√ºr Vorschau
function correctExcelDate(timestamp) {
    try {
        const date = new Date(timestamp);
        
        // Pr√ºfe ob Jahr < 2000 (Excel-Problem)
        if (date.getFullYear() < 2000) {
            console.log(`   ‚úÖ Excel-Datum korrigiert: ${timestamp} -> ${date.getFullYear()} -> 2024`);
            // Korrigiere zu 2024
            return new Date(2024, date.getMonth(), date.getDate(), 
                          date.getHours(), date.getMinutes(), date.getSeconds());
        }
        
        return date;
    } catch (error) {
        console.error('Fehler bei Excel-Datum-Korrektur:', error);
        return new Date(timestamp);
    }
}

// Datenvorschau anzeigen
function showDataPreview(data, fileName = '', dataType) {
    console.log('üìä Zeige Datenvorschau:', data);
    
    const previewContainer = document.getElementById('dataPreview');
    const importButton = document.getElementById('importButton');
    
    if (!data || data.length === 0) {
        previewContainer.innerHTML = '<div class="text-red-600">‚ùå Keine Daten zum Anzeigen</div>';
        previewContainer.classList.remove('hidden');
        importButton.style.display = 'none';
        return;
    }
    
    // Statistiken berechnen
    const values = data.map(d => parseFloat(d.value)).filter(v => !isNaN(v));
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const avgValue = values.reduce((a, b) => a + b, 0) / values.length;
    
    // Zeitraum mit Excel-Datum-Korrektur
    const firstDate = correctExcelDate(data[0].timestamp);
    const lastDate = correctExcelDate(data[data.length - 1].timestamp);
    
    // Standard-Profilname aus Dateiname oder Zeitstempel
    const defaultProfileName = fileName ? 
        fileName.replace(/\.[^/.]+$/, '') : 
        `Lastprofil ${new Date().toLocaleDateString('de-DE')}`;
    
    let previewHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-semibold text-green-800 mb-3">‚úÖ Daten erfolgreich erkannt!</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-3 rounded border">
                    <h4 class="font-medium text-gray-700 mb-2">üìä Statistiken</h4>
                    <p><strong>Datenpunkte:</strong> ${data.length}</p>
                    <p><strong>Minimal:</strong> ${minValue.toFixed(2)} ${data[0].unit || 'kW'}</p>
                    <p><strong>Maximal:</strong> ${maxValue.toFixed(2)} ${data[0].unit || 'kW'}</p>
                    <p><strong>Durchschnitt:</strong> ${avgValue.toFixed(2)} ${data[0].unit || 'kW'}</p>
                </div>
                
                <div class="bg-white p-3 rounded border">
                    <h4 class="font-medium text-gray-700 mb-2">üìÖ Zeitraum</h4>
                    <p><strong>Von:</strong> ${firstDate.toLocaleString('de-DE')}</p>
                    <p><strong>Bis:</strong> ${lastDate.toLocaleString('de-DE')}</p>
                    <p><strong>Dauer:</strong> ${Math.round((lastDate - firstDate) / (1000 * 60 * 60 * 24))} Tage</p>
                </div>
            </div>
            
            <div class="bg-white p-3 rounded border mb-4">
                <h4 class="font-medium text-gray-700 mb-2">üìã Erste 5 Datens√§tze</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-2 py-1 text-left">Zeitstempel</th>
                                <th class="px-2 py-1 text-left">Wert</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // Erste 5 Datens√§tze anzeigen (mit Excel-Datum-Korrektur)
        data.slice(0, 5).forEach(row => {
            const date = correctExcelDate(row.timestamp);
            previewHTML += `
                <tr class="border-b">
                    <td class="px-2 py-1">${date.toLocaleString('de-DE')}</td>
                    <td class="px-2 py-1">${parseFloat(row.value).toFixed(2)} ${row.unit || 'kW'}</td>
                </tr>
            `;
        });
        
        previewHTML += `
                        </tbody>
                    </table>
                </div>
            </div>
            
            ${currentDataType === 'load' ? `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h4 class="text-lg font-semibold text-yellow-800 mb-2">üìù Lastprofil benennen</h4>
                <p class="text-yellow-700 mb-3">
                    Geben Sie einen aussagekr√§ftigen Namen f√ºr dieses Lastprofil ein. 
                    Dieser Name wird in den BESS Analysen zur Auswahl angezeigt.
                </p>
                <div class="flex gap-3 items-center">
                    <label class="text-sm font-medium text-gray-700">Profilname:</label>
                    <input type="text" id="profileNameInput" value="${defaultProfileName}" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="z.B. Winter-Lastprofil 2024">
                </div>
            </div>
            ` : ''}
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-blue-800 mb-2">üöÄ Import bereit!</h4>
                <p class="text-blue-700 mb-3">
                    Die Daten wurden erfolgreich erkannt und k√∂nnen jetzt importiert werden. 
                    M√∂chten Sie diese Daten in die Datenbank importieren?
                </p>
                <div class="flex gap-3">
                    <button id="confirmImport" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        ‚úÖ Ja, Daten importieren
                    </button>
                    <button id="cancelImport" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
                        ‚ùå Abbrechen
                    </button>
                </div>
            </div>
        </div>
    `;
    
    previewContainer.innerHTML = previewHTML;
    previewContainer.classList.remove('hidden');
    
    // Import-Button verstecken (wird durch Abfrage ersetzt)
    importButton.style.display = 'none';
    
    // Event-Listener f√ºr Import-Abfrage
    document.getElementById('confirmImport').addEventListener('click', () => {
        console.log('üöÄ Import best√§tigt, starte Upload...');
        
        // Profilname f√ºr Lastprofile extrahieren
        let profileName = null;
        if (currentDataType === 'load') {
            profileName = document.getElementById('profileNameInput').value.trim();
            if (!profileName) {
                alert('Bitte geben Sie einen Namen f√ºr das Lastprofil ein!');
                return;
            }
        }
        
        uploadDataToServer(data, profileName);
    });

    document.getElementById('cancelImport').addEventListener('click', () => {
        console.log('‚ùå Import abgebrochen');
        previewContainer.classList.add('hidden');
        importButton.style.display = 'none';
    });
}

// Daten importieren
async function importData() {
    if (!currentProjectId) {
        alert('Bitte w√§hle ein Projekt aus');
        return;
    }
    
    const hasData = Object.values(importedData).some(data => data.length > 0);
    if (!hasData) {
        alert('Bitte w√§hle Daten zum Importieren aus');
        return;
    }
    
    try {
        const importSettings = {
            project_id: currentProjectId,
            time_interval: parseInt(document.getElementById('timeInterval').value),
            date_format: document.getElementById('dateFormat').value,
            data_combination: document.getElementById('dataCombination').value,
            quality_check: document.getElementById('qualityCheck').value
        };
        
        // Alle Datentypen importieren
        for (const [dataType, data] of Object.entries(importedData)) {
            if (data.length > 0) {
                await importDataType(dataType, data, importSettings);
            }
        }
        
        alert('Daten erfolgreich importiert!');
        updateDataOverview();
        
    } catch (error) {
        console.error('Fehler beim Import:', error);
        alert('Fehler beim Importieren der Daten');
    }
}

// Einzelnen Datentyp importieren
async function importDataType(dataType, data, settings) {
    const response = await fetch(`/api/data-import/${dataType}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            project_id: settings.project_id,
            data: data,
            settings: settings
        })
    });
    
    const result = await response.json();
    
    if (!result.success) {
        throw new Error(`Fehler beim Import von ${dataType}: ${result.error}`);
    }
    
    return result;
}

// Daten√ºbersicht aktualisieren
function updateDataOverview() {
    console.log('üîÑ Aktualisiere Daten√ºbersicht...');
    
    // Projekt-ID aus der Auswahl holen
    const projectSelect = document.getElementById('projectSelect');
    const projectId = projectSelect.value || 1; // Default zu Projekt 1
    
    fetch(`/api/projects/${projectId}/data-overview`)
        .then(response => response.json())
        .then(data => {
            console.log('üìä Daten√ºbersicht:', data);
            
            if (data.success) {
                // Obere Daten√ºbersicht aktualisieren
                document.getElementById('loadCount').textContent = data.load_profiles || 0;
                document.getElementById('solarCount').textContent = data.solar_data || 0;
                document.getElementById('hydroCount').textContent = data.hydro_data || 0;
                document.getElementById('weatherCount').textContent = data.weather_data || 0;
                
                // Untere Daten√ºbersicht aktualisieren (falls vorhanden)
                const loadDataCount = document.getElementById('loadDataCount');
                const solarDataCount = document.getElementById('solarDataCount');
                const hydroDataCount = document.getElementById('hydroDataCount');
                const weatherDataCount = document.getElementById('weatherDataCount');
                
                if (loadDataCount) loadDataCount.textContent = data.load_profiles || 0;
                if (solarDataCount) solarDataCount.textContent = data.solar_data || 0;
                if (hydroDataCount) hydroDataCount.textContent = data.hydro_data || 0;
                if (weatherDataCount) weatherDataCount.textContent = data.weather_data || 0;
                
                console.log('‚úÖ Daten√ºbersicht aktualisiert');
            } else {
                console.error('‚ùå Fehler beim Laden der Daten√ºbersicht:', data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå Fehler beim Laden der Daten√ºbersicht:', error);
        });
}

// Beim Laden der Seite Daten√ºbersicht aktualisieren
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Datenimport-Center geladen, aktualisiere Daten√ºbersicht...');
    updateDataOverview();
    
    // Event-Listener f√ºr Projekt-Auswahl
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            console.log('üìã Projekt gewechselt, aktualisiere Daten√ºbersicht...');
            updateDataOverview();
        });
    }
});

// Event Listeners
document.getElementById('projectSelect').addEventListener('change', function(e) {
    currentProjectId = e.target.value;
    if (currentProjectId) {
        updateDataOverview();
    }
});

// Datentyp aus Input-ID extrahieren
function getDataTypeFromInputId(inputId) {
    if (inputId.includes('load')) return 'load';
    if (inputId.includes('solar')) return 'solar';
    if (inputId.includes('hydro')) return 'hydro';
    if (inputId.includes('pvsol')) return 'pvsol';
    if (inputId.includes('weather')) return 'weather';
    return 'load';
}

// Benachrichtigung anzeigen
function showNotification(message, type = 'info') {
    // Einfache Benachrichtigung
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md text-white z-50 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Daten an Server uploaden
function uploadDataToServer(data, profileName = null) {
    console.log('üì§ Starte Upload an Server...');
    
    // Loading-Zustand anzeigen
    const previewContainer = document.getElementById('dataPreview');
    previewContainer.innerHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                <div>
                    <h4 class="text-lg font-semibold text-blue-800">üì§ Import l√§uft...</h4>
                    <p class="text-blue-700">Lade ${data.length} Datens√§tze in die Datenbank...</p>
                    <p class="text-sm text-blue-600 mt-1">Bitte warten Sie, dies kann einige Sekunden dauern.</p>
                </div>
            </div>
        </div>
    `;
    
    // Daten f√ºr Server vorbereiten - Verwende die aktuelle Datenart
    const uploadData = {
        data_type: currentDataType || 'load_profile',
        data: data.map(row => ({
            timestamp: row.timestamp,
            value: parseFloat(row.value),
            unit: row.unit || 'kW'
        })),
        profile_name: profileName
    };
    
    console.log('üìã Upload-Daten:', uploadData);
    
    // CSRF-Token holen
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // AJAX-Request an Server
    fetch('/api/import-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(uploadData)
    })
    .then(response => {
        console.log('üì° Server-Antwort Status:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('‚úÖ Server-Antwort:', result);
        
        if (result.success) {
            // Erfolg anzeigen mit detaillierten Informationen
            previewContainer.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <div class="text-green-600 text-2xl mr-3 mt-1">‚úÖ</div>
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-green-800">Import erfolgreich abgeschlossen!</h4>
                            <div class="mt-3 space-y-2">
                                <p class="text-green-700">
                                    <strong>${data.length} Datens√§tze</strong> wurden erfolgreich in die Datenbank importiert.
                                </p>
                                <p class="text-green-700">
                                    <strong>Datenart:</strong> ${getDataTypeName(currentDataType)}
                                </p>
                                <p class="text-green-700">
                                    <strong>Projekt:</strong> ${document.getElementById('projectSelect').options[document.getElementById('projectSelect').selectedIndex].text}
                                </p>
                                <p class="text-green-700">
                                    <strong>Zeitraum:</strong> ${correctExcelDate(data[0].timestamp).toLocaleDateString('de-DE')} - ${correctExcelDate(data[data.length-1].timestamp).toLocaleDateString('de-DE')}
                                </p>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button onclick="viewImportedData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üìä Daten anzeigen
                                </button>
                                <button onclick="importMoreData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                                    ‚ûï Weitere Daten importieren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Import-Button wieder anzeigen
            document.getElementById('importButton').style.display = 'block';
            
            // Daten√ºbersicht aktualisieren
            updateDataOverview();
            
            // Erfolgs-Benachrichtigung anzeigen
            showNotification(`‚úÖ ${data.length} Datens√§tze erfolgreich importiert!`, 'success');
            
        } else {
            // Fehler anzeigen
            throw new Error(result.error || 'Unbekannter Fehler beim Import');
        }
    })
    .catch(error => {
        console.error('‚ùå Upload-Fehler:', error);
        
        previewContainer.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="text-red-600 text-2xl mr-3 mt-1">‚ùå</div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-red-800">Import fehlgeschlagen!</h4>
                        <p class="text-red-700 mt-2">
                            <strong>Fehler:</strong> ${error.message || 'Unbekannter Fehler beim Upload der Daten.'}
                        </p>
                        <p class="text-red-600 text-sm mt-2">
                            Bitte √ºberpr√ºfen Sie die Daten und versuchen Sie es erneut.
                        </p>
                        <div class="mt-4 flex space-x-3">
                            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                                üîÑ Erneut versuchen
                            </button>
                            <button onclick="clearImportData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium">
                                üóëÔ∏è Daten l√∂schen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Import-Button wieder anzeigen
        document.getElementById('importButton').style.display = 'block';
        
        // Fehler-Benachrichtigung anzeigen
        showNotification(`‚ùå Import fehlgeschlagen: ${error.message}`, 'error');
    });
}

// Datentyp-Name abrufen
function getDataTypeName(dataType) {
    const dataTypeNames = {
        'load': 'Lastprofile',
        'solar': 'Einstrahlung',
        'hydro': 'Pegelst√§nde',
        'pvsol': 'PVSol Export',
        'weather': 'Wetterdaten',
        'load_profile': 'Lastprofile',
        'solar_radiation': 'Einstrahlung',
        'water_level': 'Pegelst√§nde',
        'pvsol_export': 'PVSol Export'
    };
    return dataTypeNames[dataType] || dataType;
}

// Importierte Daten anzeigen
function viewImportedData() {
    window.location.href = '/preview_data';
}

// Weitere Daten importieren
function importMoreData() {
    // Datenvorschau zur√ºcksetzen
    const previewContainer = document.getElementById('dataPreview');
    previewContainer.innerHTML = '';
    
    // Import-Button verstecken
    document.getElementById('importButton').style.display = 'none';
    
    // Datei-Inputs zur√ºcksetzen
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => input.value = '');
    
    showNotification('‚úÖ Bereit f√ºr neuen Import!', 'success');
}

// Import-Daten l√∂schen
function clearImportData() {
    const previewContainer = document.getElementById('dataPreview');
    previewContainer.innerHTML = '';
    
    // Import-Button verstecken
    document.getElementById('importButton').style.display = 'none';
    
    // Datei-Inputs zur√ºcksetzen
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => input.value = '');
    
    showNotification('üóëÔ∏è Import-Daten gel√∂scht', 'info');
}
</script>

<style>
.tab-button.active {
    @apply border-blue-500 text-blue-600;
}
</style>
{% endblock %} 