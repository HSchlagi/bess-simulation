{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-lg mb-6">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-leaf text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Carbon Credits Dashboard</h1>
                    <p class="text-orange-100">CO‚ÇÇ-Zertifikate Handel und Monetarisierung</p>
                </div>
            </div>
            <div class="text-right">
                <div id="currentDateTime" class="text-sm"></div>
                <div class="mt-2">
                    <select id="projectSelect" style="min-width: 250px; z-index: 1000;">
                        <option value="">Projekt ausw√§hlen...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm">Verf√ºgbare Credits</p>
                    <p class="text-2xl font-bold" id="availableCredits">0</p>
                </div>
                <i class="fas fa-certificate text-2xl text-orange-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm">Verkaufte Credits</p>
                    <p class="text-2xl font-bold" id="soldCredits">0</p>
                </div>
                <i class="fas fa-handshake text-2xl text-green-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm">Umsatz</p>
                    <p class="text-2xl font-bold" id="revenue">0 ‚Ç¨</p>
                </div>
                <i class="fas fa-euro-sign text-2xl text-blue-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-600 to-violet-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm">Durchschnittspreis</p>
                    <p class="text-2xl font-bold" id="avgPrice">0 ‚Ç¨</p>
                    <p class="text-xs text-purple-200" id="marketStatus">Markt: -</p>
                </div>
                <i class="fas fa-chart-line text-2xl text-purple-200"></i>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8 border-b border-gray-200">
            <button id="creditsTab" onclick="switchTab('credits')" class="tab-button active py-2 px-1 border-b-2 border-orange-500 text-sm font-medium text-orange-600">
                <i class="fas fa-certificate mr-2"></i>Credits
            </button>
            <button id="tradingTab" onclick="switchTab('trading')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-exchange-alt mr-2"></i>Handel
            </button>
            <button id="marketTab" onclick="switchTab('market')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-chart-line mr-2"></i>Markt
            </button>
            <button id="reportsTab" onclick="switchTab('reports')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-file-alt mr-2"></i>Berichte
            </button>
        </nav>
    </div>

    <!-- Credits Tab Content -->
    <div id="creditsContent" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Credits Verteilung</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="creditsChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Preisentwicklung</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Tab Content -->
    <div id="tradingContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Carbon Credits Handel</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-orange-50 rounded-lg">
                        <span class="font-medium">Verf√ºgbare Credits</span>
                        <span class="text-orange-600 font-bold" id="availableCreditsValue">0</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                        <span class="font-medium">Verkaufte Credits</span>
                        <span class="text-green-600 font-bold" id="soldCreditsValue">0</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                        <span class="font-medium">Aktueller Preis</span>
                        <span class="text-blue-600 font-bold" id="currentPriceValue">45 ‚Ç¨</span>
                    </div>
                    <button onclick="openSellCreditsModal()" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-handshake mr-2"></i>Credits verkaufen
                    </button>
                    <button onclick="openGenerateCreditsModal()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 transform hover:scale-105 mt-2">
                        <i class="fas fa-plus mr-2"></i>Credits generieren
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Handelshistorie</h3>
                <div style="height: 300px; position: relative; background-color: #f8f9fa;">
                    <canvas id="tradingHistoryChart" width="400" height="300" style="display: block !important; width: 400px !important; height: 300px !important; position: absolute !important; top: 0 !important; left: 0 !important;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Tab Content -->
    <div id="marketContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Marktpreis-Trend</h3>
                <div style="height: 300px; position: relative; background-color: #f8f9fa;">
                    <canvas id="marketTrendChart" width="400" height="300" style="display: block !important; width: 400px !important; height: 300px !important; position: absolute !important; top: 0 !important; left: 0 !important;"></canvas>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Markt-√úbersicht</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>Durchschnittspreis</span>
                        <span class="font-bold text-orange-600" id="avgPriceValue">45 ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>Marktvolumen</span>
                        <span class="font-bold text-blue-600" id="marketVolume">0</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>Marktstatus</span>
                        <span class="font-bold text-green-600" id="marketStatusValue">Aktiv</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>Umsatz gesamt</span>
                        <span class="font-bold text-purple-600" id="totalRevenueValue">0 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab Content -->
    <div id="reportsContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Carbon Credits Berichte</h3>
                <div class="space-y-3">
                    <button onclick="downloadReport('credits-report', 'pdf')" class="w-full text-left p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors duration-200">
                        <i class="fas fa-file-pdf mr-2 text-red-600"></i>September 2025 - Credits Report
                    </button>
                    <button onclick="downloadReport('trading-analysis', 'excel')" class="w-full text-left p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors duration-200">
                        <i class="fas fa-file-excel mr-2 text-green-600"></i>August 2025 - Trading Analyse
                    </button>
                    <button onclick="downloadReport('market-report', 'pdf')" class="w-full text-left p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors duration-200">
                        <i class="fas fa-file-pdf mr-2 text-red-600"></i>Juli 2025 - Marktbericht
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Berichte generieren</h3>
                <div class="space-y-4">
                    <button onclick="generateReport('credits-pdf')" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-download mr-2"></i>Credits Report PDF
                    </button>
                    <button onclick="generateReport('excel-export')" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-table mr-2"></i>Excel Export
                    </button>
                    <button onclick="generateReport('market-dashboard')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-chart-bar mr-2"></i>Markt Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Credits verkaufen Modal -->
<div id="sellCreditsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Credits verkaufen</h3>
            <button onclick="closeSellCreditsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="sellCreditsForm" onsubmit="window.sellCredits(event); return false;">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Credits</label>
                <input type="number" id="creditsToSell" step="1" min="1" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                       placeholder="0" required>
                <p class="text-xs text-gray-500 mt-1">Verf√ºgbar: <span id="availableCreditsDisplay">0</span> Credits</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preis pro Credit (‚Ç¨)</label>
                <input type="number" id="pricePerCredit" step="0.01" min="0" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                       placeholder="45.00" value="45" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                <input type="date" id="sellDate" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                       required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Notizen (optional)</label>
                <textarea id="sellNotes" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                          placeholder="Zus√§tzliche Informationen zum Verkauf..."></textarea>
            </div>
            <div class="mb-4 p-3 bg-orange-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">Gesamtbetrag:</span>
                    <span class="text-lg font-bold text-orange-600" id="totalSellValue">0.00 ‚Ç¨</span>
                </div>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeSellCreditsModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    Abbrechen
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-handshake mr-2"></i>Verkaufen
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Credits generieren Modal -->
<div id="generateCreditsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-900">Credits generieren</h3>
            <button onclick="closeGenerateCreditsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="generateCreditsForm" onsubmit="window.generateCredits(event); return false;">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Anzahl Credits</label>
                <input type="number" id="creditsToGenerate" step="1" min="1" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       placeholder="0" required>
                <p class="text-xs text-gray-500 mt-1">1 Credit = 1 Tonne CO‚ÇÇ-Einsparung</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">CO‚ÇÇ-Reduktion (kg)</label>
                <input type="number" id="co2ReductionKg" step="0.01" min="0" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       placeholder="0.00" required>
                <p class="text-xs text-gray-500 mt-1">Wird automatisch berechnet (Credits √ó 1000)</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                <input type="date" id="generateDate" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                       required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Notizen (optional)</label>
                <textarea id="generateNotes" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                          placeholder="Zus√§tzliche Informationen zur Generierung..."></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeGenerateCreditsModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                    Abbrechen
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Generieren
                </button>
            </div>
        </form>
    </div>
</div>

<script>
console.log('üöÄ Carbon Credits Dashboard Script startet...');

// Globale Variablen - M√úSSEN GLOBAL SEIN f√ºr alle Funktionen!
var currentProjectId = null;
var creditsChart = null;
var priceChart = null;
var tradingHistoryChart = null;
var marketTrendChart = null;

// Zus√§tzlich als window-Property f√ºr maximale Kompatibilit√§t
window.currentProjectId = currentProjectId;

// Datum/Zeit aktualisieren
function updateDateTime() {
    const now = new Date();
    const options = {
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit'
    };
    const dateTimeElement = document.getElementById('currentDateTime');
    if (dateTimeElement) {
        dateTimeElement.textContent = now.toLocaleDateString('de-DE', options);
    }
}

updateDateTime();
setInterval(updateDateTime, 1000);

// Tab Navigation
function switchTab(tabName) {
    console.log('üîÑ Wechsle zu Tab:', tabName);
    
    try {
        // Alle Tabs verstecken
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Alle Tab-Buttons deaktivieren
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active', 'border-orange-500', 'text-orange-600');
            button.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Gew√§hlten Tab anzeigen
        const contentElement = document.getElementById(tabName + 'Content');
        const tabButton = document.getElementById(tabName + 'Tab');
        
        if (!contentElement) {
            console.error('‚ùå Tab-Content nicht gefunden:', tabName + 'Content');
            return;
        }
        
        if (!tabButton) {
            console.error('‚ùå Tab-Button nicht gefunden:', tabName + 'Tab');
            return;
        }
        
        contentElement.classList.remove('hidden');
        tabButton.classList.add('active', 'border-orange-500', 'text-orange-600');
        tabButton.classList.remove('border-transparent', 'text-gray-500');
        
        console.log('‚úÖ Tab erfolgreich gewechselt zu:', tabName);
        
        // Market Trend Chart aktualisieren wenn Market Tab aktiviert wird
        if (tabName === 'market') {
            console.log('üîÑ Aktualisiere Market Trend Chart beim Tab-Wechsel...');
            
            // Warte kurz, damit das Tab-Element sichtbar ist
            setTimeout(() => {
                const canvas = document.getElementById('marketTrendChart');
                if (!canvas) {
                    console.error('‚ùå marketTrendChart Canvas nicht gefunden!');
                    setTimeout(() => {
                        const retryCanvas = document.getElementById('marketTrendChart');
                        if (retryCanvas) {
                            console.log('‚úÖ Canvas beim zweiten Versuch gefunden');
                            if (typeof window.createMarketTrendChartForMarketTab === 'function') {
                                window.createMarketTrendChartForMarketTab();
                            } else if (typeof createMarketTrendChartForMarketTab === 'function') {
                                createMarketTrendChartForMarketTab();
                            }
                        }
                    }, 200);
                    return;
                }
                
                if (typeof window.createMarketTrendChartForMarketTab === 'function') {
                    window.createMarketTrendChartForMarketTab();
                } else if (typeof createMarketTrendChartForMarketTab === 'function') {
                    createMarketTrendChartForMarketTab();
                } else {
                    // Fallback: Direkt erstellen
                    const monthlyData = [
                        { month: 'Jan', saved: 95.2 },
                        { month: 'Feb', saved: 108.7 },
                        { month: 'M√§r', saved: 142.3 },
                        { month: 'Apr', saved: 156.8 },
                        { month: 'Mai', saved: 178.9 },
                        { month: 'Jun', saved: 195.6 }
                    ];
                    if (typeof window.createMarketTrendChart === 'function') {
                        window.createMarketTrendChart(monthlyData);
                    }
                }
            }, 150);
        }
        
        // Trading History Chart aktualisieren wenn Handel Tab aktiviert wird
        if (tabName === 'trading') {
            console.log('üîÑ Aktualisiere Trading History Chart beim Tab-Wechsel...');
            
            // Warte kurz, damit das Tab-Element sichtbar ist
            setTimeout(() => {
                // Pr√ºfe ob Tab-Content sichtbar ist
                const tradingContent = document.getElementById('tradingContent');
                const canvas = document.getElementById('tradingHistoryChart');
                
                if (!canvas) {
                    console.error('‚ùå tradingHistoryChart Canvas nicht gefunden!');
                    return;
                }
                
                if (tradingContent && tradingContent.classList.contains('hidden')) {
                    console.warn('‚ö†Ô∏è Trading Content ist noch versteckt, versuche es erneut...');
                    setTimeout(() => {
                        if (typeof updateTradingHistoryChart === 'function') {
                            updateTradingHistoryChart();
                        } else if (typeof createTradingHistoryChartDirectly === 'function') {
                            // Hole Daten aus dem Dashboard
                            const soldCreditsElement = document.getElementById('soldCreditsValue');
                            const soldCredits = soldCreditsElement ? parseInt(soldCreditsElement.textContent.replace(/,/g, '')) || 0 : 0;
                            const monthlyValues = [95.2, 108.7, 142.3, 156.8, 178.9, 195.6];
                            createTradingHistoryChartDirectly(soldCredits, monthlyValues);
                        }
                    }, 200);
                } else {
                    if (typeof updateTradingHistoryChart === 'function') {
                        updateTradingHistoryChart();
                    } else if (typeof createTradingHistoryChartDirectly === 'function') {
                        // Hole Daten aus dem Dashboard
                        const soldCreditsElement = document.getElementById('soldCreditsValue');
                        const soldCredits = soldCreditsElement ? parseInt(soldCreditsElement.textContent.replace(/,/g, '')) || 0 : 0;
                        const monthlyValues = [95.2, 108.7, 142.3, 156.8, 178.9, 195.6];
                        createTradingHistoryChartDirectly(soldCredits, monthlyValues);
                    }
                }
            }, 200);
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Wechseln des Tabs:', error);
    }
}

// Funktion global verf√ºgbar machen
window.switchTab = switchTab;

// Trading History Chart aktualisieren - GLOBALE FUNKTION
function updateTradingHistoryChart() {
    console.log('üìä Aktualisiere Trading History Chart...');
    
    // Echte Daten aus dem Dashboard verwenden
    const availableCreditsElement = document.getElementById('availableCreditsValue');
    const soldCreditsElement = document.getElementById('soldCreditsValue');
    const revenueElement = document.getElementById('revenue');
    
    const availableCredits = availableCreditsElement ? parseInt(availableCreditsElement.textContent.replace(/,/g, '')) || 0 : 0;
    const soldCredits = soldCreditsElement ? parseInt(soldCreditsElement.textContent.replace(/,/g, '')) || 0 : 0;
    const revenue = revenueElement ? parseFloat(revenueElement.textContent.replace(/[‚Ç¨,]/g, '')) || 0 : 0;
    
    const monthlyValues = [95.2, 108.7, 142.3, 156.8, 178.9, 195.6];
    
    console.log('üìä Rufe updateTabCharts auf mit:', { availableCredits, soldCredits, monthlyValues, revenue });
    if (typeof updateTabCharts === 'function') {
        updateTabCharts(availableCredits, soldCredits, monthlyValues, revenue);
        console.log('‚úÖ updateTabCharts aufgerufen - Handelshistorie sollte jetzt sichtbar sein!');
    } else {
        console.warn('‚ö†Ô∏è updateTabCharts Funktion nicht gefunden, erstelle Chart direkt...');
        // Direktes Chart erstellen als Fallback
        createTradingHistoryChartDirectly(soldCredits, monthlyValues);
    }
}

// Trading History Chart direkt erstellen - FALLBACK - GLOBAL VERF√úGBAR
window.createTradingHistoryChartDirectly = function(soldCredits, monthlyValues) {
    console.log('üìä Erstelle Trading History Chart direkt...', { soldCredits, monthlyValues });
    const canvas = document.getElementById('tradingHistoryChart');
    if (!canvas) {
        console.error('‚ùå tradingHistoryChart Canvas nicht gefunden!');
        // Retry nach kurzer Verz√∂gerung
        setTimeout(() => {
            const retryCanvas = document.getElementById('tradingHistoryChart');
            if (retryCanvas) {
                console.log('‚úÖ Canvas beim zweiten Versuch gefunden');
                window.createTradingHistoryChartDirectly(soldCredits, monthlyValues);
            }
        }, 300);
        return;
    }
    
    // Zerst√∂re altes Chart falls vorhanden
    if (typeof tradingHistoryChart !== 'undefined' && tradingHistoryChart) {
        try {
            tradingHistoryChart.destroy();
        } catch (e) {
            console.warn('‚ö†Ô∏è Fehler beim Zerst√∂ren des alten Charts:', e);
        }
        tradingHistoryChart = null;
    }
    
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js ist nicht geladen!');
        return;
    }
    
    const labels = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'];
    const chartData = monthlyValues && monthlyValues.length > 0 
        ? monthlyValues.slice(0, 6).map(value => Math.floor(value * 0.37))
        : [soldCredits || 0, 0, 0, 0, 0, 0];
    
    console.log('üìä Chart-Daten:', { labels, chartData });
    
    try {
        tradingHistoryChart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Verkaufte Credits',
                    data: chartData,
                    backgroundColor: '#10B981',
                    borderColor: '#059669',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: Math.max(10, Math.ceil(Math.max(...chartData, 1) / 10))
                        }
                    }
                }
            }
        });
        console.log('‚úÖ Trading History Chart direkt erstellt!', tradingHistoryChart);
    } catch (error) {
        console.error('‚ùå Fehler beim Erstellen des Trading History Charts:', error);
        console.error('‚ùå Fehler-Stack:', error.stack);
    }
};

// Globale Funktion verf√ºgbar machen
window.updateTradingHistoryChart = updateTradingHistoryChart;
// createTradingHistoryChartDirectly ist bereits als window.createTradingHistoryChartDirectly definiert

// Alias f√ºr Kompatibilit√§t
function createTradingHistoryChartDirectly(soldCredits, monthlyValues) {
    return window.createTradingHistoryChartDirectly(soldCredits, monthlyValues);
}

// Market Trend Chart erstellen/aktualisieren - GLOBALE FUNKTION
// Market Trend Chart - GLOBAL VERF√úGBAR
window.updateMarketTrendChart = function(monthlyData) {
    window.createMarketTrendChart(monthlyData);
};

window.createMarketTrendChart = function(monthlyData) {
    console.log('üé® createMarketTrendChart aufgerufen');
    
    const canvas = document.getElementById('marketTrendChart');
    console.log('üîç Market Trend Canvas gefunden:', canvas);
    
    if (!canvas) {
        console.error('‚ùå Market Trend Canvas nicht gefunden!');
        // Versuche es nochmal nach kurzer Verz√∂gerung
        setTimeout(() => {
            const retryCanvas = document.getElementById('marketTrendChart');
            if (retryCanvas) {
                console.log('‚úÖ Canvas beim zweiten Versuch gefunden');
                window.createMarketTrendChart(monthlyData);
            } else {
                console.error('‚ùå Canvas auch beim zweiten Versuch nicht gefunden');
            }
        }, 200);
        return;
    }
    
    const ctx = canvas.getContext('2d');
    console.log('üéØ Market Trend Context:', ctx);
    
    if (marketTrendChart) {
        console.log('üóëÔ∏è Zerst√∂re altes Market Trend Chart');
        marketTrendChart.destroy();
    }
    
    // Demo-Daten f√ºr Marktpreis-Trend (‚Ç¨ pro t CO2)
    const marketPrices = [42, 44, 45, 47, 46, 45];
    const labels = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'];
    
    try {
        marketTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Marktpreis (‚Ç¨/t CO‚ÇÇ)',
                    data: marketPrices,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 35,
                        max: 50,
                        ticks: {
                            callback: function(value) {
                                return value + ' ‚Ç¨';
                            }
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Market Trend Chart erstellt:', marketTrendChart);
    } catch (error) {
        console.error('‚ùå Fehler beim Erstellen des Market Trend Charts:', error);
    }
};

// Market Trend Chart (Alias f√ºr globale Funktionen)
function updateMarketTrendChart(monthlyData) {
    return window.updateMarketTrendChart(monthlyData);
}

function createMarketTrendChart(monthlyData) {
    return window.createMarketTrendChart(monthlyData);
}

// Hilfsfunktion zum Erstellen des Market Trend Charts f√ºr den Markt-Tab
function createMarketTrendChartForMarketTab() {
    console.log('üìä Erstelle Market Trend Chart f√ºr Markt-Tab...');
    const monthlyData = [
        { month: 'Jan', saved: 95.2 },
        { month: 'Feb', saved: 108.7 },
        { month: 'M√§r', saved: 142.3 },
        { month: 'Apr', saved: 156.8 },
        { month: 'Mai', saved: 178.9 },
        { month: 'Jun', saved: 195.6 }
    ];
    
    if (typeof window.createMarketTrendChart === 'function') {
        window.createMarketTrendChart(monthlyData);
        console.log('‚úÖ Market Trend Chart erstellt');
    } else if (typeof window.updateMarketTrendChart === 'function') {
        window.updateMarketTrendChart(monthlyData);
        console.log('‚úÖ Market Trend Chart aktualisiert');
    } else {
        console.warn('‚ö†Ô∏è Keine Market Trend Chart Funktion gefunden');
    }
}

// Globale Funktion verf√ºgbar machen
window.createMarketTrendChartForMarketTab = createMarketTrendChartForMarketTab;

// Projekte laden - KOPIERT VOM ERFOLGREICHEN CLIMATE IMPACT DASHBOARD
async function loadProjects() {
    try {
        console.log('üîÑ Lade Projekte...');
        const response = await fetch('/climate/api/climate/projects');
        const data = await response.json();
        
        console.log('üìä API Response:', data);
        
        if (data.success && data.projects) {
            const select = document.getElementById('projectSelect');
            console.log('üîç Dropdown-Element gefunden:', select);
            
            if (!select) {
                console.error('‚ùå Dropdown-Element nicht gefunden!');
                return;
            }
            
            select.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
            console.log('üßπ Dropdown geleert');
            
            console.log(`üìã F√ºge ${data.projects.length} Projekte hinzu:`);
            data.projects.forEach(project => {
                console.log(`  - ${project.name} (ID: ${project.id})`);
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.location})`;
                select.appendChild(option);
            });
            
            console.log('üîç Dropdown nach Bef√ºllung:', select.innerHTML);
            
            // CSS-Debug: Dropdown sichtbarer machen
            select.style.backgroundColor = 'white';
            select.style.color = 'black';
            select.style.border = '2px solid orange';
            select.style.minHeight = '40px';
            select.style.fontSize = '14px';
            select.style.width = '300px';
            select.style.zIndex = '9999';
            
            // Force re-render
            select.style.display = 'none';
            select.offsetHeight; // Trigger reflow
            select.style.display = 'block';
            
            console.log('üé® Dropdown-Styling angepasst und neu gerendert');
            console.log('üìä Anzahl Optionen im Dropdown:', select.options.length);
            console.log(`‚úÖ ${data.projects.length} Projekte geladen, Dropdown leer gelassen`);
        } else {
            console.error('‚ùå API Response hat keine Projekte:', data);
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Projekte:', error);
    }
}

// Projekt-Daten laden - GLOBAL VERF√úGBAR
window.loadProjectData = async function(projectId) {
    currentProjectId = projectId;
    window.currentProjectId = projectId; // Auch global setzen!
    console.log('Lade Carbon Credits Daten f√ºr Projekt ID:', projectId);
    
    try {
        // Lade Transaktionen von der API
        const transactionsResponse = await fetch(`/climate/api/carbon-credits/transactions/${projectId}`);
        const transactionsData = await transactionsResponse.json();
        
        console.log('üîç Transaktionen API Response:', transactionsData);
        
        let availableCredits = 0;
        let soldCredits = 0;
        let revenue = 0;
        let avgPrice = 45; // Standardpreis
        
        if (transactionsData.success && transactionsData.data) {
            const stats = transactionsData.data.statistics;
            availableCredits = stats.available || 0;
            soldCredits = stats.sold || 0;
            revenue = stats.revenue || 0;
            
            // Durchschnittspreis berechnen
            if (soldCredits > 0) {
                avgPrice = Math.round(revenue / soldCredits);
            }
            
            console.log('üí∞ Echte Werte aus Datenbank:', { availableCredits, soldCredits, revenue, avgPrice });
        } else {
            // Fallback: CO2-Daten verwenden wenn keine Transaktionen vorhanden
            console.log('‚ö†Ô∏è Keine Transaktionen gefunden, verwende CO2-Daten als Fallback');
            const response = await fetch(`/climate/api/climate/co2-data/${projectId}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                const co2Data = data.data;
                const totalCredits = Math.floor(co2Data.total_co2_saved * 0.37);
                soldCredits = Math.floor(totalCredits * 0.6);
                availableCredits = totalCredits - soldCredits;
                revenue = Math.floor(soldCredits * 45);
                avgPrice = soldCredits > 0 ? Math.round(revenue / soldCredits) : 45;
            }
        }
        
        const marketStatus = 'Aktiv';
        
        // Charts aktualisieren - WICHTIG: Auch ohne CO2-Daten!
        let monthlyValues = [95.2, 108.7, 142.3, 156.8, 178.9, 195.6]; // Fallback-Daten
        if (transactionsData.success && transactionsData.data) {
            // Wenn wir Transaktionsdaten haben, verwende Demo-Trend
            console.log('üìä Verwende Demo-Trend-Daten f√ºr Charts');
        }
        
        // UI aktualisieren - ALLE Elemente mit Debugging
        console.log('üîÑ Aktualisiere UI-Elemente...');
        
        const availableElement = document.getElementById('availableCredits');
        const soldElement = document.getElementById('soldCredits');
        const revenueElement = document.getElementById('revenue');
        const avgPriceElement = document.getElementById('avgPrice');
        const marketStatusElement = document.getElementById('marketStatus');
        
        if (availableElement) {
            availableElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Available Credits UI aktualisiert:', availableCredits);
        } else {
            console.error('‚ùå availableCredits Element nicht gefunden!');
        }
        
        if (soldElement) {
            soldElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Sold Credits UI aktualisiert:', soldCredits);
        } else {
            console.error('‚ùå soldCredits Element nicht gefunden!');
        }
        
        if (revenueElement) {
            revenueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Revenue UI aktualisiert:', revenue);
        } else {
            console.error('‚ùå revenue Element nicht gefunden!');
        }
        
        if (avgPriceElement) {
            avgPriceElement.textContent = avgPrice + ' ‚Ç¨';
            console.log('‚úÖ Avg Price UI aktualisiert:', avgPrice);
        } else {
            console.error('‚ùå avgPrice Element nicht gefunden!');
        }
        
        if (marketStatusElement) {
            marketStatusElement.textContent = 'Markt: ' + marketStatus;
            console.log('‚úÖ Market Status UI aktualisiert:', marketStatus);
        } else {
            console.error('‚ùå marketStatus Element nicht gefunden!');
        }
        
        // Charts SOFORT aktualisieren - auch ohne CO2-Daten!
        console.log('üìä Aktualisiere Charts mit:', { availableCredits, soldCredits, monthlyValues });
        try {
            updateCharts(availableCredits, soldCredits, monthlyValues);
            console.log('‚úÖ Charts erfolgreich aktualisiert!');
        } catch (error) {
            console.error('‚ùå Fehler beim Aktualisieren der Charts:', error);
        }
        
        // Wenn CO2-Daten vorhanden sind, aktualisiere Charts erneut mit echten Trend-Daten
        const co2Data = transactionsData.success && transactionsData.data ? null : 
            (await fetch(`/climate/api/climate/co2-data/${projectId}`).then(r => r.json()).catch(() => null));
        if (co2Data && co2Data.success && co2Data.data && co2Data.data.monthly_trend) {
            monthlyValues = co2Data.data.monthly_trend.map(item => item.saved || 0);
            console.log('üìä Aktualisiere Charts mit echten CO2-Trend-Daten');
            try {
                updateCharts(availableCredits, soldCredits, monthlyValues);
            } catch (error) {
                console.error('‚ùå Fehler beim Aktualisieren der Charts mit CO2-Daten:', error);
            }
        }
        
        // Tab-Daten aktualisieren
        console.log('üîÑ Aktualisiere Tab-Elemente...');
        
        const availableCreditsValueElement = document.getElementById('availableCreditsValue');
        const soldCreditsValueElement = document.getElementById('soldCreditsValue');
        const avgPriceValueElement = document.getElementById('avgPriceValue');
        const marketStatusValueElement = document.getElementById('marketStatusValue');
        const totalRevenueValueElement = document.getElementById('totalRevenueValue');
        const marketVolumeElement = document.getElementById('marketVolume');
        
        if (availableCreditsValueElement) {
            availableCreditsValueElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Tab Available Credits aktualisiert:', availableCredits);
        }
        
        if (soldCreditsValueElement) {
            soldCreditsValueElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Tab Sold Credits aktualisiert:', soldCredits);
        }
        
        if (avgPriceValueElement) {
            avgPriceValueElement.textContent = avgPrice + ' ‚Ç¨';
            console.log('‚úÖ Tab Avg Price aktualisiert:', avgPrice);
        }
        
        if (marketStatusValueElement) {
            marketStatusValueElement.textContent = marketStatus;
            console.log('‚úÖ Tab Market Status aktualisiert:', marketStatus);
        }
        
        if (totalRevenueValueElement) {
            totalRevenueValueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Tab Revenue aktualisiert:', revenue);
        }
        
        if (marketVolumeElement) {
            marketVolumeElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Tab Market Volume aktualisiert:', soldCredits);
        }
        
        // Zus√§tzliche Charts f√ºr Tabs aktualisieren - INKLUSIVE HANDELSHISTORIE!
        console.log('üìä Rufe updateTabCharts auf mit:', { availableCredits, soldCredits, revenue, monthlyValues });
        try {
            updateTabCharts(availableCredits, soldCredits, monthlyValues, revenue);
            console.log('‚úÖ Tab-Charts (inkl. Handelshistorie) erfolgreich aktualisiert!');
            
            // ZUS√ÑTZLICH: Handelshistorie-Chart IMMER erstellen (auch wenn Tab versteckt ist)
            setTimeout(() => {
                console.log('üìä Erstelle Handelshistorie-Chart nach Datenladen...');
                if (typeof window.createTradingHistoryChartDirectly === 'function') {
                    window.createTradingHistoryChartDirectly(soldCredits, monthlyValues);
                } else if (typeof createTradingHistoryChartDirectly === 'function') {
                    createTradingHistoryChartDirectly(soldCredits, monthlyValues);
                }
            }, 300);
            
            // ZUS√ÑTZLICH: Marktpreis-Trend-Chart erstellen, falls Markt-Tab sichtbar ist
            setTimeout(() => {
                const marketContent = document.getElementById('marketContent');
                if (marketContent && !marketContent.classList.contains('hidden')) {
                    console.log('üìä Markt-Tab ist sichtbar, erstelle Marktpreis-Trend-Chart...');
                    const monthlyData = [
                        { month: 'Jan', saved: 95.2 },
                        { month: 'Feb', saved: 108.7 },
                        { month: 'M√§r', saved: 142.3 },
                        { month: 'Apr', saved: 156.8 },
                        { month: 'Mai', saved: 178.9 },
                        { month: 'Jun', saved: 195.6 }
                    ];
                    if (typeof window.createMarketTrendChart === 'function') {
                        window.createMarketTrendChart(monthlyData);
                    }
                }
            }, 400);
        } catch (error) {
            console.error('‚ùå Fehler beim Aktualisieren der Tab-Charts:', error);
        }
        
        // Zus√§tzliche UI-Elemente aktualisieren
        console.log('üîÑ Aktualisiere zus√§tzliche UI-Elemente...');
        
        // Verf√ºgbare Credits in der Hauptansicht aktualisieren
        const mainAvailableElement = document.getElementById('availableCredits');
        if (mainAvailableElement) {
            mainAvailableElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Main Available Credits aktualisiert:', availableCredits);
        }
        
        // Verkaufte Credits in der Hauptansicht aktualisieren
        const mainSoldElement = document.getElementById('soldCredits');
        if (mainSoldElement) {
            mainSoldElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Main Sold Credits aktualisiert:', soldCredits);
        }
        
        // Umsatz in der Hauptansicht aktualisieren
        const mainRevenueElement = document.getElementById('revenue');
        if (mainRevenueElement) {
            mainRevenueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Main Revenue aktualisiert:', revenue);
        }
        
        console.log('‚úÖ Carbon Credits Daten geladen:', {
            availableCredits,
            soldCredits,
            revenue,
            avgPrice
        });
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Projekt-Daten:', error);
        console.log('üîÑ Lade Demo-Daten als Fallback...');
        if (typeof loadDemoData === 'function') {
            loadDemoData();
        } else if (typeof window.loadDemoData === 'function') {
            window.loadDemoData();
        } else {
            console.error('‚ùå loadDemoData Funktion nicht gefunden!');
        }
    }
};

// Alias f√ºr Kompatibilit√§t - WICHTIG: Auch global verf√ºgbar machen!
async function loadProjectData(projectId) {
    if (typeof window.loadProjectData === 'function') {
        return window.loadProjectData(projectId);
    } else {
        console.error('‚ùå window.loadProjectData ist nicht verf√ºgbar!');
        throw new Error('loadProjectData Funktion nicht verf√ºgbar');
    }
}

// Zus√§tzlich sicherstellen, dass die Funktion global verf√ºgbar ist
if (typeof window.loadProjectData === 'undefined') {
    console.error('‚ùå KRITISCH: window.loadProjectData wurde nicht definiert!');
} else {
    console.log('‚úÖ window.loadProjectData ist verf√ºgbar');
}

// Intelligente Chart-Cleanup-Funktion
function destroyAllCharts() {
    try {
        if (typeof creditsChart !== 'undefined' && creditsChart) {
            creditsChart.destroy();
            creditsChart = null;
        }
        if (typeof priceChart !== 'undefined' && priceChart) {
            priceChart.destroy();
            priceChart = null;
        }
        if (typeof historyChart !== 'undefined' && historyChart) {
            historyChart.destroy();
            historyChart = null;
        }
        console.log('‚úÖ Alle Charts erfolgreich zerst√∂rt');
    } catch (error) {
        console.error('‚ùå Fehler beim Zerst√∂ren der Charts:', error);
    }
}

// Charts aktualisieren - GLOBAL VERF√úGBAR
window.updateCharts = function(availableCredits, soldCredits, monthlyTrend) {
    console.log('üìä updateCharts aufgerufen mit:', { availableCredits, soldCredits, monthlyTrendLength: monthlyTrend?.length });
    
    // Pr√ºfe ob Chart.js geladen ist
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js ist nicht geladen!');
        return;
    }
    
    // Alle Charts vorher zerst√∂ren
    destroyAllCharts();
    
    // Credits Chart
    const creditsCanvas = document.getElementById('creditsChart');
    if (!creditsCanvas) {
        console.error('‚ùå creditsChart Canvas nicht gefunden!');
        return;
    }
    
    if (creditsChart) creditsChart.destroy();
    const creditsCtx = creditsCanvas.getContext('2d');
    creditsChart = new Chart(creditsCtx, {
        type: 'doughnut',
        data: {
            labels: ['Verf√ºgbar', 'Verkauft'],
            datasets: [{
                data: [availableCredits, soldCredits],
                backgroundColor: ['#F59E0B', '#10B981'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
    
    // Price Chart
    const priceCanvas = document.getElementById('priceChart');
    if (!priceCanvas) {
        console.error('‚ùå priceChart Canvas nicht gefunden!');
        return;
    }
    
    if (priceChart) priceChart.destroy();
    const priceCtx = priceCanvas.getContext('2d');
    const labels = monthlyTrend && monthlyTrend.length > 0 
        ? monthlyTrend.map((_, index) => `Monat ${index + 1}`)
        : ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'];
    const trendData = monthlyTrend && monthlyTrend.length > 0 
        ? monthlyTrend.map(() => 45 + Math.random() * 10 - 5)
        : [42, 44, 45, 47, 46, 45];
    priceChart = new Chart(priceCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Credit Preis (‚Ç¨)',
                data: trendData,
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: 35,
                    max: 55,
                    ticks: {
                        stepSize: 5
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    console.log('‚úÖ Charts erfolgreich erstellt!');
};

// Charts aktualisieren (Alias f√ºr globale Funktion)
function updateCharts(availableCredits, soldCredits, monthlyTrend) {
    return window.updateCharts(availableCredits, soldCredits, monthlyTrend);
}

// Tab-Charts aktualisieren
function updateTabCharts(availableCredits, soldCredits, monthlyValues, revenue) {
    console.log('üîÑ updateTabCharts aufgerufen mit:', { availableCredits, soldCredits, revenue });
    
    // UI-Elemente aktualisieren
    try {
        const availableElement = document.getElementById('availableCreditsValue');
        const soldElement = document.getElementById('soldCreditsValue');
        const revenueElement = document.getElementById('totalRevenueValue');
        
        if (availableElement) {
            availableElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Available Credits aktualisiert:', availableCredits);
        }
        
        if (soldElement) {
            soldElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Sold Credits aktualisiert:', soldCredits);
        }
        
        if (revenueElement) {
            revenueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Revenue aktualisiert:', revenue);
        }
        
        // Zus√§tzliche UI-Elemente aktualisieren
        const marketVolumeElement = document.getElementById('marketVolume');
        if (marketVolumeElement) {
            marketVolumeElement.textContent = soldCredits.toLocaleString();
        }
        
        // Durchschnittspreis aktualisieren
        const avgPriceElement = document.getElementById('avgPriceValue');
        if (avgPriceElement && soldCredits > 0) {
            const avgPrice = Math.round(revenue / soldCredits);
            avgPriceElement.textContent = avgPrice.toLocaleString() + ' ‚Ç¨';
        }
        
        // Verf√ºgbare Credits in der Hauptansicht aktualisieren
        const mainAvailableElement = document.getElementById('availableCredits');
        if (mainAvailableElement) {
            mainAvailableElement.textContent = availableCredits.toLocaleString();
        }
        
        // Verkaufte Credits in der Hauptansicht aktualisieren
        const mainSoldElement = document.getElementById('soldCredits');
        if (mainSoldElement) {
            mainSoldElement.textContent = soldCredits.toLocaleString();
        }
        
        // Umsatz in der Hauptansicht aktualisieren
        const mainRevenueElement = document.getElementById('revenue');
        if (mainRevenueElement) {
            mainRevenueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
        }
        
    } catch (error) {
        console.error('‚ùå Fehler beim Aktualisieren der UI-Elemente:', error);
    }
    
    // Trading History Chart - HANDELSHISTORIE ERSTELLEN - IMMER ERSTELLEN!
    console.log('üìä Erstelle Trading History Chart...', { soldCredits, monthlyValues });
    
    // Zerst√∂re altes Chart
    if (tradingHistoryChart) {
        try {
            tradingHistoryChart.destroy();
        } catch (e) {
            console.warn('‚ö†Ô∏è Fehler beim Zerst√∂ren des alten Charts:', e);
        }
        tradingHistoryChart = null;
    }
    
    // Warte kurz, damit das Canvas-Element verf√ºgbar ist (auch wenn Tab versteckt ist)
    setTimeout(() => {
        const tradingHistoryCtx = document.getElementById('tradingHistoryChart');
        if (!tradingHistoryCtx) {
            console.error('‚ùå tradingHistoryChart Canvas nicht gefunden!');
            // Retry nach l√§ngerer Verz√∂gerung
            setTimeout(() => {
                const retryCtx = document.getElementById('tradingHistoryChart');
                if (retryCtx) {
                    console.log('‚úÖ Canvas beim zweiten Versuch gefunden');
                    createTradingHistoryChartNow(soldCredits, monthlyValues);
                } else {
                    console.error('‚ùå Canvas auch beim zweiten Versuch nicht gefunden');
                }
            }, 500);
            return;
        }
        
        createTradingHistoryChartNow(soldCredits, monthlyValues);
    }, 100);
}

// Hilfsfunktion zum Erstellen des Trading History Charts
function createTradingHistoryChartNow(soldCredits, monthlyValues) {
    const tradingHistoryCtx = document.getElementById('tradingHistoryChart');
    if (!tradingHistoryCtx) {
        console.error('‚ùå tradingHistoryChart Canvas nicht gefunden in createTradingHistoryChartNow!');
        return;
    }
    
    try {
        // Chart.js pr√ºfen
        if (typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js ist nicht geladen!');
            return;
        }
        
        // Daten f√ºr Handelshistorie vorbereiten
        const labels = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'];
        const chartData = monthlyValues && monthlyValues.length > 0 
            ? monthlyValues.slice(0, 6).map(value => Math.floor(value * 0.37))
            : [soldCredits || 0, 0, 0, 0, 0, 0]; // Fallback wenn keine monthlyValues
        
        console.log('üìä Handelshistorie Daten:', { labels, chartData, soldCredits });
        
        tradingHistoryChart = new Chart(tradingHistoryCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Verkaufte Credits',
                    data: chartData,
                    backgroundColor: '#10B981',
                    borderColor: '#059669',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: Math.max(10, Math.ceil(Math.max(...chartData, 1) / 10))
                        }
                    }
                }
            }
        });
        console.log('‚úÖ Trading History Chart erfolgreich erstellt!', tradingHistoryChart);
    } catch (error) {
        console.error('‚ùå Fehler beim Erstellen des Trading History Charts:', error);
        console.error('‚ùå Fehler-Stack:', error.stack);
    }
}

// Market Trend Chart wird separat erstellt (nicht hier)

// Event Listeners - KOPIERT VOM ERFOLGREICHEN CLIMATE IMPACT DASHBOARD
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM Content Loaded');
    
    // Projekte laden
    loadProjects();
    
    // Projekt-Auswahl - WICHTIG: Pr√ºfe beim Laden, ob bereits ein Projekt ausgew√§hlt ist!
    const projectSelectElement = document.getElementById('projectSelect');
    if (projectSelectElement) {
        // Beim Laden: Pr√ºfe ob bereits ein Projekt ausgew√§hlt ist
        const initialValue = projectSelectElement.value;
        if (initialValue) {
            const initialProjectId = parseInt(initialValue);
            window.currentProjectId = initialProjectId;
            if (typeof currentProjectId !== 'undefined') {
                currentProjectId = initialProjectId;
            }
            console.log('‚úÖ Initiales Projekt gefunden:', initialProjectId);
            // Lade Daten f√ºr das initiale Projekt
            if (typeof loadProjectData === 'function') {
                loadProjectData(initialProjectId);
            }
        }
        
        // Event-Listener f√ºr √Ñnderungen (wird vom zweiten Script-Block behandelt, daher hier entfernt)
        // Der zweite Script-Block hat bereits einen Event-Listener
    }
    
    console.log('‚úÖ Event Listeners registriert');
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verwende die globale currentProjectId Variable
    // let currentProjectId = 1; // ENTFERNT - verwende globale Variable
    let co2TrendChart = null;
    let creditsChart = null;

    // Aktuelle Zeit anzeigen
    function updateDateTime() {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit'
        };
        document.getElementById('currentDateTime').textContent = now.toLocaleDateString('de-DE', options);
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Projekte laden
    async function loadProjects() {
        try {
            console.log('üîÑ Lade Projekte...');
            const response = await fetch('/climate/api/climate/projects');
            const data = await response.json();
            
            console.log('üìä API Response:', data);
            
            if (data.success && data.projects) {
                const select = document.getElementById('projectSelect');
                console.log('üîç Dropdown-Element gefunden:', select);
                
                if (!select) {
                    console.error('‚ùå Dropdown-Element nicht gefunden!');
                    return;
                }
                
                select.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
                console.log('üßπ Dropdown geleert');
                
                console.log(`üìã F√ºge ${data.projects.length} Projekte hinzu:`);
                data.projects.forEach(project => {
                    console.log(`  - ${project.name} (ID: ${project.id})`);
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (${project.location})`;
                    select.appendChild(option);
                });
                
                console.log('üîç Dropdown nach Bef√ºllung:', select.innerHTML);
                
                // CSS-Debug: Dropdown sichtbarer machen
                select.style.backgroundColor = 'white';
                select.style.color = 'black';
                select.style.border = '2px solid blue';
                select.style.minHeight = '40px';
                select.style.fontSize = '14px';
                select.style.width = '300px';
                select.style.zIndex = '9999';
                
                // Force re-render
                select.style.display = 'none';
                select.offsetHeight; // Trigger reflow
                select.style.display = 'block';
                
                console.log('üé® Dropdown-Styling angepasst und neu gerendert');
                console.log('üìä Anzahl Optionen im Dropdown:', select.options.length);
                console.log(`‚úÖ ${data.projects.length} Projekte geladen, Dropdown leer gelassen`);
            } else {
                console.error('‚ùå API Response hat keine Projekte:', data);
                if (typeof window.loadDemoData === 'function') {
                    window.loadDemoData();
                } else {
                    console.error('‚ùå window.loadDemoData ist keine Funktion!');
                }
            }
        } catch (error) {
            console.error('‚ùå Fehler beim Laden der Projekte:', error);
            loadDemoData();
        }
    }

    // CO2-Daten laden
    async function loadCO2Data(projectId) {
        try {
            const response = await fetch(`/climate/api/climate/co2-data/${projectId}`);
            const result = await response.json();
            
            if (result.success) {
                updateCO2Metrics(result.data);
                updateCO2TrendChart(result.data.monthly_trend);
                updateCarbonCreditsChart(result.data);
            } else {
                console.error('API-Fehler:', result.error);
                if (typeof window.loadDemoData === 'function') {
                    window.loadDemoData();
                } else {
                    console.error('‚ùå window.loadDemoData ist keine Funktion!');
                }
            }
        } catch (error) {
            console.error('Fehler beim Laden der CO2-Daten:', error);
            loadDemoData();
        }
    }

    // Demo-Daten als Fallback - GLOBALE FUNKTION
    function loadDemoData() {
        console.log('üöÄ loadDemoData() Funktion aufgerufen!');
        console.log('üîÑ Lade Demo-Daten...');
        console.log('üîç loadDemoData ist definiert:', typeof loadDemoData);
        const data = {
            total_co2_saved: 1161.3,
            total_co2_emitted: 89.2,
            net_co2_balance: 1072.1,
            monthly_trend: [
                { month: 'Jan', saved: 95.2, emitted: 7.1 },
                { month: 'Feb', saved: 108.7, emitted: 8.3 },
                { month: 'M√§r', saved: 142.3, emitted: 9.8 },
                { month: 'Apr', saved: 156.8, emitted: 11.2 },
                { month: 'Mai', saved: 178.9, emitted: 12.4 },
                { month: 'Jun', saved: 195.6, emitted: 13.7 },
                { month: 'Jul', saved: 201.3, emitted: 14.2 },
                { month: 'Aug', saved: 189.4, emitted: 13.9 },
                { month: 'Sep', saved: 175.2, emitted: 12.8 },
                { month: 'Okt', saved: 158.7, emitted: 11.5 },
                { month: 'Nov', saved: 132.4, emitted: 9.8 },
                { month: 'Dez', saved: 112.9, emitted: 8.4 }
            ]
        };
        
        console.log('üìä Demo-Daten geladen:', data);
        
        // Berechnungen basierend auf Demo-Daten
        const totalCredits = Math.floor(data.total_co2_saved * 0.37); // 0.37 Credits pro kg CO2
        const soldCredits = Math.floor(totalCredits * 0.6); // 60% verkauft
        const availableCredits = totalCredits - soldCredits;
        const revenue = Math.floor(soldCredits * 45); // 45‚Ç¨ pro Credit
        const avgPrice = Math.round(revenue / soldCredits); // Dynamisch berechnet
        console.log('üí∞ Demo-Durchschnittspreis berechnet:', { revenue, soldCredits, avgPrice });
        const marketStatus = 'Aktiv';
        
        console.log('üí∞ Demo-Werte berechnet:', { totalCredits, soldCredits, availableCredits, revenue });
        
        // UI aktualisieren - ALLE Elemente mit Debugging
        console.log('üîÑ Aktualisiere UI-Elemente mit Demo-Daten...');
        
        const availableElement = document.getElementById('availableCredits');
        const soldElement = document.getElementById('soldCredits');
        const revenueElement = document.getElementById('revenue');
        const avgPriceElement = document.getElementById('avgPrice');
        const marketStatusElement = document.getElementById('marketStatus');
        
        if (availableElement) {
            availableElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Demo Available Credits UI aktualisiert:', availableCredits);
        }
        
        if (soldElement) {
            soldElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Demo Sold Credits UI aktualisiert:', soldCredits);
        }
        
        if (revenueElement) {
            revenueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Demo Revenue UI aktualisiert:', revenue);
        }
        
        if (avgPriceElement) {
            avgPriceElement.textContent = avgPrice + ' ‚Ç¨';
            console.log('‚úÖ Demo Avg Price UI aktualisiert:', avgPrice);
        }
        
        if (marketStatusElement) {
            marketStatusElement.textContent = 'Markt: ' + marketStatus;
            console.log('‚úÖ Demo Market Status UI aktualisiert:', marketStatus);
        }
        
        // Tab-Daten aktualisieren
        console.log('üîÑ Aktualisiere Tab-Elemente mit Demo-Daten...');
        
        const availableCreditsValueElement = document.getElementById('availableCreditsValue');
        const soldCreditsValueElement = document.getElementById('soldCreditsValue');
        const avgPriceValueElement = document.getElementById('avgPriceValue');
        const marketStatusValueElement = document.getElementById('marketStatusValue');
        const totalRevenueValueElement = document.getElementById('totalRevenueValue');
        const marketVolumeElement = document.getElementById('marketVolume');
        
        if (availableCreditsValueElement) {
            availableCreditsValueElement.textContent = availableCredits.toLocaleString();
            console.log('‚úÖ Demo Tab Available Credits aktualisiert:', availableCredits);
        }
        
        if (soldCreditsValueElement) {
            soldCreditsValueElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Demo Tab Sold Credits aktualisiert:', soldCredits);
        }
        
        if (avgPriceValueElement) {
            avgPriceValueElement.textContent = avgPrice + ' ‚Ç¨';
            console.log('‚úÖ Demo Tab Avg Price aktualisiert:', avgPrice);
        }
        
        if (marketStatusValueElement) {
            marketStatusValueElement.textContent = marketStatus;
            console.log('‚úÖ Demo Tab Market Status aktualisiert:', marketStatus);
        }
        
        if (totalRevenueValueElement) {
            totalRevenueValueElement.textContent = revenue.toLocaleString() + ' ‚Ç¨';
            console.log('‚úÖ Demo Tab Revenue aktualisiert:', revenue);
        }
        
        if (marketVolumeElement) {
            marketVolumeElement.textContent = soldCredits.toLocaleString();
            console.log('‚úÖ Demo Tab Market Volume aktualisiert:', soldCredits);
        }
        
        // Charts aktualisieren
        const monthlyValues = data.monthly_trend.map(item => item.saved || 0);
        updateCharts(availableCredits, soldCredits, monthlyValues);
        updateTabCharts(availableCredits, soldCredits, monthlyValues, revenue);
        
        console.log('‚úÖ Demo-Daten erfolgreich geladen und UI aktualisiert!');
    };

    // CO2-Metriken aktualisieren
    function updateCO2Metrics(data) {
        const availableCredits = Math.floor(data.total_co2_saved * 0.37);
        const soldCredits = Math.floor(availableCredits * 0.42);
        const revenue = Math.floor(soldCredits * 45); // 45‚Ç¨ pro Credit
        const avgPrice = 45;
        
        document.getElementById('availableCredits').textContent = availableCredits;
        document.getElementById('soldCredits').textContent = soldCredits;
        document.getElementById('revenue').textContent = revenue.toLocaleString() + ' ‚Ç¨';
        document.getElementById('avgPrice').textContent = avgPrice + ' ‚Ç¨';
        
        document.getElementById('availableCreditsValue').textContent = availableCredits;
        document.getElementById('soldCreditsValue').textContent = soldCredits;
    }

    // CO2-Trend Chart aktualisieren
    function updateCO2TrendChart(monthlyData) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (co2TrendChart) {
            co2TrendChart.destroy();
        }
        
        co2TrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyData.map(d => d.month),
                datasets: [{
                    label: 'CO‚ÇÇ-Einsparungen (kg)',
                    data: monthlyData.map(d => d.saved),
                    borderColor: '#8B5CF6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'CO‚ÇÇ-Einsparungen (kg)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Monate'
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                }
            }
        });
    }

    // Carbon Credits Chart aktualisieren
    function updateCarbonCreditsChart(data) {
        const ctx = document.getElementById('creditsChart').getContext('2d');
        
        if (creditsChart) {
            creditsChart.destroy();
        }
        
        const totalCredits = Math.floor(data.total_co2_saved * 0.37);
        const soldCredits = Math.floor(totalCredits * 0.42);
        const availableCredits = totalCredits - soldCredits;
        
        creditsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Generiert', 'Verkauft', 'Verf√ºgbar'],
                datasets: [{
                    data: [totalCredits, soldCredits, availableCredits],
                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }


    // Event-Listener f√ºr Projektauswahl - VEREINHEITLICHT
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect) {
        // Entferne alle alten Event-Listener (falls vorhanden)
        const newProjectSelect = projectSelect.cloneNode(true);
        projectSelect.parentNode.replaceChild(newProjectSelect, projectSelect);
        
        newProjectSelect.addEventListener('change', function(e) {
            console.log('üîÑ Projekt ausgew√§hlt:', e.target.value);
            const selectedProjectId = e.target.value;
            if (selectedProjectId) {
                const projectId = parseInt(selectedProjectId);
                // IMMER window.currentProjectId setzen - OHNE Pr√ºfung!
                window.currentProjectId = projectId;
                // Auch lokale Variable setzen falls verf√ºgbar
                if (typeof currentProjectId !== 'undefined') {
                    currentProjectId = projectId;
                }
                console.log(`‚úÖ currentProjectId gesetzt: ${projectId} (window.currentProjectId: ${window.currentProjectId})`);
                // Verwende loadProjectData statt loadCO2Data
                if (typeof window.loadProjectData === 'function') {
                    window.loadProjectData(projectId);
                } else if (typeof loadProjectData === 'function') {
                    loadProjectData(projectId);
                } else if (typeof loadCO2Data === 'function') {
                    loadCO2Data(projectId);
                }
            } else {
                console.log('‚ùå Kein Projekt ausgew√§hlt');
                if (typeof loadDemoData === 'function') {
                    loadDemoData();
                }
            }
        });
    }

    // Credits generieren Funktion - wird durch Modal ersetzt
    // Die Funktion wird jetzt √ºber das Modal aufgerufen

    // Initialisierung
    loadProjects();
    
    // Sicherstellen, dass switchTab global verf√ºgbar ist
    if (typeof window.switchTab === 'function') {
        console.log('‚úÖ switchTab Funktion ist global verf√ºgbar');
    } else {
        console.warn('‚ö†Ô∏è switchTab Funktion nicht global verf√ºgbar, setze sie...');
        window.switchTab = function(tabName) {
            console.log('üîÑ Wechsle zu Tab (aus DOMContentLoaded):', tabName);
            // Alle Tabs verstecken
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // Alle Tab-Buttons deaktivieren
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-orange-500', 'text-orange-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            // Gew√§hlten Tab anzeigen
            const contentElement = document.getElementById(tabName + 'Content');
            const tabButton = document.getElementById(tabName + 'Tab');
            if (contentElement) contentElement.classList.remove('hidden');
            if (tabButton) {
                tabButton.classList.add('active', 'border-orange-500', 'text-orange-600');
                tabButton.classList.remove('border-transparent', 'text-gray-500');
            }
        };
    }
    
    console.log('‚úÖ Event Listeners registriert');
});

// Berichtswesen Funktionen f√ºr Carbon Credits Dashboard
async function downloadReport(reportType, format) {
    console.log(`üìÑ Lade Carbon Credits Bericht herunter: ${reportType} (${format})`);
    
    showReportNotification(`Bericht wird heruntergeladen...`, 'info');
    
    try {
        if (format === 'pdf') {
            // Echte PDF mit jsPDF erstellen
            await generateCarbonCreditsPDF(reportType);
            showReportNotification('PDF-Bericht erfolgreich heruntergeladen!', 'success');
        } else {
            // CSV oder andere Formate
            const fileExtension = 'csv';
            const fileName = `carbon-credits-${reportType}-${new Date().toISOString().split('T')[0]}.${fileExtension}`;
            const content = generateCarbonCreditsReportContent(reportType, format);
            
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showReportNotification(`${fileName} erfolgreich heruntergeladen!`, 'success');
        }
    } catch (error) {
        console.error('Download Fehler:', error);
        showReportNotification('Download fehlgeschlagen: ' + error.message, 'error');
    }
}

async function generateReport(reportType) {
    console.log(`üìä Generiere Carbon Credits Bericht: ${reportType}`);
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generiere...';
    button.classList.add('opacity-75', 'cursor-not-allowed');
    
    try {
        const fileName = generateCarbonCreditsFileName(reportType);
        
        // Pr√ºfe ob es ein Excel-Export ist
        if (fileName.endsWith('.xlsx')) {
            // Excel-Datei √ºber Server-API erstellen
            const availableCredits = document.getElementById('availableCredits').textContent;
            const soldCredits = document.getElementById('soldCredits').textContent;
            const revenue = document.getElementById('revenue').textContent;
            const avgPrice = document.getElementById('avgPrice').textContent;
            
            const data = {
                availableCredits: availableCredits,
                soldCredits: soldCredits,
                revenue: revenue,
                avgPrice: avgPrice
            };
            
            const response = await fetch('/climate/api/carbon-credits/export-excel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                // Excel-Datei direkt als Blob herunterladen
                const excelBlob = await response.blob();
                const url = window.URL.createObjectURL(excelBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `carbon_credits_${new Date().toISOString().slice(0,10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showReportNotification('Excel-Bericht erfolgreich erstellt!', 'success');
            } else {
                throw new Error('Server-Export fehlgeschlagen');
            }
        } else if (fileName.endsWith('.txt') || reportType === 'credits-pdf' || reportType === 'market-dashboard') {
            // PDF mit jsPDF erstellen
            await generateCarbonCreditsPDF(reportType);
            showReportNotification('PDF-Bericht erfolgreich generiert!', 'success');
        } else {
            // Fallback f√ºr andere Formate
            const content = generateCarbonCreditsReportContent(reportType, 'pdf');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showReportNotification(`${fileName} erfolgreich generiert!`, 'success');
        }
    } catch (error) {
        console.error('Export Fehler:', error);
        showReportNotification('Export fehlgeschlagen: ' + error.message, 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
    }
}

// Echte PDF mit jsPDF erstellen
async function generateCarbonCreditsPDF(reportType) {
    try {
        // jsPDF laden
        let jsPDF;
        if (typeof window.jspdf !== 'undefined') {
            jsPDF = window.jspdf.jsPDF;
        } else {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    setTimeout(() => {
                        if (typeof window.jspdf !== 'undefined') {
                            jsPDF = window.jspdf.jsPDF;
                            resolve();
                        } else {
                            reject(new Error('jsPDF konnte nicht geladen werden'));
                        }
                    }, 500);
                };
                script.onerror = () => reject(new Error('jsPDF CDN nicht erreichbar'));
                document.head.appendChild(script);
            });
        }
        
        // Daten sammeln
        const currentDate = new Date().toLocaleDateString('de-DE');
        const availableCredits = document.getElementById('availableCredits') ? document.getElementById('availableCredits').textContent : '0';
        const soldCredits = document.getElementById('soldCredits') ? document.getElementById('soldCredits').textContent : '0';
        const revenue = document.getElementById('revenue') ? document.getElementById('revenue').textContent : '0 ‚Ç¨';
        const avgPrice = document.getElementById('avgPrice') ? document.getElementById('avgPrice').textContent : '0 ‚Ç¨';
        
        // PDF erstellen
        const pdf = new jsPDF('portrait', 'mm', 'a4');
        
        // Titel
        pdf.setFontSize(20);
        pdf.setFont(undefined, 'bold');
        pdf.setTextColor(245, 158, 11); // Orange
        pdf.text('CARBON CREDITS DASHBOARD BERICHT', 20, 30);
        
        // Untertitel basierend auf Report-Typ
        pdf.setFontSize(14);
        pdf.setTextColor(0, 0, 0);
        let reportTitle = 'Credits Report';
        if (reportType === 'market-dashboard') {
            reportTitle = 'Markt Dashboard Report';
        } else if (reportType === 'credits-report') {
            reportTitle = 'Credits Report';
        } else if (reportType === 'trading-analyse') {
            reportTitle = 'Trading Analyse';
        }
        pdf.text(reportTitle, 20, 40);
        
        // Datum
        pdf.setFontSize(10);
        pdf.setTextColor(100, 100, 100);
        pdf.text('Generiert am: ' + currentDate, 20, 50);
        
        // Linie
        pdf.setDrawColor(245, 158, 11);
        pdf.setLineWidth(0.5);
        pdf.line(20, 55, 190, 55);
        
        // Zusammenfassung
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.setTextColor(0, 0, 0);
        pdf.text('ZUSAMMENFASSUNG', 20, 70);
        
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'normal');
        let yPos = 80;
        pdf.text('Verf√ºgbare Credits: ' + availableCredits, 20, yPos);
        yPos += 10;
        pdf.text('Verkaufte Credits: ' + soldCredits, 20, yPos);
        yPos += 10;
        pdf.text('Umsatz: ' + revenue, 20, yPos);
        yPos += 10;
        pdf.text('Durchschnittspreis: ' + avgPrice, 20, yPos);
        
        // Footer
        const pageHeight = pdf.internal.pageSize.height;
        pdf.setFontSize(9);
        pdf.setTextColor(150, 150, 150);
        pdf.text('¬© 2025 BESS Simulation - Entwickelt f√ºr professionelle Energiespeicher-Simulationen', 20, pageHeight - 20);
        pdf.text('Kontakt: office@instanet.at', 20, pageHeight - 15);
        
        // PDF speichern
        const fileName = `carbon-credits-${reportType}-${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);
        
    } catch (error) {
        console.error('PDF-Generierung Fehler:', error);
        throw new Error('PDF konnte nicht generiert werden: ' + error.message);
    }
}

function generateCarbonCreditsReportContent(reportType, format) {
    const currentDate = new Date().toLocaleDateString('de-DE');
    const availableCredits = document.getElementById('availableCredits').textContent;
    const soldCredits = document.getElementById('soldCredits').textContent;
    const revenue = document.getElementById('revenue').textContent;
    const avgPrice = document.getElementById('avgPrice').textContent;
    
    let content = '';
    
    if (format === 'pdf') {
        // Erstelle einfachen Text-Content f√ºr PDF (wird als Text-PDF erkannt)
        content = `CARBON CREDITS DASHBOARD BERICHT
=================================

Generiert am: ${currentDate}

ZUSAMMENFASSUNG:
---------------
Verf√ºgbare Credits: ${availableCredits}
Verkaufte Credits: ${soldCredits}
Umsatz: ${revenue}
Durchschnittspreis: ${avgPrice}

DETAILANALYSE:
--------------
Dieser Bericht wurde automatisch vom BESS Simulation System generiert.
Alle Daten basieren auf den aktuellen Carbon Credits Metriken und werden kontinuierlich aktualisiert.

Kontakt: office@instanet.at
¬© 2025 BESS Simulation - Entwickelt f√ºr professionelle Energiespeicher-Simulationen`;
    } else {
        // Excel-Content mit UTF-8 BOM f√ºr korrekte Zeichenkodierung
        content = `\uFEFFDatum,Verf√ºgbare_Credits,Verkaufte_Credits,Umsatz,Durchschnittspreis\n${currentDate},${availableCredits},${soldCredits},${revenue},${avgPrice}`;
    }
    
    return content;
}

function generateCarbonCreditsFileName(reportType) {
    const date = new Date().toISOString().split('T')[0];
    const typeMap = {
        'credits-pdf': `carbon-credits-${date}.txt`,
        'excel-export': `carbon-credits-daten-${date}.xlsx`,
        'market-dashboard': `carbon-credits-markt-${date}.txt`
    };
    return typeMap[reportType] || `carbon-credits-${date}.txt`;
}

function showReportNotification(message, type) {
    const colors = {
        'info': 'bg-blue-500',
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500'
    };
    
    const icons = {
        'info': 'fa-info-circle',
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle'
    };
    
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icons[type]} mr-2"></i>
            <div class="font-semibold">${message}</div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Modal Funktionen f√ºr Credits verkaufen
async function openSellCreditsModal() {
    console.log('üìù √ñffne Modal f√ºr Credits verkaufen');
    const modal = document.getElementById('sellCreditsModal');
    if (modal) {
        modal.classList.remove('hidden');
        // Aktuelles Datum als Standard setzen
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('sellDate');
        if (dateInput) {
            dateInput.value = today;
        }
        
        // Verf√ºgbare Credits AUS DER DATENBANK holen - nicht aus dem Dashboard!
        let projectId = window.currentProjectId || (typeof currentProjectId !== 'undefined' ? currentProjectId : null);
        if (!projectId) {
            const projectSelect = document.getElementById('projectSelect');
            if (projectSelect && projectSelect.value) {
                projectId = parseInt(projectSelect.value);
            }
        }
        
        let availableCredits = 0;
        if (projectId) {
            try {
                console.log('üìä Lade verf√ºgbare Credits von der API f√ºr Projekt:', projectId);
                const response = await fetch(`/climate/api/carbon-credits/transactions/${projectId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.statistics) {
                    availableCredits = data.data.statistics.available || 0;
                    console.log('‚úÖ Verf√ºgbare Credits aus API:', availableCredits);
                } else {
                    // Fallback: Dashboard-Wert verwenden
                    availableCredits = parseInt(document.getElementById('availableCreditsValue').textContent.replace(/,/g, '')) || 0;
                    console.warn('‚ö†Ô∏è API-Fehler, verwende Dashboard-Wert:', availableCredits);
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der verf√ºgbaren Credits:', error);
                // Fallback: Dashboard-Wert verwenden
                availableCredits = parseInt(document.getElementById('availableCreditsValue').textContent.replace(/,/g, '')) || 0;
            }
        } else {
            // Fallback: Dashboard-Wert verwenden
            availableCredits = parseInt(document.getElementById('availableCreditsValue').textContent.replace(/,/g, '')) || 0;
        }
        
        document.getElementById('availableCreditsDisplay').textContent = availableCredits.toLocaleString();
        console.log('üìä Verf√ºgbare Credits im Modal angezeigt:', availableCredits);
        
        // Gesamtbetrag berechnen
        updateSellTotal();
    }
}

function closeSellCreditsModal() {
    console.log('‚ùå Schlie√üe Modal f√ºr Credits verkaufen');
    const modal = document.getElementById('sellCreditsModal');
    if (modal) {
        modal.classList.add('hidden');
        const form = document.getElementById('sellCreditsForm');
        if (form) {
            form.reset();
        }
    }
}

function updateSellTotal() {
    const credits = parseInt(document.getElementById('creditsToSell').value) || 0;
    const price = parseFloat(document.getElementById('pricePerCredit').value) || 0;
    const total = credits * price;
    document.getElementById('totalSellValue').textContent = total.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‚Ç¨';
}

// Event Listener f√ºr Gesamtbetrag-Berechnung
document.addEventListener('DOMContentLoaded', function() {
    const creditsInput = document.getElementById('creditsToSell');
    const priceInput = document.getElementById('pricePerCredit');
    if (creditsInput) {
        creditsInput.addEventListener('input', updateSellTotal);
    }
    if (priceInput) {
        priceInput.addEventListener('input', updateSellTotal);
    }
});

// Credits verkaufen Funktion mit API - GLOBAL VERF√úGBAR
window.sellCredits = async function(event) {
    event.preventDefault();
    console.log('üíæ Verkaufe Credits...');
    
    // Pr√ºfe ob Projekt ausgew√§hlt ist - Pr√ºfe auch das Dropdown direkt!
    let projectId = window.currentProjectId || (typeof currentProjectId !== 'undefined' ? currentProjectId : null);
    
    // FALLBACK: Pr√ºfe das Dropdown direkt, falls window.currentProjectId nicht gesetzt ist
    if (!projectId) {
        const projectSelect = document.getElementById('projectSelect');
        if (projectSelect && projectSelect.value) {
            projectId = parseInt(projectSelect.value);
            window.currentProjectId = projectId; // Jetzt setzen!
            console.log('‚ö†Ô∏è Projekt-ID aus Dropdown gelesen:', projectId);
        }
    }
    
    console.log('üîç Aktuelles Projekt ID:', projectId, '(window.currentProjectId:', window.currentProjectId, ')');
    if (!projectId) {
        showReportNotification('Bitte w√§hlen Sie zuerst ein Projekt aus!', 'error');
        return false;
    }
    
    const creditsToSell = parseInt(document.getElementById('creditsToSell').value);
    const pricePerCredit = parseFloat(document.getElementById('pricePerCredit').value);
    const sellDate = document.getElementById('sellDate').value;
    const notes = document.getElementById('sellNotes').value;
    
    // Verf√ºgbare Credits aus dem Modal-Text holen (ist aktuell!)
    const availableCreditsText = document.getElementById('availableCreditsDisplay').textContent.replace(/,/g, '');
    const availableCredits = parseInt(availableCreditsText) || 0;
    
    if (!creditsToSell || creditsToSell <= 0) {
        showReportNotification('Bitte geben Sie eine g√ºltige Anzahl Credits ein!', 'error');
        return false;
    }
    if (creditsToSell > availableCredits) {
        showReportNotification(`Nicht gen√ºgend Credits verf√ºgbar! Verf√ºgbar: ${availableCredits.toLocaleString()}, Angefragt: ${creditsToSell}`, 'error');
        return false;
    }
    if (!pricePerCredit || pricePerCredit <= 0) {
        showReportNotification('Bitte geben Sie einen g√ºltigen Preis ein!', 'error');
        return false;
    }
    if (!sellDate) {
        showReportNotification('Bitte w√§hlen Sie ein Datum!', 'error');
        return false;
    }
    
    // Submit-Button deaktivieren
    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton ? submitButton.innerHTML : '';
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verkaufe...';
    }
    
    try {
        const requestData = {
            project_id: projectId,
            credits: creditsToSell,
            price_per_credit: pricePerCredit,
            date: sellDate,
            notes: notes || ''
        };
        
        console.log('üì§ Sende Verkaufsanfrage:', requestData);
        
        const response = await fetch('/climate/api/carbon-credits/sell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('üì• Response Status:', response.status, response.statusText);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå HTTP Fehler:', response.status, errorText);
            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.error || errorMessage;
            } catch (e) {
                // Fehler-Text ist kein JSON
            }
            showReportNotification('Fehler beim Verkauf: ' + errorMessage, 'error');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
            return false;
        }
        
        const result = await response.json();
        console.log('üì• Server-Antwort:', result);
        
        if (result.success) {
            const totalValue = creditsToSell * pricePerCredit;
            showReportNotification(
                `${creditsToSell} Credits erfolgreich f√ºr ${totalValue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨ verkauft!`, 
                'success'
            );
            
            setTimeout(() => {
                closeSellCreditsModal();
                // Dashboard-Daten aktualisieren - WICHTIG: Direkt aufrufen, nicht pr√ºfen!
                if (projectId) {
                    console.log('üîÑ Aktualisiere Dashboard-Daten nach Verkauf...');
                    // Versuche window.loadProjectData direkt aufzurufen
                    try {
                        if (window.loadProjectData) {
                            window.loadProjectData(projectId);
                        } else {
                            // Fallback: Seite neu laden
                            console.warn('‚ö†Ô∏è loadProjectData nicht verf√ºgbar, lade Seite neu...');
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('‚ùå Fehler beim Aktualisieren der Daten:', error);
                        // Fallback: Seite neu laden
                        window.location.reload();
                    }
                }
            }, 1500);
            return true;
        } else {
            const errorMessage = result.error || 'Unbekannter Fehler';
            console.error('‚ùå Verkaufsfehler:', errorMessage);
            showReportNotification('Fehler beim Verkauf: ' + errorMessage, 'error');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
            return false;
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Verkauf der Credits:', error);
        console.error('‚ùå Fehler-Stack:', error.stack);
        showReportNotification('Fehler beim Verkauf der Credits: ' + (error.message || String(error)), 'error');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
        return false;
    }
};

// Credits verkaufen Funktion (Alias f√ºr globale Funktion)
async function sellCredits(event) {
    return window.sellCredits(event);
}

// Modal Funktionen f√ºr Credits generieren
function openGenerateCreditsModal() {
    console.log('üìù √ñffne Modal f√ºr Credits generieren');
    const modal = document.getElementById('generateCreditsModal');
    if (modal) {
        modal.classList.remove('hidden');
        // Aktuelles Datum als Standard setzen
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('generateDate');
        if (dateInput) {
            dateInput.value = today;
        }
        // CO2-Reduktion automatisch berechnen
        const creditsInput = document.getElementById('creditsToGenerate');
        const co2Input = document.getElementById('co2ReductionKg');
        if (creditsInput && co2Input) {
            creditsInput.addEventListener('input', function() {
                const credits = parseInt(this.value) || 0;
                co2Input.value = (credits * 1000).toFixed(2);
            });
        }
    }
}

function closeGenerateCreditsModal() {
    console.log('‚ùå Schlie√üe Modal f√ºr Credits generieren');
    const modal = document.getElementById('generateCreditsModal');
    if (modal) {
        modal.classList.add('hidden');
        const form = document.getElementById('generateCreditsForm');
        if (form) {
            form.reset();
        }
    }
}

// Credits generieren Funktion mit API - GLOBAL VERF√úGBAR
window.generateCredits = async function(event) {
    event.preventDefault();
    console.log('üíæ Generiere Credits...');
    
    // Pr√ºfe ob Projekt ausgew√§hlt ist - Pr√ºfe auch das Dropdown direkt!
    let projectId = window.currentProjectId || (typeof currentProjectId !== 'undefined' ? currentProjectId : null);
    
    // FALLBACK: Pr√ºfe das Dropdown direkt, falls window.currentProjectId nicht gesetzt ist
    if (!projectId) {
        const projectSelect = document.getElementById('projectSelect');
        if (projectSelect && projectSelect.value) {
            projectId = parseInt(projectSelect.value);
            window.currentProjectId = projectId; // Jetzt setzen!
            console.log('‚ö†Ô∏è Projekt-ID aus Dropdown gelesen:', projectId);
        }
    }
    
    console.log('üîç Aktuelles Projekt ID:', projectId, '(window.currentProjectId:', window.currentProjectId, ')');
    if (!projectId) {
        showReportNotification('Bitte w√§hlen Sie zuerst ein Projekt aus!', 'error');
        return false;
    }
    
    const creditsToGenerate = parseInt(document.getElementById('creditsToGenerate').value);
    const co2ReductionKg = parseFloat(document.getElementById('co2ReductionKg').value);
    const generateDate = document.getElementById('generateDate').value;
    const notes = document.getElementById('generateNotes').value;
    
    if (!creditsToGenerate || creditsToGenerate <= 0) {
        showReportNotification('Bitte geben Sie eine g√ºltige Anzahl Credits ein!', 'error');
        return;
    }
    if (!co2ReductionKg || co2ReductionKg <= 0) {
        showReportNotification('Bitte geben Sie eine g√ºltige CO‚ÇÇ-Reduktion ein!', 'error');
        return;
    }
    if (!generateDate) {
        showReportNotification('Bitte w√§hlen Sie ein Datum!', 'error');
        return;
    }
    
    // Submit-Button deaktivieren
    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton ? submitButton.innerHTML : '';
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generiere...';
    }
    
    try {
        console.log('üì§ Sende Generierungsanfrage:', {
            project_id: projectId,
            credits: creditsToGenerate,
            co2_reduction_kg: co2ReductionKg,
            date: generateDate
        });
        
        const response = await fetch('/climate/api/carbon-credits/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                credits: creditsToGenerate,
                co2_reduction_kg: co2ReductionKg,
                date: generateDate,
                notes: notes || ''
            })
        });
        
        const result = await response.json();
        console.log('üì• Server-Antwort:', result);
        
        if (result.success) {
            showReportNotification(
                `${creditsToGenerate} Credits erfolgreich generiert!`, 
                'success'
            );
            
            setTimeout(() => {
                closeGenerateCreditsModal();
                // Dashboard-Daten aktualisieren - WICHTIG: Direkt aufrufen, nicht pr√ºfen!
                if (projectId) {
                    console.log('üîÑ Aktualisiere Dashboard-Daten nach Generierung...');
                    // Versuche window.loadProjectData direkt aufzurufen
                    try {
                        if (window.loadProjectData) {
                            window.loadProjectData(projectId);
                        } else {
                            // Fallback: Seite neu laden
                            console.warn('‚ö†Ô∏è loadProjectData nicht verf√ºgbar, lade Seite neu...');
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('‚ùå Fehler beim Aktualisieren der Daten:', error);
                        // Fallback: Seite neu laden
                        window.location.reload();
                    }
                }
            }, 1500);
        } else {
            const errorMessage = result.error || 'Unbekannter Fehler';
            console.error('‚ùå Generierungsfehler:', errorMessage);
            showReportNotification('Fehler beim Generieren: ' + errorMessage, 'error');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Generieren der Credits:', error);
        showReportNotification('Fehler beim Generieren der Credits: ' + error.message, 'error');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    }
};

// Credits generieren Funktion (Alias f√ºr globale Funktion)
async function generateCredits(event) {
    return window.generateCredits(event);
}

// Globale showNotification Funktion - vereinfacht
function showNotification(message, type) {
    alert(message);
}

// Modal schlie√üen bei Klick au√üerhalb
document.addEventListener('DOMContentLoaded', function() {
    const sellModal = document.getElementById('sellCreditsModal');
    const generateModal = document.getElementById('generateCreditsModal');
    
    if (sellModal) {
        sellModal.addEventListener('click', function(e) {
            if (e.target === sellModal) {
                closeSellCreditsModal();
            }
        });
    }
    
    if (generateModal) {
        generateModal.addEventListener('click', function(e) {
            if (e.target === generateModal) {
                closeGenerateCreditsModal();
            }
        });
    }
});
</script>
{% endblock %}