{% extends "base.html" %}

{% block title %}aWattar API Integration - BESS Simulation{% endblock %}

{% block extra_css %}
<style>
    .price-chart {
        height: 300px;
        width: 100% !important;
    }
    .status-card {
        transition: transform 0.2s ease-in-out;
    }
    .status-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="awattarIntegration()">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">aWattar API Integration</h1>
                <p class="mt-2 text-lg text-gray-600">Österreichische Strompreise in Echtzeit</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="px-4 py-2 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                    Live Integration
                </span>
            </div>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- API Status -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">API Verbindung</p>
                    <p class="text-lg font-semibold text-gray-900" x-text="status.api_connection || 'OK'"></p>
                </div>
            </div>
        </div>

        <!-- Database Records -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-database text-blue-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Datenbank Records</p>
                    <p class="text-lg font-semibold text-gray-900" x-text="status.database_records || '0'"></p>
                </div>
            </div>
        </div>

        <!-- Last 24h -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Letzte 24h</p>
                    <p class="text-lg font-semibold text-gray-900" x-text="status.last_24h || '0'"></p>
                </div>
            </div>
        </div>

        <!-- Latest Price -->
        <div class="bg-white rounded-lg shadow p-6 status-card">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-euro-sign text-purple-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Neuester Preis</p>
                    <p class="text-lg font-semibold text-gray-900" x-text="status.latest_price || 'N/A'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Section -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">aWattar-Daten importieren</h2>
            <p class="text-sm text-gray-500 mt-1">Holen Sie aktuelle österreichische Strompreise von der aWattar API</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Startdatum</label>
                    <input type="date" x-model="importForm.startDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enddatum</label>
                    <input type="date" x-model="importForm.endDate" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button @click="importData()" 
                        :disabled="loading"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-download mr-2"></i>
                    <span x-text="loading ? 'Importiere...' : 'Daten importieren'"></span>
                </button>
                
                <button @click="testIntegration()" 
                        :disabled="loading"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>
                    Integration testen
                </button>
                
                <button @click="refreshStatus()" 
                        class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Status aktualisieren
                </button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div x-show="importResult" class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Import-Ergebnis</h2>
        </div>
        <div class="p-6">
            <div x-show="importResult && importResult.success" class="bg-green-50 border border-green-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Import erfolgreich</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <p x-text="importResult.message"></p>
                            <div x-show="importResult.data" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <span class="font-medium">Gespeichert:</span>
                                    <span x-text="importResult.data.saved_count || 0"></span>
                                </div>
                                <div>
                                    <span class="font-medium">Übersprungen:</span>
                                    <span x-text="importResult.data.skipped_count || 0"></span>
                                </div>
                                <div>
                                    <span class="font-medium">Fehler:</span>
                                    <span x-text="importResult.data.error_count || 0"></span>
                                </div>
                                <div>
                                    <span class="font-medium">Verarbeitet:</span>
                                    <span x-text="importResult.data.total_processed || 0"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div x-show="importResult && !importResult.success" class="bg-red-50 border border-red-200 rounded-md p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Import fehlgeschlagen</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p x-text="importResult.error"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Chart -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Preisverlauf (letzte 24 Stunden)</h2>
            <p class="text-sm text-gray-500 mt-1">Österreichische Strompreise von aWattar</p>
        </div>
        <div class="p-6">
            <div class="price-chart">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
function awattarIntegration() {
    return {
        loading: false,
        importResult: null,
        status: {
            api_connection: 'OK',
            database_records: '0',
            last_24h: '0',
            latest_price: 'N/A'
        },
        importForm: {
            startDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            endDate: new Date().toISOString().split('T')[0]
        },

        async init() {
            await this.refreshStatus();
            await this.loadPriceChart();
        },

        async refreshStatus() {
            try {
                console.log('Refreshing status...');
                const response = await fetch('/api/awattar/status');
                console.log('Status response:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Status data:', data);
                    
                    if (data.success) {
                        this.status = data.status;
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden des Status:', error);
            }
        },

        async importData() {
            this.loading = true;
            this.importResult = null;
            
            try {
                // Fallback-Daten wenn keine eingegeben - letzte 7 Tage
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const startDate = this.importForm.startDate || weekAgo.toISOString().split('T')[0];
                const endDate = this.importForm.endDate || today.toISOString().split('T')[0];
                
                console.log('Starting import with dates:', startDate, 'to', endDate);
                
                const response = await fetch('/api/awattar/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_date: startDate + 'T00:00:00Z',
                        end_date: endDate + 'T23:59:59Z'
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                this.importResult = data;
                
                if (data.success) {
                    await this.refreshStatus();
                    await this.loadPriceChart();
                }
            } catch (error) {
                console.error('Import error:', error);
                this.importResult = {
                    success: false,
                    error: 'Fehler beim Importieren: ' + error.message
                };
            } finally {
                this.loading = false;
            }
        },

        async testIntegration() {
            this.loading = true;
            
            try {
                console.log('Starting integration test...');
                
                const response = await fetch('/api/awattar/test');
                
                console.log('Test response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Test HTTP Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Test response data:', data);
                
                if (data.success) {
                    this.importResult = {
                        success: true,
                        message: data.message,
                        data: data.test_results
                    };
                } else {
                    this.importResult = {
                        success: false,
                        error: data.error
                    };
                }
            } catch (error) {
                console.error('Test error:', error);
                this.importResult = {
                    success: false,
                    error: 'Test fehlgeschlagen: ' + error.message
                };
            } finally {
                this.loading = false;
            }
        },

        async loadPriceChart() {
            try {
                const response = await fetch('/api/awattar/latest?hours=24');
                const data = await response.json();
                
                if (data.success && data.prices && data.prices.length > 0) {
                    this.renderChart(data.prices);
                }
            } catch (error) {
                console.error('Fehler beim Laden des Charts:', error);
            }
        },

        renderChart(prices) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Chart löschen falls vorhanden
            if (window.priceChart) {
                window.priceChart.destroy();
            }
            
            window.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: prices.map(p => new Date(p.timestamp).toLocaleTimeString('de-DE', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })),
                    datasets: [{
                        label: 'Strompreis (€/MWh)',
                        data: prices.map(p => p.price_eur_mwh),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Preis (€/MWh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        }
                    }
                }
            });
        }
    }
}
</script>
{% endblock %}
