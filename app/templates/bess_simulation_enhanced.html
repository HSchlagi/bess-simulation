{% extends "base.html" %}

{% block title %}BESS-Simulation Erweitert - Projekt & Use Case Analyse{% endblock %}

{% block content %}
<style>
/* Stufe-Sektionen Aus-/Einklapp-Funktionalität */
.stufe-content {
    max-height: 5000px;
    overflow: visible;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    opacity: 1;
    display: block !important;
}

.stufe-content.collapsed {
    max-height: 0;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-top: 0;
    margin-bottom: 0;
    overflow: hidden;
    display: none;
}

.stufe-content.expanded {
    max-height: 5000px;
    opacity: 1;
    display: block;
    overflow: visible;
}

/* Chevron-Icon Rotation */
.fa-chevron-down {
    transition: transform 0.3s ease;
}

.fa-chevron-down.rotated {
    transform: rotate(180deg);
}
</style>
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">BESS-Simulation Erweitert</h1>
        <p class="text-gray-600">Projektbasierte Analyse mit Use Cases, 10-Jahres-Prognose und Batterie-Degradation</p>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-8">
        <nav class="flex space-x-8 border-b border-gray-200">
            <button id="simulationTab" onclick="switchTab('simulation')" class="tab-button active py-2 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">
                <i class="fas fa-calculator mr-2"></i>Simulation & Use Cases
            </button>
            <button id="dashboardTab" onclick="switchTab('dashboard')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-tachometer-alt mr-2"></i>Enhanced Dashboard
            </button>
        </nav>
    </div>

    <!-- Simulation Tab Content -->
    <div id="simulationContent" class="tab-content">
        <!-- Projekt Auswahl -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projekt Auswahl</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Projekt auswählen:</label>
                <select id="projectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadProjectDetails()">
                    <option value="">Projekt auswählen...</option>
                </select>
            </div>
            
            <!-- Projekt Details -->
            <div id="projectDetails" class="hidden bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-lg text-gray-900 mb-3">Projektdetails</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <span class="text-sm text-gray-600">Name:</span>
                        <div class="font-medium" id="projectName">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Standort:</span>
                        <div class="font-medium" id="projectLocation">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">BESS-Größe:</span>
                        <div class="font-medium" id="projectBessSize">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">BESS-Leistung:</span>
                        <div class="font-medium" id="projectBessPower">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Use Case Auswahl (nur sichtbar wenn Projekt ausgewählt) -->
        <div id="useCaseSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Use Case Auswahl für <span id="projectNameHeader">Projekt</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="useCaseCards">
                    <!-- Use Cases werden dynamisch geladen -->
                    <div class="text-center p-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Lade Use Cases...</p>
                    </div>
                </div>
            </div>

            <!-- Simulation Parameter -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Simulationsparameter</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Use Case</label>
                        <select id="useCaseSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Use Case auswählen...</option>
                            <!-- Use Cases werden dynamisch geladen -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Simulationsjahr</label>
                        <select id="simulationYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Größe (MWh)</label>
                        <input type="number" id="bessSize" value="1.0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Leistung (MW)</label>
                        <input type="number" id="bessPower" value="0.5" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="runSimulation()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Simulation starten
                    </button>
                    <button onclick="run10YearAnalysis()" class="ml-4 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        10-Jahres-Analyse
                    </button>
                </div>
            </div>
        </div>

        <!-- Ergebnisse -->
        <div id="results" class="hidden">
            <!-- Jahresbilanz -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Jahresbilanz</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="annualConsumption">-</div>
                        <div class="text-sm text-gray-600">Verbrauch (MWh/a)</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="annualGeneration">-</div>
                        <div class="text-sm text-gray-600">Erzeugung (MWh/a)</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="annualRevenues">-</div>
                        <div class="text-sm text-gray-600">Erlöse (EUR/a)</div>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="annualCosts">-</div>
                        <div class="text-sm text-gray-600">Kosten (EUR/a)</div>
                    </div>
                </div>
            </div>

            <!-- Wirtschaftlichkeitsmetriken -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Wirtschaftlichkeitsmetriken</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600" id="roiPercent">-</div>
                        <div class="text-sm text-gray-600">ROI (%)</div>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600" id="paybackYears">-</div>
                        <div class="text-sm text-gray-600">Amortisation (Jahre)</div>
                    </div>
                    <div class="text-center p-4 bg-indigo-50 rounded-lg">
                        <div class="text-2xl font-bold text-indigo-600" id="totalInvestment">-</div>
                        <div class="text-sm text-gray-600">Investition (EUR)</div>
                    </div>
                    <div class="text-center p-4 bg-teal-50 rounded-lg">
                        <div class="text-2xl font-bold text-teal-600" id="netCashflow">-</div>
                        <div class="text-sm text-gray-600">Net Cashflow (EUR/a)</div>
                    </div>
                </div>
            </div>

            <!-- STUFE 1: Erweiterte Kennzahlen -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border-2 border-purple-200">
                <div class="flex items-center mb-4 cursor-pointer" onclick="toggleStufeSection('stufe1Section', 'stufe1Icon')">
                    <i class="fas fa-chart-line text-purple-600 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold text-gray-900">Stufe 1 - Erweiterte Kennzahlen</h2>
                    <span class="ml-auto px-3 py-1 bg-purple-600 text-white text-xs font-semibold rounded-full">NEU</span>
                    <i class="fas fa-chevron-down text-purple-600 text-xl ml-3 transition-transform" id="stufe1Icon"></i>
                </div>
                <div id="stufe1Section" class="stufe-content">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <!-- State of Health -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-battery-three-quarters text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="stateOfHealth">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">State of Health (SoH)</div>
                        <div class="text-xs text-gray-500 mt-1">Batterie-Zustand</div>
                    </div>
                    
                    <!-- Aktuelle Kapazität -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-bolt text-blue-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-blue-600" id="currentCapacity">-</div>
                            <span class="text-lg text-gray-500 ml-1">kWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Aktuelle Kapazität</div>
                        <div class="text-xs text-gray-500 mt-1">Nach Degradation</div>
                    </div>
                    
                    <!-- Kapazitätsverlust -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-orange-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-down text-orange-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-orange-600" id="capacityLoss">-</div>
                            <span class="text-lg text-gray-500 ml-1">kWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Kapazitätsverlust</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Alterung</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Erlösverlust durch Restriktionen -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-red-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-red-600" id="revenueLossRestrictions">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Erlösverlust (Restriktionen)</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Netzrestriktionen</div>
                    </div>
                    
                    <!-- Second-Life Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="secondLifeCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-recycle text-gray-600 text-xl mr-2" id="secondLifeIcon"></i>
                            <div class="text-xl font-bold text-gray-600" id="secondLifeStatus">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Second-Life Batterie</div>
                        <div class="text-xs text-gray-500 mt-1" id="secondLifeInfo">-</div>
                    </div>
                    
                    <!-- Kostenvorteil Second-Life -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200" id="secondLifeCostCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-euro-sign text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="secondLifeCostReduction">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Kostenvorteil</div>
                        <div class="text-xs text-gray-500 mt-1">Second-Life Ersparnis</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- STUFE 2.1: Co-Location PV + BESS Kennzahlen -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg shadow-md p-6 mb-8 border-2 border-green-200" id="coLocationSection">
                <div class="flex items-center mb-4 cursor-pointer" onclick="toggleStufeSection('stufe21Section', 'stufe21Icon')">
                    <i class="fas fa-solar-panel text-green-600 text-2xl mr-3"></i>
                    <h2 class="text-xl font-semibold text-gray-900">Stufe 2.1 - Co-Location PV + BESS</h2>
                    <span class="ml-auto px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded-full">NEU</span>
                    <i class="fas fa-chevron-down text-green-600 text-xl ml-3 transition-transform" id="stufe21Icon"></i>
                </div>
                <div id="stufe21Section" class="stufe-content">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Co-Location Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="coLocationStatusCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-link text-gray-600 text-xl mr-2" id="coLocationIcon"></i>
                            <div class="text-xl font-bold text-gray-600" id="coLocationStatus">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Co-Location</div>
                        <div class="text-xs text-gray-500 mt-1" id="coLocationInfo">-</div>
                    </div>
                    
                    <!-- PV-Ausnutzung -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-sun text-blue-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-blue-600" id="pvUtilization">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">PV-Ausnutzung</div>
                        <div class="text-xs text-gray-500 mt-1">Nach Curtailment</div>
                    </div>
                    
                    <!-- Vermiedene Curtailment -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-shield-alt text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="avoidedCurtailment">-</div>
                            <span class="text-lg text-gray-500 ml-1">kW</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Vermiedene Curtailment</div>
                        <div class="text-xs text-gray-500 mt-1">Durch BESS</div>
                    </div>
                    
                    <!-- Eigenverbrauchsquote -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-home text-purple-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-purple-600" id="selfConsumptionRate">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Eigenverbrauchsquote</div>
                        <div class="text-xs text-gray-500 mt-1">Mit Co-Location</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Co-Location Erlöszuwachs -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="coLocationRevenueIncrease">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Erlöszuwachs</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Co-Location</div>
                    </div>
                    
                    <!-- Co-Location Kosteneinsparung -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-piggy-bank text-blue-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-blue-600" id="coLocationCostSavings">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Kosteneinsparung</div>
                        <div class="text-xs text-gray-500 mt-1">Grid-Fee-Ersparnis</div>
                    </div>
                    
                    <!-- Gesamtnutzen -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-emerald-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chart-line text-emerald-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-emerald-600" id="coLocationTotalBenefit">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Gesamtnutzen</div>
                        <div class="text-xs text-gray-500 mt-1">Erlöse + Einsparungen</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- STUFE 2.2: Optimierte Regelstrategien Kennzahlen -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg shadow-md p-6 mb-8 border-2 border-purple-200" id="optimizationSection" style="display: block !important;">
                <div class="flex items-center mb-4">
                    <div class="flex items-center flex-1 cursor-pointer" onclick="toggleStufeSection('stufe22Section', 'stufe22Icon')">
                        <i class="fas fa-brain text-purple-600 text-2xl mr-3"></i>
                        <h2 class="text-xl font-semibold text-gray-900">Stufe 2.2 - Optimierte Regelstrategien</h2>
                    </div>
                    <!-- Optimierung Toggle Switch -->
                    <div class="flex items-center mx-4">
                        <span class="text-sm text-gray-600 mr-2">Optimierung:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="optimizationToggle" class="sr-only peer" onchange="toggleOptimization()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700" id="optimizationToggleLabel">Aktivieren</span>
                        </label>
                    </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 bg-purple-600 text-white text-xs font-semibold rounded-full">NEU</span>
                        <i class="fas fa-chevron-down text-purple-600 text-xl ml-3 transition-transform cursor-pointer" id="stufe22Icon" onclick="toggleStufeSection('stufe22Section', 'stufe22Icon')"></i>
                    </div>
                </div>
                <div id="stufe22Section" class="stufe-content expanded" style="display: block !important;">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Optimierung Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="optimizationStatusCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-cog text-gray-600 text-xl mr-2" id="optimizationIcon"></i>
                            <div class="text-xl font-bold text-gray-600" id="optimizationStatus">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Optimierung</div>
                        <div class="text-xs text-gray-500 mt-1" id="optimizationInfo">-</div>
                    </div>
                    
                    <!-- Strategie -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chess text-blue-600 text-xl mr-2"></i>
                            <div class="text-lg font-bold text-blue-600" id="optimizationStrategy">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Strategie</div>
                        <div class="text-xs text-gray-500 mt-1">Aktive Optimierung</div>
                    </div>
                    
                    <!-- Erlös-Boost -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chart-line text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="optimizationRevenueBoost">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Erlös-Boost</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Optimierung</div>
                    </div>
                    
                    <!-- Preis-Volatilität -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-orange-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-wave-square text-orange-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-orange-600" id="optimizationPriceVolatility">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Preis-Volatilität</div>
                        <div class="text-xs text-gray-500 mt-1">Markt-Schwankungen</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Optimierungs-Benefit -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-euro-sign text-purple-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-purple-600" id="optimizationBenefit">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Optimierungs-Benefit</div>
                        <div class="text-xs text-gray-500 mt-1">Zusätzlicher Erlös/Jahr</div>
                    </div>
                    
                    <!-- Strategie-Details -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-indigo-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-info-circle text-indigo-600 text-xl mr-2"></i>
                            <div class="text-sm font-medium text-indigo-600" id="optimizationDetails">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Strategie-Details</div>
                        <div class="text-xs text-gray-500 mt-1" id="optimizationDescription">-</div>
                    </div>
                </div>
                
                <!-- EXTREMPREIS-SZENARIEN & SPREAD WIDTH -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                    <!-- Spread Width -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrows-alt-h text-blue-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-blue-600" id="spreadWidthEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Spread Width</div>
                        <div class="text-xs text-gray-500 mt-1" id="spreadWidthPercent">-</div>
                    </div>
                    
                    <!-- Negative Preise -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-down text-green-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-green-600" id="negativePriceCount">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Negative Preise</div>
                        <div class="text-xs text-gray-500 mt-1">Voll-Ladungen</div>
                    </div>
                    
                    <!-- Extreme Peaks -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-red-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-red-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-red-600" id="extremePeakCount">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Extreme Peaks</div>
                        <div class="text-xs text-gray-500 mt-1">Voll-Entladungen</div>
                    </div>
                    
                    <!-- Min Preis -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-down text-gray-600 text-lg mr-2"></i>
                            <div class="text-lg font-bold text-gray-700" id="minPriceEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Min Preis</div>
                    </div>
                    
                    <!-- Max Preis -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-gray-600 text-lg mr-2"></i>
                            <div class="text-lg font-bold text-gray-700" id="maxPriceEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Max Preis</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Jahresbilanz Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Jahresbilanz</h3>
                    <canvas id="annualBalanceChart" width="400" height="300"></canvas>
                </div>

                <!-- Erlöse nach Komponenten -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Erlöse nach Komponenten</h3>
                    <canvas id="revenueComponentsChart" width="400" height="300"></canvas>
                </div>
            </div>
            
            <!-- Export-Buttons für Simulation -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Export & Druck</h3>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="printSimulationResults()" 
                            class="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-print mr-2"></i>Simulation drucken
                    </button>
                    <button onclick="exportSimulationToPDF()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fas fa-file-pdf mr-2"></i>Als PDF exportieren
                    </button>
                    <button onclick="exportSimulationToExcel()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-file-excel mr-2"></i>Als Excel exportieren
                    </button>
                    <button onclick="exportSimulationToWord()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-file-word mr-2"></i>Als Word exportieren
                    </button>
                </div>
            </div>

            <!-- 10-Jahres-Analyse -->
            <div id="tenYearAnalysis" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">10-Jahres-Analyse mit Batterie-Degradation</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Cashflow-Verlauf -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Cashflow-Verlauf</h3>
                            <canvas id="cashflowChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Batterie-Degradation -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Batterie-Kapazität</h3>
                            <canvas id="degradationChart" width="400" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Erweiterte Metriken -->
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-xl font-bold text-blue-600" id="totalRevenues">-</div>
                            <div class="text-sm text-gray-600">Gesamterlöse (10J)</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-xl font-bold text-green-600" id="totalNetCashflow">-</div>
                            <div class="text-sm text-gray-600">Net Cashflow (10J)</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-xl font-bold text-orange-600" id="npv">-</div>
                            <div class="text-sm text-gray-600">NPV (EUR)</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-xl font-bold text-purple-600" id="irr">-</div>
                            <div class="text-sm text-gray-600">IRR (%)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Dashboard Tab Content -->
    <div id="dashboardContent" class="tab-content hidden">
        <!-- Projektauswahl für Dashboard -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projektauswahl für Dashboard</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Projekt für Dashboard-Analyse:</label>
                <select id="dashboardProjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadDashboardProject()">
                    <option value="">Projekt auswählen...</option>
                </select>
            </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div id="enhancedDashboard" class="hidden">
            <!-- Kontrollen -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Dashboard-Kontrollen</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Use Case:</label>
                        <select id="dashboardUseCase" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="UC1">UC1 - Nur Verbrauch</option>
                            <option value="UC2">UC2 - PV + Verbrauch</option>
                            <option value="UC3">UC3 - PV + Hydro + Verbrauch</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Modus:</label>
                        <select id="dashboardBessMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="arbitrage">Arbitrage</option>
                            <option value="peak_shaving">Peak Shaving</option>
                            <option value="frequency_regulation">Frequenzregelung</option>
                            <option value="backup">Backup</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Optimierungsziel:</label>
                        <select id="dashboardOptimizationTarget" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="cost_minimization">Kostenminimierung</option>
                            <option value="revenue_maximization">Erlösmaximierung</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Spot-Preis Szenario:</label>
                        <select id="dashboardSpotPriceScenario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="current">Aktuell</option>
                            <option value="optimistic">Optimistisch</option>
                            <option value="pessimistic">Pessimistisch</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="runDashboardSimulation()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-rocket mr-2"></i>Dashboard-Simulation starten
                    </button>
                </div>
                
                <!-- BESS-Modus Info -->
                <div id="bessModeInfo"></div>
            </div>

            <!-- Kennzahlen -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="text-sm text-gray-600 mb-2">Eigenverbrauchsquote</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardEigenverbrauchsquote">--</div>
                    <div class="text-sm text-gray-500">%</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardEigenverbrauchsquoteTrend">↗ +5.2%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="text-sm text-gray-600 mb-2">CO₂-Einsparung</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardCo2Savings">--</div>
                    <div class="text-sm text-gray-500">kg/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardCo2SavingsTrend">↗ +12.8%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="text-sm text-gray-600 mb-2">Netto-Erlös</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardNettoErloes">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardNettoErloesTrend">↗ +8.3%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                    <div class="text-sm text-gray-600 mb-2">BESS-Effizienz</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardBessEfficiency">--</div>
                    <div class="text-sm text-gray-500">%</div>
                    <div class="text-sm text-yellow-600 mt-2" id="dashboardBessEfficiencyTrend">→ Stabil</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500">
                    <div class="text-sm text-gray-600 mb-2">Spot-Revenue</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardSpotRevenue">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardSpotRevenueTrend">↗ +15.7%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="text-sm text-gray-600 mb-2">Regelreserve</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardRegelreserveRevenue">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardRegelreserveRevenueTrend">↗ +22.1%</div>
                </div>
            </div>

            <!-- STUFE 1: Erweiterte Kennzahlen im Dashboard -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl shadow-lg border-2 border-purple-200 p-6 mb-8">
                <div class="flex items-center mb-4 cursor-pointer" onclick="toggleStufeSection('dashboardStufe1Section', 'dashboardStufe1Icon')">
                    <i class="fas fa-chart-line text-purple-600 text-2xl mr-3"></i>
                    <h3 class="text-xl font-semibold text-gray-900">Stufe 1 - Erweiterte Kennzahlen</h3>
                    <span class="ml-auto px-3 py-1 bg-purple-600 text-white text-xs font-semibold rounded-full">NEU</span>
                    <i class="fas fa-chevron-down text-purple-600 text-xl ml-3 transition-transform" id="dashboardStufe1Icon"></i>
                </div>
                <div id="dashboardStufe1Section" class="stufe-content">
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <!-- State of Health -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <i class="fas fa-battery-three-quarters text-green-600 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-green-600" id="dashboardStateOfHealth">--</div>
                        <div class="text-xs text-gray-600 mt-1">SoH (%)</div>
                    </div>
                    
                    <!-- Aktuelle Kapazität -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <i class="fas fa-bolt text-blue-600 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-blue-600" id="dashboardCurrentCapacity">--</div>
                        <div class="text-xs text-gray-600 mt-1">Kapazität (kWh)</div>
                    </div>
                    
                    <!-- Kapazitätsverlust -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-orange-200">
                        <i class="fas fa-arrow-down text-orange-600 text-2xl mb-2"></i>
                        <div class="text-2xl font-bold text-orange-600" id="dashboardCapacityLoss">--</div>
                        <div class="text-xs text-gray-600 mt-1">Verlust (kWh)</div>
                    </div>
                    
                    <!-- Erlösverlust Restriktionen -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-red-200">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl mb-2"></i>
                        <div class="text-xl font-bold text-red-600" id="dashboardRevenueLoss">--</div>
                        <div class="text-xs text-gray-600 mt-1">Restriktionen (€)</div>
                    </div>
                    
                    <!-- Second-Life Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="dashboardSecondLifeCard">
                        <i class="fas fa-recycle text-gray-600 text-2xl mb-2" id="dashboardSecondLifeIcon"></i>
                        <div class="text-xl font-bold text-gray-600" id="dashboardSecondLifeStatus">--</div>
                        <div class="text-xs text-gray-600 mt-1">Second-Life</div>
                    </div>
                    
                    <!-- Kostenvorteil -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200" id="dashboardCostReductionCard">
                        <i class="fas fa-euro-sign text-green-600 text-2xl mb-2"></i>
                        <div class="text-xl font-bold text-green-600" id="dashboardCostReduction">--</div>
                        <div class="text-xs text-gray-600 mt-1">Ersparnis (%)</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- STUFE 2.1: Co-Location PV + BESS Kennzahlen im Dashboard -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg border-2 border-green-200 p-6 mb-8" id="dashboardCoLocationSection">
                <div class="flex items-center mb-4 cursor-pointer" onclick="toggleStufeSection('dashboardStufe21Section', 'dashboardStufe21Icon')">
                    <i class="fas fa-solar-panel text-green-600 text-2xl mr-3"></i>
                    <h3 class="text-xl font-semibold text-gray-900">Stufe 2.1 - Co-Location PV + BESS</h3>
                    <span class="ml-auto px-3 py-1 bg-green-600 text-white text-xs font-semibold rounded-full">NEU</span>
                    <i class="fas fa-chevron-down text-green-600 text-xl ml-3 transition-transform" id="dashboardStufe21Icon"></i>
                </div>
                <div id="dashboardStufe21Section" class="stufe-content">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Co-Location Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="dashboardCoLocationStatusCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-link text-gray-600 text-xl mr-2" id="dashboardCoLocationIcon"></i>
                            <div class="text-xl font-bold text-gray-600" id="dashboardCoLocationStatus">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Co-Location</div>
                        <div class="text-xs text-gray-500 mt-1" id="dashboardCoLocationInfo">-</div>
                    </div>
                    
                    <!-- PV-Ausnutzung -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-sun text-blue-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-blue-600" id="dashboardPvUtilization">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">PV-Ausnutzung</div>
                        <div class="text-xs text-gray-500 mt-1">Nach Curtailment</div>
                    </div>
                    
                    <!-- Vermiedene Curtailment -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-shield-alt text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="dashboardAvoidedCurtailment">-</div>
                            <span class="text-lg text-gray-500 ml-1">kW</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Vermiedene Curtailment</div>
                        <div class="text-xs text-gray-500 mt-1">Durch BESS</div>
                    </div>
                    
                    <!-- Eigenverbrauchsquote -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-home text-purple-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-purple-600" id="dashboardSelfConsumptionRate">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Eigenverbrauchsquote</div>
                        <div class="text-xs text-gray-500 mt-1">Mit Co-Location</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Co-Location Erlöszuwachs -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="dashboardCoLocationRevenueIncrease">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Erlöszuwachs</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Co-Location</div>
                    </div>
                    
                    <!-- Co-Location Kosteneinsparung -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-piggy-bank text-blue-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-blue-600" id="dashboardCoLocationCostSavings">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Kosteneinsparung</div>
                        <div class="text-xs text-gray-500 mt-1">Grid-Fee-Ersparnis</div>
                    </div>
                    
                    <!-- Gesamtnutzen -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-emerald-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chart-line text-emerald-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-emerald-600" id="dashboardCoLocationTotalBenefit">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Gesamtnutzen</div>
                        <div class="text-xs text-gray-500 mt-1">Erlöse + Einsparungen</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- STUFE 2.2: Optimierte Regelstrategien Kennzahlen im Dashboard -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg border-2 border-purple-200 p-6 mb-8" id="dashboardOptimizationSection" style="display: block !important;">
                <div class="flex items-center mb-4">
                    <div class="flex items-center flex-1 cursor-pointer" onclick="toggleStufeSection('dashboardStufe22Section', 'dashboardStufe22Icon')">
                        <i class="fas fa-brain text-purple-600 text-2xl mr-3"></i>
                        <h3 class="text-xl font-semibold text-gray-900">Stufe 2.2 - Optimierte Regelstrategien</h3>
                    </div>
                    <!-- Optimierung Toggle Switch -->
                    <div class="flex items-center mx-4">
                        <span class="text-sm text-gray-600 mr-2">Optimierung:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dashboardOptimizationToggle" class="sr-only peer" onchange="toggleDashboardOptimization()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700" id="dashboardOptimizationToggleLabel">Aktivieren</span>
                        </label>
                    </div>
                    <div class="flex items-center">
                        <span class="px-3 py-1 bg-purple-600 text-white text-xs font-semibold rounded-full">NEU</span>
                        <i class="fas fa-chevron-down text-purple-600 text-xl ml-3 transition-transform cursor-pointer" id="dashboardStufe22Icon" onclick="toggleStufeSection('dashboardStufe22Section', 'dashboardStufe22Icon')"></i>
                    </div>
                </div>
                <div id="dashboardStufe22Section" class="stufe-content expanded" style="display: block !important;">
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Optimierung Status -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200" id="dashboardOptimizationStatusCard">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-cog text-gray-600 text-xl mr-2" id="dashboardOptimizationIcon"></i>
                            <div class="text-xl font-bold text-gray-600" id="dashboardOptimizationStatus">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Optimierung</div>
                        <div class="text-xs text-gray-500 mt-1" id="dashboardOptimizationInfo">-</div>
                    </div>
                    
                    <!-- Strategie -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chess text-blue-600 text-xl mr-2"></i>
                            <div class="text-lg font-bold text-blue-600" id="dashboardOptimizationStrategy">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Strategie</div>
                        <div class="text-xs text-gray-500 mt-1">Aktive Optimierung</div>
                    </div>
                    
                    <!-- Erlös-Boost -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-chart-line text-green-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-green-600" id="dashboardOptimizationRevenueBoost">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Erlös-Boost</div>
                        <div class="text-xs text-gray-500 mt-1">Durch Optimierung</div>
                    </div>
                    
                    <!-- Preis-Volatilität -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-orange-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-wave-square text-orange-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-orange-600" id="dashboardOptimizationPriceVolatility">-</div>
                            <span class="text-lg text-gray-500 ml-1">%</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Preis-Volatilität</div>
                        <div class="text-xs text-gray-500 mt-1">Markt-Schwankungen</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Optimierungs-Benefit -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-purple-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-euro-sign text-purple-600 text-xl mr-2"></i>
                            <div class="text-2xl font-bold text-purple-600" id="dashboardOptimizationBenefit">-</div>
                            <span class="text-lg text-gray-500 ml-1">€</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Optimierungs-Benefit</div>
                        <div class="text-xs text-gray-500 mt-1">Zusätzlicher Erlös/Jahr</div>
                    </div>
                    
                    <!-- Strategie-Details -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-indigo-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-info-circle text-indigo-600 text-xl mr-2"></i>
                            <div class="text-sm font-medium text-indigo-600" id="dashboardOptimizationDetails">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Strategie-Details</div>
                        <div class="text-xs text-gray-500 mt-1" id="dashboardOptimizationDescription">-</div>
                    </div>
                </div>
                
                <!-- EXTREMPREIS-SZENARIEN & SPREAD WIDTH -->
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                    <!-- Spread Width -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrows-alt-h text-blue-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-blue-600" id="dashboardSpreadWidthEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Spread Width</div>
                        <div class="text-xs text-gray-500 mt-1" id="dashboardSpreadWidthPercent">-</div>
                    </div>
                    
                    <!-- Negative Preise -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-down text-green-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-green-600" id="dashboardNegativePriceCount">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Negative Preise</div>
                        <div class="text-xs text-gray-500 mt-1">Voll-Ladungen</div>
                    </div>
                    
                    <!-- Extreme Peaks -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-red-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-red-600 text-xl mr-2"></i>
                            <div class="text-xl font-bold text-red-600" id="dashboardExtremePeakCount">-</div>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Extreme Peaks</div>
                        <div class="text-xs text-gray-500 mt-1">Voll-Entladungen</div>
                    </div>
                    
                    <!-- Min Preis -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-down text-gray-600 text-lg mr-2"></i>
                            <div class="text-lg font-bold text-gray-700" id="dashboardMinPriceEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Min Preis</div>
                    </div>
                    
                    <!-- Max Preis -->
                    <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-center mb-2">
                            <i class="fas fa-arrow-up text-gray-600 text-lg mr-2"></i>
                            <div class="text-lg font-bold text-gray-700" id="dashboardMaxPriceEurMwh">-</div>
                            <span class="text-sm text-gray-500 ml-1">€/MWh</span>
                        </div>
                        <div class="text-sm text-gray-600 font-medium">Max Preis</div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Monatliche Auswertung</h3>
                    <canvas id="dashboardMonthlyChart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">CO₂-Bilanz</h3>
                    <canvas id="dashboardCo2Chart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Saisonale Performance</h3>
                    <canvas id="dashboardSeasonalChart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">SOC-Profil (24h)</h3>
                    <canvas id="dashboardSocChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Vollbreite Charts -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Erlösaufschlüsselung</h3>
                <canvas id="dashboardRevenueChart" width="800" height="300"></canvas>
            </div>
            
            <!-- Export-Buttons für Dashboard -->
            <div class="bg-white rounded-lg shadow-md p-6 mt-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Export & Druck</h3>
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="printDashboard()" 
                            class="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-print mr-2"></i>Dashboard drucken
                    </button>
                    <button onclick="exportDashboardToPDF()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fas fa-file-pdf mr-2"></i>Als PDF exportieren
                    </button>
                    <button onclick="exportDashboardToExcel()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-file-excel mr-2"></i>Als Excel exportieren
                    </button>
                    <button onclick="exportDashboardToWord()" 
                            class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-file-word mr-2"></i>Als Word exportieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-700">Simulation läuft...</span>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js wird bereits in base.html geladen -->
<script>
// Währungsformatierung
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '-';
    }
    
    // Für sehr große Zahlen: Millionen oder Tausender
    if (value >= 1000000) {
        return (value / 1000000).toFixed(1) + ' Mio. €';
    } else if (value >= 1000) {
        return (value / 1000).toFixed(0) + ' Tsd. €';
    } else {
        return value.toFixed(0) + ' €';
    }
}
let charts = {};
let selectedProject = null;
let selectedUseCase = null;

// Lade Projekte beim Seitenstart
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});

// Lade alle verfügbaren Projekte
async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '<option value="">Projekt auswählen...</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Projekte:', error);
    }
}

// Lade Projektdetails
async function loadProjectDetails() {
    const projectId = document.getElementById('projectSelect').value;
    
    if (!projectId) {
        document.getElementById('projectDetails').classList.add('hidden');
        document.getElementById('useCaseSection').classList.add('hidden');
        document.getElementById('results').classList.add('hidden');
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}`);
        const project = await response.json();
        
        selectedProject = project;
        
        // Zeige Projektdetails
        document.getElementById('projectName').textContent = project.name;
        document.getElementById('projectLocation').textContent = project.location || '-';
        document.getElementById('projectBessSize').textContent = project.bess_size ? `${project.bess_size} MWh` : '-';
        document.getElementById('projectBessPower').textContent = project.bess_power ? `${project.bess_power} MW` : '-';
        
        // Update Header
        document.getElementById('projectNameHeader').textContent = project.name;
        
        // Zeige Projektdetails und Use Case Sektion
        document.getElementById('projectDetails').classList.remove('hidden');
        document.getElementById('useCaseSection').classList.remove('hidden');
        
        // Update BESS-Parameter basierend auf Projekt
        if (project.bess_size) {
            document.getElementById('bessSize').value = project.bess_size;
        }
        if (project.bess_power) {
            document.getElementById('bessPower').value = project.bess_power;
        }
        
        // Use Cases für dieses Projekt laden
        await loadUseCasesForProject(projectId);
        
        // Initialisiere Roadmap Stufe 1 Werte mit Projekt-Daten (vor Simulation)
        initializeRoadmapStufe1Metrics(project);
        
        // ROADMAP STUFE 2.2: Lade Optimierungs-Konfiguration und initialisiere Toggle
        loadOptimizationConfig(projectId);
        
    } catch (error) {
        console.error('Fehler beim Laden der Projektdetails:', error);
    }
}

// Initialisiere Roadmap Stufe 1 Metriken mit Projekt-Daten
function initializeRoadmapStufe1Metrics(project) {
    // Initialwerte setzen (vor Simulation)
    // bess_size aus Projekt - prüfe ob in MWh oder kWh
    let bessSizeKwh = project.bess_size || 0;
    
    // Wenn bess_size < 1000, könnte es MWh sein (z.B. 40 MWh = 40000 kWh)
    // Wenn bess_size >= 1000, ist es wahrscheinlich bereits in kWh
    // Aber: 40 MWh könnte auch als 40 gespeichert sein
    // Prüfe auch die Eingabefelder für Hinweise
    const bessSizeInput = document.getElementById('bessSize');
    if (bessSizeInput && bessSizeInput.value) {
        const inputValue = parseFloat(bessSizeInput.value);
        // Wenn das Eingabefeld einen großen Wert hat (z.B. 40000), ist es wahrscheinlich kWh
        // Wenn das Eingabefeld einen kleinen Wert hat (z.B. 40), könnte es MWh sein
        if (inputValue > 0) {
            if (inputValue < 1000) {
                // Wahrscheinlich MWh, konvertiere zu kWh
                bessSizeKwh = inputValue * 1000;
            } else {
                // Wahrscheinlich bereits in kWh
                bessSizeKwh = inputValue;
            }
        }
    } else if (bessSizeKwh > 0 && bessSizeKwh < 1000) {
        // Fallback: Wenn bess_size < 1000, könnte es MWh sein
        bessSizeKwh = bessSizeKwh * 1000;
    }
    
    const initialData = {
        state_of_health: 100.0,
        current_capacity_kwh: bessSizeKwh,
        capacity_loss_kwh: 0,
        revenue_loss_restrictions: 0,
        is_second_life: false,
        second_life_cost_reduction_percent: 0,
        bess_size: bessSizeKwh,  // Für Fallback in displayRoadmapStufe1Metrics
        bess_size_kwh: bessSizeKwh  // Für Fallback in displayRoadmapStufe1Metrics
    };
    
    console.log('🔄 Initialisiere Roadmap Stufe 1 Metriken mit Projekt-Daten:', {
        project_bess_size: project.bess_size,
        calculated_bessSizeKwh: bessSizeKwh,
        initialData
    });
    displayRoadmapStufe1Metrics(initialData);
}

// Use Cases für ein Projekt laden
async function loadUseCasesForProject(projectId) {
    try {
        const response = await fetch(`/api/projects/${projectId}/use-cases`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const useCases = await response.json();
        console.log('📊 Use Cases geladen:', useCases);
        
        // Use Case-Karten rendern
        renderUseCaseCards(useCases);
        
        // Use Case-Dropdown aktualisieren
        updateUseCaseSelect(useCases);
        
        // Automatisch ersten Use Case auswählen wenn vorhanden
        if (useCases.length > 0 && !selectedUseCase) {
            const firstUseCase = useCases[0].name;
            selectUseCase(firstUseCase);
            console.log(`🔄 Automatisch ${firstUseCase} ausgewählt für neues Projekt`);
        }
        
    } catch (error) {
        console.error('Fehler beim Laden der Use Cases:', error);
        // Fallback: Standard-Use Cases anzeigen
        renderUseCaseCardsFallback();
    }
}

// Use Case-Karten rendern
function renderUseCaseCards(useCases) {
    const container = document.getElementById('useCaseCards');
    if (!container) return;
    
    // Sortiere Use Cases nach Name (UC1, UC2, UC3)
    const sortedUseCases = useCases.sort((a, b) => a.name.localeCompare(b.name));
    
    if (sortedUseCases.length === 0) {
        container.innerHTML = `
            <div class="col-span-3 text-center p-8 text-gray-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Keine Use Cases für dieses Projekt gefunden.</p>
            </div>
        `;
        return;
    }
    
    // Use Case-Farben und Icons (mit vollständigen Tailwind-Klassen)
    const useCaseStyles = {
        'UC1': { colorClass: 'text-blue-600', borderClass: 'border-blue-200', icon: 'fa-bolt' },
        'UC2': { colorClass: 'text-green-600', borderClass: 'border-green-200', icon: 'fa-sun' },
        'UC3': { colorClass: 'text-purple-600', borderClass: 'border-purple-200', icon: 'fa-water' }
    };
    
    container.innerHTML = sortedUseCases.map(uc => {
        const style = useCaseStyles[uc.name] || { colorClass: 'text-gray-600', borderClass: 'border-gray-200', icon: 'fa-cog' };
        const pvPower = uc.pv_power_mwp ? `${uc.pv_power_mwp.toFixed(2)} MWp` : '0 MWp';
        const hydroPower = uc.hydro_power_kw ? `${uc.hydro_power_kw.toFixed(0)} kW` : '0 kW';
        
        // Beschreibung basierend auf Use Case
        let description = uc.description || '';
        if (!description) {
            if (uc.name === 'UC1') {
                description = 'Verbrauch ohne Eigenerzeugung';
            } else if (uc.name === 'UC2') {
                description = `Verbrauch + PV (${pvPower})`;
            } else if (uc.name === 'UC3') {
                description = `Verbrauch + PV + Wasserkraft`;
            }
        }
        
        return `
            <div class="border ${style.borderClass} rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-all" 
                 onclick="selectUseCase('${uc.name}')" 
                 id="useCaseCard-${uc.name}">
                <h3 class="font-semibold text-lg ${style.colorClass} mb-2">
                    <i class="fas ${style.icon} mr-2"></i>${uc.name}
                </h3>
                <p class="text-sm text-gray-600 mb-2">${description}</p>
                <ul class="text-xs text-gray-500 space-y-1">
                    <li>• PV: ${pvPower}</li>
                    <li>• Wasserkraft: ${hydroPower}</li>
                    <li>• ${uc.name === 'UC1' ? 'Nur BESS-Optimierung' : uc.name === 'UC2' ? 'PV + BESS-Optimierung' : 'Vollständige Optimierung'}</li>
                </ul>
            </div>
        `;
    }).join('');
}

// Fallback: Standard-Use Cases anzeigen (wenn API-Fehler)
function renderUseCaseCardsFallback() {
    const container = document.getElementById('useCaseCards');
    if (!container) return;
    
    container.innerHTML = `
        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC1')">
            <h3 class="font-semibold text-lg text-blue-600">UC1</h3>
            <p class="text-sm text-gray-600 mb-2">Verbrauch ohne Eigenerzeugung</p>
            <ul class="text-xs text-gray-500">
                <li>• PV: 0 MWp</li>
                <li>• Wasserkraft: 0 kW</li>
                <li>• Nur BESS-Optimierung</li>
            </ul>
        </div>
        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC2')">
            <h3 class="font-semibold text-lg text-green-600">UC2</h3>
            <p class="text-sm text-gray-600 mb-2">Verbrauch + PV</p>
            <ul class="text-xs text-gray-500">
                <li>• PV: Variabel</li>
                <li>• Wasserkraft: 0 kW</li>
                <li>• PV + BESS-Optimierung</li>
            </ul>
        </div>
        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC3')">
            <h3 class="font-semibold text-lg text-purple-600">UC3</h3>
            <p class="text-sm text-gray-600 mb-2">Verbrauch + PV + Wasserkraft</p>
            <ul class="text-xs text-gray-500">
                <li>• PV: Variabel</li>
                <li>• Wasserkraft: Variabel</li>
                <li>• Vollständige Optimierung</li>
            </ul>
        </div>
    `;
}

// Use Case-Dropdown aktualisieren
function updateUseCaseSelect(useCases) {
    const select = document.getElementById('useCaseSelect');
    if (!select) return;
    
    // Sortiere Use Cases nach Name
    const sortedUseCases = useCases.sort((a, b) => a.name.localeCompare(b.name));
    
    // Lösche alte Optionen (außer der ersten "auswählen..." Option)
    select.innerHTML = '<option value="">Use Case auswählen...</option>';
    
    // Füge Use Cases hinzu
    sortedUseCases.forEach(uc => {
        const option = document.createElement('option');
        option.value = uc.name;
        
        // Beschreibung für Option
        let description = uc.description || '';
        if (!description) {
            if (uc.name === 'UC1') {
                description = 'Verbrauch ohne Eigenerzeugung';
            } else if (uc.name === 'UC2') {
                const pvPower = uc.pv_power_mwp ? `${uc.pv_power_mwp.toFixed(2)} MWp` : '0 MWp';
                description = `Verbrauch + PV (${pvPower})`;
            } else if (uc.name === 'UC3') {
                description = 'Verbrauch + PV + Wasserkraft';
            }
        }
        
        option.textContent = `${uc.name} - ${description}`;
        select.appendChild(option);
    });
    
    // Event Listener für Dropdown-Änderung
    select.onchange = function() {
        if (this.value) {
            selectUseCase(this.value);
        }
    };
}

// Use Case auswählen
function selectUseCase(useCase) {
    selectedUseCase = useCase;
    
    // Dropdown aktualisieren
    const useCaseSelect = document.getElementById('useCaseSelect');
    if (useCaseSelect) {
        useCaseSelect.value = useCase;
    }
    
    // Visueller Feedback für alle Use Case Karten
    document.querySelectorAll('[onclick^="selectUseCase"], [id^="useCaseCard-"]').forEach(el => {
        el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
        el.classList.add('border-gray-200');
    });
    
    // Aktuelle Karte hervorheben
    const currentCard = document.getElementById(`useCaseCard-${useCase}`);
    if (currentCard) {
        currentCard.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
        currentCard.classList.remove('border-gray-200');
    } else {
        // Fallback: Suche nach onclick-Attribut
        const fallbackCard = event?.target?.closest('[onclick^="selectUseCase"]');
        if (fallbackCard) {
            fallbackCard.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
            fallbackCard.classList.remove('border-gray-200');
        }
    }
    
    // Debug-Log
    console.log('Use Case ausgewählt:', useCase);
    console.log('Projekt ausgewählt:', selectedProject);
    console.log('selectedUseCase:', selectedUseCase);
    console.log('useCaseSelect.value:', useCaseSelect ? useCaseSelect.value : 'Element nicht gefunden');
    
    // Prüfe ob Projekt und Use Case ausgewählt sind
    if (selectedProject && selectedUseCase) {
        console.log('✅ Projekt und Use Case sind ausgewählt - Simulation kann gestartet werden');
    }
}

// Simulation starten
async function runSimulation() {
    if (!selectedProject || !selectedUseCase) {
        alert('Bitte wählen Sie ein Projekt und einen Use Case aus.');
        return;
    }
    
    // Extrahiere nur den Use Case-Namen (z.B. "UC2" aus "BORBET UC2 Batterie + PV - Beschreibung")
    let useCaseName = selectedUseCase.trim();
    
    // Versuche, UC1, UC2 oder UC3 aus dem Text zu extrahieren
    const ucMatch = useCaseName.match(/\b(UC[123])\b/i);
    if (ucMatch) {
        useCaseName = ucMatch[1].toUpperCase(); // UC1, UC2 oder UC3
    } else if (useCaseName.includes(' - ')) {
        // Fallback: Nimm den Teil vor " - "
        useCaseName = useCaseName.split(' - ')[0].trim();
        // Versuche nochmal, UC1/UC2/UC3 zu finden
        const ucMatch2 = useCaseName.match(/\b(UC[123])\b/i);
        if (ucMatch2) {
            useCaseName = ucMatch2[1].toUpperCase();
        }
    }
    
    // Validiere, dass es ein gültiger Use Case ist
    if (!['UC1', 'UC2', 'UC3'].includes(useCaseName)) {
        alert(`Ungültiger Use Case: "${selectedUseCase}" (extrahiert: "${useCaseName}"). Bitte wählen Sie UC1, UC2 oder UC3.`);
        console.error('❌ Use Case-Extraktion fehlgeschlagen:', {
            original: selectedUseCase,
            extracted: useCaseName
        });
        return;
    }
    
    console.log('🚀 Simulation gestartet:', {
        projectId: selectedProject.id,
        useCase: useCaseName,
        originalUseCase: selectedUseCase
    });
    
    showLoading();
    
    try {
        const simulationData = {
            project_id: selectedProject.id,
            use_case: useCaseName,  // Verwende den extrahierten Use Case-Namen
            simulation_year: document.getElementById('simulationYear').value,
            bess_size: parseFloat(document.getElementById('bessSize').value),
            bess_power: parseFloat(document.getElementById('bessPower').value)
        };
        
        const response = await fetch('/api/simulation/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(simulationData)
        });
        
        const results = await response.json();
        
        console.log('📊 Vollständige Simulation-Ergebnisse:', results);
        console.log('📊 Roadmap Stufe 1 Werte:', {
            state_of_health: results.state_of_health,
            current_capacity_kwh: results.current_capacity_kwh,
            capacity_loss_kwh: results.capacity_loss_kwh,
            revenue_loss_restrictions: results.revenue_loss_restrictions,
            is_second_life: results.is_second_life,
            second_life_cost_reduction_percent: results.second_life_cost_reduction_percent
        });
        
        // Speichere Ergebnisse für Export
        window.currentSimulationResults = {
            use_cases: {
                [selectedUseCase]: results
            },
            ten_year_analysis: {},
            economic_metrics: {
                annual_consumption: results.annual_consumption,
                annual_generation: results.annual_generation,
                annual_revenues: results.annual_revenues,
                annual_costs: results.annual_costs,
                roi_percent: results.roi_percent,
                payback_years: results.payback_years,
                total_investment: results.total_investment,
                net_cashflow: results.net_cashflow
            }
        };
        
        displayResults(results);
        
    } catch (error) {
        console.error('Fehler bei der Simulation:', error);
        alert('Fehler bei der Simulation. Bitte versuchen Sie es erneut.');
    } finally {
        hideLoading();
    }
}

// 10-Jahres-Analyse
async function run10YearAnalysis() {
    if (!selectedProject || !selectedUseCase) {
        alert('Bitte wählen Sie ein Projekt und einen Use Case aus.');
        return;
    }
    
    // Extrahiere nur den Use Case-Namen (z.B. "UC2" aus "BORBET UC2 Batterie + PV - Beschreibung")
    let useCaseName = selectedUseCase.trim();
    
    // Versuche, UC1, UC2 oder UC3 aus dem Text zu extrahieren
    const ucMatch = useCaseName.match(/\b(UC[123])\b/i);
    if (ucMatch) {
        useCaseName = ucMatch[1].toUpperCase(); // UC1, UC2 oder UC3
    } else if (useCaseName.includes(' - ')) {
        // Fallback: Nimm den Teil vor " - "
        useCaseName = useCaseName.split(' - ')[0].trim();
        // Versuche nochmal, UC1/UC2/UC3 zu finden
        const ucMatch2 = useCaseName.match(/\b(UC[123])\b/i);
        if (ucMatch2) {
            useCaseName = ucMatch2[1].toUpperCase();
        }
    }
    
    // Validiere, dass es ein gültiger Use Case ist
    if (!['UC1', 'UC2', 'UC3'].includes(useCaseName)) {
        alert(`Ungültiger Use Case: "${selectedUseCase}" (extrahiert: "${useCaseName}"). Bitte wählen Sie UC1, UC2 oder UC3.`);
        console.error('❌ Use Case-Extraktion fehlgeschlagen:', {
            original: selectedUseCase,
            extracted: useCaseName
        });
        return;
    }
    
    console.log('🚀 10-Jahres-Analyse gestartet:', {
        projectId: selectedProject.id,
        useCase: useCaseName,
        originalUseCase: selectedUseCase
    });
    
    showLoading();
    
    try {
        const analysisData = {
            project_id: selectedProject.id,
            use_case: useCaseName,  // Verwende den extrahierten Use Case-Namen
            bess_size: parseFloat(document.getElementById('bessSize').value),
            bess_power: parseFloat(document.getElementById('bessPower').value)
        };
        
        console.log('10-Jahres-Analyse Daten:', analysisData);
        
        const response = await fetch('/api/simulation/10-year-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(analysisData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.error) {
            throw new Error(results.error);
        }
        
        console.log('10-Jahres-Analyse Ergebnisse:', results);
        
        // Speichere 10-Jahres-Analyse für Export
        if (window.currentSimulationResults) {
            window.currentSimulationResults.ten_year_analysis = results;
        } else {
            window.currentSimulationResults = {
                use_cases: {},
                ten_year_analysis: results,
                economic_metrics: {}
            };
        }
        
        display10YearAnalysis(results);
        
    } catch (error) {
        console.error('Fehler bei der 10-Jahres-Analyse:', error);
        alert(`Fehler bei der 10-Jahres-Analyse: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// Ergebnisse anzeigen
function displayResults(data) {
    console.log('📊 displayResults aufgerufen mit Daten:', data);
    
    // Jahresbilanz
    const annualConsumptionEl = document.getElementById('annualConsumption');
    const annualGenerationEl = document.getElementById('annualGeneration');
    const annualRevenuesEl = document.getElementById('annualRevenues');
    const annualCostsEl = document.getElementById('annualCosts');
    
    if (annualConsumptionEl) {
        annualConsumptionEl.textContent = data.annual_consumption?.toFixed(1) || '-';
    }
    if (annualGenerationEl) {
        annualGenerationEl.textContent = data.annual_generation?.toFixed(1) || '-';
    }
    if (annualRevenuesEl) {
        annualRevenuesEl.textContent = formatCurrency(data.annual_revenues) || '-';
    }
    if (annualCostsEl) {
        annualCostsEl.textContent = formatCurrency(data.annual_costs) || '-';
    }
    
    // Wirtschaftlichkeitsmetriken
    const roiPercentEl = document.getElementById('roiPercent');
    const paybackYearsEl = document.getElementById('paybackYears');
    const totalInvestmentEl = document.getElementById('totalInvestment');
    const netCashflowEl = document.getElementById('netCashflow');
    
    if (roiPercentEl) {
        roiPercentEl.textContent = data.roi_percent?.toFixed(1) || '-';
    }
    if (paybackYearsEl) {
        paybackYearsEl.textContent = data.payback_years?.toFixed(1) || '-';
    }
    if (totalInvestmentEl) {
        totalInvestmentEl.textContent = formatCurrency(data.total_investment) || '-';
    }
    if (netCashflowEl) {
        netCashflowEl.textContent = formatCurrency(data.net_cashflow) || '-';
    }
    
    // ROADMAP STUFE 1: Erweiterte Kennzahlen anzeigen
    displayRoadmapStufe1Metrics(data);
    
    // ROADMAP STUFE 2.1: Co-Location Kennzahlen anzeigen
    displayCoLocationMetrics(data);
    
    // ROADMAP STUFE 2.2: Optimierte Regelstrategien Kennzahlen anzeigen
    displayOptimizationMetrics(data);
    
    // Charts erstellen
    createAnnualBalanceChart(data);
    createRevenueComponentsChart(data);
    
    // Ergebnisse anzeigen
    const resultsEl = document.getElementById('results');
    if (resultsEl) {
        resultsEl.classList.remove('hidden');
    }
}

// ROADMAP STUFE 1: Erweiterte Kennzahlen anzeigen
function displayRoadmapStufe1Metrics(data) {
    console.log('📊 Roadmap Stufe 1 Daten:', data);
    
    // State of Health
    const soh = data.state_of_health || data.stateOfHealth || 100.0;
    if (document.getElementById('stateOfHealth')) {
        document.getElementById('stateOfHealth').textContent = soh.toFixed(1);
    }
    
    // Aktuelle Kapazität - prüfe verschiedene mögliche Felder
    let currentCapacity = data.current_capacity_kwh || data.currentCapacity || data.current_capacity || 0;
    // Falls 0, versuche aus bess_size zu berechnen
    if (currentCapacity === 0 && data.bess_size_kwh) {
        currentCapacity = data.bess_size_kwh;
    } else if (currentCapacity === 0 && data.bess_size) {
        // bess_size könnte in MWh sein, konvertiere zu kWh
        currentCapacity = data.bess_size > 1000 ? data.bess_size : data.bess_size * 1000;
    } else if (currentCapacity === 0 && selectedProject && selectedProject.bess_size) {
        // Projekt bess_size könnte in MWh sein, konvertiere zu kWh
        const projectSize = selectedProject.bess_size;
        currentCapacity = projectSize > 1000 ? projectSize : projectSize * 1000;
    }
    
    if (document.getElementById('currentCapacity')) {
        document.getElementById('currentCapacity').textContent = currentCapacity.toFixed(0);
    }
    
    // Kapazitätsverlust
    let capacityLoss = data.capacity_loss_kwh || data.capacityLoss || data.capacity_loss || 0;
    // Falls 0, aber SoH < 100%, berechne Verlust
    if (capacityLoss === 0 && soh < 100.0 && currentCapacity > 0) {
        const initialCapacity = currentCapacity / (soh / 100.0);
        capacityLoss = initialCapacity - currentCapacity;
    }
    
    if (document.getElementById('capacityLoss')) {
        document.getElementById('capacityLoss').textContent = capacityLoss.toFixed(0);
    }
    
    // Erlösverlust durch Restriktionen
    const revenueLoss = data.revenue_loss_restrictions || data.revenueLossRestrictions || data.revenue_loss || 0;
    if (document.getElementById('revenueLossRestrictions')) {
        document.getElementById('revenueLossRestrictions').textContent = formatCurrency(revenueLoss) || '0 €';
    }
    
    // Second-Life Status
    const isSecondLife = data.is_second_life || data.isSecondLife || false;
    const secondLifeCard = document.getElementById('secondLifeCard');
    const secondLifeIcon = document.getElementById('secondLifeIcon');
    const secondLifeStatus = document.getElementById('secondLifeStatus');
    const secondLifeInfo = document.getElementById('secondLifeInfo');
    
    if (isSecondLife) {
        secondLifeCard.classList.remove('border-gray-200');
        secondLifeCard.classList.add('border-green-300', 'bg-green-50');
        secondLifeIcon.classList.remove('text-gray-600');
        secondLifeIcon.classList.add('text-green-600');
        secondLifeStatus.textContent = 'Ja';
        secondLifeStatus.classList.remove('text-gray-600');
        secondLifeStatus.classList.add('text-green-600');
        secondLifeInfo.textContent = 'Second-Life Batterie aktiv';
    } else {
        secondLifeCard.classList.remove('border-green-300', 'bg-green-50');
        secondLifeCard.classList.add('border-gray-200');
        secondLifeIcon.classList.remove('text-green-600');
        secondLifeIcon.classList.add('text-gray-600');
        secondLifeStatus.textContent = 'Nein';
        secondLifeStatus.classList.remove('text-green-600');
        secondLifeStatus.classList.add('text-gray-600');
        secondLifeInfo.textContent = 'Standard-Batterie';
    }
    
    // Kostenvorteil Second-Life
    const costReduction = data.second_life_cost_reduction_percent || 0;
    const costCard = document.getElementById('secondLifeCostCard');
    if (costReduction > 0) {
        document.getElementById('secondLifeCostReduction').textContent = costReduction.toFixed(1);
        costCard.classList.remove('border-gray-200');
        costCard.classList.add('border-green-300', 'bg-green-50');
    } else {
        document.getElementById('secondLifeCostReduction').textContent = '0.0';
        costCard.classList.remove('border-green-300', 'bg-green-50');
        costCard.classList.add('border-gray-200');
    }
}

// ROADMAP STUFE 2.1: Co-Location Kennzahlen anzeigen
function displayCoLocationMetrics(data) {
    const isCoLocation = data.is_co_location || false;
    const coLocationSection = document.getElementById('coLocationSection');
    const coLocationStatusCard = document.getElementById('coLocationStatusCard');
    const coLocationIcon = document.getElementById('coLocationIcon');
    const coLocationStatus = document.getElementById('coLocationStatus');
    const coLocationInfo = document.getElementById('coLocationInfo');
    
    if (!coLocationSection) return; // Sektion existiert nicht
    
    if (isCoLocation) {
        // Co-Location aktiviert - Sektion anzeigen
        coLocationSection.classList.remove('hidden');
        
        // Status-Karte aktualisieren
        if (coLocationStatusCard && coLocationIcon && coLocationStatus && coLocationInfo) {
            coLocationStatusCard.classList.remove('border-gray-200');
            coLocationStatusCard.classList.add('border-green-300', 'bg-green-50');
            coLocationIcon.classList.remove('text-gray-600');
            coLocationIcon.classList.add('text-green-600');
            coLocationStatus.textContent = 'Aktiv';
            coLocationStatus.classList.remove('text-gray-600');
            coLocationStatus.classList.add('text-green-600');
            coLocationInfo.textContent = 'PV + BESS Co-Location';
        }
        
        // PV-Ausnutzung
        const pvUtilization = data.pv_utilization_percent || 100.0;
        if (document.getElementById('pvUtilization')) {
            document.getElementById('pvUtilization').textContent = pvUtilization.toFixed(1);
        }
        
        // Vermiedene Curtailment
        const avoidedCurtailment = data.avoided_curtailment_kw || 0.0;
        if (document.getElementById('avoidedCurtailment')) {
            document.getElementById('avoidedCurtailment').textContent = avoidedCurtailment.toFixed(0);
        }
        
        // Eigenverbrauchsquote
        const selfConsumptionRate = data.self_consumption_rate_percent || 0.0;
        if (document.getElementById('selfConsumptionRate')) {
            document.getElementById('selfConsumptionRate').textContent = selfConsumptionRate.toFixed(1);
        }
        
        // Erlöszuwachs
        const revenueIncrease = data.co_location_revenue_increase_eur || 0.0;
        if (document.getElementById('coLocationRevenueIncrease')) {
            document.getElementById('coLocationRevenueIncrease').textContent = formatCurrency(revenueIncrease) || '0 €';
        }
        
        // Kosteneinsparung
        const costSavings = data.co_location_cost_savings_eur || 0.0;
        if (document.getElementById('coLocationCostSavings')) {
            document.getElementById('coLocationCostSavings').textContent = formatCurrency(costSavings) || '0 €';
        }
        
        // Gesamtnutzen
        const totalBenefit = data.co_location_total_benefit_eur || 0.0;
        if (document.getElementById('coLocationTotalBenefit')) {
            document.getElementById('coLocationTotalBenefit').textContent = formatCurrency(totalBenefit) || '0 €';
        }
    } else {
        // Co-Location nicht aktiviert - Sektion ausblenden
        coLocationSection.classList.add('hidden');
    }
}

// ROADMAP STUFE 2.2: Optimierte Regelstrategien Kennzahlen anzeigen (Simulation Tab)
function displayOptimizationMetrics(data) {
    console.log('📊 Aktualisiere Optimierungs-Metriken:', data);
    
    const isOptimizationEnabled = data.optimization_enabled || false;
    const strategy = data.optimization_strategy || 'none';
    const revenueBoost = data.optimization_revenue_boost_percent || 0.0;
    const priceVolatility = data.optimization_price_volatility || 0.0;
    const optimizationBenefit = data.optimization_benefit_eur || 0.0;
    
    // Optimierungs-Sektion
    const optimizationSection = document.getElementById('optimizationSection');
    if (!optimizationSection) {
        console.log('⚠️ optimizationSection nicht gefunden');
        return;
    }
    
    if (isOptimizationEnabled) {
        optimizationSection.classList.remove('hidden');
        
        // Optimierung Status
        const statusCard = document.getElementById('optimizationStatusCard');
        const statusIcon = document.getElementById('optimizationIcon');
        const statusText = document.getElementById('optimizationStatus');
        const statusInfo = document.getElementById('optimizationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-gray-200');
            statusCard.classList.add('border-purple-300', 'bg-purple-50');
            statusIcon.classList.remove('text-gray-600');
            statusIcon.classList.add('text-purple-600');
            statusText.textContent = 'Aktiv';
            statusText.classList.remove('text-gray-600');
            statusText.classList.add('text-purple-600');
            
            // Strategie-Namen für Info
            const strategyNames = {
                'pso': 'Particle Swarm Optimization',
                'multi_objective': 'Multi-Objective Optimierung',
                'cycle_optimization': 'Zyklenoptimierung',
                'cluster_dispatch': 'Cluster-Based Dispatch',
                'none': 'Keine Optimierung'
            };
            statusInfo.textContent = strategyNames[strategy] || 'Optimierung aktiv';
        }
        
        // Strategie anzeigen
        if (document.getElementById('optimizationStrategy')) {
            const strategyLabels = {
                'pso': 'PSO',
                'multi_objective': 'Multi-Obj',
                'cycle_optimization': 'Cycle Opt',
                'cluster_dispatch': 'Cluster',
                'none': '-'
            };
            document.getElementById('optimizationStrategy').textContent = strategyLabels[strategy] || strategy;
        }
        
        // Erlös-Boost
        if (document.getElementById('optimizationRevenueBoost')) {
            document.getElementById('optimizationRevenueBoost').textContent = revenueBoost.toFixed(1);
        }
        
        // Preis-Volatilität
        if (document.getElementById('optimizationPriceVolatility')) {
            document.getElementById('optimizationPriceVolatility').textContent = priceVolatility.toFixed(1);
        }
        
        // Optimierungs-Benefit
        if (document.getElementById('optimizationBenefit')) {
            document.getElementById('optimizationBenefit').textContent = formatCurrency(optimizationBenefit) || '0';
        }
        
        // Strategie-Details - Beschreibung in optimizationDetails
        if (document.getElementById('optimizationDetails')) {
            const strategyDescriptions = {
                'pso': 'Schwarm-basierte Optimierung',
                'multi_objective': 'Erlös + Degradation',
                'cycle_optimization': 'Battery Health',
                'cluster_dispatch': 'Preis-Cluster',
                'none': 'Keine Details'
            };
            document.getElementById('optimizationDetails').textContent = strategyDescriptions[strategy] || 'Optimierung aktiv';
        }
        
        // Strategie-Details - Beschreibung in optimizationDescription
        if (document.getElementById('optimizationDescription')) {
            document.getElementById('optimizationDescription').textContent = 
                `+${revenueBoost.toFixed(1)}% Mehrertrag durch intelligente Strategien`;
        }
        
        // EXTREMPREIS-SZENARIEN & SPREAD WIDTH Kennzahlen
        const spreadWidthEurMwh = data.spread_width_eur_mwh || 0.0;
        const spreadWidthPercent = data.spread_width_percent || 0.0;
        const negativePriceCount = data.negative_price_count || 0;
        const extremePeakCount = data.extreme_peak_count || 0;
        const minPrice = data.min_price_eur_mwh || 0.0;
        const maxPrice = data.max_price_eur_mwh || 0.0;
        
        // Spread Width anzeigen
        if (document.getElementById('spreadWidthEurMwh')) {
            document.getElementById('spreadWidthEurMwh').textContent = spreadWidthEurMwh.toFixed(2);
        }
        if (document.getElementById('spreadWidthPercent')) {
            document.getElementById('spreadWidthPercent').textContent = spreadWidthPercent.toFixed(1);
        }
        
        // Negative Preise
        if (document.getElementById('negativePriceCount')) {
            document.getElementById('negativePriceCount').textContent = negativePriceCount.toLocaleString('de-DE');
        }
        
        // Extreme Peaks
        if (document.getElementById('extremePeakCount')) {
            document.getElementById('extremePeakCount').textContent = extremePeakCount.toLocaleString('de-DE');
        }
        
        // Min/Max Preise
        if (document.getElementById('minPriceEurMwh')) {
            document.getElementById('minPriceEurMwh').textContent = minPrice.toFixed(2);
        }
        if (document.getElementById('maxPriceEurMwh')) {
            document.getElementById('maxPriceEurMwh').textContent = maxPrice.toFixed(2);
        }
    } else {
        optimizationSection.classList.add('hidden');
        
        // Status auf "Inaktiv" setzen
        const statusCard = document.getElementById('optimizationStatusCard');
        const statusIcon = document.getElementById('optimizationIcon');
        const statusText = document.getElementById('optimizationStatus');
        const statusInfo = document.getElementById('optimizationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-purple-300', 'bg-purple-50');
            statusCard.classList.add('border-gray-200');
            statusIcon.classList.remove('text-purple-600');
            statusIcon.classList.add('text-gray-600');
            statusText.textContent = 'Inaktiv';
            statusText.classList.remove('text-purple-600');
            statusText.classList.add('text-gray-600');
            statusInfo.textContent = 'Optimierung deaktiviert';
        }
    }
    
    // Toggle Switch aktualisieren
    const toggle = document.getElementById('optimizationToggle');
    const toggleLabel = document.getElementById('optimizationToggleLabel');
    if (toggle) {
        toggle.checked = isOptimizationEnabled;
    }
    if (toggleLabel) {
        toggleLabel.textContent = isOptimizationEnabled ? 'Aktiv' : 'Inaktiv';
    }
    
    console.log('✅ Optimierungs-Metriken aktualisiert');
}

// Optimierung aktivieren/deaktivieren (Simulation Tab)
async function toggleOptimization() {
    const projectId = getCurrentProjectId();
    if (!projectId) {
        alert('Bitte wählen Sie zuerst ein Projekt aus');
        const toggle = document.getElementById('optimizationToggle');
        if (toggle) toggle.checked = !toggle.checked; // Rückgängig machen
        return;
    }
    
    const toggle = document.getElementById('optimizationToggle');
    const isEnabled = toggle.checked;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/optimization-config`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                optimization_enabled: isEnabled
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const toggleLabel = document.getElementById('optimizationToggleLabel');
            if (toggleLabel) {
                toggleLabel.textContent = isEnabled ? 'Aktiv' : 'Inaktiv';
            }
            
            // Erfolgsmeldung
            showSuccessMessage(isEnabled ? 'Optimierung aktiviert' : 'Optimierung deaktiviert');
            
            // Metriken neu laden, wenn Simulation bereits gelaufen ist
            if (window.currentSimulationResults) {
                // Lade aktualisierte Konfiguration
                const configResponse = await fetch(`/api/projects/${projectId}/optimization-config`);
                const configData = await configResponse.json();
                if (configData.success) {
                    // Aktualisiere Anzeige
                    displayOptimizationMetrics({
                        optimization_enabled: isEnabled,
                        optimization_strategy: configData.config.preferred_strategy || 'none',
                        optimization_revenue_boost_percent: 0.0,
                        optimization_price_volatility: 0.0,
                        optimization_benefit_eur: 0.0
                    });
                }
            }
        } else {
            alert('Fehler beim Aktualisieren der Optimierung: ' + (data.error || 'Unbekannter Fehler'));
            toggle.checked = !isEnabled; // Rückgängig machen
        }
    } catch (error) {
        console.error('Fehler beim Aktivieren/Deaktivieren der Optimierung:', error);
        alert('Fehler beim Aktivieren/Deaktivieren der Optimierung');
        toggle.checked = !isEnabled; // Rückgängig machen
    }
}

// Optimierung aktivieren/deaktivieren (Dashboard Tab)
async function toggleDashboardOptimization() {
    const projectId = getCurrentProjectId();
    if (!projectId) {
        alert('Bitte wählen Sie zuerst ein Projekt aus');
        const toggle = document.getElementById('dashboardOptimizationToggle');
        if (toggle) toggle.checked = !toggle.checked; // Rückgängig machen
        return;
    }
    
    const toggle = document.getElementById('dashboardOptimizationToggle');
    const isEnabled = toggle.checked;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/optimization-config`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                optimization_enabled: isEnabled
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const toggleLabel = document.getElementById('dashboardOptimizationToggleLabel');
            if (toggleLabel) {
                toggleLabel.textContent = isEnabled ? 'Aktiv' : 'Inaktiv';
            }
            
            // Erfolgsmeldung
            showSuccessMessage(isEnabled ? 'Optimierung aktiviert' : 'Optimierung deaktiviert');
            
            // Metriken neu laden, wenn Dashboard bereits geladen ist
            if (window.currentDashboardResults) {
                // Lade aktualisierte Konfiguration
                const configResponse = await fetch(`/api/projects/${projectId}/optimization-config`);
                const configData = await configResponse.json();
                if (configData.success) {
                    // Aktualisiere Anzeige
                    updateDashboardOptimizationMetrics({
                        optimization_enabled: isEnabled,
                        optimization_strategy: configData.config.preferred_strategy || 'none',
                        optimization_revenue_boost_percent: 0.0,
                        optimization_price_volatility: 0.0,
                        optimization_benefit_eur: 0.0
                    });
                }
            }
        } else {
            alert('Fehler beim Aktualisieren der Optimierung: ' + (data.error || 'Unbekannter Fehler'));
            toggle.checked = !isEnabled; // Rückgängig machen
        }
    } catch (error) {
        console.error('Fehler beim Aktivieren/Deaktivieren der Optimierung:', error);
        alert('Fehler beim Aktivieren/Deaktivieren der Optimierung');
        toggle.checked = !isEnabled; // Rückgängig machen
    }
}

// 10-Jahres-Analyse anzeigen
function display10YearAnalysis(data) {
    // Erweiterte Metriken
    document.getElementById('totalRevenues').textContent = formatCurrency(data.total_revenues) || '-';
    document.getElementById('totalNetCashflow').textContent = formatCurrency(data.total_net_cashflow) || '-';
    document.getElementById('npv').textContent = formatCurrency(data.npv) || '-';
    document.getElementById('irr').textContent = data.irr?.toFixed(1) || '-';
    
    // ROADMAP STUFE 1: Erweiterte Kennzahlen aus 10-Jahres-Analyse
    if (data.roadmap_stufe1) {
        displayRoadmapStufe1Summary(data.roadmap_stufe1);
    }
    
    // Charts erstellen
    createCashflowChart(data);
    createDegradationChart(data);
    
    // 10-Jahres-Analyse anzeigen
    document.getElementById('tenYearAnalysis').classList.remove('hidden');
}

// ROADMAP STUFE 1: Zusammenfassung der 10-Jahres-Analyse anzeigen
function displayRoadmapStufe1Summary(roadmapData) {
    // Erstelle oder aktualisiere Zusammenfassungs-Sektion
    let summarySection = document.getElementById('roadmapStufe1Summary');
    if (!summarySection) {
        summarySection = document.createElement('div');
        summarySection.id = 'roadmapStufe1Summary';
        summarySection.className = 'bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border-2 border-purple-200';
        summarySection.innerHTML = `
            <div class="flex items-center mb-4">
                <i class="fas fa-chart-line text-purple-600 text-2xl mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-900">10-Jahres-Zusammenfassung (Roadmap Stufe 1)</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-red-200">
                    <div class="text-2xl font-bold text-red-600" id="totalRevenueLoss10y">-</div>
                    <div class="text-sm text-gray-600 font-medium">Erlösverlust (10J)</div>
                    <div class="text-xs text-gray-500 mt-1">Durch Restriktionen</div>
                </div>
                <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-green-200">
                    <div class="text-2xl font-bold text-green-600" id="finalSoH">-</div>
                    <div class="text-sm text-gray-600 font-medium">Finaler SoH</div>
                    <div class="text-xs text-gray-500 mt-1">Nach 10 Jahren</div>
                </div>
                <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-blue-200">
                    <div class="text-2xl font-bold text-blue-600" id="finalCapacity">-</div>
                    <div class="text-sm text-gray-600 font-medium">Finale Kapazität</div>
                    <div class="text-xs text-gray-500 mt-1">Nach 10 Jahren</div>
                </div>
                <div class="text-center p-4 bg-white rounded-lg shadow-sm border border-orange-200">
                    <div class="text-2xl font-bold text-orange-600" id="totalCapacityLoss10y">-</div>
                    <div class="text-sm text-gray-600 font-medium">Gesamtverlust (10J)</div>
                    <div class="text-xs text-gray-500 mt-1">Kapazitätsverlust</div>
                </div>
            </div>
        `;
        // Füge vor den Charts ein
        const tenYearSection = document.getElementById('tenYearAnalysis');
        if (tenYearSection) {
            tenYearSection.insertBefore(summarySection, tenYearSection.firstChild);
        }
    }
    
    // Werte aktualisieren
    if (document.getElementById('totalRevenueLoss10y')) {
        document.getElementById('totalRevenueLoss10y').textContent = formatCurrency(roadmapData.total_revenue_loss_restrictions_10y || 0) || '0 €';
    }
    if (document.getElementById('finalSoH')) {
        document.getElementById('finalSoH').textContent = (roadmapData.final_state_of_health || 0).toFixed(1) + '%';
    }
    if (document.getElementById('finalCapacity')) {
        document.getElementById('finalCapacity').textContent = (roadmapData.final_capacity_kwh || 0).toFixed(0) + ' kWh';
    }
    if (document.getElementById('totalCapacityLoss10y')) {
        document.getElementById('totalCapacityLoss10y').textContent = (roadmapData.total_capacity_loss_kwh || 0).toFixed(0) + ' kWh';
    }
}

// Chart-Funktionen
function createAnnualBalanceChart(data) {
    const ctx = document.getElementById('annualBalanceChart').getContext('2d');
    
    if (charts.annualBalance) {
        charts.annualBalance.destroy();
    }
    
    charts.annualBalance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Verbrauch', 'Erzeugung', 'Netto'],
            datasets: [{
                label: 'MWh/a',
                data: [
                    data.annual_consumption || 0,
                    data.annual_generation || 0,
                    (data.annual_consumption || 0) - (data.annual_generation || 0)
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6'],
                borderColor: ['#2563EB', '#059669', '#7C3AED'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createRevenueComponentsChart(data) {
    const ctx = document.getElementById('revenueComponentsChart').getContext('2d');
    
    if (charts.revenueComponents) {
        charts.revenueComponents.destroy();
    }
    
    charts.revenueComponents = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Arbitrage', 'SRL+', 'SRL-', 'Day-Ahead'],
            datasets: [{
                data: [
                    data.arbitrage_revenue || 0,
                    data.srl_positive_revenue || 0,
                    data.srl_negative_revenue || 0,
                    data.day_ahead_revenue || 0
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createCashflowChart(data) {
    const ctx = document.getElementById('cashflowChart').getContext('2d');
    
    if (charts.cashflow) {
        charts.cashflow.destroy();
    }
    
    const years = Array.from({length: 10}, (_, i) => 2024 + i);
    
    charts.cashflow = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Jährlicher Cashflow (EUR)',
                data: data.cashflow_data || Array(10).fill(0),
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createDegradationChart(data) {
    const ctx = document.getElementById('degradationChart').getContext('2d');
    
    if (charts.degradation) {
        charts.degradation.destroy();
    }
    
    const years = Array.from({length: 10}, (_, i) => 2024 + i);
    
    charts.degradation = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Batterie-Kapazität (%)',
                data: data.degradation_data || Array(10).fill(100),
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Loading-Funktionen
function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

// Tab-Funktionalität
function switchTab(tabName) {
    // Tab-Buttons aktualisieren
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Aktiven Tab markieren
    if (tabName === 'simulation') {
        document.getElementById('simulationTab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById('simulationTab').classList.remove('border-transparent', 'text-gray-500');
    } else if (tabName === 'dashboard') {
        document.getElementById('dashboardTab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById('dashboardTab').classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Tab-Inhalte ein-/ausblenden
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    if (tabName === 'simulation') {
        document.getElementById('simulationContent').classList.remove('hidden');
    } else if (tabName === 'dashboard') {
        document.getElementById('dashboardContent').classList.remove('hidden');
        // Dashboard-Projekte laden
        loadDashboardProjects();
        
        // Charts initialisieren wenn Dashboard aktiv wird
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('🔄 Initialisiere Dashboard-Charts...');
                initializeDashboardCharts();
                
                // Test-Daten laden wenn Dashboard aktiv wird
                setTimeout(() => {
                    console.log('📊 Lade Test-Daten für Dashboard-Charts');
                    loadTestChartData();
                }, 500);
            } else {
                console.error('❌ Chart.js nicht verfügbar beim Tab-Wechsel!');
            }
        }, 500);
    }
}

// Dashboard-Projekte laden
async function loadDashboardProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const select = document.getElementById('dashboardProjectSelect');
        select.innerHTML = '<option value="">Projekt auswählen...</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = `${project.name} (${project.location || 'Kein Standort'})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Dashboard-Projekte:', error);
    }
}

// Dashboard-Projekt laden
async function loadDashboardProject() {
    const projectId = document.getElementById('dashboardProjectSelect').value;
    if (projectId) {
        document.getElementById('enhancedDashboard').classList.remove('hidden');
        
        // Use Cases für Dashboard-Projekt laden
        await loadDashboardUseCases(projectId);
        
        // ROADMAP STUFE 2.2: Lade Optimierungs-Konfiguration und initialisiere Toggle
        loadOptimizationConfig(projectId);
        
        // Dashboard mit Standarddaten initialisieren
        initializeDashboard();
    } else {
        document.getElementById('enhancedDashboard').classList.add('hidden');
    }
}

// Use Cases für Dashboard-Projekt laden
async function loadDashboardUseCases(projectId) {
    try {
        const response = await fetch(`/api/projects/${projectId}/use-cases`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const useCases = await response.json();
        console.log('📊 Dashboard Use Cases geladen:', useCases);
        
        // Use Case-Dropdown im Dashboard aktualisieren
        const dashboardUseCaseSelect = document.getElementById('dashboardUseCase');
        if (dashboardUseCaseSelect) {
            // Sortiere Use Cases nach Name
            const sortedUseCases = useCases.sort((a, b) => a.name.localeCompare(b.name));
            
            // Lösche alte Optionen
            dashboardUseCaseSelect.innerHTML = '<option value="">Use Case auswählen...</option>';
            
            // Füge Use Cases hinzu
            sortedUseCases.forEach(uc => {
                const option = document.createElement('option');
                option.value = uc.name;
                
                // Beschreibung für Option
                let description = uc.description || '';
                if (!description) {
                    if (uc.name === 'UC1') {
                        description = 'Verbrauch ohne Eigenerzeugung';
                    } else if (uc.name === 'UC2') {
                        const pvPower = uc.pv_power_mwp ? `${uc.pv_power_mwp.toFixed(2)} MWp` : '0 MWp';
                        description = `PV + Verbrauch (${pvPower})`;
                    } else if (uc.name === 'UC3') {
                        description = 'PV + Hydro + Verbrauch';
                    }
                }
                
                option.textContent = `${uc.name} - ${description}`;
                dashboardUseCaseSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Fehler beim Laden der Dashboard Use Cases:', error);
    }
}

// Dashboard initialisieren
function initializeDashboard() {
    // Standarddaten für Dashboard
    updateDashboard('UC1');
    
    // Charts initialisieren
    initializeDashboardCharts();
    
    // Test-Daten für Charts laden
    setTimeout(() => {
        loadTestChartData();
    }, 1000);
}

// Test-Daten für Charts laden
function loadTestChartData() {
    console.log('📊 Lade Test-Daten für Charts...');
    
    // Prüfe ob Charts initialisiert sind
    if (!dashboardCharts.monthly || !dashboardCharts.co2 || !dashboardCharts.seasonal || !dashboardCharts.soc || !dashboardCharts.revenue) {
        console.log('⚠️ Charts noch nicht initialisiert - initialisiere sie zuerst');
        initializeDashboardCharts();
        setTimeout(() => loadTestChartData(), 500);
        return;
    }
    
    const testData = {
        monthly_data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            strombezug: [120, 110, 95, 85, 75, 70, 65, 60, 80, 90, 105, 115],
            stromverkauf: [80, 85, 90, 95, 100, 105, 110, 115, 95, 85, 75, 70],
            pv_erzeugung: [60, 100, 160, 240, 320, 380, 400, 380, 300, 200, 100, 60]
        },
        co2_savings: 1250,
        bess_efficiency: 85.5,
        soc_profile: Array.from({length: 24}, (_, i) => ({
            hour: i,
            soc: 60 + 20 * Math.sin(i * Math.PI / 12) + (Math.random() - 0.5) * 10
        }))
    };
    
    // Charts mit Test-Daten aktualisieren
    try {
        console.log('🔄 Aktualisiere Monthly Chart...');
        updateMonthlyChart(testData.monthly_data);
        
        console.log('🔄 Aktualisiere CO2 Chart...');
        updateCo2Chart([testData.co2_savings, 400]);
        
        console.log('🔄 Aktualisiere Seasonal Chart...');
        updateSeasonalChart([0.8, 1.0, 1.2, 0.9]);
        
        console.log('🔄 Aktualisiere SOC Chart...');
        updateSocChart(testData.soc_profile);
        
        console.log('🔄 Aktualisiere Revenue Chart...');
        updateRevenueChart([28000, 8500, 5000, -12000, -8000]);
        
        console.log('✅ Test-Daten für Charts erfolgreich geladen');
        
        // Debug: Zeige Chart-Status
        console.log('📊 Chart-Status:', {
            monthly: !!dashboardCharts.monthly,
            co2: !!dashboardCharts.co2,
            seasonal: !!dashboardCharts.seasonal,
            soc: !!dashboardCharts.soc,
            revenue: !!dashboardCharts.revenue
        });
        
    } catch (error) {
        console.error('❌ Fehler beim Laden der Test-Daten:', error);
        // Fallback: Charts neu initialisieren
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('🔄 Fallback: Charts neu initialisieren');
                initializeDashboardCharts();
                setTimeout(() => loadTestChartData(), 500);
            }
        }, 1000);
    }
}

// Dashboard-Charts initialisieren
function initializeDashboardCharts() {
    console.log('🔄 Initialisiere Dashboard-Charts...');
    
    try {
        // Bestehende Charts zerstören
        destroyExistingCharts();
        
        // Chart.js Konfiguration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#7f8c8d';
        
        // Farbpalette
        const colors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#27ae60',
            warning: '#f39c12',
            danger: '#e74c3c',
            info: '#3498db',
            light: '#ecf0f1',
            dark: '#2c3e50'
        };
        
        // Charts initialisieren
        console.log('🔄 Initialisiere Monthly Chart...');
        initializeMonthlyChart(colors);
        
        console.log('🔄 Initialisiere CO2 Chart...');
        initializeCo2Chart(colors);
        
        console.log('🔄 Initialisiere Seasonal Chart...');
        initializeSeasonalChart(colors);
        
        console.log('🔄 Initialisiere SOC Chart...');
        initializeSocChart(colors);
        
        console.log('🔄 Initialisiere Revenue Chart...');
        initializeRevenueChart(colors);
        
        console.log('✅ Dashboard-Charts erfolgreich initialisiert');
        
        // Debug: Zeige Chart-Status
        setTimeout(() => {
            console.log('📊 Chart-Status nach Initialisierung:', {
                monthly: !!dashboardCharts.monthly,
                co2: !!dashboardCharts.co2,
                seasonal: !!dashboardCharts.seasonal,
                soc: !!dashboardCharts.soc,
                revenue: !!dashboardCharts.revenue
            });
        }, 100);
        
    } catch (error) {
        console.error('❌ Fehler bei der Chart-Initialisierung:', error);
    }
}

// Bestehende Charts zerstören
function destroyExistingCharts() {
    console.log('🗑️ Zerstöre bestehende Charts...');
    
    if (dashboardCharts.monthly) {
        dashboardCharts.monthly.destroy();
        dashboardCharts.monthly = null;
    }
    if (dashboardCharts.co2) {
        dashboardCharts.co2.destroy();
        dashboardCharts.co2 = null;
    }
    if (dashboardCharts.seasonal) {
        dashboardCharts.seasonal.destroy();
        dashboardCharts.seasonal = null;
    }
    if (dashboardCharts.soc) {
        dashboardCharts.soc.destroy();
        dashboardCharts.soc = null;
    }
    if (dashboardCharts.revenue) {
        dashboardCharts.revenue.destroy();
        dashboardCharts.revenue = null;
    }
    
    console.log('✅ Bestehende Charts zerstört');
}

// Monatliche Auswertung Chart
function initializeMonthlyChart(colors) {
    const ctx = document.getElementById('dashboardMonthlyChart').getContext('2d');
    dashboardCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Strombezug (MWh)',
                    data: [],
                    borderColor: colors.danger,
                    backgroundColor: colors.danger + '20',
                    tension: 0.4
                },
                {
                    label: 'Stromverkauf (MWh)',
                    data: [],
                    borderColor: colors.success,
                    backgroundColor: colors.success + '20',
                    tension: 0.4
                },
                {
                    label: 'PV-Erzeugung (MWh)',
                    data: [],
                    borderColor: colors.warning,
                    backgroundColor: colors.warning + '20',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// CO₂-Bilanz Chart
function initializeCo2Chart(colors) {
    const ctx = document.getElementById('dashboardCo2Chart').getContext('2d');
    dashboardCharts.co2 = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['CO₂-Einsparung', 'CO₂-Emission'],
            datasets: [{
                data: [1250, 400],
                backgroundColor: [colors.success, colors.danger],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

// Saisonale Performance Chart
function initializeSeasonalChart(colors) {
    const ctx = document.getElementById('dashboardSeasonalChart').getContext('2d');
    dashboardCharts.seasonal = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Winter', 'Frühling', 'Sommer', 'Herbst'],
            datasets: [{
                label: 'Performance-Faktor',
                data: [0.8, 1.0, 1.2, 0.9],
                borderColor: colors.primary,
                backgroundColor: colors.primary + '20',
                pointBackgroundColor: colors.primary
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 1.5
                }
            }
        }
    });
}

// SOC-Profil Chart
function initializeSocChart(colors) {
    const ctx = document.getElementById('dashboardSocChart').getContext('2d');
    dashboardCharts.soc = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'SOC (%)',
                data: [],
                borderColor: colors.info,
                backgroundColor: colors.info + '20',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Erlösaufschlüsselung Chart
function initializeRevenueChart(colors) {
    const ctx = document.getElementById('dashboardRevenueChart').getContext('2d');
    dashboardCharts.revenue = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Spot-Markt', 'Regelreserve', 'Förderung', 'Netzentgelte', 'Betriebskosten'],
            datasets: [{
                label: 'Erlöse (EUR)',
                data: [28000, 8500, 5000, -12000, -8000],
                backgroundColor: [
                    colors.success,
                    colors.info,
                    colors.warning,
                    colors.danger,
                    colors.danger
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Dashboard-Simulation starten
async function runDashboardSimulation() {
    const projectId = document.getElementById('dashboardProjectSelect').value;
    const useCaseSelect = document.getElementById('dashboardUseCase');
    const useCase = useCaseSelect ? useCaseSelect.value : '';
    const bessMode = document.getElementById('dashboardBessMode').value;
    const optimizationTarget = document.getElementById('dashboardOptimizationTarget').value;
    const spotPriceScenario = document.getElementById('dashboardSpotPriceScenario').value;
    
    if (!projectId) {
        alert('Bitte wählen Sie ein Projekt für die Dashboard-Analyse aus.');
        return;
    }
    
    if (!useCase || useCase.trim() === '') {
        alert('Bitte wählen Sie einen Use Case aus.');
        return;
    }
    
    // Extrahiere nur den Use Case-Namen (z.B. "UC2" aus "BORBET UC2 Batterie + PV - Beschreibung")
    let useCaseName = useCase.trim();
    
    // Versuche, UC1, UC2 oder UC3 aus dem Text zu extrahieren
    // Mögliche Formate:
    // - "UC2" (direkt)
    // - "BORBET UC2 Batterie + PV - Beschreibung"
    // - "UC2 - Beschreibung"
    const ucMatch = useCaseName.match(/\b(UC[123])\b/i);
    if (ucMatch) {
        useCaseName = ucMatch[1].toUpperCase(); // UC1, UC2 oder UC3
    } else if (useCaseName.includes(' - ')) {
        // Fallback: Nimm den Teil vor " - "
        useCaseName = useCaseName.split(' - ')[0].trim();
        // Versuche nochmal, UC1/UC2/UC3 zu finden
        const ucMatch2 = useCaseName.match(/\b(UC[123])\b/i);
        if (ucMatch2) {
            useCaseName = ucMatch2[1].toUpperCase();
        }
    }
    
    // Validiere, dass es ein gültiger Use Case ist
    if (!['UC1', 'UC2', 'UC3'].includes(useCaseName)) {
        alert(`Ungültiger Use Case: "${useCase}" (extrahiert: "${useCaseName}"). Bitte wählen Sie UC1, UC2 oder UC3.`);
        console.error('❌ Use Case-Extraktion fehlgeschlagen:', {
            original: useCase,
            extracted: useCaseName
        });
        return;
    }
    
    console.log('🚀 Dashboard-Simulation gestartet:', {
        projectId,
        useCase: useCaseName,
        originalUseCase: useCase,
        bessMode,
        optimizationTarget,
        spotPriceScenario
    });
    
    showLoading();
    
    try {
        // 1. Lade Projektdaten
        const projectResponse = await fetch(`/api/projects/${projectId}`);
        const project = await projectResponse.json();
        
        // 2. Führe normale Simulation durch
        const simulationData = {
            project_id: projectId,
            use_case: useCaseName,  // Verwende den validierten Use Case-Namen
            simulation_year: new Date().getFullYear(),
            bess_size: project.bess_size || 1000,
            bess_power: project.bess_power || 500,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        const simulationResponse = await fetch('/api/simulation/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(simulationData)
        });
        
        if (!simulationResponse.ok) {
            const errorData = await simulationResponse.json().catch(() => ({ error: 'Unbekannter Fehler' }));
            const errorMessage = errorData.error || `HTTP ${simulationResponse.status}: ${simulationResponse.statusText}`;
            console.error('❌ Simulation-Fehler:', errorMessage);
            throw new Error(errorMessage);
        }
        
        const simulationResults = await simulationResponse.json();
        
        if (simulationResults.error) {
            console.error('❌ Simulation-Ergebnis-Fehler:', simulationResults.error);
            throw new Error(simulationResults.error);
        }
        
        console.log('✅ Simulation erfolgreich:', simulationResults);
        
        // 3. Führe 10-Jahres-Analyse durch
        const analysisData = {
            project_id: projectId,
            use_case: useCaseName,  // Verwende den validierten Use Case-Namen
            bess_size: project.bess_size || 1000,
            bess_power: project.bess_power || 500,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        const analysisResponse = await fetch('/api/simulation/10-year-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(analysisData)
        });
        
        if (!analysisResponse.ok) {
            const errorData = await analysisResponse.json().catch(() => ({ error: 'Unbekannter Fehler' }));
            throw new Error(errorData.error || `HTTP ${analysisResponse.status}: ${analysisResponse.statusText}`);
        }
        
        const analysisResults = await analysisResponse.json();
        
        if (analysisResults.error) {
            throw new Error(analysisResults.error);
        }
        
        // 4. Kombiniere Ergebnisse und aktualisiere Dashboard
        const combinedResults = {
            ...simulationResults,
            ten_year_analysis: analysisResults,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        // Speichere Dashboard-Ergebnisse für Export
        window.currentDashboardResults = {
            project_id: projectId,
            use_case: useCase,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario,
            simulation_results: simulationResults,
            ten_year_analysis: analysisResults,
            dashboard_metrics: {
                eigenverbrauchsquote: combinedResults.eigenverbrauchsquote,
                co2_savings: combinedResults.co2_savings,
                netto_erloes: combinedResults.netto_erloes,
                bess_efficiency: combinedResults.bess_efficiency,
                spot_revenue: combinedResults.spot_revenue,
                regelreserve_revenue: combinedResults.regelreserve_revenue
            }
        };
        
        updateEnhancedDashboard(combinedResults, project);
        
        // Animation für bessere UX
        document.querySelectorAll('#enhancedDashboard .metric-card .text-3xl').forEach(el => {
            el.style.transform = 'scale(1.1)';
            setTimeout(() => {
                el.style.transform = 'scale(1)';
            }, 200);
        });
        
    } catch (error) {
        console.error('Fehler bei der Dashboard-Simulation:', error);
        const errorMessage = error.message || 'Unbekannter Fehler';
        alert(`Fehler bei der Dashboard-Simulation:\n\n${errorMessage}\n\nBitte versuchen Sie es erneut oder kontaktieren Sie den Support.`);
    } finally {
        hideLoading();
    }
}

// Dashboard aktualisieren (Legacy-Funktion für Use Case Dropdown)
function updateDashboard(useCase) {
    // Diese Funktion wird nur noch für das Use Case Dropdown verwendet
    // Die echte Dashboard-Aktualisierung erfolgt über updateEnhancedDashboard()
    console.log('Legacy updateDashboard aufgerufen für Use Case:', useCase);
    
    // Standarddaten für schnelle Vorschau
    const data = {
        eigenverbrauchsquote: 45.2,
        co2_savings: 1250,
        netto_erloes: 45000,
        bess_efficiency: 85.5,
        spot_revenue: 28000,
        regelreserve_revenue: 8500
    };
    
    // Kennzahlen aktualisieren
    document.getElementById('dashboardEigenverbrauchsquote').textContent = data.eigenverbrauchsquote.toFixed(1);
    document.getElementById('dashboardCo2Savings').textContent = data.co2_savings.toLocaleString();
    document.getElementById('dashboardNettoErloes').textContent = data.netto_erloes.toLocaleString();
    
    // ROADMAP STUFE 1: Erweiterte Kennzahlen im Dashboard anzeigen
    updateDashboardRoadmapStufe1Metrics(data);
    document.getElementById('dashboardBessEfficiency').textContent = data.bess_efficiency.toFixed(1);
    document.getElementById('dashboardSpotRevenue').textContent = data.spot_revenue.toLocaleString();
    document.getElementById('dashboardRegelreserveRevenue').textContent = data.regelreserve_revenue.toLocaleString();
}

// Erweitertes Dashboard mit echten Daten aktualisieren
function updateEnhancedDashboard(results, project) {
    console.log('📊 Aktualisiere Enhanced Dashboard mit:', results);
    
    // Basis-Kennzahlen aus Simulation
    document.getElementById('dashboardEigenverbrauchsquote').textContent = 
        results.eigenverbrauchsquote?.toFixed(1) || '--';
    document.getElementById('dashboardCo2Savings').textContent = 
        Math.round(results.co2_savings || 0).toLocaleString();
    document.getElementById('dashboardNettoErloes').textContent = 
        formatCurrency(results.netto_erloes || 0);
    document.getElementById('dashboardBessEfficiency').textContent = 
        (results.bess_efficiency || 85.0).toFixed(1);
    document.getElementById('dashboardSpotRevenue').textContent = 
        formatCurrency(results.spot_revenue || 0);
    document.getElementById('dashboardRegelreserveRevenue').textContent = 
        formatCurrency(results.regelreserve_revenue || 0);
    
    // 10-Jahres-Daten integrieren
    if (results.ten_year_analysis) {
        const tenYear = results.ten_year_analysis;
        
        // Erweiterte Metriken mit 10-Jahres-Daten
        document.getElementById('dashboardEigenverbrauchsquoteTrend').textContent = 
            `↗ +${(tenYear.irr / 10).toFixed(1)}% (10J)`;
        document.getElementById('dashboardCo2SavingsTrend').textContent = 
            `↗ +${(tenYear.npv / 1000000).toFixed(1)} Mio. € NPV`;
        document.getElementById('dashboardNettoErloesTrend').textContent = 
            `↗ ${tenYear.irr?.toFixed(1) || '--'}% IRR`;
        document.getElementById('dashboardBessEfficiencyTrend').textContent = 
            `→ ${tenYear.payback_years?.toFixed(1) || '--'} Jahre`;
        document.getElementById('dashboardSpotRevenueTrend').textContent = 
            `↗ ${formatCurrency(tenYear.total_revenues || 0)}`;
        document.getElementById('dashboardRegelreserveRevenueTrend').textContent = 
            `↗ ${formatCurrency(tenYear.total_net_cashflow || 0)}`;
    }
    
    // ROADMAP STUFE 1: Erweiterte Kennzahlen im Dashboard anzeigen
    updateDashboardRoadmapStufe1Metrics(results);
    
    // ROADMAP STUFE 2.1: Co-Location Kennzahlen im Dashboard anzeigen
    updateDashboardCoLocationMetrics(results);
    
    // ROADMAP STUFE 2.2: Optimierte Regelstrategien Kennzahlen im Dashboard anzeigen
    updateDashboardOptimizationMetrics(results);
    
    // BESS-Modus spezifische Anpassungen
    updateBessModeSpecificData(results.bess_mode, results);
    
    // Charts mit echten Daten aktualisieren
    updateEnhancedDashboardCharts(results, project);
}

// ROADMAP STUFE 1: Erweiterte Kennzahlen im Dashboard aktualisieren
function updateDashboardRoadmapStufe1Metrics(data) {
    // State of Health
    const soh = data.state_of_health || 100.0;
    if (document.getElementById('dashboardStateOfHealth')) {
        document.getElementById('dashboardStateOfHealth').textContent = soh.toFixed(1);
    }
    
    // Aktuelle Kapazität
    const currentCapacity = data.current_capacity_kwh || data.bess_size || 0;
    if (document.getElementById('dashboardCurrentCapacity')) {
        document.getElementById('dashboardCurrentCapacity').textContent = currentCapacity.toLocaleString('de-DE', {maximumFractionDigits: 0});
    }
    
    // Kapazitätsverlust
    const capacityLoss = data.capacity_loss_kwh || 0;
    if (document.getElementById('dashboardCapacityLoss')) {
        document.getElementById('dashboardCapacityLoss').textContent = capacityLoss.toLocaleString('de-DE', {maximumFractionDigits: 0});
    }
    
    // Erlösverlust durch Restriktionen
    const revenueLoss = data.revenue_loss_restrictions || 0;
    if (document.getElementById('dashboardRevenueLoss')) {
        document.getElementById('dashboardRevenueLoss').textContent = formatCurrency(revenueLoss) || '0 €';
    }
    
    // Second-Life Status
    const isSecondLife = data.is_second_life || false;
    const secondLifeCard = document.getElementById('dashboardSecondLifeCard');
    const secondLifeIcon = document.getElementById('dashboardSecondLifeIcon');
    const secondLifeStatus = document.getElementById('dashboardSecondLifeStatus');
    
    if (secondLifeCard && secondLifeIcon && secondLifeStatus) {
        if (isSecondLife) {
            secondLifeCard.classList.remove('border-gray-200');
            secondLifeCard.classList.add('border-green-300', 'bg-green-50');
            secondLifeIcon.classList.remove('text-gray-600');
            secondLifeIcon.classList.add('text-green-600');
            secondLifeStatus.textContent = 'Ja';
            secondLifeStatus.classList.remove('text-gray-600');
            secondLifeStatus.classList.add('text-green-600');
        } else {
            secondLifeCard.classList.remove('border-green-300', 'bg-green-50');
            secondLifeCard.classList.add('border-gray-200');
            secondLifeIcon.classList.remove('text-green-600');
            secondLifeIcon.classList.add('text-gray-600');
            secondLifeStatus.textContent = 'Nein';
            secondLifeStatus.classList.remove('text-green-600');
            secondLifeStatus.classList.add('text-gray-600');
        }
    }
    
    // Kostenvorteil Second-Life
    const costReduction = data.second_life_cost_reduction_percent || 0;
    const costCard = document.getElementById('dashboardCostReductionCard');
    if (costCard && document.getElementById('dashboardCostReduction')) {
        if (costReduction > 0) {
            document.getElementById('dashboardCostReduction').textContent = costReduction.toFixed(1);
            costCard.classList.remove('border-gray-200');
            costCard.classList.add('border-green-300', 'bg-green-50');
        } else {
            document.getElementById('dashboardCostReduction').textContent = '0.0';
            costCard.classList.remove('border-green-300', 'bg-green-50');
            costCard.classList.add('border-gray-200');
        }
    }
}

// ROADMAP STUFE 2.1: Co-Location Kennzahlen im Dashboard aktualisieren
function updateDashboardCoLocationMetrics(data) {
    console.log('📊 Aktualisiere Dashboard Co-Location Metriken:', data);
    
    const isCoLocation = data.is_co_location || false;
    
    // Co-Location-Sektion im Dashboard (falls vorhanden)
    const coLocationSection = document.getElementById('dashboardCoLocationSection');
    if (!coLocationSection) {
        // Sektion existiert nicht im Dashboard - das ist OK, Co-Location wird nur im Simulation-Tab angezeigt
        console.log('⚠️ dashboardCoLocationSection nicht gefunden');
        return;
    }
    
    if (isCoLocation) {
        coLocationSection.classList.remove('hidden');
        
        // Co-Location Status
        const statusCard = document.getElementById('dashboardCoLocationStatusCard');
        const statusIcon = document.getElementById('dashboardCoLocationIcon');
        const statusText = document.getElementById('dashboardCoLocationStatus');
        const statusInfo = document.getElementById('dashboardCoLocationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-gray-200');
            statusCard.classList.add('border-green-300', 'bg-green-50');
            statusIcon.classList.remove('text-gray-600');
            statusIcon.classList.add('text-green-600');
            statusText.textContent = 'Aktiv';
            statusText.classList.remove('text-gray-600');
            statusText.classList.add('text-green-600');
            statusInfo.textContent = 'PV + BESS Co-Location';
        }
        
        // Kennzahlen aktualisieren
        if (document.getElementById('dashboardPvUtilization')) {
            document.getElementById('dashboardPvUtilization').textContent = (data.pv_utilization_percent || 100.0).toFixed(1);
        }
        if (document.getElementById('dashboardAvoidedCurtailment')) {
            document.getElementById('dashboardAvoidedCurtailment').textContent = (data.avoided_curtailment_kw || 0.0).toFixed(0);
        }
        if (document.getElementById('dashboardSelfConsumptionRate')) {
            document.getElementById('dashboardSelfConsumptionRate').textContent = (data.self_consumption_rate_percent || 0.0).toFixed(1);
        }
        if (document.getElementById('dashboardCoLocationRevenueIncrease')) {
            document.getElementById('dashboardCoLocationRevenueIncrease').textContent = formatCurrency(data.co_location_revenue_increase_eur || 0.0) || '0';
        }
        if (document.getElementById('dashboardCoLocationCostSavings')) {
            document.getElementById('dashboardCoLocationCostSavings').textContent = formatCurrency(data.co_location_cost_savings_eur || 0.0) || '0';
        }
        if (document.getElementById('dashboardCoLocationTotalBenefit')) {
            document.getElementById('dashboardCoLocationTotalBenefit').textContent = formatCurrency(data.co_location_total_benefit_eur || 0.0) || '0';
        }
    } else {
        coLocationSection.classList.add('hidden');
        
        // Status auf "Inaktiv" setzen
        const statusCard = document.getElementById('dashboardCoLocationStatusCard');
        const statusIcon = document.getElementById('dashboardCoLocationIcon');
        const statusText = document.getElementById('dashboardCoLocationStatus');
        const statusInfo = document.getElementById('dashboardCoLocationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-green-300', 'bg-green-50');
            statusCard.classList.add('border-gray-200');
            statusIcon.classList.remove('text-green-600');
            statusIcon.classList.add('text-gray-600');
            statusText.textContent = 'Inaktiv';
            statusText.classList.remove('text-green-600');
            statusText.classList.add('text-gray-600');
            statusInfo.textContent = 'Keine Co-Location';
        }
    }
    
    console.log('✅ Dashboard Co-Location Metriken aktualisiert');
}

// ROADMAP STUFE 2.2: Optimierte Regelstrategien Kennzahlen im Dashboard aktualisieren
function updateDashboardOptimizationMetrics(data) {
    console.log('📊 Aktualisiere Dashboard Optimierungs-Metriken:', data);
    
    const isOptimizationEnabled = data.optimization_enabled || false;
    const strategy = data.optimization_strategy || 'none';
    const revenueBoost = data.optimization_revenue_boost_percent || 0.0;
    const priceVolatility = data.optimization_price_volatility || 0.0;
    const optimizationBenefit = data.optimization_benefit_eur || 0.0;
    
    // Optimierungs-Sektion im Dashboard
    const optimizationSection = document.getElementById('dashboardOptimizationSection');
    if (!optimizationSection) {
        console.log('⚠️ dashboardOptimizationSection nicht gefunden');
        return;
    }
    
    if (isOptimizationEnabled) {
        optimizationSection.classList.remove('hidden');
        
        // Optimierung Status
        const statusCard = document.getElementById('dashboardOptimizationStatusCard');
        const statusIcon = document.getElementById('dashboardOptimizationIcon');
        const statusText = document.getElementById('dashboardOptimizationStatus');
        const statusInfo = document.getElementById('dashboardOptimizationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-gray-200');
            statusCard.classList.add('border-purple-300', 'bg-purple-50');
            statusIcon.classList.remove('text-gray-600');
            statusIcon.classList.add('text-purple-600');
            statusText.textContent = 'Aktiv';
            statusText.classList.remove('text-gray-600');
            statusText.classList.add('text-purple-600');
            
            // Strategie-Namen für Info
            const strategyNames = {
                'pso': 'Particle Swarm Optimization',
                'multi_objective': 'Multi-Objective Optimierung',
                'cycle_optimization': 'Zyklenoptimierung',
                'cluster_dispatch': 'Cluster-Based Dispatch',
                'none': 'Keine Optimierung'
            };
            statusInfo.textContent = strategyNames[strategy] || 'Optimierung aktiv';
        }
        
        // Strategie anzeigen
        if (document.getElementById('dashboardOptimizationStrategy')) {
            const strategyLabels = {
                'pso': 'PSO',
                'multi_objective': 'Multi-Obj',
                'cycle_optimization': 'Cycle Opt',
                'cluster_dispatch': 'Cluster',
                'none': '-'
            };
            document.getElementById('dashboardOptimizationStrategy').textContent = strategyLabels[strategy] || strategy;
        }
        
        // Erlös-Boost
        if (document.getElementById('dashboardOptimizationRevenueBoost')) {
            document.getElementById('dashboardOptimizationRevenueBoost').textContent = revenueBoost.toFixed(1);
        }
        
        // Preis-Volatilität
        if (document.getElementById('dashboardOptimizationPriceVolatility')) {
            document.getElementById('dashboardOptimizationPriceVolatility').textContent = priceVolatility.toFixed(1);
        }
        
        // Optimierungs-Benefit
        if (document.getElementById('dashboardOptimizationBenefit')) {
            document.getElementById('dashboardOptimizationBenefit').textContent = formatCurrency(optimizationBenefit) || '0';
        }
        
        // Strategie-Details
        if (document.getElementById('dashboardOptimizationDetails')) {
            const strategyDescriptions = {
                'pso': 'Schwarm-basierte Optimierung',
                'multi_objective': 'Erlös + Degradation',
                'cycle_optimization': 'Battery Health',
                'cluster_dispatch': 'Preis-Cluster',
                'none': 'Keine Details'
            };
            document.getElementById('dashboardOptimizationDetails').textContent = strategyDescriptions[strategy] || 'Optimierung aktiv';
        }
        
        if (document.getElementById('dashboardOptimizationDescription')) {
            document.getElementById('dashboardOptimizationDescription').textContent = 
                `+${revenueBoost.toFixed(1)}% Mehrertrag durch intelligente Strategien`;
        }
        
        // EXTREMPREIS-SZENARIEN & SPREAD WIDTH Kennzahlen
        const spreadWidthEurMwh = data.spread_width_eur_mwh || 0.0;
        const spreadWidthPercent = data.spread_width_percent || 0.0;
        const negativePriceCount = data.negative_price_count || 0;
        const extremePeakCount = data.extreme_peak_count || 0;
        const minPrice = data.min_price_eur_mwh || 0.0;
        const maxPrice = data.max_price_eur_mwh || 0.0;
        
        // Spread Width anzeigen
        if (document.getElementById('dashboardSpreadWidthEurMwh')) {
            document.getElementById('dashboardSpreadWidthEurMwh').textContent = spreadWidthEurMwh.toFixed(2);
        }
        if (document.getElementById('dashboardSpreadWidthPercent')) {
            document.getElementById('dashboardSpreadWidthPercent').textContent = spreadWidthPercent.toFixed(1);
        }
        
        // Negative Preise
        if (document.getElementById('dashboardNegativePriceCount')) {
            document.getElementById('dashboardNegativePriceCount').textContent = negativePriceCount.toLocaleString('de-DE');
        }
        
        // Extreme Peaks
        if (document.getElementById('dashboardExtremePeakCount')) {
            document.getElementById('dashboardExtremePeakCount').textContent = extremePeakCount.toLocaleString('de-DE');
        }
        
        // Min/Max Preise
        if (document.getElementById('dashboardMinPriceEurMwh')) {
            document.getElementById('dashboardMinPriceEurMwh').textContent = minPrice.toFixed(2);
        }
        if (document.getElementById('dashboardMaxPriceEurMwh')) {
            document.getElementById('dashboardMaxPriceEurMwh').textContent = maxPrice.toFixed(2);
        }
    } else {
        optimizationSection.classList.add('hidden');
        
        // Status auf "Inaktiv" setzen
        const statusCard = document.getElementById('dashboardOptimizationStatusCard');
        const statusIcon = document.getElementById('dashboardOptimizationIcon');
        const statusText = document.getElementById('dashboardOptimizationStatus');
        const statusInfo = document.getElementById('dashboardOptimizationInfo');
        
        if (statusCard && statusIcon && statusText && statusInfo) {
            statusCard.classList.remove('border-purple-300', 'bg-purple-50');
            statusCard.classList.add('border-gray-200');
            statusIcon.classList.remove('text-purple-600');
            statusIcon.classList.add('text-gray-600');
            statusText.textContent = 'Inaktiv';
            statusText.classList.remove('text-purple-600');
            statusText.classList.add('text-gray-600');
            statusInfo.textContent = 'Optimierung deaktiviert';
        }
    }
    
    // Toggle Switch aktualisieren
    const toggle = document.getElementById('dashboardOptimizationToggle');
    const toggleLabel = document.getElementById('dashboardOptimizationToggleLabel');
    if (toggle) {
        toggle.checked = isOptimizationEnabled;
    }
    if (toggleLabel) {
        toggleLabel.textContent = isOptimizationEnabled ? 'Aktiv' : 'Inaktiv';
    }
    
    console.log('✅ Dashboard Optimierungs-Metriken aktualisiert');
}

// Lade Optimierungs-Konfiguration und initialisiere Toggle
async function loadOptimizationConfig(projectId) {
    if (!projectId) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/optimization-config`);
        const data = await response.json();
        
        if (data.success && data.config) {
            const isEnabled = data.config.optimization_enabled || false;
            
            // Toggle Switch im Simulation Tab
            const toggle = document.getElementById('optimizationToggle');
            const toggleLabel = document.getElementById('optimizationToggleLabel');
            if (toggle) {
                toggle.checked = isEnabled;
            }
            if (toggleLabel) {
                toggleLabel.textContent = isEnabled ? 'Aktiv' : 'Inaktiv';
            }
            
            // Toggle Switch im Dashboard Tab
            const dashboardToggle = document.getElementById('dashboardOptimizationToggle');
            const dashboardToggleLabel = document.getElementById('dashboardOptimizationToggleLabel');
            if (dashboardToggle) {
                dashboardToggle.checked = isEnabled;
            }
            if (dashboardToggleLabel) {
                dashboardToggleLabel.textContent = isEnabled ? 'Aktiv' : 'Inaktiv';
            }
        }
    } catch (error) {
        console.error('Fehler beim Laden der Optimierungs-Konfiguration:', error);
    }
}

// BESS-Modus spezifische Daten anpassen
function updateBessModeSpecificData(bessMode, results) {
    const modeInfo = {
        arbitrage: {
            name: 'Arbitrage',
            description: 'Strompreis-Differenz nutzen',
            efficiency_boost: 1.1,
            revenue_boost: 1.2
        },
        peak_shaving: {
            name: 'Peak Shaving',
            description: 'Spitzenlast reduzieren',
            efficiency_boost: 1.05,
            revenue_boost: 1.15
        },
        frequency_regulation: {
            name: 'Frequenzregelung',
            description: 'Netzstabilität unterstützen',
            efficiency_boost: 1.15,
            revenue_boost: 1.25
        },
        backup: {
            name: 'Backup',
            description: 'Notstromversorgung',
            efficiency_boost: 1.0,
            revenue_boost: 1.05
        }
    };
    
    const mode = modeInfo[bessMode] || modeInfo.arbitrage;
    
    // Zeige BESS-Modus Info
    const modeInfoElement = document.getElementById('bessModeInfo');
    if (modeInfoElement) {
        modeInfoElement.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-battery-three-quarters text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>${mode.name}:</strong> ${mode.description}
                        </p>
                        <p class="text-xs text-blue-600 mt-1">
                            Effizienz-Boost: +${((mode.efficiency_boost - 1) * 100).toFixed(1)}% | 
                            Erlös-Boost: +${((mode.revenue_boost - 1) * 100).toFixed(1)}%
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Erweiterte Dashboard-Charts mit echten Daten
function updateEnhancedDashboardCharts(results, project) {
    // Monatliche Auswertung mit echten Daten
    const monthlyData = generateMonthlyData(results, project);
    updateMonthlyChart(monthlyData);
    
    // CO₂-Bilanz mit echten Daten
    const co2Data = generateCo2Data(results);
    updateCo2Chart(co2Data);
    
    // Saisonale Performance mit echten Daten
    const seasonalData = generateSeasonalData(results);
    updateSeasonalChart(seasonalData);
    
    // SOC-Profil mit echten Daten
    const socData = generateSocData(results, results.bess_mode);
    updateSocChart(socData);
    
    // Erlösaufschlüsselung mit echten Daten
    const revenueData = generateRevenueData(results);
    updateRevenueChart(revenueData);
}

// Hilfsfunktionen für Chart-Daten
function generateMonthlyData(results, project) {
    // Verwende echte Simulationsergebnisse statt Projekt-Daten
    const annualConsumption = results.annual_consumption || 4380;
    const annualGeneration = results.annual_generation || 2190;
    const annualPvGeneration = results.annual_pv_generation || 1095;
    
    // BESS-Modus spezifische Anpassungen
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: { consumption_factor: 1.0, generation_factor: 1.2, pv_factor: 1.1 },
        peak_shaving: { consumption_factor: 0.9, generation_factor: 1.15, pv_factor: 1.05 },
        frequency_regulation: { consumption_factor: 1.1, generation_factor: 1.25, pv_factor: 1.15 },
        backup: { consumption_factor: 1.05, generation_factor: 1.05, pv_factor: 1.0 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    // Monatliche Verteilung mit saisonalen Faktoren
    const monthlyFactors = [1.2, 1.1, 1.0, 0.9, 0.8, 0.7, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2]; // Winter höher
    
    return {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        strombezug: monthlyFactors.map((factor, i) => 
            (annualConsumption / 12) * factor * mode.consumption_factor + (Math.random() - 0.5) * 50
        ),
        stromverkauf: monthlyFactors.map((factor, i) => 
            (annualGeneration / 12) * factor * mode.generation_factor + (Math.random() - 0.5) * 30
        ),
        pv_erzeugung: [60, 100, 160, 240, 320, 380, 400, 380, 300, 200, 100, 60]
    };
}

function generateCo2Data(results) {
    // Verwende echte CO₂-Daten aus der Simulation
    const savings = results.co2_savings || 1000;
    const emission = Math.round(savings * 0.32);
    
    // BESS-Modus spezifische Anpassung
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: 1.2,
        peak_shaving: 1.15,
        frequency_regulation: 1.25,
        backup: 1.05
    };
    
    const modeFactor = modeFactors[bessMode] || 1.0;
    return [Math.round(savings * modeFactor), emission];
}

function generateSeasonalData(results) {
    // BESS-Modus spezifische saisonale Performance
    const bessMode = results.bess_mode || 'arbitrage';
    const baseEfficiency = results.bess_efficiency / 100 || 0.85;
    
    const modeFactors = {
        arbitrage: { winter: 0.8, spring: 1.0, summer: 1.2, autumn: 0.9 },
        peak_shaving: { winter: 0.85, spring: 1.05, summer: 1.15, autumn: 0.95 },
        frequency_regulation: { winter: 0.75, spring: 1.1, summer: 1.25, autumn: 0.85 },
        backup: { winter: 0.9, spring: 0.95, summer: 1.0, autumn: 0.9 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return [
        baseEfficiency * mode.winter,  // Winter
        baseEfficiency * mode.spring,  // Frühling
        baseEfficiency * mode.summer,  // Sommer
        baseEfficiency * mode.autumn   // Herbst
    ];
}

function generateSocData(results, bessMode) {
    // BESS-Modus spezifische SOC-Profile
    const baseSoc = 60;
    const modeFactors = {
        arbitrage: { 
            amplitude: 30, 
            frequency: 1.2, 
            baseLevel: 60,
            pattern: 'arbitrage' // Zwei Spitzen pro Tag
        },
        peak_shaving: { 
            amplitude: 25, 
            frequency: 1.0, 
            baseLevel: 65,
            pattern: 'peak_shaving' // Morgens und abends
        },
        frequency_regulation: { 
            amplitude: 35, 
            frequency: 1.5, 
            baseLevel: 55,
            pattern: 'frequency' // Häufige Schwankungen
        },
        backup: { 
            amplitude: 15, 
            frequency: 0.8, 
            baseLevel: 80,
            pattern: 'backup' // Stabil hoch
        }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return Array.from({length: 24}, (_, i) => {
        let soc;
        
        switch(mode.pattern) {
            case 'arbitrage':
                // Zwei Spitzen: morgens und abends
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12 * mode.frequency);
                break;
            case 'peak_shaving':
                // Morgens und abends Spitzen
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12) + 
                      mode.amplitude * 0.5 * Math.sin(i * Math.PI / 6);
                break;
            case 'frequency':
                // Häufige Schwankungen
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 8 * mode.frequency) +
                      mode.amplitude * 0.3 * Math.sin(i * Math.PI / 4);
                break;
            case 'backup':
                // Stabil mit leichten Schwankungen
                soc = mode.baseLevel + mode.amplitude * 0.3 * Math.sin(i * Math.PI / 12);
                break;
            default:
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12);
        }
        
        return {
            hour: i,
            soc: Math.max(10, Math.min(95, soc + (Math.random() - 0.5) * 5))
        };
    });
}

function generateRevenueData(results) {
    // Verwende echte Erlösdaten aus der Simulation
    const spotRevenue = results.spot_revenue || 28000;
    const regelreserveRevenue = results.regelreserve_revenue || 8500;
    const annualCosts = results.annual_costs || 20000;
    
    // BESS-Modus spezifische Anpassungen
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: { spot_boost: 1.2, srl_boost: 1.0, cost_factor: 1.0 },
        peak_shaving: { spot_boost: 1.15, srl_boost: 1.1, cost_factor: 0.95 },
        frequency_regulation: { spot_boost: 1.25, srl_boost: 1.2, cost_factor: 1.1 },
        backup: { spot_boost: 1.05, srl_boost: 0.8, cost_factor: 0.9 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return [
        spotRevenue * mode.spot_boost,                    // Spot-Markt
        regelreserveRevenue * mode.srl_boost,             // Regelreserve
        5000,                                             // Förderung
        -(annualCosts * 0.3 * mode.cost_factor),          // Netzentgelte
        -(annualCosts * 0.2 * mode.cost_factor)           // Betriebskosten
    ];
}

// Chart-Update Funktionen
function updateMonthlyChart(data) {
    if (dashboardCharts.monthly) {
        dashboardCharts.monthly.data.labels = data.labels;
        dashboardCharts.monthly.data.datasets[0].data = data.strombezug;
        dashboardCharts.monthly.data.datasets[1].data = data.stromverkauf;
        dashboardCharts.monthly.data.datasets[2].data = data.pv_erzeugung;
        dashboardCharts.monthly.update();
    } else {
        console.log('⚠️ Monthly Chart noch nicht initialisiert');
        // Chart neu initialisieren falls nötig
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateMonthlyChart(data), 500);
            }
        }, 100);
    }
}

function updateCo2Chart(data) {
    if (dashboardCharts.co2) {
        dashboardCharts.co2.data.datasets[0].data = data;
        dashboardCharts.co2.update();
    } else {
        console.log('⚠️ CO2 Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateCo2Chart(data), 500);
            }
        }, 100);
    }
}

function updateSeasonalChart(data) {
    if (dashboardCharts.seasonal) {
        dashboardCharts.seasonal.data.datasets[0].data = data;
        dashboardCharts.seasonal.update();
    } else {
        console.log('⚠️ Seasonal Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateSeasonalChart(data), 500);
            }
        }, 100);
    }
}

function updateSocChart(data) {
    if (dashboardCharts.soc) {
        dashboardCharts.soc.data.labels = data.map(p => p.hour + ':00');
        dashboardCharts.soc.data.datasets[0].data = data.map(p => p.soc);
        dashboardCharts.soc.update();
    } else {
        console.log('⚠️ SOC Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateSocChart(data), 500);
            }
        }, 100);
    }
}

function updateRevenueChart(data) {
    if (dashboardCharts.revenue) {
        dashboardCharts.revenue.data.datasets[0].data = data;
        dashboardCharts.revenue.update();
    } else {
        console.log('⚠️ Revenue Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateRevenueChart(data), 500);
            }
        }, 100);
    }
}

// Dashboard-Charts Objekt
const dashboardCharts = {};

// Test-Funktion für Charts (kann manuell aufgerufen werden)
function testCharts() {
    console.log('🧪 Teste Charts manuell...');
    console.log('Chart.js verfügbar:', typeof Chart !== 'undefined');
    console.log('Dashboard Charts Status:', dashboardCharts);
    
    if (typeof Chart !== 'undefined') {
        console.log('🔄 Initialisiere Charts neu...');
        initializeDashboardCharts();
        
        setTimeout(() => {
            console.log('📊 Lade Test-Daten...');
            loadTestChartData();
        }, 500);
    } else {
        console.error('❌ Chart.js nicht verfügbar!');
        console.log('🔄 Lade Chart.js neu...');
        loadChartJSAndInitialize();
    }
}

// Globale Funktion für Browser-Console
window.testCharts = testCharts;

// Event Listener für Use Case Änderung im Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 BESS-Simulation Enhanced geladen');
    
    // Use Case Event Listener für Dashboard
    const dashboardUseCaseSelect = document.getElementById('dashboardUseCase');
    if (dashboardUseCaseSelect) {
        dashboardUseCaseSelect.addEventListener('change', function() {
            updateDashboard(this.value);
        });
    }
    
    // Standardmäßig Simulation-Tab aktivieren
    switchTab('simulation');
    
    // Chart.js laden und initialisieren
    loadChartJSAndInitialize();
});

// Chart.js laden und initialisieren
function loadChartJSAndInitialize() {
    // Prüfe ob Chart.js bereits geladen ist
    if (typeof Chart !== 'undefined') {
        console.log('✅ Chart.js bereits verfügbar - initialisiere Charts');
        initializeChartsAndData();
        return;
    }
    
    console.log('🔄 Chart.js wird geladen...');
    
    // Chart.js dynamisch laden
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        console.log('✅ Chart.js erfolgreich geladen');
        // Warte kurz und initialisiere dann
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('🔄 Initialisiere Charts nach Chart.js Laden...');
                initializeChartsAndData();
            } else {
                console.error('❌ Chart.js immer noch nicht verfügbar nach Laden!');
            }
        }, 500);
    };
    script.onerror = function() {
        console.error('❌ Fehler beim Laden von Chart.js');
        // Fallback: Versuche es mit alternativer CDN
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        fallbackScript.onload = function() {
            console.log('✅ Chart.js von Fallback-CDN geladen');
            setTimeout(() => initializeChartsAndData(), 500);
        };
        fallbackScript.onerror = function() {
            console.error('❌ Beide CDNs fehlgeschlagen!');
        };
        document.head.appendChild(fallbackScript);
    };
    document.head.appendChild(script);
}

// Charts und Daten initialisieren
function initializeChartsAndData() {
    try {
        console.log('🔄 Initialisiere Dashboard-Charts...');
        initializeDashboardCharts();
        
        // Test-Daten laden
        setTimeout(() => {
            console.log('📊 Lade Test-Daten für Dashboard-Charts...');
            loadTestChartData();
        }, 500);
        
    } catch (error) {
        console.error('❌ Fehler bei der Chart-Initialisierung:', error);
    }
}

// ========================================
// EXPORT & DRUCK FUNKTIONEN
// ========================================

// Simulation & Use Cases Export-Funktionen
function printSimulationResults() {
    const content = generateSimulationPrintContent();
    printContent(content);
}

function exportSimulationToPDF() {
    const content = generateSimulationPDFContent();
    exportToPDF(content, 'BESS-Simulation-Use-Cases.pdf');
}

function exportSimulationToExcel() {
    const data = collectSimulationData();
    exportToExcel(data, 'BESS-Simulation-Use-Cases.xlsx');
}

function exportSimulationToWord() {
    const content = generateSimulationWordContent();
    exportToWord(content, 'BESS-Simulation-Use-Cases.docx');
}

// Enhanced Dashboard Export-Funktionen
function printDashboard() {
    const printContent = generateDashboardPrintContent();
    printContent(printContent);
}

function exportDashboardToPDF() {
    const content = generateDashboardPDFContent();
    exportToPDF(content, 'BESS-Enhanced-Dashboard.pdf');
}

function exportDashboardToExcel() {
    const data = collectDashboardData();
    exportToExcel(data, 'BESS-Enhanced-Dashboard.xlsx');
}

function exportDashboardToWord() {
    const content = generateDashboardWordContent();
    exportToWord(content, 'BESS-Enhanced-Dashboard.docx');
}

// ========================================
// INHALT GENERIEREN
// ========================================

function generateSimulationPrintContent() {
    const projectName = document.getElementById('projectSelect')?.value || 'Ausgewähltes Projekt';
    const useCase = document.getElementById('useCaseSelect')?.value || 'Ausgewählter Use Case';
    
    let content = `
        <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
            <h1 style="color: #1f2937; text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
                BESS-Simulation: ${projectName}
            </h1>
            <h2 style="color: #374151; margin-top: 30px;">Use Case: ${useCase}</h2>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #4b5563;">Jahresbilanz</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Metrik</th>
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">Wert</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Verbrauch (MWh/a)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('annualConsumption')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Erzeugung (MWh/a)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('annualGeneration')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Erlöse (EUR/a)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('annualRevenues')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Kosten (EUR/a)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('annualCosts')?.textContent || '-'}</td>
                    </tr>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #4b5563;">Wirtschaftlichkeitsmetriken</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Metrik</th>
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">Wert</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">ROI (%)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('roiPercent')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Amortisation (Jahre)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('paybackYears')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Investition (EUR)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('totalInvestment')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Net Cashflow (EUR/a)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('netCashflow')?.textContent || '-'}</td>
                    </tr>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                <p>Generiert am ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}</p>
                <p>BESS-Simulation Erweitert - Projektbasierte Analyse mit Use Cases</p>
            </div>
        </div>
    `;
    
    return content;
}

function generateDashboardPrintContent() {
    const projectName = document.getElementById('dashboardProjectSelect')?.value || 'Ausgewähltes Projekt';
    const useCase = document.getElementById('dashboardUseCase')?.value || 'Ausgewählter Use Case';
    const bessMode = document.getElementById('dashboardBessMode')?.value || 'Ausgewählter BESS-Modus';
    
    let content = `
        <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
            <h1 style="color: #1f2937; text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
                BESS Enhanced Dashboard: ${projectName}
            </h1>
            <h2 style="color: #374151; margin-top: 30px;">Konfiguration</h2>
            <p><strong>Use Case:</strong> ${useCase}</p>
            <p><strong>BESS-Modus:</strong> ${bessMode}</p>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #4b5563;">Kennzahlen</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Metrik</th>
                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">Wert</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Eigenverbrauchsquote (%)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardEigenverbrauchsquote')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">CO₂-Einsparung (kg/Jahr)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardCo2Savings')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Netto-Erlös (EUR/Jahr)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardNettoErloes')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">BESS-Effizienz (%)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardBessEfficiency')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Spot-Revenue (EUR/Jahr)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardSpotRevenue')?.textContent || '-'}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #d1d5db; padding: 8px;">Regelreserve (EUR/Jahr)</td>
                        <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">${document.getElementById('dashboardRegelreserveRevenue')?.textContent || '-'}</td>
                    </tr>
                </table>
            </div>
            
            <div style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                <p>Generiert am ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}</p>
                <p>BESS Enhanced Dashboard - Projektbasierte Analyse</p>
            </div>
        </div>
    `;
    
    return content;
}

function generateSimulationPDFContent() {
    return generateSimulationPrintContent();
}

function generateDashboardPDFContent() {
    return generateDashboardPrintContent();
}

function generateSimulationWordContent() {
    return generateSimulationPrintContent();
}

function generateDashboardWordContent() {
    return generateDashboardPrintContent();
}

// ========================================
// DATEN SAMMELN
// ========================================

// Diese Funktion wurde durch eine erweiterte Version ersetzt (siehe unten)

function collectDashboardData() {
    console.log('🔍 collectDashboardData aufgerufen');
    console.log('🔍 window.currentDashboardResults:', window.currentDashboardResults);
    
    // Verwende gespeicherte Dashboard-Ergebnisse falls verfügbar
    if (window.currentDashboardResults) {
        console.log('✅ Verwende gespeicherte Dashboard-Ergebnisse');
        const data = {
            project: window.currentDashboardResults.project_id || 'Ausgewähltes Projekt',
            useCase: window.currentDashboardResults.use_case || 'Ausgewählter Use Case',
            bessMode: window.currentDashboardResults.bess_mode || 'Ausgewählter BESS-Modus',
            optimizationTarget: window.currentDashboardResults.optimization_target || 'Ausgewähltes Ziel',
            spotPriceScenario: window.currentDashboardResults.spot_price_scenario || 'Ausgewähltes Szenario',
            eigenverbrauchsquote: window.currentDashboardResults.dashboard_metrics?.eigenverbrauchsquote?.toFixed(1) || '-',
            co2Savings: window.currentDashboardResults.dashboard_metrics?.co2_savings?.toLocaleString() || '-',
            nettoErloes: window.currentDashboardResults.dashboard_metrics?.netto_erloes?.toLocaleString() || '-',
            bessEfficiency: window.currentDashboardResults.dashboard_metrics?.bess_efficiency?.toFixed(1) || '-',
            spotRevenue: window.currentDashboardResults.dashboard_metrics?.spot_revenue?.toLocaleString() || '-',
            regelreserveRevenue: window.currentDashboardResults.dashboard_metrics?.regelreserve_revenue?.toLocaleString() || '-',
            timestamp: new Date().toISOString()
        };
        
        console.log('📊 Gesammelte Dashboard-Daten:', data);
        
        // Überprüfe ob Dashboard-Daten verfügbar sind
        const hasDashboardData = data.eigenverbrauchsquote !== '-' || data.co2Savings !== '-' || data.nettoErloes !== '-';
        console.log('🔍 Dashboard-Daten verfügbar:', hasDashboardData);
        
        if (hasDashboardData) {
            console.log('✅ Dashboard-Daten erfolgreich gesammelt');
            return data;
        }
    } else {
        console.log('⚠️ Keine gespeicherten Dashboard-Ergebnisse gefunden');
    }
    
    // Fallback auf DOM-Elemente
    console.log('🔄 Verwende Fallback auf DOM-Elemente');
    const fallbackData = {
        project: document.getElementById('dashboardProjectSelect')?.value || 'Ausgewähltes Projekt',
        useCase: document.getElementById('dashboardProjectSelect')?.value || 'Ausgewählter Use Case',
        bessMode: document.getElementById('dashboardBessMode')?.value || 'Ausgewählter BESS-Modus',
        optimizationTarget: document.getElementById('dashboardOptimizationTarget')?.value || 'Ausgewähltes Ziel',
        spotPriceScenario: document.getElementById('dashboardSpotPriceScenario')?.value || 'Ausgewähltes Szenario',
        eigenverbrauchsquote: document.getElementById('dashboardEigenverbrauchsquote')?.textContent || '-',
        co2Savings: document.getElementById('dashboardCo2Savings')?.textContent || '-',
        nettoErloes: document.getElementById('dashboardNettoErloes')?.textContent || '-',
        bessEfficiency: document.getElementById('dashboardBessEfficiency')?.textContent || '-',
        spotRevenue: document.getElementById('dashboardSpotRevenue')?.textContent || '-',
        regelreserveRevenue: document.getElementById('dashboardRegelreserveRevenue')?.textContent || '-',
        timestamp: new Date().toISOString()
    };
    
    console.log('📊 Fallback-Daten:', fallbackData);
    
    // Überprüfe ob Fallback-Daten verfügbar sind
    const hasFallbackData = fallbackData.eigenverbrauchsquote !== '-' || fallbackData.co2Savings !== '-' || fallbackData.nettoErloes !== '-';
    console.log('🔍 Fallback-Daten verfügbar:', hasFallbackData);
    
    if (!hasFallbackData) {
        console.warn('❌ Keine Dashboard-Daten verfügbar (weder gespeichert noch im DOM)');
        return null;
    }
    
    console.log('✅ Dashboard-Daten erfolgreich gesammelt (Fallback)');
    return fallbackData;
}

// ========================================
// EXPORT FUNKTIONEN
// ========================================

function printContent(content) {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>BESS-Simulation - Druck</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    h1, h2, h3 { color: #333; }
                </style>
            </head>
            <body>
                ${content}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function exportToPDF(content, filename) {
    try {
        // Lade aktuelle Projektdaten
        const projectId = getCurrentProjectId();
        if (!projectId) {
            alert('Bitte wählen Sie zuerst ein Projekt aus.');
            return;
        }
        
        // Zeige Lade-Animation
        showLoadingMessage('PDF wird generiert...');
        
        // PDF über API generieren
        generatePDF(projectId);
        
    } catch (error) {
        console.error('Fehler beim PDF-Export:', error);
        alert('Fehler beim PDF-Export. Bitte versuchen Sie es erneut.');
    }
}

function exportToExcel(data, filename) {
    // Für echte Excel-Export würde man eine Bibliothek wie SheetJS verwenden
    // Hier verwenden wir einen einfachen CSV-Export
    const csvContent = convertToCSV(data);
    downloadFile(csvContent, filename.replace('.xlsx', '.csv'), 'text/csv');
}

function exportToWord(data, filename) {
    // Für echte Word-Export würde man eine Bibliothek wie docx verwenden
    // Hier verwenden wir einen einfachen HTML-Export
    const htmlContent = convertToHTML(data);
    downloadFile(htmlContent, filename.replace('.docx', '.html'), 'text/html');
}

function convertToCSV(data) {
    if (typeof data === 'object') {
        const rows = [];
        const headers = Object.keys(data);
        rows.push(headers.join(','));
        
        const values = Object.values(data);
        rows.push(values.join(','));
        
        return rows.join('\n');
    }
    return data;
}

function convertToHTML(data) {
    if (typeof data === 'object') {
        let html = '<html><head><title>BESS-Simulation Export</title></head><body>';
        html += '<h1>BESS-Simulation Export</h1>';
        html += '<table border="1" style="border-collapse: collapse; width: 100%;">';
        html += '<tr><th>Feld</th><th>Wert</th></tr>';
        
        for (const [key, value] of Object.entries(data)) {
            html += `<tr><td>${key}</td><td>${value}</td></tr>`;
        }
        
        html += '</table></body></html>';
        return html;
    }
    return data;
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// PDF-Export Hilfsfunktionen
function generatePDF(projectId) {
    console.log('🚀 generatePDF aufgerufen mit Projekt-ID:', projectId);
    
    // Lade-Animation anzeigen
    showLoadingMessage('Simulation PDF wird heruntergeladen....');
    
    try {
        // Sammle alle Simulationsdaten
        console.log('📊 Sammle Simulationsdaten...');
        const simulationData = collectSimulationData();
        console.log('📊 Simulationsdaten gesammelt:', simulationData);
        
        console.log('📊 Sammle Dashboard-Daten...');
        const dashboardData = collectDashboardData();
        console.log('📊 Dashboard-Daten gesammelt:', dashboardData);
        
        console.log('🔍 Simulationsdaten verfügbar:', !!simulationData);
        console.log('🔍 Dashboard-Daten verfügbar:', !!dashboardData);
        
        // Überprüfe ob Daten verfügbar sind
        if (!simulationData && !dashboardData) {
            hideLoadingMessage();
            alert('Keine Simulationsdaten für den Export verfügbar. Bitte führen Sie zuerst eine Simulation durch.');
            return;
        }
        
        // Für Dashboard-Export reichen Dashboard-Daten
        if (!simulationData && dashboardData) {
            console.log('📊 Verwende Dashboard-Daten für Export');
        }
        
        // Überprüfe ob Server erreichbar ist
        console.log('🌐 Sende PDF-Export-Request an Backend...');
        
        const requestData = {
            project_id: projectId,
            simulation_data: simulationData,
            dashboard_data: dashboardData,
            export_type: 'combined'
        };
        
        console.log('📤 Sende Daten:', JSON.stringify(requestData, null, 2));
        
        // Sende Daten an Backend für PDF-Generierung
        fetch('/api/export/pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('📡 Backend-Response erhalten:', response.status, response.statusText);
            console.log('📡 Response Headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
                console.log('✅ PDF erfolgreich generiert, lade herunter...');
                return response.blob();
            }
            
            console.error('❌ Backend-Fehler:', response.status, response.statusText);
            // Versuche JSON-Fehler zu lesen
            return response.json().then(errorData => {
                throw new Error(errorData.error || 'PDF-Generierung fehlgeschlagen');
            });
        })
        .then(blob => {
            console.log('📄 PDF-Blob erhalten:', blob.size, 'Bytes, Typ:', blob.type);
            
            if (!blob || blob.size === 0) {
                throw new Error('PDF ist leer oder fehlerhaft');
            }
            
            // PDF herunterladen
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BESS_Simulation_${projectId}_${new Date().toISOString().slice(0,10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Lade-Animation sofort verstecken und Erfolgsmeldung anzeigen
            hideLoadingMessage();
            showSuccessMessage('PDF erfolgreich heruntergeladen!');
            console.log('✅ PDF erfolgreich heruntergeladen!');
            
            // Zusätzliche Sicherheit: Lade-Animation nach 1 Sekunde nochmal verstecken
            setTimeout(() => {
                hideLoadingMessage();
                console.log('🔄 Zusätzliche Sicherheit: Lade-Animation versteckt');
            }, 1000);
        })
        .catch(error => {
            console.error('❌ Fehler beim PDF-Download:', error);
            hideLoadingMessage();
            alert(`Fehler beim PDF-Download: ${error.message || 'Unbekannter Fehler'}. Bitte versuchen Sie es erneut.`);
        });
        
    } catch (error) {
        console.error('❌ Fehler in generatePDF:', error);
        hideLoadingMessage();
        alert(`Fehler beim PDF-Export: ${error.message || 'Unbekannter Fehler'}. Bitte versuchen Sie es erneut.`);
    }
}

function collectSimulationData() {
    console.log('🔍 collectSimulationData aufgerufen');
    console.log('🔍 window.currentSimulationResults:', window.currentSimulationResults);
    
    // Sammle alle verfügbaren Simulationsdaten
    const data = {
        use_cases: {},
        ten_year_analysis: {},
        economic_metrics: {},
        project_info: {}
    };
    
    // Use Cases sammeln (falls verfügbar)
    if (window.currentSimulationResults) {
        console.log('✅ Verwende gespeicherte Simulationsergebnisse');
        data.use_cases = window.currentSimulationResults.use_cases || {};
        data.ten_year_analysis = window.currentSimulationResults.ten_year_analysis || {};
        data.economic_metrics = window.currentSimulationResults.economic_metrics || {};
        
        console.log('📊 Gesammelte Daten:', {
            use_cases: Object.keys(data.use_cases),
            ten_year_analysis: Object.keys(data.ten_year_analysis),
            economic_metrics: Object.keys(data.economic_metrics)
        });
    } else {
        console.log('⚠️ Keine gespeicherten Simulationsergebnisse gefunden');
    }
    
    // Überprüfe ob mindestens ein Use Case oder 10-Jahres-Analyse verfügbar ist
    const hasSimulationData = Object.keys(data.use_cases).length > 0 || 
                              Object.keys(data.ten_year_analysis).length > 0 ||
                              Object.keys(data.economic_metrics).length > 0;
    
    console.log('🔍 Simulationsdaten verfügbar:', hasSimulationData);
    
    if (!hasSimulationData) {
        console.warn('❌ Keine Simulationsdaten verfügbar');
        return null;
    }
    
    // Projekt-Informationen sammeln
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect && projectSelect.value) {
        data.project_info = {
            id: projectSelect.value,
            name: projectSelect.options[projectSelect.selectedIndex]?.text || 'Unbekanntes Projekt'
        };
        console.log('📋 Projekt-Info gesammelt:', data.project_info);
    } else {
        console.log('⚠️ Kein Projekt ausgewählt');
    }
    
    // Aktuelle Simulationsparameter sammeln
    data.simulation_parameters = {
        bess_size: parseFloat(document.getElementById('bessSize')?.value) || 0,
        bess_power: parseFloat(document.getElementById('bessPower')?.value) || 0,
        simulation_year: document.getElementById('simulationYear')?.value || new Date().getFullYear()
    };
    
    console.log('⚙️ Simulationsparameter gesammelt:', data.simulation_parameters);
    console.log('✅ Simulationsdaten erfolgreich gesammelt:', data);
    
    return data;
}

function getCurrentProjectId() {
    console.log('🔍 getCurrentProjectId aufgerufen');
    
    // Versuche Projekt-ID aus verschiedenen Quellen zu bekommen
    if (window.currentProjectId) {
        console.log('✅ Projekt-ID aus window.currentProjectId:', window.currentProjectId);
        return window.currentProjectId;
    }
    
    // Aus Projekt-Select
    const projectSelect = document.getElementById('projectSelect');
    if (projectSelect && projectSelect.value) {
        console.log('✅ Projekt-ID aus projectSelect:', projectSelect.value);
        return projectSelect.value;
    }
    
    // Aus Dashboard-Projekt-Select
    const dashboardProjectSelect = document.getElementById('dashboardProjectSelect');
    if (dashboardProjectSelect && dashboardProjectSelect.value) {
        console.log('✅ Projekt-ID aus dashboardProjectSelect:', dashboardProjectSelect.value);
        return dashboardProjectSelect.value;
    }
    
    // Aus gespeicherten Ergebnissen
    if (window.currentSimulationResults && window.currentSimulationResults.project_info) {
        console.log('✅ Projekt-ID aus currentSimulationResults:', window.currentSimulationResults.project_info.id);
        return window.currentSimulationResults.project_info.id;
    }
    
    if (window.currentDashboardResults && window.currentDashboardResults.project_id) {
        console.log('✅ Projekt-ID aus currentDashboardResults:', window.currentDashboardResults.project_id);
        return window.currentDashboardResults.project_id;
    }
    
    // Aus URL extrahieren
    const urlParams = new URLSearchParams(window.location.search);
    const urlProjectId = urlParams.get('project_id');
    if (urlProjectId) {
        console.log('✅ Projekt-ID aus URL:', urlProjectId);
        return urlProjectId;
    }
    
    // Fallback auf Projekt 1
    console.log('⚠️ Keine Projekt-ID gefunden, verwende Fallback: 1');
    return '1';
}

function showLoadingMessage(message) {
    // Lade-Animation anzeigen
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loadingOverlay';
    loadingDiv.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div class="fas fa-spinner fa-spin" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;"></div>
                <div style="color: #374151;">${message}</div>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoadingMessage() {
    const loadingDiv = document.getElementById('loadingOverlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// Notfall-Funktion um hängende Lade-Animation zu schließen
function forceHideLoading() {
    console.log('🚨 Force-Hide Loading aufgerufen');
    hideLoadingMessage();
    // Entferne alle möglichen Lade-Overlays
    const overlays = document.querySelectorAll('[id*="loading"], [class*="loading"]');
    overlays.forEach(overlay => overlay.remove());
    console.log('✅ Alle Lade-Overlays entfernt');
}

// Globale Funktion für Browser-Console
window.forceHideLoading = forceHideLoading;

function showSuccessMessage(message) {
    // Erfolgsmeldung anzeigen
    const successDiv = document.createElement('div');
    successDiv.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <i class="fas fa-check mr-2"></i>${message}
        </div>
    `;
    document.body.appendChild(successDiv);
    
    // Nach 3 Sekunden ausblenden
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

// Stufe-Sektionen Aus-/Einklapp-Funktion
function toggleStufeSection(sectionId, iconId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(iconId);
    
    if (!section || !icon) {
        console.warn(`⚠️ Sektion oder Icon nicht gefunden: ${sectionId} / ${iconId}`);
        return;
    }
    
    // Toggle collapsed/expanded
    if (section.classList.contains('collapsed')) {
        section.classList.remove('collapsed');
        section.classList.add('expanded');
        icon.classList.remove('rotated');
    } else {
        section.classList.remove('expanded');
        section.classList.add('collapsed');
        icon.classList.add('rotated');
    }
}

// Initialisiere alle Stufe-Sektionen als ausgeklappt beim Laden
document.addEventListener('DOMContentLoaded', function() {
    // Alle Stufe-Sektionen standardmäßig ausgeklappt
    const stufeSections = [
        'stufe1Section', 'stufe21Section', 'stufe22Section',
        'dashboardStufe1Section', 'dashboardStufe21Section', 'dashboardStufe22Section'
    ];
    
    stufeSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('expanded');
            section.classList.remove('collapsed');
        }
    });
    
    // Alle Icons standardmäßig nicht rotiert (nach oben zeigend = ausgeklappt)
    const stufeIcons = [
        'stufe1Icon', 'stufe21Icon', 'stufe22Icon',
        'dashboardStufe1Icon', 'dashboardStufe21Icon', 'dashboardStufe22Icon'
    ];
    
    stufeIcons.forEach(iconId => {
        const icon = document.getElementById(iconId);
        if (icon) {
            icon.classList.remove('rotated');
        }
    });
});
</script>
{% endblock %} 