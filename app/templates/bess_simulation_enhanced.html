{% extends "base.html" %}

{% block title %}BESS-Simulation Erweitert - Projekt & Use Case Analyse{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">BESS-Simulation Erweitert</h1>
        <p class="text-gray-600">Projektbasierte Analyse mit Use Cases, 10-Jahres-Prognose und Batterie-Degradation</p>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-8">
        <nav class="flex space-x-8 border-b border-gray-200">
            <button id="simulationTab" onclick="switchTab('simulation')" class="tab-button active py-2 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">
                <i class="fas fa-calculator mr-2"></i>Simulation & Use Cases
            </button>
            <button id="dashboardTab" onclick="switchTab('dashboard')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-tachometer-alt mr-2"></i>Enhanced Dashboard
            </button>
        </nav>
    </div>

    <!-- Simulation Tab Content -->
    <div id="simulationContent" class="tab-content">
        <!-- Projekt Auswahl -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projekt Auswahl</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Projekt ausw√§hlen:</label>
                <select id="projectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadProjectDetails()">
                    <option value="">Projekt ausw√§hlen...</option>
                </select>
            </div>
            
            <!-- Projekt Details -->
            <div id="projectDetails" class="hidden bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-lg text-gray-900 mb-3">Projektdetails</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <span class="text-sm text-gray-600">Name:</span>
                        <div class="font-medium" id="projectName">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Standort:</span>
                        <div class="font-medium" id="projectLocation">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">BESS-Gr√∂√üe:</span>
                        <div class="font-medium" id="projectBessSize">-</div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">BESS-Leistung:</span>
                        <div class="font-medium" id="projectBessPower">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Use Case Auswahl (nur sichtbar wenn Projekt ausgew√§hlt) -->
        <div id="useCaseSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Use Case Auswahl f√ºr <span id="projectNameHeader">Projekt</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC1')">
                        <h3 class="font-semibold text-lg text-blue-600">UC1</h3>
                        <p class="text-sm text-gray-600 mb-2">Verbrauch ohne Eigenerzeugung</p>
                        <ul class="text-xs text-gray-500">
                            <li>‚Ä¢ PV: 0 MWp</li>
                            <li>‚Ä¢ Wasserkraft: 0 kW</li>
                            <li>‚Ä¢ Nur BESS-Optimierung</li>
                        </ul>
                    </div>
                    <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC2')">
                        <h3 class="font-semibold text-lg text-green-600">UC2</h3>
                        <p class="text-sm text-gray-600 mb-2">Verbrauch + PV (1,95 MWp)</p>
                        <ul class="text-xs text-gray-500">
                            <li>‚Ä¢ PV: 1,95 MWp</li>
                            <li>‚Ä¢ Wasserkraft: 0 kW</li>
                            <li>‚Ä¢ PV + BESS-Optimierung</li>
                        </ul>
                    </div>
                    <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="selectUseCase('UC3')">
                        <h3 class="font-semibold text-lg text-purple-600">UC3</h3>
                        <p class="text-sm text-gray-600 mb-2">Verbrauch + PV + Wasserkraft</p>
                        <ul class="text-xs text-gray-500">
                            <li>‚Ä¢ PV: 1,95 MWp</li>
                            <li>‚Ä¢ Wasserkraft: 650 kW</li>
                            <li>‚Ä¢ Vollst√§ndige Optimierung</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Simulation Parameter -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Simulationsparameter</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Use Case</label>
                        <select id="useCaseSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Use Case ausw√§hlen...</option>
                            <option value="UC1">UC1 - Verbrauch ohne Eigenerzeugung</option>
                            <option value="UC2">UC2 - Verbrauch + PV (1,95 MWp)</option>
                            <option value="UC3">UC3 - Verbrauch + PV + Wasserkraft</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Simulationsjahr</label>
                        <select id="simulationYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Gr√∂√üe (MWh)</label>
                        <input type="number" id="bessSize" value="1.0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Leistung (MW)</label>
                        <input type="number" id="bessPower" value="0.5" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="runSimulation()" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Simulation starten
                    </button>
                    <button onclick="run10YearAnalysis()" class="ml-4 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        10-Jahres-Analyse
                    </button>
                </div>
            </div>
        </div>

        <!-- Ergebnisse -->
        <div id="results" class="hidden">
            <!-- Jahresbilanz -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Jahresbilanz</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="annualConsumption">-</div>
                        <div class="text-sm text-gray-600">Verbrauch (MWh/a)</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="annualGeneration">-</div>
                        <div class="text-sm text-gray-600">Erzeugung (MWh/a)</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="annualRevenues">-</div>
                        <div class="text-sm text-gray-600">Erl√∂se (EUR/a)</div>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="annualCosts">-</div>
                        <div class="text-sm text-gray-600">Kosten (EUR/a)</div>
                    </div>
                </div>
            </div>

            <!-- Wirtschaftlichkeitsmetriken -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Wirtschaftlichkeitsmetriken</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600" id="roiPercent">-</div>
                        <div class="text-sm text-gray-600">ROI (%)</div>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <div class="text-2xl font-bold text-orange-600" id="paybackYears">-</div>
                        <div class="text-sm text-gray-600">Amortisation (Jahre)</div>
                    </div>
                    <div class="text-center p-4 bg-indigo-50 rounded-lg">
                        <div class="text-2xl font-bold text-indigo-600" id="totalInvestment">-</div>
                        <div class="text-sm text-gray-600">Investition (EUR)</div>
                    </div>
                    <div class="text-center p-4 bg-teal-50 rounded-lg">
                        <div class="text-2xl font-bold text-teal-600" id="netCashflow">-</div>
                        <div class="text-sm text-gray-600">Net Cashflow (EUR/a)</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Jahresbilanz Chart -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Jahresbilanz</h3>
                    <canvas id="annualBalanceChart" width="400" height="300"></canvas>
                </div>

                <!-- Erl√∂se nach Komponenten -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Erl√∂se nach Komponenten</h3>
                    <canvas id="revenueComponentsChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- 10-Jahres-Analyse -->
            <div id="tenYearAnalysis" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">10-Jahres-Analyse mit Batterie-Degradation</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Cashflow-Verlauf -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Cashflow-Verlauf</h3>
                            <canvas id="cashflowChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Batterie-Degradation -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Batterie-Kapazit√§t</h3>
                            <canvas id="degradationChart" width="400" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Erweiterte Metriken -->
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-xl font-bold text-blue-600" id="totalRevenues">-</div>
                            <div class="text-sm text-gray-600">Gesamterl√∂se (10J)</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-xl font-bold text-green-600" id="totalNetCashflow">-</div>
                            <div class="text-sm text-gray-600">Net Cashflow (10J)</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-xl font-bold text-orange-600" id="npv">-</div>
                            <div class="text-sm text-gray-600">NPV (EUR)</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-xl font-bold text-purple-600" id="irr">-</div>
                            <div class="text-sm text-gray-600">IRR (%)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Dashboard Tab Content -->
    <div id="dashboardContent" class="tab-content hidden">
        <!-- Projektauswahl f√ºr Dashboard -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projektauswahl f√ºr Dashboard</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Projekt f√ºr Dashboard-Analyse:</label>
                <select id="dashboardProjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadDashboardProject()">
                    <option value="">Projekt ausw√§hlen...</option>
                </select>
            </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div id="enhancedDashboard" class="hidden">
            <!-- Kontrollen -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Dashboard-Kontrollen</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Use Case:</label>
                        <select id="dashboardUseCase" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="UC1">UC1 - Nur Verbrauch</option>
                            <option value="UC2">UC2 - PV + Verbrauch</option>
                            <option value="UC3">UC3 - PV + Hydro + Verbrauch</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">BESS-Modus:</label>
                        <select id="dashboardBessMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="arbitrage">Arbitrage</option>
                            <option value="peak_shaving">Peak Shaving</option>
                            <option value="frequency_regulation">Frequenzregelung</option>
                            <option value="backup">Backup</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Optimierungsziel:</label>
                        <select id="dashboardOptimizationTarget" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="cost_minimization">Kostenminimierung</option>
                            <option value="revenue_maximization">Erl√∂smaximierung</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Spot-Preis Szenario:</label>
                        <select id="dashboardSpotPriceScenario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="current">Aktuell</option>
                            <option value="optimistic">Optimistisch</option>
                            <option value="pessimistic">Pessimistisch</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="runDashboardSimulation()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-md hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-rocket mr-2"></i>Dashboard-Simulation starten
                    </button>
                </div>
                
                <!-- BESS-Modus Info -->
                <div id="bessModeInfo"></div>
            </div>

            <!-- Kennzahlen -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="text-sm text-gray-600 mb-2">Eigenverbrauchsquote</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardEigenverbrauchsquote">--</div>
                    <div class="text-sm text-gray-500">%</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardEigenverbrauchsquoteTrend">‚Üó +5.2%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="text-sm text-gray-600 mb-2">CO‚ÇÇ-Einsparung</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardCo2Savings">--</div>
                    <div class="text-sm text-gray-500">kg/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardCo2SavingsTrend">‚Üó +12.8%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="text-sm text-gray-600 mb-2">Netto-Erl√∂s</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardNettoErloes">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardNettoErloesTrend">‚Üó +8.3%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                    <div class="text-sm text-gray-600 mb-2">BESS-Effizienz</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardBessEfficiency">--</div>
                    <div class="text-sm text-gray-500">%</div>
                    <div class="text-sm text-yellow-600 mt-2" id="dashboardBessEfficiencyTrend">‚Üí Stabil</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500">
                    <div class="text-sm text-gray-600 mb-2">Spot-Revenue</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardSpotRevenue">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardSpotRevenueTrend">‚Üó +15.7%</div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="text-sm text-gray-600 mb-2">Regelreserve</div>
                    <div class="text-3xl font-bold text-gray-900" id="dashboardRegelreserveRevenue">--</div>
                    <div class="text-sm text-gray-500">EUR/Jahr</div>
                    <div class="text-sm text-green-600 mt-2" id="dashboardRegelreserveRevenueTrend">‚Üó +22.1%</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Monatliche Auswertung</h3>
                    <canvas id="dashboardMonthlyChart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">CO‚ÇÇ-Bilanz</h3>
                    <canvas id="dashboardCo2Chart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Saisonale Performance</h3>
                    <canvas id="dashboardSeasonalChart" width="400" height="300"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">SOC-Profil (24h)</h3>
                    <canvas id="dashboardSocChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Vollbreite Charts -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Erl√∂saufschl√ºsselung</h3>
                <canvas id="dashboardRevenueChart" width="800" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-700">Simulation l√§uft...</span>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js wird bereits in base.html geladen -->
<script>
// W√§hrungsformatierung
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '-';
    }
    
    // F√ºr sehr gro√üe Zahlen: Millionen oder Tausender
    if (value >= 1000000) {
        return (value / 1000000).toFixed(1) + ' Mio. ‚Ç¨';
    } else if (value >= 1000) {
        return (value / 1000).toFixed(0) + ' Tsd. ‚Ç¨';
    } else {
        return value.toFixed(0) + ' ‚Ç¨';
    }
}
let charts = {};
let selectedProject = null;
let selectedUseCase = null;

// Lade Projekte beim Seitenstart
document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});

// Lade alle verf√ºgbaren Projekte
async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const projectSelect = document.getElementById('projectSelect');
        projectSelect.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Projekte:', error);
    }
}

// Lade Projektdetails
async function loadProjectDetails() {
    const projectId = document.getElementById('projectSelect').value;
    
    if (!projectId) {
        document.getElementById('projectDetails').classList.add('hidden');
        document.getElementById('useCaseSection').classList.add('hidden');
        document.getElementById('results').classList.add('hidden');
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}`);
        const project = await response.json();
        
        selectedProject = project;
        
        // Zeige Projektdetails
        document.getElementById('projectName').textContent = project.name;
        document.getElementById('projectLocation').textContent = project.location || '-';
        document.getElementById('projectBessSize').textContent = project.bess_size ? `${project.bess_size} MWh` : '-';
        document.getElementById('projectBessPower').textContent = project.bess_power ? `${project.bess_power} MW` : '-';
        
        // Update Header
        document.getElementById('projectNameHeader').textContent = project.name;
        
        // Zeige Projektdetails und Use Case Sektion
        document.getElementById('projectDetails').classList.remove('hidden');
        document.getElementById('useCaseSection').classList.remove('hidden');
        
        // Update BESS-Parameter basierend auf Projekt
        if (project.bess_size) {
            document.getElementById('bessSize').value = project.bess_size;
        }
        if (project.bess_power) {
            document.getElementById('bessPower').value = project.bess_power;
        }
        
        // Automatisch UC1 ausw√§hlen wenn Projekt geladen wird
        if (!selectedUseCase) {
            selectUseCase('UC1');
            console.log('üîÑ Automatisch UC1 ausgew√§hlt f√ºr neues Projekt');
        }
        
    } catch (error) {
        console.error('Fehler beim Laden der Projektdetails:', error);
    }
}

// Use Case ausw√§hlen
function selectUseCase(useCase) {
    selectedUseCase = useCase;
    
    // Dropdown aktualisieren
    const useCaseSelect = document.getElementById('useCaseSelect');
    if (useCaseSelect) {
        useCaseSelect.value = useCase;
    }
    
    // Visueller Feedback f√ºr alle Use Case Karten
    document.querySelectorAll('[onclick^="selectUseCase"]').forEach(el => {
        el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
    });
    
    // Aktuelle Karte hervorheben
    const currentCard = event.target.closest('[onclick^="selectUseCase"]');
    if (currentCard) {
        currentCard.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
    }
    
    // Debug-Log
    console.log('Use Case ausgew√§hlt:', useCase);
    console.log('Projekt ausgew√§hlt:', selectedProject);
    console.log('selectedUseCase:', selectedUseCase);
    console.log('useCaseSelect.value:', useCaseSelect ? useCaseSelect.value : 'Element nicht gefunden');
    
    // Pr√ºfe ob Projekt und Use Case ausgew√§hlt sind
    if (selectedProject && selectedUseCase) {
        console.log('‚úÖ Projekt und Use Case sind ausgew√§hlt - Simulation kann gestartet werden');
    }
}

// Simulation starten
async function runSimulation() {
    if (!selectedProject || !selectedUseCase) {
        alert('Bitte w√§hlen Sie ein Projekt und einen Use Case aus.');
        return;
    }
    
    showLoading();
    
    try {
        const simulationData = {
            project_id: selectedProject.id,
            use_case: selectedUseCase,
            simulation_year: document.getElementById('simulationYear').value,
            bess_size: parseFloat(document.getElementById('bessSize').value),
            bess_power: parseFloat(document.getElementById('bessPower').value)
        };
        
        const response = await fetch('/api/simulation/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(simulationData)
        });
        
        const results = await response.json();
        displayResults(results);
        
    } catch (error) {
        console.error('Fehler bei der Simulation:', error);
        alert('Fehler bei der Simulation. Bitte versuchen Sie es erneut.');
    } finally {
        hideLoading();
    }
}

// 10-Jahres-Analyse
async function run10YearAnalysis() {
    if (!selectedProject || !selectedUseCase) {
        alert('Bitte w√§hlen Sie ein Projekt und einen Use Case aus.');
        return;
    }
    
    showLoading();
    
    try {
        const analysisData = {
            project_id: selectedProject.id,
            use_case: selectedUseCase,
            bess_size: parseFloat(document.getElementById('bessSize').value),
            bess_power: parseFloat(document.getElementById('bessPower').value)
        };
        
        console.log('10-Jahres-Analyse Daten:', analysisData);
        
        const response = await fetch('/api/simulation/10-year-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(analysisData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const results = await response.json();
        
        if (results.error) {
            throw new Error(results.error);
        }
        
        console.log('10-Jahres-Analyse Ergebnisse:', results);
        display10YearAnalysis(results);
        
    } catch (error) {
        console.error('Fehler bei der 10-Jahres-Analyse:', error);
        alert(`Fehler bei der 10-Jahres-Analyse: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// Ergebnisse anzeigen
function displayResults(data) {
    // Jahresbilanz
    document.getElementById('annualConsumption').textContent = data.annual_consumption?.toFixed(1) || '-';
    document.getElementById('annualGeneration').textContent = data.annual_generation?.toFixed(1) || '-';
    document.getElementById('annualRevenues').textContent = formatCurrency(data.annual_revenues) || '-';
    document.getElementById('annualCosts').textContent = formatCurrency(data.annual_costs) || '-';
    
    // Wirtschaftlichkeitsmetriken
    document.getElementById('roiPercent').textContent = data.roi_percent?.toFixed(1) || '-';
    document.getElementById('paybackYears').textContent = data.payback_years?.toFixed(1) || '-';
    document.getElementById('totalInvestment').textContent = formatCurrency(data.total_investment) || '-';
    document.getElementById('netCashflow').textContent = formatCurrency(data.net_cashflow) || '-';
    
    // Charts erstellen
    createAnnualBalanceChart(data);
    createRevenueComponentsChart(data);
    
    // Ergebnisse anzeigen
    document.getElementById('results').classList.remove('hidden');
}

// 10-Jahres-Analyse anzeigen
function display10YearAnalysis(data) {
    // Erweiterte Metriken
    document.getElementById('totalRevenues').textContent = formatCurrency(data.total_revenues) || '-';
    document.getElementById('totalNetCashflow').textContent = formatCurrency(data.total_net_cashflow) || '-';
    document.getElementById('npv').textContent = formatCurrency(data.npv) || '-';
    document.getElementById('irr').textContent = data.irr?.toFixed(1) || '-';
    
    // Charts erstellen
    createCashflowChart(data);
    createDegradationChart(data);
    
    // 10-Jahres-Analyse anzeigen
    document.getElementById('tenYearAnalysis').classList.remove('hidden');
}

// Chart-Funktionen
function createAnnualBalanceChart(data) {
    const ctx = document.getElementById('annualBalanceChart').getContext('2d');
    
    if (charts.annualBalance) {
        charts.annualBalance.destroy();
    }
    
    charts.annualBalance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Verbrauch', 'Erzeugung', 'Netto'],
            datasets: [{
                label: 'MWh/a',
                data: [
                    data.annual_consumption || 0,
                    data.annual_generation || 0,
                    (data.annual_consumption || 0) - (data.annual_generation || 0)
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6'],
                borderColor: ['#2563EB', '#059669', '#7C3AED'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createRevenueComponentsChart(data) {
    const ctx = document.getElementById('revenueComponentsChart').getContext('2d');
    
    if (charts.revenueComponents) {
        charts.revenueComponents.destroy();
    }
    
    charts.revenueComponents = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Arbitrage', 'SRL+', 'SRL-', 'Day-Ahead'],
            datasets: [{
                data: [
                    data.arbitrage_revenue || 0,
                    data.srl_positive_revenue || 0,
                    data.srl_negative_revenue || 0,
                    data.day_ahead_revenue || 0
                ],
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createCashflowChart(data) {
    const ctx = document.getElementById('cashflowChart').getContext('2d');
    
    if (charts.cashflow) {
        charts.cashflow.destroy();
    }
    
    const years = Array.from({length: 10}, (_, i) => 2024 + i);
    
    charts.cashflow = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'J√§hrlicher Cashflow (EUR)',
                data: data.cashflow_data || Array(10).fill(0),
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createDegradationChart(data) {
    const ctx = document.getElementById('degradationChart').getContext('2d');
    
    if (charts.degradation) {
        charts.degradation.destroy();
    }
    
    const years = Array.from({length: 10}, (_, i) => 2024 + i);
    
    charts.degradation = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Batterie-Kapazit√§t (%)',
                data: data.degradation_data || Array(10).fill(100),
                borderColor: '#EF4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Loading-Funktionen
function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
}

// Tab-Funktionalit√§t
function switchTab(tabName) {
    // Tab-Buttons aktualisieren
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Aktiven Tab markieren
    if (tabName === 'simulation') {
        document.getElementById('simulationTab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById('simulationTab').classList.remove('border-transparent', 'text-gray-500');
    } else if (tabName === 'dashboard') {
        document.getElementById('dashboardTab').classList.add('active', 'border-blue-500', 'text-blue-600');
        document.getElementById('dashboardTab').classList.remove('border-transparent', 'text-gray-500');
    }
    
    // Tab-Inhalte ein-/ausblenden
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    if (tabName === 'simulation') {
        document.getElementById('simulationContent').classList.remove('hidden');
    } else if (tabName === 'dashboard') {
        document.getElementById('dashboardContent').classList.remove('hidden');
        // Dashboard-Projekte laden
        loadDashboardProjects();
        
        // Charts initialisieren wenn Dashboard aktiv wird
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('üîÑ Initialisiere Dashboard-Charts...');
                initializeDashboardCharts();
                
                // Test-Daten laden wenn Dashboard aktiv wird
                setTimeout(() => {
                    console.log('üìä Lade Test-Daten f√ºr Dashboard-Charts');
                    loadTestChartData();
                }, 500);
            } else {
                console.error('‚ùå Chart.js nicht verf√ºgbar beim Tab-Wechsel!');
            }
        }, 500);
    }
}

// Dashboard-Projekte laden
async function loadDashboardProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        
        const select = document.getElementById('dashboardProjectSelect');
        select.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = `${project.name} (${project.location || 'Kein Standort'})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Dashboard-Projekte:', error);
    }
}

// Dashboard-Projekt laden
function loadDashboardProject() {
    const projectId = document.getElementById('dashboardProjectSelect').value;
    if (projectId) {
        document.getElementById('enhancedDashboard').classList.remove('hidden');
        // Dashboard mit Standarddaten initialisieren
        initializeDashboard();
    } else {
        document.getElementById('enhancedDashboard').classList.add('hidden');
    }
}

// Dashboard initialisieren
function initializeDashboard() {
    // Standarddaten f√ºr Dashboard
    updateDashboard('UC1');
    
    // Charts initialisieren
    initializeDashboardCharts();
    
    // Test-Daten f√ºr Charts laden
    setTimeout(() => {
        loadTestChartData();
    }, 1000);
}

// Test-Daten f√ºr Charts laden
function loadTestChartData() {
    console.log('üìä Lade Test-Daten f√ºr Charts...');
    
    // Pr√ºfe ob Charts initialisiert sind
    if (!dashboardCharts.monthly || !dashboardCharts.co2 || !dashboardCharts.seasonal || !dashboardCharts.soc || !dashboardCharts.revenue) {
        console.log('‚ö†Ô∏è Charts noch nicht initialisiert - initialisiere sie zuerst');
        initializeDashboardCharts();
        setTimeout(() => loadTestChartData(), 500);
        return;
    }
    
    const testData = {
        monthly_data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            strombezug: [120, 110, 95, 85, 75, 70, 65, 60, 80, 90, 105, 115],
            stromverkauf: [80, 85, 90, 95, 100, 105, 110, 115, 95, 85, 75, 70],
            pv_erzeugung: [60, 100, 160, 240, 320, 380, 400, 380, 300, 200, 100, 60]
        },
        co2_savings: 1250,
        bess_efficiency: 85.5,
        soc_profile: Array.from({length: 24}, (_, i) => ({
            hour: i,
            soc: 60 + 20 * Math.sin(i * Math.PI / 12) + (Math.random() - 0.5) * 10
        }))
    };
    
    // Charts mit Test-Daten aktualisieren
    try {
        console.log('üîÑ Aktualisiere Monthly Chart...');
        updateMonthlyChart(testData.monthly_data);
        
        console.log('üîÑ Aktualisiere CO2 Chart...');
        updateCo2Chart([testData.co2_savings, 400]);
        
        console.log('üîÑ Aktualisiere Seasonal Chart...');
        updateSeasonalChart([0.8, 1.0, 1.2, 0.9]);
        
        console.log('üîÑ Aktualisiere SOC Chart...');
        updateSocChart(testData.soc_profile);
        
        console.log('üîÑ Aktualisiere Revenue Chart...');
        updateRevenueChart([28000, 8500, 5000, -12000, -8000]);
        
        console.log('‚úÖ Test-Daten f√ºr Charts erfolgreich geladen');
        
        // Debug: Zeige Chart-Status
        console.log('üìä Chart-Status:', {
            monthly: !!dashboardCharts.monthly,
            co2: !!dashboardCharts.co2,
            seasonal: !!dashboardCharts.seasonal,
            soc: !!dashboardCharts.soc,
            revenue: !!dashboardCharts.revenue
        });
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Test-Daten:', error);
        // Fallback: Charts neu initialisieren
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('üîÑ Fallback: Charts neu initialisieren');
                initializeDashboardCharts();
                setTimeout(() => loadTestChartData(), 500);
            }
        }, 1000);
    }
}

// Dashboard-Charts initialisieren
function initializeDashboardCharts() {
    console.log('üîÑ Initialisiere Dashboard-Charts...');
    
    try {
        // Chart.js Konfiguration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#7f8c8d';
        
        // Farbpalette
        const colors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#27ae60',
            warning: '#f39c12',
            danger: '#e74c3c',
            info: '#3498db',
            light: '#ecf0f1',
            dark: '#2c3e50'
        };
        
        // Charts initialisieren
        console.log('üîÑ Initialisiere Monthly Chart...');
        initializeMonthlyChart(colors);
        
        console.log('üîÑ Initialisiere CO2 Chart...');
        initializeCo2Chart(colors);
        
        console.log('üîÑ Initialisiere Seasonal Chart...');
        initializeSeasonalChart(colors);
        
        console.log('üîÑ Initialisiere SOC Chart...');
        initializeSocChart(colors);
        
        console.log('üîÑ Initialisiere Revenue Chart...');
        initializeRevenueChart(colors);
        
        console.log('‚úÖ Dashboard-Charts erfolgreich initialisiert');
        
        // Debug: Zeige Chart-Status
        setTimeout(() => {
            console.log('üìä Chart-Status nach Initialisierung:', {
                monthly: !!dashboardCharts.monthly,
                co2: !!dashboardCharts.co2,
                seasonal: !!dashboardCharts.seasonal,
                soc: !!dashboardCharts.soc,
                revenue: !!dashboardCharts.revenue
            });
        }, 100);
        
    } catch (error) {
        console.error('‚ùå Fehler bei der Chart-Initialisierung:', error);
    }
}

// Monatliche Auswertung Chart
function initializeMonthlyChart(colors) {
    const ctx = document.getElementById('dashboardMonthlyChart').getContext('2d');
    dashboardCharts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Strombezug (MWh)',
                    data: [],
                    borderColor: colors.danger,
                    backgroundColor: colors.danger + '20',
                    tension: 0.4
                },
                {
                    label: 'Stromverkauf (MWh)',
                    data: [],
                    borderColor: colors.success,
                    backgroundColor: colors.success + '20',
                    tension: 0.4
                },
                {
                    label: 'PV-Erzeugung (MWh)',
                    data: [],
                    borderColor: colors.warning,
                    backgroundColor: colors.warning + '20',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// CO‚ÇÇ-Bilanz Chart
function initializeCo2Chart(colors) {
    const ctx = document.getElementById('dashboardCo2Chart').getContext('2d');
    dashboardCharts.co2 = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['CO‚ÇÇ-Einsparung', 'CO‚ÇÇ-Emission'],
            datasets: [{
                data: [1250, 400],
                backgroundColor: [colors.success, colors.danger],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

// Saisonale Performance Chart
function initializeSeasonalChart(colors) {
    const ctx = document.getElementById('dashboardSeasonalChart').getContext('2d');
    dashboardCharts.seasonal = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Winter', 'Fr√ºhling', 'Sommer', 'Herbst'],
            datasets: [{
                label: 'Performance-Faktor',
                data: [0.8, 1.0, 1.2, 0.9],
                borderColor: colors.primary,
                backgroundColor: colors.primary + '20',
                pointBackgroundColor: colors.primary
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 1.5
                }
            }
        }
    });
}

// SOC-Profil Chart
function initializeSocChart(colors) {
    const ctx = document.getElementById('dashboardSocChart').getContext('2d');
    dashboardCharts.soc = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'SOC (%)',
                data: [],
                borderColor: colors.info,
                backgroundColor: colors.info + '20',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Erl√∂saufschl√ºsselung Chart
function initializeRevenueChart(colors) {
    const ctx = document.getElementById('dashboardRevenueChart').getContext('2d');
    dashboardCharts.revenue = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Spot-Markt', 'Regelreserve', 'F√∂rderung', 'Netzentgelte', 'Betriebskosten'],
            datasets: [{
                label: 'Erl√∂se (EUR)',
                data: [28000, 8500, 5000, -12000, -8000],
                backgroundColor: [
                    colors.success,
                    colors.info,
                    colors.warning,
                    colors.danger,
                    colors.danger
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Dashboard-Simulation starten
async function runDashboardSimulation() {
    const projectId = document.getElementById('dashboardProjectSelect').value;
    const useCase = document.getElementById('dashboardUseCase').value;
    const bessMode = document.getElementById('dashboardBessMode').value;
    const optimizationTarget = document.getElementById('dashboardOptimizationTarget').value;
    const spotPriceScenario = document.getElementById('dashboardSpotPriceScenario').value;
    
    if (!projectId) {
        alert('Bitte w√§hlen Sie ein Projekt f√ºr die Dashboard-Analyse aus.');
        return;
    }
    
    console.log('üöÄ Dashboard-Simulation gestartet:', {
        projectId,
        useCase,
        bessMode,
        optimizationTarget,
        spotPriceScenario
    });
    
    showLoading();
    
    try {
        // 1. Lade Projektdaten
        const projectResponse = await fetch(`/api/projects/${projectId}`);
        const project = await projectResponse.json();
        
        // 2. F√ºhre normale Simulation durch
        const simulationData = {
            project_id: projectId,
            use_case: useCase,
            simulation_year: new Date().getFullYear(),
            bess_size: project.bess_size || 1000,
            bess_power: project.bess_power || 500,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        const simulationResponse = await fetch('/api/simulation/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(simulationData)
        });
        
        const simulationResults = await simulationResponse.json();
        
        // 3. F√ºhre 10-Jahres-Analyse durch
        const analysisData = {
            project_id: projectId,
            use_case: useCase,
            bess_size: project.bess_size || 1000,
            bess_power: project.bess_power || 500,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        const analysisResponse = await fetch('/api/simulation/10-year-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(analysisData)
        });
        
        const analysisResults = await analysisResponse.json();
        
        // 4. Kombiniere Ergebnisse und aktualisiere Dashboard
        const combinedResults = {
            ...simulationResults,
            ten_year_analysis: analysisResults,
            bess_mode: bessMode,
            optimization_target: optimizationTarget,
            spot_price_scenario: spotPriceScenario
        };
        
        updateEnhancedDashboard(combinedResults, project);
        
        // Animation f√ºr bessere UX
        document.querySelectorAll('#enhancedDashboard .metric-card .text-3xl').forEach(el => {
            el.style.transform = 'scale(1.1)';
            setTimeout(() => {
                el.style.transform = 'scale(1)';
            }, 200);
        });
        
    } catch (error) {
        console.error('Fehler bei der Dashboard-Simulation:', error);
        alert('Fehler bei der Dashboard-Simulation. Bitte versuchen Sie es erneut.');
    } finally {
        hideLoading();
    }
}

// Dashboard aktualisieren (Legacy-Funktion f√ºr Use Case Dropdown)
function updateDashboard(useCase) {
    // Diese Funktion wird nur noch f√ºr das Use Case Dropdown verwendet
    // Die echte Dashboard-Aktualisierung erfolgt √ºber updateEnhancedDashboard()
    console.log('Legacy updateDashboard aufgerufen f√ºr Use Case:', useCase);
    
    // Standarddaten f√ºr schnelle Vorschau
    const data = {
        eigenverbrauchsquote: 45.2,
        co2_savings: 1250,
        netto_erloes: 45000,
        bess_efficiency: 85.5,
        spot_revenue: 28000,
        regelreserve_revenue: 8500
    };
    
    // Kennzahlen aktualisieren
    document.getElementById('dashboardEigenverbrauchsquote').textContent = data.eigenverbrauchsquote.toFixed(1);
    document.getElementById('dashboardCo2Savings').textContent = data.co2_savings.toLocaleString();
    document.getElementById('dashboardNettoErloes').textContent = data.netto_erloes.toLocaleString();
    document.getElementById('dashboardBessEfficiency').textContent = data.bess_efficiency.toFixed(1);
    document.getElementById('dashboardSpotRevenue').textContent = data.spot_revenue.toLocaleString();
    document.getElementById('dashboardRegelreserveRevenue').textContent = data.regelreserve_revenue.toLocaleString();
}

// Erweitertes Dashboard mit echten Daten aktualisieren
function updateEnhancedDashboard(results, project) {
    console.log('üìä Aktualisiere Enhanced Dashboard mit:', results);
    
    // Basis-Kennzahlen aus Simulation
    document.getElementById('dashboardEigenverbrauchsquote').textContent = 
        results.eigenverbrauchsquote?.toFixed(1) || '--';
    document.getElementById('dashboardCo2Savings').textContent = 
        Math.round(results.co2_savings || 0).toLocaleString();
    document.getElementById('dashboardNettoErloes').textContent = 
        formatCurrency(results.netto_erloes || 0);
    document.getElementById('dashboardBessEfficiency').textContent = 
        (results.bess_efficiency || 85.0).toFixed(1);
    document.getElementById('dashboardSpotRevenue').textContent = 
        formatCurrency(results.spot_revenue || 0);
    document.getElementById('dashboardRegelreserveRevenue').textContent = 
        formatCurrency(results.regelreserve_revenue || 0);
    
    // 10-Jahres-Daten integrieren
    if (results.ten_year_analysis) {
        const tenYear = results.ten_year_analysis;
        
        // Erweiterte Metriken mit 10-Jahres-Daten
        document.getElementById('dashboardEigenverbrauchsquoteTrend').textContent = 
            `‚Üó +${(tenYear.irr / 10).toFixed(1)}% (10J)`;
        document.getElementById('dashboardCo2SavingsTrend').textContent = 
            `‚Üó +${(tenYear.npv / 1000000).toFixed(1)} Mio. ‚Ç¨ NPV`;
        document.getElementById('dashboardNettoErloesTrend').textContent = 
            `‚Üó ${tenYear.irr?.toFixed(1) || '--'}% IRR`;
        document.getElementById('dashboardBessEfficiencyTrend').textContent = 
            `‚Üí ${tenYear.payback_years?.toFixed(1) || '--'} Jahre`;
        document.getElementById('dashboardSpotRevenueTrend').textContent = 
            `‚Üó ${formatCurrency(tenYear.total_revenues || 0)}`;
        document.getElementById('dashboardRegelreserveRevenueTrend').textContent = 
            `‚Üó ${formatCurrency(tenYear.total_net_cashflow || 0)}`;
    }
    
    // BESS-Modus spezifische Anpassungen
    updateBessModeSpecificData(results.bess_mode, results);
    
    // Charts mit echten Daten aktualisieren
    updateEnhancedDashboardCharts(results, project);
}

// BESS-Modus spezifische Daten anpassen
function updateBessModeSpecificData(bessMode, results) {
    const modeInfo = {
        arbitrage: {
            name: 'Arbitrage',
            description: 'Strompreis-Differenz nutzen',
            efficiency_boost: 1.1,
            revenue_boost: 1.2
        },
        peak_shaving: {
            name: 'Peak Shaving',
            description: 'Spitzenlast reduzieren',
            efficiency_boost: 1.05,
            revenue_boost: 1.15
        },
        frequency_regulation: {
            name: 'Frequenzregelung',
            description: 'Netzstabilit√§t unterst√ºtzen',
            efficiency_boost: 1.15,
            revenue_boost: 1.25
        },
        backup: {
            name: 'Backup',
            description: 'Notstromversorgung',
            efficiency_boost: 1.0,
            revenue_boost: 1.05
        }
    };
    
    const mode = modeInfo[bessMode] || modeInfo.arbitrage;
    
    // Zeige BESS-Modus Info
    const modeInfoElement = document.getElementById('bessModeInfo');
    if (modeInfoElement) {
        modeInfoElement.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-battery-three-quarters text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>${mode.name}:</strong> ${mode.description}
                        </p>
                        <p class="text-xs text-blue-600 mt-1">
                            Effizienz-Boost: +${((mode.efficiency_boost - 1) * 100).toFixed(1)}% | 
                            Erl√∂s-Boost: +${((mode.revenue_boost - 1) * 100).toFixed(1)}%
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
}

// Erweiterte Dashboard-Charts mit echten Daten
function updateEnhancedDashboardCharts(results, project) {
    // Monatliche Auswertung mit echten Daten
    const monthlyData = generateMonthlyData(results, project);
    updateMonthlyChart(monthlyData);
    
    // CO‚ÇÇ-Bilanz mit echten Daten
    const co2Data = generateCo2Data(results);
    updateCo2Chart(co2Data);
    
    // Saisonale Performance mit echten Daten
    const seasonalData = generateSeasonalData(results);
    updateSeasonalChart(seasonalData);
    
    // SOC-Profil mit echten Daten
    const socData = generateSocData(results, results.bess_mode);
    updateSocChart(socData);
    
    // Erl√∂saufschl√ºsselung mit echten Daten
    const revenueData = generateRevenueData(results);
    updateRevenueChart(revenueData);
}

// Hilfsfunktionen f√ºr Chart-Daten
function generateMonthlyData(results, project) {
    // Verwende echte Simulationsergebnisse statt Projekt-Daten
    const annualConsumption = results.annual_consumption || 4380;
    const annualGeneration = results.annual_generation || 2190;
    const annualPvGeneration = results.annual_pv_generation || 1095;
    
    // BESS-Modus spezifische Anpassungen
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: { consumption_factor: 1.0, generation_factor: 1.2, pv_factor: 1.1 },
        peak_shaving: { consumption_factor: 0.9, generation_factor: 1.15, pv_factor: 1.05 },
        frequency_regulation: { consumption_factor: 1.1, generation_factor: 1.25, pv_factor: 1.15 },
        backup: { consumption_factor: 1.05, generation_factor: 1.05, pv_factor: 1.0 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    // Monatliche Verteilung mit saisonalen Faktoren
    const monthlyFactors = [1.2, 1.1, 1.0, 0.9, 0.8, 0.7, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2]; // Winter h√∂her
    
    return {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        strombezug: monthlyFactors.map((factor, i) => 
            (annualConsumption / 12) * factor * mode.consumption_factor + (Math.random() - 0.5) * 50
        ),
        stromverkauf: monthlyFactors.map((factor, i) => 
            (annualGeneration / 12) * factor * mode.generation_factor + (Math.random() - 0.5) * 30
        ),
        pv_erzeugung: [60, 100, 160, 240, 320, 380, 400, 380, 300, 200, 100, 60]
    };
}

function generateCo2Data(results) {
    // Verwende echte CO‚ÇÇ-Daten aus der Simulation
    const savings = results.co2_savings || 1000;
    const emission = Math.round(savings * 0.32);
    
    // BESS-Modus spezifische Anpassung
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: 1.2,
        peak_shaving: 1.15,
        frequency_regulation: 1.25,
        backup: 1.05
    };
    
    const modeFactor = modeFactors[bessMode] || 1.0;
    return [Math.round(savings * modeFactor), emission];
}

function generateSeasonalData(results) {
    // BESS-Modus spezifische saisonale Performance
    const bessMode = results.bess_mode || 'arbitrage';
    const baseEfficiency = results.bess_efficiency / 100 || 0.85;
    
    const modeFactors = {
        arbitrage: { winter: 0.8, spring: 1.0, summer: 1.2, autumn: 0.9 },
        peak_shaving: { winter: 0.85, spring: 1.05, summer: 1.15, autumn: 0.95 },
        frequency_regulation: { winter: 0.75, spring: 1.1, summer: 1.25, autumn: 0.85 },
        backup: { winter: 0.9, spring: 0.95, summer: 1.0, autumn: 0.9 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return [
        baseEfficiency * mode.winter,  // Winter
        baseEfficiency * mode.spring,  // Fr√ºhling
        baseEfficiency * mode.summer,  // Sommer
        baseEfficiency * mode.autumn   // Herbst
    ];
}

function generateSocData(results, bessMode) {
    // BESS-Modus spezifische SOC-Profile
    const baseSoc = 60;
    const modeFactors = {
        arbitrage: { 
            amplitude: 30, 
            frequency: 1.2, 
            baseLevel: 60,
            pattern: 'arbitrage' // Zwei Spitzen pro Tag
        },
        peak_shaving: { 
            amplitude: 25, 
            frequency: 1.0, 
            baseLevel: 65,
            pattern: 'peak_shaving' // Morgens und abends
        },
        frequency_regulation: { 
            amplitude: 35, 
            frequency: 1.5, 
            baseLevel: 55,
            pattern: 'frequency' // H√§ufige Schwankungen
        },
        backup: { 
            amplitude: 15, 
            frequency: 0.8, 
            baseLevel: 80,
            pattern: 'backup' // Stabil hoch
        }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return Array.from({length: 24}, (_, i) => {
        let soc;
        
        switch(mode.pattern) {
            case 'arbitrage':
                // Zwei Spitzen: morgens und abends
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12 * mode.frequency);
                break;
            case 'peak_shaving':
                // Morgens und abends Spitzen
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12) + 
                      mode.amplitude * 0.5 * Math.sin(i * Math.PI / 6);
                break;
            case 'frequency':
                // H√§ufige Schwankungen
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 8 * mode.frequency) +
                      mode.amplitude * 0.3 * Math.sin(i * Math.PI / 4);
                break;
            case 'backup':
                // Stabil mit leichten Schwankungen
                soc = mode.baseLevel + mode.amplitude * 0.3 * Math.sin(i * Math.PI / 12);
                break;
            default:
                soc = mode.baseLevel + mode.amplitude * Math.sin(i * Math.PI / 12);
        }
        
        return {
            hour: i,
            soc: Math.max(10, Math.min(95, soc + (Math.random() - 0.5) * 5))
        };
    });
}

function generateRevenueData(results) {
    // Verwende echte Erl√∂sdaten aus der Simulation
    const spotRevenue = results.spot_revenue || 28000;
    const regelreserveRevenue = results.regelreserve_revenue || 8500;
    const annualCosts = results.annual_costs || 20000;
    
    // BESS-Modus spezifische Anpassungen
    const bessMode = results.bess_mode || 'arbitrage';
    const modeFactors = {
        arbitrage: { spot_boost: 1.2, srl_boost: 1.0, cost_factor: 1.0 },
        peak_shaving: { spot_boost: 1.15, srl_boost: 1.1, cost_factor: 0.95 },
        frequency_regulation: { spot_boost: 1.25, srl_boost: 1.2, cost_factor: 1.1 },
        backup: { spot_boost: 1.05, srl_boost: 0.8, cost_factor: 0.9 }
    };
    
    const mode = modeFactors[bessMode] || modeFactors.arbitrage;
    
    return [
        spotRevenue * mode.spot_boost,                    // Spot-Markt
        regelreserveRevenue * mode.srl_boost,             // Regelreserve
        5000,                                             // F√∂rderung
        -(annualCosts * 0.3 * mode.cost_factor),          // Netzentgelte
        -(annualCosts * 0.2 * mode.cost_factor)           // Betriebskosten
    ];
}

// Chart-Update Funktionen
function updateMonthlyChart(data) {
    if (dashboardCharts.monthly) {
        dashboardCharts.monthly.data.labels = data.labels;
        dashboardCharts.monthly.data.datasets[0].data = data.strombezug;
        dashboardCharts.monthly.data.datasets[1].data = data.stromverkauf;
        dashboardCharts.monthly.data.datasets[2].data = data.pv_erzeugung;
        dashboardCharts.monthly.update();
    } else {
        console.log('‚ö†Ô∏è Monthly Chart noch nicht initialisiert');
        // Chart neu initialisieren falls n√∂tig
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateMonthlyChart(data), 500);
            }
        }, 100);
    }
}

function updateCo2Chart(data) {
    if (dashboardCharts.co2) {
        dashboardCharts.co2.data.datasets[0].data = data;
        dashboardCharts.co2.update();
    } else {
        console.log('‚ö†Ô∏è CO2 Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateCo2Chart(data), 500);
            }
        }, 100);
    }
}

function updateSeasonalChart(data) {
    if (dashboardCharts.seasonal) {
        dashboardCharts.seasonal.data.datasets[0].data = data;
        dashboardCharts.seasonal.update();
    } else {
        console.log('‚ö†Ô∏è Seasonal Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateSeasonalChart(data), 500);
            }
        }, 100);
    }
}

function updateSocChart(data) {
    if (dashboardCharts.soc) {
        dashboardCharts.soc.data.labels = data.map(p => p.hour + ':00');
        dashboardCharts.soc.data.datasets[0].data = data.map(p => p.soc);
        dashboardCharts.soc.update();
    } else {
        console.log('‚ö†Ô∏è SOC Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateSocChart(data), 500);
            }
        }, 100);
    }
}

function updateRevenueChart(data) {
    if (dashboardCharts.revenue) {
        dashboardCharts.revenue.data.datasets[0].data = data;
        dashboardCharts.revenue.update();
    } else {
        console.log('‚ö†Ô∏è Revenue Chart noch nicht initialisiert');
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeDashboardCharts();
                setTimeout(() => updateRevenueChart(data), 500);
            }
        }, 100);
    }
}

// Dashboard-Charts Objekt
const dashboardCharts = {};

// Test-Funktion f√ºr Charts (kann manuell aufgerufen werden)
function testCharts() {
    console.log('üß™ Teste Charts manuell...');
    console.log('Chart.js verf√ºgbar:', typeof Chart !== 'undefined');
    console.log('Dashboard Charts Status:', dashboardCharts);
    
    if (typeof Chart !== 'undefined') {
        console.log('üîÑ Initialisiere Charts neu...');
        initializeDashboardCharts();
        
        setTimeout(() => {
            console.log('üìä Lade Test-Daten...');
            loadTestChartData();
        }, 500);
    } else {
        console.error('‚ùå Chart.js nicht verf√ºgbar!');
        console.log('üîÑ Lade Chart.js neu...');
        loadChartJSAndInitialize();
    }
}

// Globale Funktion f√ºr Browser-Console
window.testCharts = testCharts;

// Event Listener f√ºr Use Case √Ñnderung im Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ BESS-Simulation Enhanced geladen');
    
    // Use Case Event Listener f√ºr Dashboard
    const dashboardUseCaseSelect = document.getElementById('dashboardUseCase');
    if (dashboardUseCaseSelect) {
        dashboardUseCaseSelect.addEventListener('change', function() {
            updateDashboard(this.value);
        });
    }
    
    // Standardm√§√üig Simulation-Tab aktivieren
    switchTab('simulation');
    
    // Chart.js laden und initialisieren
    loadChartJSAndInitialize();
});

// Chart.js laden und initialisieren
function loadChartJSAndInitialize() {
    // Pr√ºfe ob Chart.js bereits geladen ist
    if (typeof Chart !== 'undefined') {
        console.log('‚úÖ Chart.js bereits verf√ºgbar - initialisiere Charts');
        initializeChartsAndData();
        return;
    }
    
    console.log('üîÑ Chart.js wird geladen...');
    
    // Chart.js dynamisch laden
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        console.log('‚úÖ Chart.js erfolgreich geladen');
        // Warte kurz und initialisiere dann
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                console.log('üîÑ Initialisiere Charts nach Chart.js Laden...');
                initializeChartsAndData();
            } else {
                console.error('‚ùå Chart.js immer noch nicht verf√ºgbar nach Laden!');
            }
        }, 500);
    };
    script.onerror = function() {
        console.error('‚ùå Fehler beim Laden von Chart.js');
        // Fallback: Versuche es mit alternativer CDN
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        fallbackScript.onload = function() {
            console.log('‚úÖ Chart.js von Fallback-CDN geladen');
            setTimeout(() => initializeChartsAndData(), 500);
        };
        fallbackScript.onerror = function() {
            console.error('‚ùå Beide CDNs fehlgeschlagen!');
        };
        document.head.appendChild(fallbackScript);
    };
    document.head.appendChild(script);
}

// Charts und Daten initialisieren
function initializeChartsAndData() {
    try {
        console.log('üîÑ Initialisiere Dashboard-Charts...');
        initializeDashboardCharts();
        
        // Test-Daten laden
        setTimeout(() => {
            console.log('üìä Lade Test-Daten f√ºr Dashboard-Charts...');
            loadTestChartData();
        }, 500);
        
    } catch (error) {
        console.error('‚ùå Fehler bei der Chart-Initialisierung:', error);
    }
}
</script>
{% endblock %} 