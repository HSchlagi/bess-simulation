{% extends "base.html" %}

{% block title %}BESS Dispatch & Redispatch{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">BESS Dispatch & Redispatch</h1>
        <p class="text-lg text-gray-600">Konfigurieren und starten Sie Dispatch-Simulationen f√ºr Ihre BESS-Projekte</p>
    </div>

    <!-- Status-√úberpr√ºfung -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-800">Dispatch-Status</h2>
                <p class="text-gray-600" id="dispatchStatus">Pr√ºfe Dispatch-Status...</p>
            </div>
            <button onclick="checkDispatchStatus()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                Status aktualisieren
            </button>
        </div>
    </div>

    <!-- Dispatch-Parameter -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <h3 class="text-xl font-semibold mb-4">Dispatch-Parameter</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Projekt ausw√§hlen</label>
                    <select id="projectSelect" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="">Projekt w√§hlen...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Dispatch-Modus</label>
                    <select id="dispatchMode" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="arbitrage">Arbitrage</option>
                        <option value="peak_shaving">Peak Shaving</option>
                        <option value="frequency_regulation">Frequenzregelung</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Zeitaufl√∂sung</label>
                    <select id="timeResolution" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="15">15 Minuten</option>
                        <option value="30">30 Minuten</option>
                        <option value="60">1 Stunde</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Land</label>
                    <select id="country" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="AT">√ñsterreich</option>
                        <option value="DE">Deutschland</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Simulationsjahr</label>
                    <input type="number" id="simulationYear" value="2024" min="2020" max="2030" class="w-full px-3 py-2 rounded-lg text-gray-800">
                </div>
            </div>
            
            <button onclick="startDispatchSimulation()" class="w-full mt-6 bg-white text-blue-600 hover:bg-gray-100 font-semibold py-3 px-6 rounded-lg transition-colors">
                üöÄ Dispatch-Simulation starten
            </button>
        </div>

        <!-- Redispatch-Parameter -->
        <div class="bg-gradient-to-br from-pink-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
            <h3 class="text-xl font-semibold mb-4">Redispatch-Parameter</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Redispatch-CSV hochladen</label>
                    <input type="file" id="redispatchCsv" accept=".csv" class="w-full px-3 py-2 rounded-lg text-gray-800">
                    <p class="text-xs mt-1">Format: start, duration_slots, power_mw, mode, compensation_eur_mwh, reason</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Oder manuell eingeben:</label>
                    <div id="redispatchInputs" class="space-y-2">
                        <div class="flex space-x-2">
                            <input type="datetime-local" class="flex-1 px-2 py-1 rounded text-gray-800" placeholder="TT. MM. JJJJ, --:--">
                            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="Slots">
                            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="MW">
                            <select class="w-24 px-2 py-1 rounded text-gray-800">
                                <option value="delta">Delta</option>
                                <option value="absolute">Absolut</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addRedispatchRow()" class="mt-2 bg-white text-red-600 px-3 py-1 rounded text-sm hover:bg-gray-100">
                        + Weitere Zeile hinzuf√ºgen
                    </button>
                </div>
            </div>
            
            <button onclick="startRedispatchSimulation()" class="w-full mt-6 bg-white text-red-600 hover:bg-gray-100 font-semibold py-3 px-6 rounded-lg transition-colors">
                üöÄ Redispatch-Simulation starten
            </button>
        </div>
    </div>

    <!-- Ergebnisse -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">KPI-√úbersicht</h3>
            <div id="kpiResults" class="space-y-3">
                <div class="text-center text-gray-500">Keine Simulation durchgef√ºhrt</div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">SoC-Verlauf</h3>
            <div class="chart-container">
                <canvas id="socChart"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Cashflow</h3>
            <div class="chart-container">
                <canvas id="cashflowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Historie -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Dispatch-Historie</h3>
        <div id="dispatchHistory" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projekt</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modus</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Einnahmen</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">Keine Historie verf√ºgbar</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Globale Variablen
    let currentProjectId = '';
    let socChart = null;
    let cashflowChart = null;

    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM geladen - Initialisierung startet...'); // Debug
        checkDispatchStatus();
        loadProjects();
        setupEventListeners();
    });

    // Dispatch-Status pr√ºfen
    function checkDispatchStatus() {
        const statusElement = document.getElementById('dispatchStatus');
        statusElement.textContent = 'Pr√ºfe Status...';
        
        fetch('/api/dispatch/status')
            .then(response => response.json())
            .then(data => {
                if (data.dispatch_available) {
                    statusElement.textContent = '‚úÖ Dispatch verf√ºgbar';
                    statusElement.className = 'text-green-600';
                } else {
                    statusElement.textContent = '‚ùå Dispatch nicht verf√ºgbar';
                    statusElement.className = 'text-red-600';
                }
            })
            .catch(error => {
                console.error('Fehler beim Pr√ºfen des Dispatch-Status:', error);
                statusElement.textContent = '‚ùå Fehler beim Pr√ºfen des Status';
                statusElement.className = 'text-red-600';
            });
    }

    // Projekte laden
    function loadProjects() {
        console.log('Lade Projekte...'); // Debug
        fetch('/api/projects')
            .then(response => response.json())
            .then(data => {
                console.log('Geladene Projekte:', data); // Debug
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Projekt w√§hlen...</option>';
                
                if (Array.isArray(data)) {
                    data.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        select.appendChild(option);
                    });
                    
                    // Event-Listener f√ºr Projektauswahl hinzuf√ºgen (nur einmal)
                    if (!select.hasAttribute('data-event-listener-added')) {
                        select.addEventListener('change', function() {
                            currentProjectId = this.value;
                            console.log('Projekt ausgew√§hlt:', currentProjectId); // Debug
                            if (currentProjectId) {
                                loadDispatchHistory(currentProjectId);
                            }
                        });
                        select.setAttribute('data-event-listener-added', 'true');
                    }
                } else {
                    console.error('Unerwartetes Datenformat:', data);
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Projekte:', error);
            });
    }

    // Event-Listener einrichten
    function setupEventListeners() {
        // Weitere Event-Listener k√∂nnen hier hinzugef√ºgt werden
    }

    // CSV-Upload verarbeiten
    document.getElementById('redispatchCsv').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                console.log('CSV-Daten geladen:', csvData);
                // Hier k√∂nnen Sie die CSV-Daten verarbeiten
            };
            reader.readAsText(file);
        }
    });

    // Dispatch-Simulation starten
    function startDispatchSimulation() {
        if (!currentProjectId) {
            alert('Bitte w√§hlen Sie zuerst ein Projekt aus.');
            return;
        }

        const params = {
            project_id: currentProjectId,
            dispatch_mode: document.getElementById('dispatchMode').value,
            time_resolution: parseInt(document.getElementById('timeResolution').value),
            country: document.getElementById('country').value,
            simulation_year: parseInt(document.getElementById('simulationYear').value)
        };

        console.log('Starte Dispatch-Simulation mit Parametern:', params);

        fetch('/api/dispatch/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Dispatch-Simulation erfolgreich:', data);
                updateResults(data);
                loadDispatchHistory(currentProjectId);
            } else {
                console.error('Dispatch-Simulation fehlgeschlagen:', data);
                alert('Fehler bei der Dispatch-Simulation: ' + (data.message || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Fehler bei der Dispatch-Simulation:', error);
            alert('Fehler bei der Dispatch-Simulation: ' + error.message);
        });
    }

    // Redispatch-Simulation starten
    function startRedispatchSimulation() {
        if (!currentProjectId) {
            alert('Bitte w√§hlen Sie zuerst ein Projekt aus.');
            return;
        }

        // Hier implementieren Sie die Redispatch-Logik
        console.log('Redispatch-Simulation gestartet f√ºr Projekt:', currentProjectId);
        alert('Redispatch-Simulation gestartet!');
    }

    // Ergebnisse aktualisieren
    function updateResults(data) {
        console.log('Aktualisiere Ergebnisse mit Daten:', data);
        
        // KPI-Ergebnisse aktualisieren
        const kpiElement = document.getElementById('kpiResults');
        const baseline = data.baseline || {};
        const settlement = baseline.settlement || [];
        
        // Berechne Summen aus den Siedlungsdaten
        let totalRevenue = 0;
        let totalCost = 0;
        if (settlement && settlement.length > 0) {
            totalRevenue = settlement.reduce((sum, item) => sum + (item.revenue || 0), 0);
            totalCost = settlement.reduce((sum, item) => sum + (item.cost || 0), 0);
        }
        const netCashflow = totalRevenue - totalCost;
        
        kpiElement.innerHTML = `
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">‚Ç¨${totalRevenue.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Gesamteinnahmen</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">‚Ç¨${totalCost.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Gesamtkosten</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">‚Ç¨${netCashflow.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Netto-Cashflow</div>
            </div>
        `;

        // SoC-Chart aktualisieren
        if (baseline.simulation && baseline.simulation.length > 0) {
            updateSocChart(baseline.simulation);
        }
        
        // Cashflow-Chart aktualisieren
        if (settlement && settlement.length > 0) {
            updateCashflowChart(settlement);
        }
    }

    // SoC-Chart aktualisieren
    function updateSocChart(socData) {
        const ctx = document.getElementById('socChart').getContext('2d');
        
        if (socChart) {
            socChart.destroy();
        }
        
        // Extrahiere Stunden und SoC-Werte aus den Simulationsdaten
        const labels = socData.map(item => `Stunde ${item.hour}`);
        const values = socData.map(item => item.soc);
        
        socChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'State of Charge (%)',
                    data: values,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Cashflow-Chart aktualisieren
    function updateCashflowChart(cashflowData) {
        const ctx = document.getElementById('cashflowChart').getContext('2d');
        
        if (cashflowChart) {
            cashflowChart.destroy();
        }
        
        // Extrahiere Stunden und Cashflow-Werte aus den Siedlungsdaten
        const labels = cashflowData.map(item => `Stunde ${item.hour}`);
        const values = cashflowData.map(item => (item.revenue || 0) - (item.cost || 0));
        
        cashflowChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cashflow (‚Ç¨)',
                    data: values,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Dispatch-Historie laden
    function loadDispatchHistory(projectId) {
        fetch(`/api/dispatch/history/${projectId}`)
            .then(response => response.json())
            .then(data => {
                updateHistoryTable(data.simulations || []);
            })
            .catch(error => {
                console.error('Fehler beim Laden der Historie:', error);
            });
    }

    // Historie-Tabelle aktualisieren
    function updateHistoryTable(simulations) {
        const tbody = document.getElementById('historyTableBody');
        
        if (simulations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Keine Historie verf√ºgbar</td></tr>';
            return;
        }
        
        tbody.innerHTML = simulations.map(sim => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(sim.simulation_date).toLocaleDateString('de-DE')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sim.project_name || 'Unbekannt'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sim.dispatch_mode}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç¨${sim.total_revenue?.toFixed(2) || '0.00'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        Abgeschlossen
                    </span>
                </td>
            </tr>
        `).join('');
    }

    // Redispatch-Zeile hinzuf√ºgen
    function addRedispatchRow() {
        const container = document.getElementById('redispatchInputs');
        const newRow = document.createElement('div');
        newRow.className = 'flex space-x-2';
        newRow.innerHTML = `
            <input type="datetime-local" class="flex-1 px-2 py-1 rounded text-gray-800" placeholder="TT. MM. JJJJ, --:--">
            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="Slots">
            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="MW">
            <select class="w-24 px-2 py-1 rounded text-gray-800">
                <option value="delta">Delta</option>
                <option value="absolute">Absolut</option>
            </select>
            <button onclick="this.parentElement.remove()" class="w-8 h-8 bg-red-500 text-white rounded hover:bg-red-600">√ó</button>
        `;
        container.appendChild(newRow);
    }
</script>
{% endblock %}
