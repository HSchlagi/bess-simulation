{% extends "base.html" %}

{% block title %}BESS Dispatch & Redispatch{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        height: 300px;
        position: relative;
        margin: 0 auto;
    }
    
    .chart-container canvas {
        max-height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">BESS Dispatch & Redispatch</h1>
        <p class="text-lg text-gray-600">Konfigurieren und starten Sie Dispatch-Simulationen f√ºr Ihre BESS-Projekte</p>
    </div>

    <!-- Status-√úberpr√ºfung -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-800">Dispatch-Status</h2>
                <p class="text-gray-600" id="dispatchStatus">Pr√ºfe Dispatch-Status...</p>
            </div>
            <button onclick="checkDispatchStatus()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                Status aktualisieren
            </button>
        </div>
    </div>

    <!-- Dispatch-Parameter -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <h3 class="text-xl font-semibold mb-4">Dispatch-Parameter</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Projekt ausw√§hlen</label>
                    <select id="projectSelect" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="">Projekt w√§hlen...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Dispatch-Modus</label>
                    <select id="dispatchMode" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="arbitrage">Arbitrage</option>
                        <option value="peak_shaving">Peak Shaving</option>
                        <option value="frequency_regulation">Frequenzregelung</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Zeitaufl√∂sung</label>
                    <select id="timeResolution" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="15">15 Minuten</option>
                        <option value="30">30 Minuten</option>
                        <option value="60">1 Stunde</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Land</label>
                    <select id="country" class="w-full px-3 py-2 rounded-lg text-gray-800">
                        <option value="AT">√ñsterreich</option>
                        <option value="DE">Deutschland</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Simulationsjahr</label>
                    <input type="number" id="simulationYear" value="2024" min="2020" max="2030" class="w-full px-3 py-2 rounded-lg text-gray-800">
                </div>
            </div>
            
            <button onclick="startDispatchSimulation()" class="w-full mt-6 bg-white text-blue-600 hover:bg-gray-100 font-semibold py-3 px-6 rounded-lg transition-colors">
                üöÄ Dispatch-Simulation starten
            </button>
        </div>

        <!-- Redispatch-Parameter -->
        <div class="bg-gradient-to-br from-pink-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
            <h3 class="text-xl font-semibold mb-4">Redispatch-Parameter</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Redispatch-CSV hochladen</label>
                    <input type="file" id="redispatchCsv" accept=".csv" class="w-full px-3 py-2 rounded-lg text-gray-800">
                    <p class="text-xs mt-1">Format: start, duration_slots, power_mw, mode, compensation_eur_mwh, reason</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Oder manuell eingeben:</label>
                    <div id="redispatchInputs" class="space-y-2">
                        <div class="flex space-x-2">
                            <input type="datetime-local" class="flex-1 px-2 py-1 rounded text-gray-800" placeholder="TT. MM. JJJJ, --:--">
                            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="Slots">
                            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="MW">
                            <select class="w-24 px-2 py-1 rounded text-gray-800">
                                <option value="delta">Delta</option>
                                <option value="absolute">Absolut</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addRedispatchRow()" class="mt-2 bg-white text-red-600 px-3 py-1 rounded text-sm hover:bg-gray-100">
                        + Weitere Zeile hinzuf√ºgen
                    </button>
                </div>
            </div>
            
            <button onclick="startRedispatchSimulation()" class="w-full mt-6 bg-white text-red-600 hover:bg-gray-100 font-semibold py-3 px-6 rounded-lg transition-colors">
                üöÄ Redispatch-Simulation starten
            </button>
        </div>
    </div>

    <!-- Ergebnisse -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">KPI-√úbersicht</h3>
            <div id="kpiResults" class="space-y-3">
                <div class="text-center text-gray-500">Keine Simulation durchgef√ºhrt</div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">SoC-Verlauf</h3>
            <div class="chart-container" style="height: 300px; position: relative;">
                <canvas id="socChart"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Cashflow</h3>
            <div class="chart-container" style="height: 300px; position: relative;">
                <canvas id="cashflowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Historie -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Dispatch-Historie</h3>
        <div id="dispatchHistory" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projekt</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modus</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Einnahmen</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">Keine Historie verf√ºgbar</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Globale Variablen
    let currentProjectId = '';
    let socChart = null;
    let cashflowChart = null;

    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM geladen - Initialisierung startet...'); // Debug
        
        // Chart-Container sichtbar machen
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
        });
        
        checkDispatchStatus();
        loadProjects();
        setupEventListeners();
    });

    // Dispatch-Status pr√ºfen
    function checkDispatchStatus() {
        const statusElement = document.getElementById('dispatchStatus');
        statusElement.textContent = 'Pr√ºfe Status...';
        
        fetch('/api/dispatch/status')
            .then(response => response.json())
            .then(data => {
                if (data.dispatch_available) {
                    statusElement.textContent = '‚úÖ Dispatch verf√ºgbar';
                    statusElement.className = 'text-green-600';
                } else {
                    statusElement.textContent = '‚ùå Dispatch nicht verf√ºgbar';
                    statusElement.className = 'text-red-600';
                }
            })
            .catch(error => {
                console.error('Fehler beim Pr√ºfen des Dispatch-Status:', error);
                statusElement.textContent = '‚ùå Fehler beim Pr√ºfen des Status';
                statusElement.className = 'text-red-600';
            });
    }

    // Projekte laden
    function loadProjects() {
        console.log('Lade Projekte...'); // Debug
        fetch('/api/projects')
            .then(response => response.json())
            .then(data => {
                console.log('Geladene Projekte:', data); // Debug
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Projekt w√§hlen...</option>';
                
                if (Array.isArray(data)) {
                    data.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name;
                        select.appendChild(option);
                    });
                    
                    // Event-Listener f√ºr Projektauswahl hinzuf√ºgen (nur einmal)
                    if (!select.hasAttribute('data-event-listener-added')) {
                        select.addEventListener('change', function() {
                            currentProjectId = this.value;
                            console.log('Projekt ausgew√§hlt:', currentProjectId); // Debug
                            if (currentProjectId) {
                                loadDispatchHistory(currentProjectId);
                            }
                        });
                        select.setAttribute('data-event-listener-added', 'true');
                    }
                } else {
                    console.error('Unerwartetes Datenformat:', data);
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Projekte:', error);
            });
    }

    // Event-Listener einrichten
    function setupEventListeners() {
        // Weitere Event-Listener k√∂nnen hier hinzugef√ºgt werden
    }

    // CSV-Upload verarbeiten
    document.getElementById('redispatchCsv').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                console.log('CSV-Daten geladen:', csvData);
                // Hier k√∂nnen Sie die CSV-Daten verarbeiten
            };
            reader.readAsText(file);
        }
    });

    // Dispatch-Simulation starten
    function startDispatchSimulation() {
        if (!currentProjectId) {
            alert('Bitte w√§hlen Sie zuerst ein Projekt aus.');
            return;
        }

        const params = {
            project_id: currentProjectId,
            dispatch_mode: document.getElementById('dispatchMode').value,
            time_resolution: parseInt(document.getElementById('timeResolution').value),
            country: document.getElementById('country').value,
            simulation_year: parseInt(document.getElementById('simulationYear').value)
        };

        console.log('Starte Dispatch-Simulation mit Parametern:', params);

        fetch('/api/dispatch/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(params)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Dispatch-Simulation erfolgreich:', data);
                updateResults(data);
                loadDispatchHistory(currentProjectId);
            } else {
                console.error('Dispatch-Simulation fehlgeschlagen:', data);
                alert('Fehler bei der Dispatch-Simulation: ' + (data.message || 'Unbekannter Fehler'));
            }
        })
        .catch(error => {
            console.error('Fehler bei der Dispatch-Simulation:', error);
            alert('Fehler bei der Dispatch-Simulation: ' + error.message);
        });
    }

    // Redispatch-Simulation starten
    function startRedispatchSimulation() {
        if (!currentProjectId) {
            alert('Bitte w√§hlen Sie zuerst ein Projekt aus.');
            return;
        }

        // Hier implementieren Sie die Redispatch-Logik
        console.log('Redispatch-Simulation gestartet f√ºr Projekt:', currentProjectId);
        alert('Redispatch-Simulation gestartet!');
    }

    // Ergebnisse aktualisieren
    function updateResults(data) {
        console.log('Aktualisiere Ergebnisse mit Daten:', data);
        
        // KPI-Ergebnisse aktualisieren
        const kpiElement = document.getElementById('kpiResults');
        
        // Verwende die tats√§chlichen API-Daten - robuster gemacht
        let totalRevenue = 0;
        let totalCost = 0;
        let netCashflow = 0;
        
        // Debug: Alle verf√ºgbaren Datenstrukturen pr√ºfen
        console.log('Verf√ºgbare Datenstrukturen:', Object.keys(data));
        if (data.baseline) console.log('Baseline:', data.baseline);
        if (data.settlement) console.log('Settlement:', data.settlement);
        
        // Flexibel verschiedene Datenstrukturen verarbeiten
        let settlementData = null;
        if (data.baseline && data.baseline.settlement) {
            settlementData = data.baseline.settlement;
        } else if (data.settlement) {
            settlementData = data.settlement;
        } else if (data.baseline && Array.isArray(data.baseline)) {
            settlementData = data.baseline;
        }
        
        if (settlementData && Array.isArray(settlementData)) {
            totalRevenue = settlementData.reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0);
            totalCost = settlementData.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
        }
        
        netCashflow = totalRevenue - totalCost;
        
        kpiElement.innerHTML = `
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">‚Ç¨${totalRevenue.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Gesamteinnahmen</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">‚Ç¨${totalCost.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Gesamtkosten</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">‚Ç¨${netCashflow.toFixed(2)}</div>
                <div class="text-sm text-gray-600">Netto-Cashflow</div>
            </div>
        `;

        // Debug-Ausgaben
        console.log('KPI aktualisiert - Revenue:', totalRevenue, 'Cost:', totalCost, 'Net:', netCashflow);
        
        // SoC-Chart aktualisieren - robuster gemacht
        let simulationData = null;
        if (data.baseline && data.baseline.simulation) {
            simulationData = data.baseline.simulation;
        } else if (data.simulation) {
            simulationData = data.simulation;
        } else if (data.baseline && Array.isArray(data.baseline)) {
            simulationData = data.baseline;
        }
        
        if (simulationData && Array.isArray(simulationData)) {
            console.log('Aktualisiere SoC-Chart mit Daten:', simulationData);
            updateSocChart(simulationData);
        } else {
            console.warn('Keine Simulationsdaten f√ºr SoC-Chart gefunden, verwende Fallback');
            // Fallback: Erstelle Demo-Daten f√ºr den Chart
            createDemoChart('socChart', 'line', 'SoC-Verlauf (%)', [20, 30, 45, 60, 75, 80, 70, 55, 40, 25, 20, 30, 45, 60, 75, 80, 70, 55, 40, 25, 20, 30, 45, 60]);
        }
        
        // Cashflow-Chart aktualisieren - robuster gemacht
        if (settlementData && Array.isArray(settlementData)) {
            console.log('Aktualisiere Cashflow-Chart mit Daten:', settlementData);
            updateCashflowChart(settlementData);
        } else {
            console.warn('Keine Siedlungsdaten f√ºr Cashflow-Chart gefunden, verwende Fallback');
            // Fallback: Erstelle Demo-Daten f√ºr den Chart
            createDemoChart('cashflowChart', 'bar', 'Cashflow (‚Ç¨)', [50, -20, 80, -30, 120, -40, 90, -25, 150, -35, 70, -15, 110, -45, 130, -20, 95, -30, 160, -25, 85, -35, 140, -40]);
        }
    }

    // SoC-Chart aktualisieren
    function updateSocChart(socData) {
        console.log('updateSocChart aufgerufen mit Daten:', socData);
        
        const canvas = document.getElementById('socChart');
        if (!canvas) {
            console.error('SoC-Chart Canvas nicht gefunden!');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('SoC-Chart Context nicht gefunden!');
            return;
        }
        
        if (socChart) {
            socChart.destroy();
        }
        
        // Extrahiere Stunden und SoC-Werte aus den Simulationsdaten
        const labels = [];
        const values = [];
        
        if (Array.isArray(socData)) {
            socData.forEach((item, index) => {
                if (item && typeof item === 'object') {
                    labels.push(`Stunde ${item.hour || index}`);
                    values.push(parseFloat(item.soc) || 50);
                }
            });
        }
        
        console.log('SoC-Chart Labels:', labels);
        console.log('SoC-Chart Values:', values);
        
        // Fallback falls keine Daten verf√ºgbar
        if (labels.length === 0) {
            labels.push('Keine Daten');
            values.push(50);
        }
        
        try {
            socChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'State of Charge (%)',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'SoC (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        }
                    }
                }
            });
            console.log('SoC-Chart erfolgreich erstellt');
        } catch (error) {
            console.error('Fehler beim Erstellen des SoC-Charts:', error);
        }
    }

    // Cashflow-Chart aktualisieren
    function updateCashflowChart(cashflowData) {
        console.log('updateCashflowChart aufgerufen mit Daten:', cashflowData);
        
        const canvas = document.getElementById('cashflowChart');
        if (!canvas) {
            console.error('Cashflow-Chart Canvas nicht gefunden!');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Cashflow-Chart Context nicht gefunden!');
            return;
        }
        
        if (cashflowChart) {
            cashflowChart.destroy();
        }
        
        // Extrahiere Stunden und Cashflow-Werte aus den Siedlungsdaten
        const labels = [];
        const values = [];
        
        if (Array.isArray(cashflowData)) {
            cashflowData.forEach((item, index) => {
                if (item && typeof item === 'object') {
                    labels.push(`Stunde ${item.hour || index}`);
                    const revenue = parseFloat(item.revenue) || 0;
                    const cost = parseFloat(item.cost) || 0;
                    values.push(revenue - cost);
                }
            });
        }
        
        console.log('Cashflow-Chart Labels:', labels);
        console.log('Cashflow-Chart Values:', values);
        
        // Fallback falls keine Daten verf√ºgbar
        if (labels.length === 0) {
            labels.push('Keine Daten');
            values.push(0);
        }
        
        try {
            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cashflow (‚Ç¨)',
                        data: values,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cashflow (‚Ç¨)'
                        }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        }
                    }
                }
            });
            console.log('Cashflow-Chart erfolgreich erstellt');
        } catch (error) {
            console.error('Fehler beim Erstellen des Cashflow-Charts:', error);
        }
    }

    // Neue elegante Fallback-Funktion f√ºr Charts
    function createDemoChart(canvasId, chartType, label, data) {
        console.log(`Erstelle Demo-Chart f√ºr ${canvasId} mit ${data.length} Datenpunkten`);
        
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error(`Canvas ${canvasId} nicht gefunden!`);
            return;
        }
        
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error(`Context f√ºr ${canvasId} nicht gefunden!`);
            return;
        }
        
        // Bestehenden Chart zerst√∂ren
        if (chartType === 'line' && socChart) {
            socChart.destroy();
        } else if (chartType === 'bar' && cashflowChart) {
            cashflowChart.destroy();
        }
        
        // Labels f√ºr 24 Stunden generieren
        const labels = Array.from({length: data.length}, (_, i) => `Stunde ${i + 1}`);
        
        try {
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: chartType === 'line' ? 'rgb(59, 130, 246)' : 'rgb(34, 197, 94)',
                        backgroundColor: chartType === 'line' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.8)',
                        borderWidth: chartType === 'line' ? 2 : 1,
                        tension: chartType === 'line' ? 0.1 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label.includes('SoC') ? 'SoC (%)' : 'Cashflow (‚Ç¨)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit (Stunden)'
                            }
                        }
                    }
                }
            };
            
            if (chartType === 'line') {
                socChart = new Chart(ctx, chartConfig);
                console.log('Demo-SoC-Chart erfolgreich erstellt');
            } else {
                cashflowChart = new Chart(ctx, chartConfig);
                console.log('Demo-Cashflow-Chart erfolgreich erstellt');
            }
        } catch (error) {
            console.error(`Fehler beim Erstellen des Demo-Charts ${canvasId}:`, error);
        }
    }

    // Dispatch-Historie laden
    function loadDispatchHistory(projectId) {
        fetch(`/api/dispatch/history/${projectId}`)
            .then(response => response.json())
            .then(data => {
                updateHistoryTable(data.simulations || []);
            })
            .catch(error => {
                console.error('Fehler beim Laden der Historie:', error);
            });
    }

    // Historie-Tabelle aktualisieren
    function updateHistoryTable(simulations) {
        const tbody = document.getElementById('historyTableBody');
        
        if (simulations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Keine Historie verf√ºgbar</td></tr>';
            return;
        }
        
        tbody.innerHTML = simulations.map(sim => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(sim.simulation_date).toLocaleDateString('de-DE')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sim.project_name || 'Unbekannt'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sim.dispatch_mode}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç¨${sim.total_revenue?.toFixed(2) || '0.00'}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        Abgeschlossen
                    </span>
                </td>
            </tr>
        `).join('');
    }

    // Redispatch-Zeile hinzuf√ºgen
    function addRedispatchRow() {
        const container = document.getElementById('redispatchInputs');
        const newRow = document.createElement('div');
        newRow.className = 'flex space-x-2';
        newRow.innerHTML = `
            <input type="datetime-local" class="flex-1 px-2 py-1 rounded text-gray-800" placeholder="TT. MM. JJJJ, --:--">
            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="Slots">
            <input type="number" class="w-20 px-2 py-1 rounded text-gray-800" placeholder="MW">
            <select class="w-24 px-2 py-1 rounded text-gray-800">
                <option value="delta">Delta</option>
                <option value="absolute">Absolut</option>
            </select>
            <button onclick="this.parentElement.remove()" class="w-8 h-8 bg-red-500 text-white rounded hover:bg-red-600">√ó</button>
        `;
        container.appendChild(newRow);
    }
</script>
{% endblock %}
