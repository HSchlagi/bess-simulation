{% extends "base.html" %}

{% block title %}COâ‚‚-Tracking & Nachhaltigkeit - BESS Simulation{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-leaf text-green-600 text-3xl mr-3"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">COâ‚‚-Tracking & Nachhaltigkeit</h1>
                        <p class="text-gray-600 mt-1">Detaillierte Nachhaltigkeits- und Performance-Analysen</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="loadDemoData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Aktualisieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Projekt-Auswahl -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Projekt auswÃ¤hlen</h2>
            <div class="flex items-center space-x-4">
                <select id="projectSelect" onchange="loadDemoData()" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Projekt auswÃ¤hlen...</option>
                    <option value="1">BESS Hinterstoder</option>
                    <option value="2">Solar-BESS Wien</option>
                    <option value="3">BESS Tillysburg</option>
                    <option value="4">Test Projekt Daily Cycles</option>
                </select>
                <select class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="30">Letzte 30 Tage</option>
                    <option value="90">Letzte 3 Monate</option>
                    <option value="365">Letztes Jahr</option>
                </select>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- COâ‚‚-Einsparungen -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-leaf text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">COâ‚‚-Einsparungen</p>
                        <p class="text-2xl font-bold text-gray-900" id="co2Saved">0 kg</p>
                    </div>
                </div>
            </div>

            <!-- Erneuerbare Energie -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-solar-panel text-yellow-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Erneuerbare Energie</p>
                        <p class="text-2xl font-bold text-gray-900" id="renewableShare">0%</p>
                    </div>
                </div>
            </div>

            <!-- Energieeffizienz -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-bolt text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Energieeffizienz</p>
                        <p class="text-2xl font-bold text-gray-900" id="energyEfficiency">0%</p>
                    </div>
                </div>
            </div>

            <!-- Kosteneinsparungen -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-euro-sign text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Kosteneinsparungen</p>
                        <p class="text-2xl font-bold text-gray-900" id="costSavings">0 â‚¬</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- COâ‚‚-Bilanz Chart -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">COâ‚‚-Bilanz Verlauf</h3>
                <div class="h-64">
                    <canvas id="co2BalanceChart"></canvas>
                </div>
            </div>

            <!-- Erneuerbare Energie Chart -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Erneuerbare Energie Anteil</h3>
                <div class="h-64">
                    <canvas id="renewableEnergyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ESG Score Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">ESG-Score</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- Environmental Score -->
                <div class="text-center">
                    <div class="relative w-24 h-24 mx-auto mb-2">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="40" stroke="#10b981" stroke-width="8" fill="none"
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" id="envScoreCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-900" id="envScore">0</span>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-gray-600">Environmental</p>
                </div>

                <!-- Social Score -->
                <div class="text-center">
                    <div class="relative w-24 h-24 mx-auto mb-2">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="40" stroke="#3b82f6" stroke-width="8" fill="none"
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" id="socialScoreCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-900" id="socialScore">0</span>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-gray-600">Social</p>
                </div>

                <!-- Governance Score -->
                <div class="text-center">
                    <div class="relative w-24 h-24 mx-auto mb-2">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="40" stroke="#8b5cf6" stroke-width="8" fill="none"
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" id="govScoreCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-900" id="govScore">0</span>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-gray-600">Governance</p>
                </div>

                <!-- Overall ESG Score -->
                <div class="text-center">
                    <div class="relative w-24 h-24 mx-auto mb-2">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="40" stroke="#f59e0b" stroke-width="8" fill="none"
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" id="overallScoreCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-bold text-gray-900" id="overallScore">0</span>
                        </div>
                    </div>
                    <p class="text-sm font-medium text-gray-600">Overall ESG</p>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Nachhaltigkeits-Reports</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="generateReport('monthly')" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-calendar-alt mr-2"></i>Monatlicher Report
                </button>
                <button onclick="generateReport('quarterly')" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Quartalsbericht
                </button>
                <button onclick="generateReport('yearly')" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-file-alt mr-2"></i>Jahresbericht
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 id="reportModalTitle" class="text-lg font-medium text-gray-900">Nachhaltigkeits-Report</h3>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div id="reportModalBody" class="mt-2 px-7 py-3">
                <!-- Report content will be inserted here -->
            </div>
            
            <!-- Modal Footer -->
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeReportModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    SchlieÃŸen
                </button>
                <button onclick="downloadReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>PDF herunterladen
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Einfache, direkte JavaScript-Funktionen
let co2Chart = null;
let renewableChart = null;

function loadDemoData() {
    console.log('Lade Demo-Daten...');
    
    // KPIs setzen
    document.getElementById('co2Saved').textContent = '13.006 kg';
    document.getElementById('renewableShare').textContent = '55.9%';
    document.getElementById('energyEfficiency').textContent = '46.9%';
    document.getElementById('costSavings').textContent = '40.461 â‚¬';
    
    // ESG-Scores setzen und animieren
    document.getElementById('envScore').textContent = '30';
    document.getElementById('socialScore').textContent = '44';
    document.getElementById('govScore').textContent = '85';
    document.getElementById('overallScore').textContent = '51';
    
    // ESG-Score-Kreise animieren
    updateCircularProgress('envScore', 'envScoreCircle', 30);
    updateCircularProgress('socialScore', 'socialScoreCircle', 44);
    updateCircularProgress('govScore', 'govScoreCircle', 85);
    updateCircularProgress('overallScore', 'overallScoreCircle', 51);
    
    // Charts erstellen
    createCharts();
    
    console.log('Demo-Daten erfolgreich geladen!');
}

function updateCircularProgress(elementId, circleId, score) {
    document.getElementById(elementId).textContent = Math.round(score);
    
    const circle = document.getElementById(circleId);
    if (circle) {
        const circumference = 2 * Math.PI * 40;
        const offset = circumference - (score / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }
}

function createCharts() {
    // COâ‚‚-Bilanz Chart
    const co2Ctx = document.getElementById('co2BalanceChart').getContext('2d');
    if (co2Chart) {
        co2Chart.destroy();
    }
    
    co2Chart = new Chart(co2Ctx, {
        type: 'line',
        data: {
            labels: ['1.9.', '2.9.', '3.9.', '4.9.', '5.9.', '6.9.', '7.9.'],
            datasets: [{
                label: 'COâ‚‚-Einsparungen (kg)',
                data: [450, 520, 380, 600, 480, 550, 420],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }, {
                label: 'COâ‚‚-Emissionen (kg)',
                data: [320, 380, 290, 450, 350, 400, 310],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Erneuerbare Energie Chart
    const renewableCtx = document.getElementById('renewableEnergyChart').getContext('2d');
    if (renewableChart) {
        renewableChart.destroy();
    }
    
    renewableChart = new Chart(renewableCtx, {
        type: 'bar',
        data: {
            labels: ['Juni', 'Juli', 'August'],
            datasets: [{
                label: 'Erneuerbare Energie (%)',
                data: [55.2, 56.1, 55.9],
                backgroundColor: '#fbbf24',
                borderColor: '#f59e0b',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    console.log('Charts erstellt!');
}

function generateReport(reportType) {
    const selectedProject = document.getElementById('projectSelect').value;
    
    if (!selectedProject) {
        alert('Bitte wÃ¤hlen Sie zuerst ein Projekt aus!');
        return;
    }
    
    try {
        // Report-Daten generieren
        const reportData = generateReportData(reportType);
        
        // Report anzeigen
        displayReport(reportType, reportData);
    } catch (error) {
        console.error('Fehler beim Generieren des Reports:', error);
        alert('Fehler beim Generieren des Reports: ' + error.message);
    }
}

function generateReportData(reportType) {
    const projectName = document.getElementById('projectSelect').selectedOptions[0].text;
    const currentDate = new Date().toLocaleDateString('de-DE');
    
    return {
        projectName: projectName,
        reportType: reportType,
        date: currentDate,
        co2Saved: document.getElementById('co2Saved').textContent,
        renewableShare: document.getElementById('renewableShare').textContent,
        energyEfficiency: document.getElementById('energyEfficiency').textContent,
        costSavings: document.getElementById('costSavings').textContent,
        envScore: document.getElementById('envScore').textContent,
        socialScore: document.getElementById('socialScore').textContent,
        govScore: document.getElementById('govScore').textContent,
        overallScore: document.getElementById('overallScore').textContent
    };
}

function displayReport(reportType, data) {
    const modal = document.getElementById('reportModal');
    const modalTitle = document.getElementById('reportModalTitle');
    const modalBody = document.getElementById('reportModalBody');
    
    // Modal-Titel setzen
    const typeNames = {
        'monthly': 'Monatlicher Nachhaltigkeits-Report',
        'quarterly': 'Quartalsbericht Nachhaltigkeit',
        'yearly': 'Jahresbericht Nachhaltigkeit'
    };
    
    modalTitle.textContent = typeNames[reportType] || 'Nachhaltigkeits-Report';
    
    // Report-Inhalt generieren
    modalBody.innerHTML = generateReportHTML(data);
    
    // Modal anzeigen
    modal.style.display = 'block';
}

function generateReportHTML(data) {
    return `
        <div class="report-content">
            <div class="report-header">
                <h2>${data.projectName} - ${data.reportType === 'monthly' ? 'Monatlicher' : data.reportType === 'quarterly' ? 'Quartals' : 'Jahres'} Nachhaltigkeits-Report</h2>
                <p><strong>Erstellt am:</strong> ${data.date}</p>
            </div>
            
            <div class="report-section">
                <h3>ðŸ“Š Nachhaltigkeits-KPIs</h3>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <strong>COâ‚‚-Einsparungen:</strong> ${data.co2Saved}
                    </div>
                    <div class="kpi-item">
                        <strong>Erneuerbare Energie:</strong> ${data.renewableShare}
                    </div>
                    <div class="kpi-item">
                        <strong>Energieeffizienz:</strong> ${data.energyEfficiency}
                    </div>
                    <div class="kpi-item">
                        <strong>Kosteneinsparungen:</strong> ${data.costSavings}
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h3>ðŸŒ± ESG-Scores</h3>
                <div class="esg-grid">
                    <div class="esg-item">
                        <strong>Environmental:</strong> ${data.envScore}/100
                    </div>
                    <div class="esg-item">
                        <strong>Social:</strong> ${data.socialScore}/100
                    </div>
                    <div class="esg-item">
                        <strong>Governance:</strong> ${data.govScore}/100
                    </div>
                    <div class="esg-item">
                        <strong>Overall ESG:</strong> ${data.overallScore}/100
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h3>ðŸ“ˆ Zusammenfassung</h3>
                <p>Das Projekt ${data.projectName} zeigt positive Nachhaltigkeitsentwicklungen mit ${data.renewableShare} erneuerbarer Energie und ${data.co2Saved} COâ‚‚-Einsparungen.</p>
            </div>
        </div>
    `;
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

function downloadReport() {
    const reportContent = document.getElementById('reportModalBody').innerHTML;
    const projectName = document.getElementById('projectSelect').selectedOptions[0].text;
    const reportType = document.getElementById('reportModalTitle').textContent;
    
    // Neues Fenster fÃ¼r Druck Ã¶ffnen
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${reportType}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .report-header { text-align: center; margin-bottom: 30px; }
                .report-section { margin-bottom: 25px; }
                .kpi-grid, .esg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                .kpi-item, .esg-item { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                h2 { color: #2d3748; }
                h3 { color: #4a5568; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            ${reportContent}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Dashboard initialisiert - wartet auf Projekt-Auswahl
document.addEventListener('DOMContentLoaded', function() {
    console.log('COâ‚‚-Dashboard geladen - bereit fÃ¼r Projekt-Auswahl');
});
</script>
{% endblock %}
