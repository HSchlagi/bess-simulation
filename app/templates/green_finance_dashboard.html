{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-700 text-white p-6 rounded-lg mb-6">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Green Finance Dashboard</h1>
                    <p class="text-green-100">Nachhaltige Finanzanlagen und Green Bonds Portfolio</p>
                </div>
            </div>
            <div class="text-right">
                <div id="currentDateTime" class="text-sm"></div>
                <div class="mt-2">
                    <select id="projectSelect" style="min-width: 250px; z-index: 1000;">
                        <option value="">Projekt ausw√§hlen...</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm">Gesamt Portfolio</p>
                    <p class="text-2xl font-bold" id="totalPortfolio">0 ‚Ç¨</p>
                </div>
                <i class="fas fa-wallet text-2xl text-green-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm">Green Bonds</p>
                    <p class="text-2xl font-bold" id="greenBonds">0 ‚Ç¨</p>
                </div>
                <i class="fas fa-leaf text-2xl text-blue-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-600 to-violet-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm">Sustainability Bonds</p>
                    <p class="text-2xl font-bold" id="sustainabilityBonds">0 ‚Ç¨</p>
                </div>
                <i class="fas fa-recycle text-2xl text-purple-200"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm">Jahresrendite</p>
                    <p class="text-2xl font-bold" id="annualReturn">0%</p>
                    <p class="text-xs text-orange-200" id="esgRating">ESG Rating: -</p>
                </div>
                <i class="fas fa-chart-line text-2xl text-orange-200"></i>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8 border-b border-gray-200">
            <button id="portfolioTab" onclick="switchTab('portfolio')" class="tab-button active py-2 px-1 border-b-2 border-green-500 text-sm font-medium text-green-600">
                <i class="fas fa-chart-pie mr-2"></i>Portfolio
            </button>
            <button id="tradingTab" onclick="switchTab('trading')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-exchange-alt mr-2"></i>Handel
            </button>
            <button id="analyticsTab" onclick="switchTab('analytics')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-chart-line mr-2"></i>Analytics
            </button>
            <button id="reportsTab" onclick="switchTab('reports')" class="tab-button py-2 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                <i class="fas fa-file-alt mr-2"></i>Berichte
            </button>
        </nav>
    </div>

    <!-- Portfolio Tab Content -->
    <div id="portfolioContent" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Portfolio Verteilung</h3>
                <div style="height: 300px; position: relative; background-color: #f8f9fa;">
                    <canvas id="portfolioChart" width="400" height="300" style="display: block !important; width: 400px !important; height: 300px !important; position: absolute !important; top: 0 !important; left: 0 !important;"></canvas>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Performance Entwicklung</h3>
                <div style="height: 300px; position: relative; background-color: #f8f9fa;">
                    <canvas id="performanceChart" width="400" height="300" style="display: block !important; width: 400px !important; height: 300px !important; position: absolute !important; top: 0 !important; left: 0 !important;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Tab Content -->
    <div id="tradingContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Green Bonds Handel</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-green-50 rounded-lg">
                        <span class="font-medium">Green Bond Portfolio</span>
                        <span class="text-green-600 font-bold" id="greenBondsValue">0 ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                        <span class="font-medium">Sustainability Bonds</span>
                        <span class="text-blue-600 font-bold" id="sustainabilityBondsValue">0 ‚Ç¨</span>
                    </div>
                    <button class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                        <i class="fas fa-shopping-cart mr-2"></i>Neue Investition
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Handelshistorie</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="tradingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Tab Content -->
    <div id="analyticsContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">ESG Score Analyse</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="esgChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Nachhaltigkeits-Metriken</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>CO‚ÇÇ-Reduktion</span>
                        <span class="font-bold text-green-600" id="co2Reduction">0 kg</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>Erneuerbare Energie</span>
                        <span class="font-bold text-blue-600" id="renewableEnergy">0%</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span>ESG Rating</span>
                        <span class="font-bold text-purple-600" id="esgRatingValue">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Tab Content -->
    <div id="reportsContent" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Monatliche Berichte</h3>
                <div class="space-y-3">
                    <button class="w-full text-left p-3 bg-blue-50 rounded-lg hover:bg-blue-100">
                        <i class="fas fa-file-pdf mr-2 text-red-600"></i>September 2025 - Green Finance Report
                    </button>
                    <button class="w-full text-left p-3 bg-blue-50 rounded-lg hover:bg-blue-100">
                        <i class="fas fa-file-excel mr-2 text-green-600"></i>August 2025 - Portfolio Analyse
                    </button>
                    <button class="w-full text-left p-3 bg-blue-50 rounded-lg hover:bg-blue-100">
                        <i class="fas fa-file-pdf mr-2 text-red-600"></i>Juli 2025 - ESG Compliance Report
                    </button>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Berichte generieren</h3>
                <div class="space-y-4">
                    <button class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Portfolio Report PDF
                    </button>
                    <button class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                        <i class="fas fa-table mr-2"></i>Excel Export
                    </button>
                    <button class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-chart-bar mr-2"></i>ESG Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üöÄ Green Finance Dashboard Script startet...');

let currentProjectId = null;
let portfolioChart = null;
let performanceChart = null;
let tradingChart = null;
let esgChart = null;

// Datum/Zeit aktualisieren
function updateDateTime() {
    const now = new Date();
    const options = {
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit'
    };
    const dateTimeElement = document.getElementById('currentDateTime');
    if (dateTimeElement) {
        dateTimeElement.textContent = now.toLocaleDateString('de-DE', options);
    }
}

updateDateTime();
setInterval(updateDateTime, 1000);

// Tab Navigation
function switchTab(tabName) {
    // Alle Tabs verstecken
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Alle Tab-Buttons deaktivieren
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-green-500', 'text-green-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Gew√§hlten Tab anzeigen
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    document.getElementById(tabName + 'Tab').classList.add('active', 'border-green-500', 'text-green-600');
    document.getElementById(tabName + 'Tab').classList.remove('border-transparent', 'text-gray-500');
}

// Projekte laden - KOPIERT VOM ERFOLGREICHEN CLIMATE IMPACT DASHBOARD
async function loadProjects() {
    console.log('üöÄ loadProjects() aufgerufen - Green Finance Dashboard');
    try {
        console.log('üîÑ Lade Projekte...');
        const response = await fetch('/climate/api/climate/projects');
        const data = await response.json();
        
        console.log('üìä API Response:', data);
        
        if (data.success && data.projects) {
            const select = document.getElementById('projectSelect');
            console.log('üîç Dropdown-Element gefunden:', select);
            
            if (!select) {
                console.error('‚ùå Dropdown-Element nicht gefunden!');
                return;
            }
            
            select.innerHTML = '<option value="">Projekt ausw√§hlen...</option>';
            console.log('üßπ Dropdown geleert');
            
            console.log(`üìã F√ºge ${data.projects.length} Projekte hinzu:`);
            data.projects.forEach(project => {
                console.log(`  - ${project.name} (ID: ${project.id})`);
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} (${project.location})`;
                select.appendChild(option);
            });
            
            console.log('üîç Dropdown nach Bef√ºllung:', select.innerHTML);
            
            // CSS-Debug: Dropdown sichtbarer machen
            select.style.backgroundColor = 'white';
            select.style.color = 'black';
            select.style.border = '2px solid green';
            select.style.minHeight = '40px';
            select.style.fontSize = '14px';
            select.style.width = '300px';
            select.style.zIndex = '9999';
            
            // Force re-render
            select.style.display = 'none';
            select.offsetHeight; // Trigger reflow
            select.style.display = 'block';
            
            console.log('üé® Dropdown-Styling angepasst und neu gerendert');
            console.log('üìä Anzahl Optionen im Dropdown:', select.options.length);
            console.log(`‚úÖ ${data.projects.length} Projekte geladen, Dropdown leer gelassen`);
        } else {
            console.error('‚ùå API Response hat keine Projekte:', data);
        }
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Projekte:', error);
    }
}

// Projekt-Daten laden
async function loadProjectData(projectId) {
    currentProjectId = projectId;
    console.log('Lade Green Finance Daten f√ºr Projekt ID:', projectId);
    
    try {
        const response = await fetch(`/climate/api/climate/co2-data/${projectId}`);
        const data = await response.json();
        
        console.log('API Response:', data);
        console.log('data.success:', data.success);
        console.log('data.data:', data.data);
        console.log('data.co2_data:', data.co2_data);
        console.log('typeof data.data:', typeof data.data);
        
        if (data.success && (data.data || data.co2_data)) {
            console.log('‚úÖ Daten gefunden, verarbeite...');
            const co2Data = data.data || data.co2_data;
            console.log('üìä CO2-Daten erhalten:', co2Data);
            
            // Berechnungen basierend auf CO2-Daten
            console.log('üßÆ Berechne Portfolio-Werte...');
            const portfolioValue = Math.floor(co2Data.total_co2_saved * 25); // 25‚Ç¨ pro t CO2
            console.log('üí∞ Portfolio-Wert:', portfolioValue);
            const greenBondsValue = Math.floor(portfolioValue * 0.68);
            console.log('üíö Green Bonds Wert:', greenBondsValue);
            const sustainabilityBondsValue = Math.floor(portfolioValue * 0.32);
            console.log('üíú Sustainability Bonds Wert:', sustainabilityBondsValue);
            const annualReturn = (co2Data.avg_efficiency * 0.1).toFixed(1);
            console.log('üìà Annual Return:', annualReturn);
            const esgRating = co2Data.avg_efficiency > 80 ? 'AA' : co2Data.avg_efficiency > 60 ? 'A' : 'BBB';
            console.log('‚≠ê ESG Rating:', esgRating);
            const efficiency = co2Data.avg_efficiency || 87.5;
            console.log('‚ö° Efficiency:', efficiency);
            
            // UI aktualisieren
            console.log('üñ•Ô∏è Aktualisiere UI-Elemente...');
            document.getElementById('totalPortfolio').textContent = portfolioValue.toLocaleString() + ' ‚Ç¨';
            document.getElementById('greenBonds').textContent = greenBondsValue.toLocaleString() + ' ‚Ç¨';
            document.getElementById('sustainabilityBonds').textContent = sustainabilityBondsValue.toLocaleString() + ' ‚Ç¨';
            document.getElementById('annualReturn').textContent = annualReturn + '%';
            document.getElementById('esgRating').textContent = 'ESG Rating: ' + esgRating;
            console.log('‚úÖ UI-Elemente aktualisiert');
            
            // Tab-Daten aktualisieren
            console.log('üìë Aktualisiere Tab-Daten...');
            document.getElementById('greenBondsValue').textContent = greenBondsValue.toLocaleString() + ' ‚Ç¨';
            document.getElementById('sustainabilityBondsValue').textContent = sustainabilityBondsValue.toLocaleString() + ' ‚Ç¨';
            document.getElementById('co2Reduction').textContent = co2Data.total_co2_saved.toLocaleString() + ' kg';
            document.getElementById('renewableEnergy').textContent = efficiency + '%';
            document.getElementById('esgRatingValue').textContent = esgRating;
            console.log('‚úÖ Tab-Daten aktualisiert');
            
            // Charts aktualisieren - monthly_trend zu Zahlen-Array konvertieren
            console.log('üìà Bereite Chart-Daten vor...');
            console.log('üìä monthly_trend:', co2Data.monthly_trend);
            const monthlyValues = co2Data.monthly_trend.map(item => item.saved || 0);
            console.log('üìà Monthly Values:', monthlyValues);
            
            try {
                console.log('üîÑ Rufe updateCharts auf mit:', { greenBondsValue, sustainabilityBondsValue, monthlyValues });
                updateCharts(greenBondsValue, sustainabilityBondsValue, monthlyValues);
                console.log('‚úÖ updateCharts erfolgreich aufgerufen');
                
                // Zus√§tzliche Charts f√ºr Tabs aktualisieren
                console.log('üîÑ Rufe updateTabCharts auf mit:', { greenBondsValue, sustainabilityBondsValue, monthlyValues, efficiency });
                updateTabCharts(greenBondsValue, sustainabilityBondsValue, monthlyValues, efficiency);
                console.log('‚úÖ updateTabCharts erfolgreich aufgerufen');
            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Charts:', error);
            }
            
            // Carbon Credits Chart (nicht vorhanden in Green Finance, aber wird aufgerufen)
            // updateCarbonCreditsChart(co2Data); // Deaktiviert da nicht ben√∂tigt
            
            console.log('‚úÖ Green Finance Daten geladen:', {
                portfolioValue,
                greenBondsValue,
                sustainabilityBondsValue,
                annualReturn,
                esgRating
            });
        }
    } catch (error) {
        console.error('Fehler beim Laden der Projekt-Daten:', error);
    }
}

// Charts aktualisieren
function updateCharts(greenBonds, sustainabilityBonds, monthlyTrend) {
    console.log('üé® updateCharts aufgerufen mit:', { greenBonds, sustainabilityBonds, monthlyTrend });
    
    // Test ob Charts funktionieren
    console.log('üß™ Teste Chart-Erstellung...');
    
    // Portfolio Chart
    console.log('üìä Erstelle Portfolio Chart...');
    if (portfolioChart) {
        console.log('üóëÔ∏è Zerst√∂re altes Portfolio Chart');
        portfolioChart.destroy();
    }
    
    const portfolioCanvas = document.getElementById('portfolioChart');
    console.log('üîç Portfolio Canvas gefunden:', portfolioCanvas);
    
    if (portfolioCanvas) {
        const portfolioCtx = portfolioCanvas.getContext('2d');
        console.log('üéØ Portfolio Context:', portfolioCtx);
        
        portfolioChart = new Chart(portfolioCtx, {
            type: 'doughnut',
            data: {
                labels: ['Green Bonds', 'Sustainability Bonds'],
                datasets: [{
                    data: [greenBonds, sustainabilityBonds],
                    backgroundColor: ['#10B981', '#8B5CF6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                devicePixelRatio: 1,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            usePointStyle: true
                        }
                    }
                },
                cutout: '60%',
                animation: {
                    animateRotate: true,
                    animateScale: true
                }
            }
        });
        console.log('‚úÖ Portfolio Chart erstellt:', portfolioChart);
    } else {
        console.error('‚ùå Portfolio Canvas nicht gefunden!');
    }
    
    // Performance Chart
    console.log('üìà Erstelle Performance Chart...');
    if (performanceChart) {
        console.log('üóëÔ∏è Zerst√∂re altes Performance Chart');
        performanceChart.destroy();
    }
    
    const performanceCanvas = document.getElementById('performanceChart');
    console.log('üîç Performance Canvas gefunden:', performanceCanvas);
    
    if (performanceCanvas) {
        const performanceCtx = performanceCanvas.getContext('2d');
        console.log('üéØ Performance Context:', performanceCtx);
        
        const labels = monthlyTrend.map((_, index) => `Monat ${index + 1}`);
        console.log('üìÖ Chart Labels:', labels);
        console.log('üìä Chart Data:', monthlyTrend.map(value => value * 1000));
        
        performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Portfolio Performance',
                    data: monthlyTrend.map(value => value * 1000),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                devicePixelRatio: 1,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ‚Ç¨';
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
        console.log('‚úÖ Performance Chart erstellt:', performanceChart);
    } else {
        console.error('‚ùå Performance Canvas nicht gefunden!');
    }
}

// Tab-Charts aktualisieren
function updateTabCharts(greenBonds, sustainabilityBonds, monthlyValues, efficiency) {
    // Trading Chart
    if (tradingChart) tradingChart.destroy();
    const tradingCtx = document.getElementById('tradingChart');
    if (tradingCtx) {
        tradingChart = new Chart(tradingCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Handelsvolumen (‚Ç¨)',
                    data: monthlyValues.slice(0, 6).map(value => value * 100),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ‚Ç¨';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // ESG Chart
    if (esgChart) esgChart.destroy();
    const esgCtx = document.getElementById('esgChart');
    if (esgCtx) {
        esgChart = new Chart(esgCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Environmental', 'Social', 'Governance'],
                datasets: [{
                    data: [efficiency, efficiency * 0.8, efficiency * 0.9],
                    backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }
}

// Tab-Charts aktualisieren
function updateTabCharts(greenBonds, sustainabilityBonds, monthlyValues, efficiency) {
    // Trading Chart
    if (tradingChart) tradingChart.destroy();
    const tradingCtx = document.getElementById('tradingChart');
    if (tradingCtx) {
        tradingChart = new Chart(tradingCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Handelsvolumen (‚Ç¨)',
                    data: monthlyValues.slice(0, 6).map(value => value * 100),
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ‚Ç¨';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // ESG Chart
    if (esgChart) esgChart.destroy();
    const esgCtx = document.getElementById('esgChart');
    if (esgCtx) {
        esgChart = new Chart(esgCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Environmental', 'Social', 'Governance'],
                datasets: [{
                    data: [efficiency, efficiency * 0.8, efficiency * 0.9],
                    backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }
}

// Event Listeners - KOPIERT VOM ERFOLGREICHEN CLIMATE IMPACT DASHBOARD
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM Content Loaded - Green Finance Dashboard');
    console.log('üîç Pr√ºfe ob alle Elemente vorhanden sind...');
    
    // Test ob alle wichtigen Elemente vorhanden sind
    const projectSelect = document.getElementById('projectSelect');
    const portfolioCanvasElement = document.getElementById('portfolioChart');
    const performanceCanvasElement = document.getElementById('performanceChart');
    
    console.log('üìã projectSelect gefunden:', projectSelect);
    console.log('üìä portfolioCanvas gefunden:', portfolioCanvasElement);
    console.log('üìà performanceCanvas gefunden:', performanceCanvasElement);
    
    // Test ob JavaScript funktioniert
    console.log('‚úÖ JavaScript l√§uft! Green Finance Dashboard initialisiert.');
    
    // Projekte laden
    loadProjects();
    
    // Projekt-Auswahl
    document.getElementById('projectSelect').addEventListener('change', function() {
        const selectedProjectId = this.value;
        console.log('üéØ Projekt ausgew√§hlt - ID:', selectedProjectId);
        console.log('üéØ Projekt ausgew√§hlt - Name:', this.options[this.selectedIndex].text);
        if (selectedProjectId) {
            console.log('üöÄ Lade Projekt-Daten...');
            loadProjectData(selectedProjectId);
        } else {
            // Reset zu Standardwerten
            console.log('üîÑ Reset Projekt-Daten...');
            document.getElementById('totalPortfolio').textContent = '0 ‚Ç¨';
            document.getElementById('greenBonds').textContent = '0 ‚Ç¨';
            document.getElementById('sustainabilityBonds').textContent = '0 ‚Ç¨';
            document.getElementById('annualReturn').textContent = '0%';
            document.getElementById('esgRating').textContent = 'ESG Rating: -';
            
            if (portfolioChart) portfolioChart.destroy();
            if (performanceChart) performanceChart.destroy();
            if (tradingChart) tradingChart.destroy();
            if (esgChart) esgChart.destroy();
            console.log('‚úÖ Reset abgeschlossen');
        }
    });
    
    console.log('‚úÖ Event Listeners registriert');
});

</script>
{% endblock %}