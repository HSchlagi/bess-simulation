{% extends "base.html" %}
{% block title %}BESS MCP Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    .status-online { background-color: #10B981; }
    .status-offline { background-color: #EF4444; }
    .status-demo { background-color: #F59E0B; }
</style>
{% endblock %}

{% block content %}
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">BESS MCP Dashboard</h1>
            <p class="text-gray-600">Intelligente Steuerung der BESS-Simulation √ºber MCP-Tools</p>
            
            <!-- Status Bar -->
            <div class="mt-4 flex items-center space-x-6">
                <div class="flex items-center">
                    <span class="status-indicator status-online" id="mcp-status"></span>
                    <span class="text-sm font-medium">MCP-Server</span>
                </div>
                <div class="flex items-center">
                    <span class="status-indicator status-demo" id="dispatch-status"></span>
                    <span class="text-sm font-medium">Dispatch-System</span>
                </div>
                <div class="flex items-center">
                    <span class="status-indicator status-online" id="db-status"></span>
                    <span class="text-sm font-medium">Datenbank</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Dispatch Simulation Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üöÄ Dispatch-Simulation</h2>
                
                <!-- Parameter Input -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kapazit√§t (MWh)</label>
                        <input type="number" id="capacity" value="0.5" step="0.1" min="0.1" max="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preis-Spread (EUR/MWh)</label>
                        <input type="number" id="price-spread" value="100" step="10" min="20" max="200"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zyklen/Tag</label>
                        <input type="number" id="cycles" value="2.0" step="0.1" min="0.5" max="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button onclick="runDispatch()" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        üöÄ Simulation starten
                    </button>
                </div>
                
                <!-- Results Display -->
                <div id="dispatch-results" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">üìä Ergebnisse</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Profit</div>
                            <div class="text-xl font-bold text-green-600" id="profit">0 EUR</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Autarkie</div>
                            <div class="text-xl font-bold text-blue-600" id="autarky">0%</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">ROI</div>
                            <div class="text-xl font-bold text-purple-600" id="roi">0%</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Payback</div>
                            <div class="text-xl font-bold text-orange-600" id="payback">0 Jahre</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä System-Status</h2>
                
                <!-- SOC Display -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">SOC (State of Charge)</span>
                        <button onclick="readSOC()" class="text-blue-600 hover:text-blue-800 text-sm">Aktualisieren</button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="soc-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <span id="soc-value" class="text-lg font-bold text-gray-800">0%</span>
                    </div>
                </div>

                <!-- Price Chart -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Spotpreise (Heute)</h3>
                    <canvas id="priceChart" width="400" height="200"></canvas>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-2">
                    <button onclick="getSpotPrices()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm">
                        üìà Spotpreise laden
                    </button>
                    <button onclick="getAwatttarPrices()" 
                            class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 text-sm">
                        ‚ö° aWATTar-Preise laden
                    </button>
                    <button onclick="showDatabase()" 
                            class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 text-sm">
                        üóÑÔ∏è Datenbank anzeigen
                    </button>
                </div>
            </div>
        </div>

        <!-- MCP Query Panel -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ü§ñ MCP-Abfrage</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Direkte MCP-Abfrage eingeben:</label>
                    <div class="flex space-x-2">
                        <input type="text" id="mcp-query" placeholder="z.B. 'Zeige mir alle Projekte' oder 'Berechne Dispatch f√ºr 1MWh'"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="executeMCPQuery()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-paper-plane mr-2"></i>Abfrage senden
                        </button>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <strong>Beispiel-Abfragen:</strong>
                    <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <div class="font-medium text-blue-600 mb-1">üìä Projekte & Daten:</div>
                            <ul class="space-y-1 text-xs">
                                <li>‚Ä¢ "Zeige mir alle Projekte"</li>
                                <li>‚Ä¢ "Lade aktuelle Spotpreise"</li>
                                <li>‚Ä¢ "Zeige SOC-Status"</li>
                                <li>‚Ä¢ "Lade aWATTar-Preise"</li>
                            </ul>
                        </div>
                        <div>
                            <div class="font-medium text-green-600 mb-1">üöÄ Simulationen:</div>
                            <ul class="space-y-1 text-xs">
                                <li>‚Ä¢ "Berechne Dispatch f√ºr 2MWh"</li>
                                <li>‚Ä¢ "Simulation mit 1.5MWh Kapazit√§t"</li>
                                <li>‚Ä¢ "Dispatch f√ºr 100 EUR/MWh Spread"</li>
                                <li>‚Ä¢ "Starte Simulation"</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3 p-3 bg-blue-50 rounded-md">
                        <div class="font-medium text-blue-800 mb-1">üí° Tipp:</div>
                        <div class="text-xs text-blue-700">
                            Sie k√∂nnen auch Parameter kombinieren: "Berechne Dispatch f√ºr 3MWh mit 150 EUR/MWh Spread und 2.5 Zyklen pro Tag"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìù Aktivit√§ts-Log</h2>
            <div id="log-panel" class="bg-gray-50 p-4 rounded-md h-48 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">MCP-Dashboard bereit...</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('Dashboard initialisiert');
            logMessage('JavaScript-Funktionen geladen: ' + (typeof window.runDispatch === 'function' ? 'OK' : 'FEHLER'));
            
            // Debug: Alle Funktionen testen
            const functions = ['runDispatch', 'readSOC', 'getSpotPrices', 'getAwatttarPrices', 'showDatabase'];
            functions.forEach(func => {
                if (typeof window[func] === 'function') {
                    logMessage(`‚úÖ ${func} verf√ºgbar`);
                } else {
                    logMessage(`‚ùå ${func} NICHT verf√ºgbar`);
                }
            });
            
            readSOC();
            getSpotPrices();
        });

        // Logging function
        function logMessage(message) {
            const logPanel = document.getElementById('log-panel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Dispatch Simulation
        window.runDispatch = async function() {
            const capacity = document.getElementById('capacity').value;
            const priceSpread = document.getElementById('price-spread').value;
            const cycles = document.getElementById('cycles').value;
            
            logMessage(`Starte Dispatch-Simulation: ${capacity}MWh, ${priceSpread}EUR/MWh, ${cycles} Zyklen`);
            
            try {
                const response = await fetch('/api/mcp/dispatch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        capacity_mwh: parseFloat(capacity),
                        price_spread_eur_mwh: parseFloat(priceSpread),
                        cycles_limit_per_day: parseFloat(cycles)
                    })
                });
                
                const result = await response.json();
                displayDispatchResults(result);
                logMessage(`Simulation abgeschlossen: ${result.profit_eur}EUR Profit`);
                
            } catch (error) {
                logMessage(`Fehler: ${error.message}`);
            }
        }

        // Display dispatch results
        window.displayDispatchResults = function(result) {
            document.getElementById('profit').textContent = result.profit_eur + ' EUR';
            document.getElementById('autarky').textContent = result.autarky_pct + '%';
            document.getElementById('roi').textContent = result.roi_pct + '%';
            document.getElementById('payback').textContent = result.payback_years + ' Jahre';
            
            document.getElementById('dispatch-results').classList.remove('hidden');
        }

        // Read SOC
        window.readSOC = async function() {
            try {
                const response = await fetch('/api/mcp/soc');
                const soc = await response.json();
                
                document.getElementById('soc-value').textContent = soc + '%';
                document.getElementById('soc-bar').style.width = soc + '%';
                
                logMessage(`SOC gelesen: ${soc}%`);
            } catch (error) {
                logMessage(`SOC-Fehler: ${error.message}`);
            }
        }

        // Get spot prices
        window.getSpotPrices = async function() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/mcp/spot-prices?date=${today}`);
                const data = await response.json();
                
                if (data.curve && data.curve.length > 0) {
                    updatePriceChart(data.curve);
                    logMessage(`Spotpreise geladen: ${data.points} Punkte`);
                } else {
                    logMessage('Keine Spotpreise verf√ºgbar');
                }
            } catch (error) {
                logMessage(`Spotpreise-Fehler: ${error.message}`);
            }
        }

        // Get aWATTar prices
        window.getAwatttarPrices = async function() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/mcp/awattar?day=${today}&country=AT`);
                const data = await response.json();
                
                if (data.curve && data.curve.length > 0) {
                    updatePriceChart(data.curve);
                    logMessage(`aWATTar-Preise geladen: ${data.points} Punkte`);
                } else {
                    logMessage('Keine aWATTar-Preise verf√ºgbar');
                }
            } catch (error) {
                logMessage(`aWATTar-Fehler: ${error.message}`);
            }
        }

        // Update price chart
        window.updatePriceChart = function(priceData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const labels = priceData.map(item => new Date(item.ts).toLocaleTimeString());
            const prices = priceData.map(item => item.price_eur_mwh);
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Preis (EUR/MWh)',
                        data: prices,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Execute MCP Query - Version 2.0 (Cache-Busting)
        window.executeMCPQuery = async function() {
            const query = document.getElementById('mcp-query').value.trim();
            if (!query) {
                logMessage('‚ùå Bitte geben Sie eine Abfrage ein');
                return;
            }
            
            logMessage(`ü§ñ MCP-Abfrage: "${query}"`);
            
            try {
                // Einfache Keyword-basierte Verarbeitung
                const lowerQuery = query.toLowerCase();
                
                if (lowerQuery.includes('projekt') || lowerQuery.includes('projekte')) {
                    logMessage('üìä Lade Projekte...');
                    await showDatabase();
                } else if (lowerQuery.includes('spotpreis') || lowerQuery.includes('spot')) {
                    logMessage('üìà Lade Spotpreise...');
                    await getSpotPrices();
                } else if (lowerQuery.includes('awattar') || lowerQuery.includes('awattar')) {
                    logMessage('‚ö° Lade aWATTar-Preise...');
                    await getAwatttarPrices();
                } else if (lowerQuery.includes('soc') || lowerQuery.includes('ladezustand')) {
                    logMessage('üîã Lade SOC-Status...');
                    await readSOC();
                } else if (lowerQuery.includes('kapazit√§t') || lowerQuery.includes('mwh') || lowerQuery.includes('dispatch') || lowerQuery.includes('simulation') || lowerQuery.includes('berechne')) {
                    // Debug: Zeige die urspr√ºngliche Abfrage
                    logMessage(`üîç Debug: Verarbeite Abfrage: "${query}"`);
                    
                    // Extrahiere alle Parameter aus der Abfrage - verbesserte Regex
                    const capacityMatch = query.match(/(\d+(?:\.\d+)?)\s*mwh/i);
                    const spreadMatch = query.match(/(\d+(?:\.\d+)?)\s*eur[\/\s]*mwh/i);
                    const cyclesMatch = query.match(/(\d+(?:\.\d+)?)\s*zyklen/i);
                    
                    logMessage(`üîç Debug: Kapazit√§t-Match: ${capacityMatch ? capacityMatch[1] : 'null'}`);
                    logMessage(`üîç Debug: Spread-Match: ${spreadMatch ? spreadMatch[1] : 'null'}`);
                    logMessage(`üîç Debug: Zyklen-Match: ${cyclesMatch ? cyclesMatch[1] : 'null'}`);
                    
                    let parametersUpdated = false;
                    
                    if (capacityMatch) {
                        const capacity = parseFloat(capacityMatch[1]);
                        document.getElementById('capacity').value = capacity;
                        logMessage(`üìä Kapazit√§t auf ${capacity} MWh gesetzt`);
                        parametersUpdated = true;
                    }
                    
                    if (spreadMatch) {
                        const spread = parseFloat(spreadMatch[1]);
                        document.getElementById('price-spread').value = spread;
                        logMessage(`üí∞ Preis-Spread auf ${spread} EUR/MWh gesetzt`);
                        parametersUpdated = true;
                    }
                    
                    if (cyclesMatch) {
                        const cycles = parseFloat(cyclesMatch[1]);
                        document.getElementById('cycles').value = cycles;
                        logMessage(`üîÑ Zyklen auf ${cycles} pro Tag gesetzt`);
                        parametersUpdated = true;
                    }
                    
                    if (parametersUpdated) {
                        logMessage('üöÄ Starte Dispatch-Simulation mit neuen Parametern...');
                        await runDispatch();
                    } else {
                        logMessage('‚ùå Keine Parameter erkannt. Verwende aktuelle Einstellungen...');
                        await runDispatch();
                    }
                } else if (lowerQuery.includes('simulation') || lowerQuery.includes('starte')) {
                    logMessage('üöÄ Starte Dispatch-Simulation mit aktuellen Parametern...');
                    await runDispatch();
                } else if (lowerQuery.includes('parameter') || lowerQuery.includes('einstellung')) {
                    // Zeige aktuelle Parameter
                    const capacity = document.getElementById('capacity').value;
                    const priceSpread = document.getElementById('price-spread').value;
                    const cycles = document.getElementById('cycles').value;
                    logMessage(`üìä Aktuelle Parameter:`);
                    logMessage(`  ‚Ä¢ Kapazit√§t: ${capacity} MWh`);
                    logMessage(`  ‚Ä¢ Preis-Spread: ${priceSpread} EUR/MWh`);
                    logMessage(`  ‚Ä¢ Zyklen/Tag: ${cycles}`);
                } else if (lowerQuery.includes('hilfe') || lowerQuery.includes('help')) {
                    logMessage('üìö Verf√ºgbare MCP-Befehle:');
                    logMessage('  üìä Daten: "projekte", "spotpreise", "soc", "awattar"');
                    logMessage('  üöÄ Simulation: "dispatch", "simulation", "starte"');
                    logMessage('  ‚öôÔ∏è Parameter: "parameter", "einstellungen"');
                    logMessage('  üí° Beispiele: "Berechne Dispatch f√ºr 2MWh"');
                } else {
                    // Fallback: Versuche Parameter-Extraktion auch bei unbekannten Abfragen
                    logMessage(`üîç Fallback: Versuche Parameter-Extraktion f√ºr: "${query}"`);
                    
                    const capacityMatch = query.match(/(\d+(?:\.\d+)?)\s*mwh/i);
                    const spreadMatch = query.match(/(\d+(?:\.\d+)?)\s*eur[\/\s]*mwh/i);
                    const cyclesMatch = query.match(/(\d+(?:\.\d+)?)\s*zyklen/i);
                    
                    if (capacityMatch || spreadMatch || cyclesMatch) {
                        logMessage('üéØ Parameter erkannt - starte Dispatch-Simulation...');
                        
                        if (capacityMatch) {
                            const capacity = parseFloat(capacityMatch[1]);
                            document.getElementById('capacity').value = capacity;
                            logMessage(`üìä Kapazit√§t auf ${capacity} MWh gesetzt`);
                        }
                        
                        if (spreadMatch) {
                            const spread = parseFloat(spreadMatch[1]);
                            document.getElementById('price-spread').value = spread;
                            logMessage(`üí∞ Preis-Spread auf ${spread} EUR/MWh gesetzt`);
                        }
                        
                        if (cyclesMatch) {
                            const cycles = parseFloat(cyclesMatch[1]);
                            document.getElementById('cycles').value = cycles;
                            logMessage(`üîÑ Zyklen auf ${cycles} pro Tag gesetzt`);
                        }
                        
                        await runDispatch();
                    } else {
                        logMessage('‚ùì Unbekannte Abfrage. Verf√ºgbare Befehle:');
                        logMessage('  ‚Ä¢ "Zeige mir alle Projekte"');
                        logMessage('  ‚Ä¢ "Berechne Dispatch f√ºr 2MWh"');
                        logMessage('  ‚Ä¢ "Lade aktuelle Spotpreise"');
                        logMessage('  ‚Ä¢ "Zeige SOC-Status"');
                    }
                }
                
                // Eingabefeld leeren
                document.getElementById('mcp-query').value = '';
                
            } catch (error) {
                logMessage(`‚ùå MCP-Abfrage-Fehler: ${error.message}`);
            }
        };

        // Show database
        window.showDatabase = async function() {
            try {
                logMessage('Lade Datenbank-Projekte...');
                const response = await fetch('/api/mcp/database?table=projects&limit=5');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Database response:', data);
                
                if (data.status === 'error') {
                    logMessage(`‚ùå Datenbank-Fehler: ${data.error}`);
                } else if (data.count !== undefined) {
                    logMessage(`‚úÖ Datenbank: ${data.count} Projekte geladen`);
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(project => {
                            logMessage(`  - Projekt ${project.id}: ${project.name} (${project.location})`);
                            logMessage(`    BESS: ${project.bess_size} kWh / ${project.bess_power} kW`);
                        });
                    } else {
                        logMessage('  (Keine Projekte in der Datenbank)');
                    }
                } else {
                    logMessage(`‚ùå Unerwartete Antwort: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                logMessage(`‚ùå Datenbank-Fehler: ${error.message}`);
                console.error('Database error:', error);
            }
        }
    </script>
{% endblock %}
