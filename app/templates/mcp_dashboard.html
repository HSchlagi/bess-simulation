<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BESS MCP Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10B981; }
        .status-offline { background-color: #EF4444; }
        .status-demo { background-color: #F59E0B; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">BESS MCP Dashboard</h1>
            <p class="text-gray-600">Intelligente Steuerung der BESS-Simulation √ºber MCP-Tools</p>
            
            <!-- Status Bar -->
            <div class="mt-4 flex items-center space-x-6">
                <div class="flex items-center">
                    <span class="status-indicator status-online" id="mcp-status"></span>
                    <span class="text-sm font-medium">MCP-Server</span>
                </div>
                <div class="flex items-center">
                    <span class="status-indicator status-demo" id="dispatch-status"></span>
                    <span class="text-sm font-medium">Dispatch-System</span>
                </div>
                <div class="flex items-center">
                    <span class="status-indicator status-online" id="db-status"></span>
                    <span class="text-sm font-medium">Datenbank</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Dispatch Simulation Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üöÄ Dispatch-Simulation</h2>
                
                <!-- Parameter Input -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kapazit√§t (MWh)</label>
                        <input type="number" id="capacity" value="0.5" step="0.1" min="0.1" max="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preis-Spread (EUR/MWh)</label>
                        <input type="number" id="price-spread" value="100" step="10" min="20" max="200"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zyklen/Tag</label>
                        <input type="number" id="cycles" value="2.0" step="0.1" min="0.5" max="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button onclick="runDispatch()" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        üöÄ Simulation starten
                    </button>
                </div>
                
                <!-- Results Display -->
                <div id="dispatch-results" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">üìä Ergebnisse</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Profit</div>
                            <div class="text-xl font-bold text-green-600" id="profit">0 EUR</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Autarkie</div>
                            <div class="text-xl font-bold text-blue-600" id="autarky">0%</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">ROI</div>
                            <div class="text-xl font-bold text-purple-600" id="roi">0%</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-md">
                            <div class="text-sm text-gray-600">Payback</div>
                            <div class="text-xl font-bold text-orange-600" id="payback">0 Jahre</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä System-Status</h2>
                
                <!-- SOC Display -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">SOC (State of Charge)</span>
                        <button onclick="readSOC()" class="text-blue-600 hover:text-blue-800 text-sm">Aktualisieren</button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="soc-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <span id="soc-value" class="text-lg font-bold text-gray-800">0%</span>
                    </div>
                </div>

                <!-- Price Chart -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Spotpreise (Heute)</h3>
                    <canvas id="priceChart" width="400" height="200"></canvas>
                </div>

                <!-- Quick Actions -->
                <div class="space-y-2">
                    <button onclick="getSpotPrices()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm">
                        üìà Spotpreise laden
                    </button>
                    <button onclick="getAwatttarPrices()" 
                            class="w-full bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 text-sm">
                        ‚ö° aWATTar-Preise laden
                    </button>
                    <button onclick="showDatabase()" 
                            class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 text-sm">
                        üóÑÔ∏è Datenbank anzeigen
                    </button>
                </div>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìù Aktivit√§ts-Log</h2>
            <div id="log-panel" class="bg-gray-50 p-4 rounded-md h-48 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">MCP-Dashboard bereit...</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('Dashboard initialisiert');
            readSOC();
            getSpotPrices();
        });

        // Logging function
        function logMessage(message) {
            const logPanel = document.getElementById('log-panel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // Dispatch Simulation
        async function runDispatch() {
            const capacity = document.getElementById('capacity').value;
            const priceSpread = document.getElementById('price-spread').value;
            const cycles = document.getElementById('cycles').value;
            
            logMessage(`Starte Dispatch-Simulation: ${capacity}MWh, ${priceSpread}EUR/MWh, ${cycles} Zyklen`);
            
            try {
                const response = await fetch('/api/mcp/dispatch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        capacity_mwh: parseFloat(capacity),
                        price_spread_eur_mwh: parseFloat(priceSpread),
                        cycles_limit_per_day: parseFloat(cycles)
                    })
                });
                
                const result = await response.json();
                displayDispatchResults(result);
                logMessage(`Simulation abgeschlossen: ${result.profit_eur}EUR Profit`);
                
            } catch (error) {
                logMessage(`Fehler: ${error.message}`);
            }
        }

        // Display dispatch results
        function displayDispatchResults(result) {
            document.getElementById('profit').textContent = result.profit_eur + ' EUR';
            document.getElementById('autarky').textContent = result.autarky_pct + '%';
            document.getElementById('roi').textContent = result.roi_pct + '%';
            document.getElementById('payback').textContent = result.payback_years + ' Jahre';
            
            document.getElementById('dispatch-results').classList.remove('hidden');
        }

        // Read SOC
        async function readSOC() {
            try {
                const response = await fetch('/api/mcp/soc');
                const soc = await response.json();
                
                document.getElementById('soc-value').textContent = soc + '%';
                document.getElementById('soc-bar').style.width = soc + '%';
                
                logMessage(`SOC gelesen: ${soc}%`);
            } catch (error) {
                logMessage(`SOC-Fehler: ${error.message}`);
            }
        }

        // Get spot prices
        async function getSpotPrices() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/mcp/spot-prices?date=${today}`);
                const data = await response.json();
                
                if (data.curve && data.curve.length > 0) {
                    updatePriceChart(data.curve);
                    logMessage(`Spotpreise geladen: ${data.points} Punkte`);
                } else {
                    logMessage('Keine Spotpreise verf√ºgbar');
                }
            } catch (error) {
                logMessage(`Spotpreise-Fehler: ${error.message}`);
            }
        }

        // Get aWATTar prices
        async function getAwatttarPrices() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch(`/api/mcp/awattar?day=${today}&country=AT`);
                const data = await response.json();
                
                if (data.curve && data.curve.length > 0) {
                    updatePriceChart(data.curve);
                    logMessage(`aWATTar-Preise geladen: ${data.points} Punkte`);
                } else {
                    logMessage('Keine aWATTar-Preise verf√ºgbar');
                }
            } catch (error) {
                logMessage(`aWATTar-Fehler: ${error.message}`);
            }
        }

        // Update price chart
        function updatePriceChart(priceData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }
            
            const labels = priceData.map(item => new Date(item.ts).toLocaleTimeString());
            const prices = priceData.map(item => item.price_eur_mwh);
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Preis (EUR/MWh)',
                        data: prices,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Show database
        async function showDatabase() {
            try {
                const response = await fetch('/api/mcp/database?table=projects&limit=5');
                const data = await response.json();
                
                logMessage(`Datenbank: ${data.count} Projekte geladen`);
                console.log('Database data:', data);
            } catch (error) {
                logMessage(`Datenbank-Fehler: ${error.message}`);
            }
        }
    </script>
</body>
</html>
