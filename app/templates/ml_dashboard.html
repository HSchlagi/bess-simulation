<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML & KI Dashboard - BESS Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
</style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    {% include 'header_simple.html' %}

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Page Title -->
    <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            ü§ñ ML & KI Dashboard
        </h1>
            <p class="text-gray-600 mt-2">Intelligente Optimierung und Prognosen f√ºr Ihre BESS-Systeme</p>
    </div>

        <!-- Projekt ausw√§hlen - Ganz oben -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìÅ Projekt ausw√§hlen</h2>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg px-3 py-2">
                    <span class="text-sm text-yellow-800">‚ö†Ô∏è W√§hlen Sie ein Projekt aus, um Berechnungen zu starten</span>
                </div>
            </div>
            <div class="flex space-x-4">
                <select id="project-select" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Projekt ausw√§hlen --</option>
            </select>
                <button onclick="loadProjectData()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition" disabled id="load-data-btn">
                    üìä Daten laden
            </button>
        </div>
    </div>

        <!-- Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Preis-Prognosen -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üìà Preis-Prognosen</h2>
                    <button onclick="startPriceForecast()" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded-lg text-sm transition" disabled id="price-forecast-btn">
                    Prognose starten
                </button>
            </div>
                <div class="space-y-4">
                    <div class="h-64">
                        <canvas id="priceForecastChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-gray-600">Durchschnittspreis:</span>
                            <span class="font-bold text-gray-400" id="avg-price">- ‚Ç¨/MWh</span>
                    </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                        <span class="text-gray-600">Maximaler Preis:</span>
                            <span class="font-bold text-gray-400" id="max-price">- ‚Ç¨/MWh</span>
                        </div>
                    </div>
            </div>
        </div>

        <!-- BESS-Optimierung -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">‚öôÔ∏è BESS-Optimierung</h2>
                    <button onclick="optimizeBESS()" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded-lg text-sm transition" disabled id="optimize-bess-btn">
                    Optimieren
                </button>
            </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Lade-Wirkungsgrad:</span>
                            <span class="font-bold text-gray-400" id="charge-efficiency">- %</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Max. SoC:</span>
                            <span class="font-bold text-gray-400" id="max-soc">- %</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Entlade-Wirkungsgrad:</span>
                            <span class="font-bold text-gray-400" id="discharge-efficiency">- %</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Min. SoC:</span>
                            <span class="font-bold text-blue-600" id="min-soc">15.0%</span>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-green-50 p-3 rounded-lg">
                                <span class="text-gray-600">Effizienz-Steigerung:</span>
                                <span class="font-bold text-green-600" id="efficiency-gain">8.5%</span>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <span class="text-gray-600">Gesch√§tzte j√§hrliche Einsparungen:</span>
                                <span class="font-bold text-green-600" id="annual-savings">20000.00 ‚Ç¨</span>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Anomalie-Erkennung -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üîç Anomalie-Erkennung</h2>
                    <button onclick="analyzeAnomalies()" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded-lg text-sm transition" disabled id="anomaly-analyze-btn">
                    Analysieren
                </button>
            </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-600">Anomalie-Rate:</span>
                            <span class="font-bold text-orange-600" id="anomaly-rate">25.00 %</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-orange-500 h-2 rounded-full" style="width: 25%"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-semibold text-gray-700">Erkannte Anomalien:</h4>
                        <div class="space-y-2 text-sm">
                            <div class="bg-red-50 p-2 rounded border-l-4 border-red-500">
                                <span class="font-medium">7.9.2025, 21:20:27</span> - <span class="text-red-600">101.1 kW</span>
                            </div>
                            <div class="bg-red-50 p-2 rounded border-l-4 border-red-500">
                                <span class="font-medium">4.9.2025, 11:20:27</span> - <span class="text-red-600">123.8 kW</span>
                </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Predictive Maintenance -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üîß Predictive Maintenance</h2>
                    <button onclick="analyzeMaintenance()" class="bg-gray-400 cursor-not-allowed text-white px-4 py-2 rounded-lg text-sm transition" disabled id="maintenance-analyze-btn">
                    Analysieren
                </button>
            </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Zyklen abgeschlossen:</span>
                            <span class="font-bold text-blue-600" id="cycles-completed">1587</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Durchschnittstemperatur:</span>
                            <span class="font-bold text-blue-600" id="avg-temperature">22.2¬∞C</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Alter (Tage):</span>
                            <span class="font-bold text-blue-600" id="age-days">794</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <span class="text-gray-600">Durchschnittliche DoD:</span>
                            <span class="font-bold text-blue-600" id="avg-dod">93.0%</span>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <span class="text-gray-600">Vorhergesagte Degradation:</span>
                                <span class="font-bold text-yellow-600" id="predicted-degradation">1.7%</span>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <span class="text-gray-600">Verbleibende Kapazit√§t:</span>
                                <span class="font-bold text-green-600" id="remaining-capacity">97.0%</span>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg mt-4">
                            <span class="text-gray-600">Wartungsempfehlung:</span>
                            <span class="font-bold text-blue-600" id="maintenance-recommendation">Batterie-Gesundheit gut - N√§chste Routine-Inspektion in 3 Monaten</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ML-Modell-Status Section -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                üìä ML-Modell-Status
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl mb-3">üìà</div>
                    <h3 class="font-semibold text-gray-800 mb-2">Preis-Prognose</h3>
                    <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Trainiert</span>
    </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl mb-3">‚öôÔ∏è</div>
                    <h3 class="font-semibold text-gray-800 mb-2">BESS-Optimierung</h3>
                    <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">Verf√ºgbar</span>
            </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl mb-3">üîç</div>
                    <h3 class="font-semibold text-gray-800 mb-2">Anomalie-Erkennung</h3>
                    <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Trainiert</span>
            </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl mb-3">üîß</div>
                    <h3 class="font-semibold text-gray-800 mb-2">Predictive Maintenance</h3>
                    <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Trainiert</span>
            </div>
            </div>
        </div>
    </main>

<script>
        // Chart.js Konfiguration
        let priceForecastChart;

        // Demo-Daten werden nur nach Projektauswahl generiert
        function generatePriceForecastLabels() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const labels = [];
            
            // 24 Stunden Prognose f√ºr morgen (alle 2 Stunden)
            for (let hour = 0; hour < 24; hour += 2) {
                const time = new Date(tomorrow);
                time.setHours(hour, 20, 0, 0);
                labels.push(time.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                }));
            }
            return labels;
        }

        // Demo-Daten werden nur nach Projektauswahl erstellt
        function createDemoPriceData() {
            return {
                labels: generatePriceForecastLabels(),
                datasets: [{
                    label: 'Prognostizierter Preis (‚Ç¨/MWh) - Morgen',
                    data: [45.2, 52.8, 68.4, 72.6, 58.9, 42.1, 38.7, 41.3, 48.9, 55.2, 61.8, 58.4],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };
        }

        // Leere Charts initialisieren (ohne Demo-Daten)
        function initEmptyCharts() {
            // Zerst√∂re existierendes Chart falls vorhanden
            if (priceForecastChart) {
                priceForecastChart.destroy();
                priceForecastChart = null;
            }
            
            const ctx = document.getElementById('priceForecastChart').getContext('2d');
            priceForecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'W√§hlen Sie ein Projekt aus',
                        data: [],
                        borderColor: 'rgb(156, 163, 175)',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Preis (‚Ç¨/MWh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Chart mit Demo-Daten initialisieren (nur nach Projektauswahl)
        function initCharts() {
            // Zerst√∂re existierendes Chart falls vorhanden
            if (priceForecastChart) {
                priceForecastChart.destroy();
                priceForecastChart = null;
            }
            
            const ctx = document.getElementById('priceForecastChart').getContext('2d');
            const demoData = createDemoPriceData();
            priceForecastChart = new Chart(ctx, {
                type: 'line',
                data: demoData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Preis (‚Ç¨/MWh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Funktionen
        function loadProjectData() {
            const projectSelect = document.getElementById('project-select');
            const projectId = projectSelect.value;
            const projectName = projectSelect.options[projectSelect.selectedIndex].text;
            
            // Pr√ºfen ob Projekt ausgew√§hlt wurde
            if (!projectId) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst ein Projekt aus!');
                return;
            }
            
            console.log('Lade Daten f√ºr Projekt:', projectName, '(ID:', projectId, ')');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Lade...';
            button.disabled = true;
            
            // Lade Projekt-Daten und pr√ºfe Spot-Preise
            Promise.all([
                // Projekt-Details laden mit besserer Fehlerbehandlung
                fetch(`/api/projects/${projectId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Fehler beim Laden der Projekt-Details:', error);
                        return null; // Fallback f√ºr Projekt-Daten
                    }),
                // Spot-Preise pr√ºfen - verwende korrekte Parameter
                fetch('/api/spot-prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        time_range: 'week',
                        start_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                        end_date: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Spot-Preise:', error);
                    return { success: false, error: error.message };
                })
            ])
            .then(([projectData, spotPriceData]) => {
                button.textContent = originalText;
                button.disabled = false;
                
                // Pr√ºfe ob Projekt-Daten geladen wurden
                if (!projectData) {
                    alert(`‚ùå Fehler beim Laden der Projekt-Daten f√ºr ${projectName}.\n\nM√∂gliche Ursachen:\n- Projekt existiert nicht (ID: ${projectId})\n- Keine Berechtigung\n- Server-Fehler\n\nBitte w√§hlen Sie ein anderes Projekt oder kontaktieren Sie den Administrator.`);
                    return;
                }
                
                console.log('‚úÖ Projekt-Daten geladen:', projectData);
                
                // Charts mit Projekt-spezifischen Daten laden
                initCharts();
                
                // Projekt-spezifische Daten anzeigen
                updateProjectSpecificData(projectId, projectData);
                
                // Alle Buttons aktivieren
                enableAllButtons();
                
                // Pr√ºfe ob Spot-Preise verf√ºgbar sind
                if (spotPriceData && spotPriceData.success && spotPriceData.data && spotPriceData.data.length > 0) {
                    alert(`‚úÖ Daten f√ºr ${projectName} erfolgreich geladen!\n\nüìä ${spotPriceData.data.length} Spot-Preise verf√ºgbar\nüîÆ Preis-Prognose bereit`);
                } else {
                    const spotError = spotPriceData && spotPriceData.error ? `\n\nSpot-Preis Fehler: ${spotPriceData.error}` : '';
                    alert(`‚ö†Ô∏è Daten f√ºr ${projectName} geladen, aber keine Spot-Preise verf√ºgbar.${spotError}\n\nBitte importieren Sie zuerst Spot-Preise f√ºr Preis-Prognosen.`);
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Projekt-Daten:', error);
                button.textContent = originalText;
                button.disabled = false;
                alert('‚ùå Fehler beim Laden der Projekt-Daten. Bitte versuchen Sie es erneut.');
            });
        }

        // Projekt-spezifische Daten aktualisieren
        function updateProjectSpecificData(projectId, projectData = null) {
            // Verwende echte Projekt-Daten falls verf√ºgbar
            if (projectData && projectData.bess_size) {
                // BESS-spezifische Parameter basierend auf Projekt-Daten
                const bessSize = projectData.bess_size;
                const bessPower = projectData.bess_power || bessSize * 0.5; // Standard: 2h Entladezeit
                
                // Berechne realistische Effizienz-Werte basierend auf BESS-Gr√∂√üe
                const baseEfficiency = 94.0;
                const sizeBonus = Math.min(2.0, (bessSize / 1000) * 0.5); // Bis zu 2% Bonus f√ºr gro√üe Systeme
                const efficiency = baseEfficiency + sizeBonus;
                
                // Statistiken aktualisieren mit Projekt-Daten
                document.getElementById('charge-efficiency').textContent = `${efficiency.toFixed(1)}%`;
                document.getElementById('max-soc').textContent = `${(efficiency + 1).toFixed(1)}%`;
                document.getElementById('discharge-efficiency').textContent = `${efficiency.toFixed(1)}%`;
                
                // Zeige Projekt-Info
                console.log(`üìä Projekt geladen: ${projectData.name}`);
                console.log(`üîã BESS-Gr√∂√üe: ${bessSize} kWh`);
                console.log(`‚ö° BESS-Leistung: ${bessPower} kW`);
            } else {
                // Fallback: Demo-Daten f√ºr verschiedene Projekte
                const projectData = {
                    '1': { // BESS Hinterstoder
                        avgPrice: '52.05',
                        maxPrice: '72.58',
                        chargeEfficiency: '95.0',
                        maxSoc: '95.0',
                        dischargeEfficiency: '95.0'
                    },
                    '2': { // BESS Salzburg
                        avgPrice: '48.32',
                        maxPrice: '68.45',
                        chargeEfficiency: '94.5',
                        maxSoc: '94.0',
                        dischargeEfficiency: '94.5'
                    },
                    '3': { // BESS Wien
                        avgPrice: '55.78',
                        maxPrice: '78.92',
                        chargeEfficiency: '95.5',
                        maxSoc: '96.0',
                        dischargeEfficiency: '95.5'
                    },
                    '4': { // BESS Graz
                        avgPrice: '49.15',
                        maxPrice: '69.23',
                        chargeEfficiency: '94.8',
                        maxSoc: '94.5',
                        dischargeEfficiency: '94.8'
                    }
                };
                
                const data = projectData[projectId] || projectData['1'];
                
                // Statistiken aktualisieren
                document.getElementById('avg-price').textContent = `${data.avgPrice} ‚Ç¨/MWh`;
                document.getElementById('max-price').textContent = `${data.maxPrice} ‚Ç¨/MWh`;
                document.getElementById('charge-efficiency').textContent = `${data.chargeEfficiency}%`;
                document.getElementById('max-soc').textContent = `${data.maxSoc}%`;
                document.getElementById('discharge-efficiency').textContent = `${data.dischargeEfficiency}%`;
            }
        }

        // Alle Buttons aktivieren
        function enableAllButtons() {
            const buttons = [
                'price-forecast-btn',
                'optimize-bess-btn',
                'anomaly-analyze-btn',
                'maintenance-analyze-btn'
            ];
            
            buttons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = false;
                    button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            });
        }

        function startPriceForecast() {
            console.log('Starte Preis-Prognose...');
            
            const projectSelect = document.getElementById('project-select');
            const projectId = projectSelect.value;
            
            if (!projectId) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie zuerst ein Projekt aus!');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Berechne...';
            button.disabled = true;
            
            // API-Aufruf f√ºr echte Preis-Prognose
            fetch('/api/ml/price-forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project_id: projectId,
                    forecast_hours: 24
                })
            })
            .then(response => response.json())
            .then(result => {
                button.textContent = originalText;
                button.disabled = false;
                
                if (result.success) {
                    // Chart mit echten Prognose-Daten aktualisieren
                    updatePriceForecastChart(result.data);
                    
                    // Statistiken aktualisieren
                    document.getElementById('avg-price').textContent = `${result.statistics.avg_price} ‚Ç¨/MWh`;
                    document.getElementById('max-price').textContent = `${result.statistics.max_price} ‚Ç¨/MWh`;
                    
                    alert(`‚úÖ Preis-Prognose erfolgreich erstellt!\n\nDurchschnittspreis: ${result.statistics.avg_price} ‚Ç¨/MWh\nMaximaler Preis: ${result.statistics.max_price} ‚Ç¨/MWh\n\nQuelle: ${result.source}`);
                } else {
                    alert(`‚ùå Fehler bei Preis-Prognose: ${result.error}\n\n${result.message || ''}`);
                }
            })
            .catch(error => {
                console.error('Fehler bei Preis-Prognose:', error);
                button.textContent = originalText;
                button.disabled = false;
                alert('‚ùå Fehler beim Laden der Preis-Prognose. Bitte versuchen Sie es erneut.');
            });
        }
        
        function updatePriceForecastChart(forecastData) {
            // Labels und Daten aus API-Response extrahieren
            const labels = forecastData.map(point => {
                const date = new Date(point.timestamp);
                return date.toLocaleTimeString('de-DE', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: '2-digit',
                    month: '2-digit'
                });
            });
            
            const prices = forecastData.map(point => point.price);
            
            // Chart aktualisieren
            priceForecastChart.data.labels = labels;
            priceForecastChart.data.datasets[0].data = prices;
            priceForecastChart.data.datasets[0].label = 'Prognostizierter Preis (‚Ç¨/MWh) - ML-basiert';
            priceForecastChart.data.datasets[0].borderColor = 'rgb(34, 197, 94)'; // Gr√ºn f√ºr ML-Prognose
            priceForecastChart.data.datasets[0].backgroundColor = 'rgba(34, 197, 94, 0.1)';
            priceForecastChart.update();
        }

        function optimizeBESS() {
            console.log('Starte BESS-Optimierung...');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Optimiere...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                
                // Simuliere Optimierungsergebnisse
                const efficiencyGain = (Math.random() * 5 + 5).toFixed(1);
                const annualSavings = (Math.random() * 10000 + 15000).toFixed(2);
                
                document.getElementById('efficiency-gain').textContent = `${efficiencyGain}%`;
                document.getElementById('annual-savings').textContent = `${annualSavings} ‚Ç¨`;
                
                alert('BESS-Optimierung erfolgreich abgeschlossen!');
            }, 2500);
        }

        function analyzeAnomalies() {
            console.log('Starte Anomalie-Analyse...');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Analysiere...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                
                // Simuliere Anomalie-Ergebnisse
                const anomalyRate = (Math.random() * 30 + 10).toFixed(2);
                document.getElementById('anomaly-rate').textContent = `${anomalyRate} %`;
                
                // Aktualisiere Progress Bar
                const progressBar = document.querySelector('.bg-orange-500');
                progressBar.style.width = `${anomalyRate}%`;
                
                alert('Anomalie-Analyse erfolgreich abgeschlossen!');
            }, 2000);
        }

        function analyzeMaintenance() {
            console.log('Starte Predictive Maintenance...');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚è≥ Analysiere...';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
                
                // Simuliere Maintenance-Ergebnisse
                const degradation = (Math.random() * 2 + 1).toFixed(1);
                const capacity = (100 - degradation).toFixed(1);
                
                document.getElementById('predicted-degradation').textContent = `${degradation}%`;
                document.getElementById('remaining-capacity').textContent = `${capacity}%`;
                
                alert('Predictive Maintenance-Analyse erfolgreich abgeschlossen!');
            }, 2500);
        }

        // Projekte aus der Datenbank laden
        async function loadProjectsFromDatabase() {
            try {
                console.log('üîÑ Lade Projekte aus der Datenbank...');
                const response = await fetch('/api/projects');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const projects = await response.json();
                
                console.log('üìä Geladene Projekte:', projects.length);
                console.log('üìã Projekt-Details:', projects);
                
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">-- Projekt ausw√§hlen --</option>';
                
                if (projects.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Keine Projekte verf√ºgbar';
                    option.disabled = true;
                    select.appendChild(option);
                    console.warn('‚ö†Ô∏è Keine Projekte in der Datenbank gefunden');
                    return;
                }
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    const customerName = project.customer_name || 'Kein Kunde zugeordnet';
                    option.textContent = `${project.name}${project.location ? ' - ' + project.location : ''} (${customerName})`;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Projekte erfolgreich geladen:', projects.length);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Projekte:', error);
                const select = document.getElementById('project-select');
                select.innerHTML = '<option value="">Fehler beim Laden der Projekte</option>';
            }
        }

        // Initialisierung - KEINE automatischen Charts beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            // Projekte aus der Datenbank laden
            loadProjectsFromDatabase();
            
            // Nur leere Charts initialisieren, keine Demo-Daten
            initEmptyCharts();
            
            // Projekt-Auswahl Event Listener
            document.getElementById('project-select').addEventListener('change', function() {
                const selectedProject = this.value;
                const loadButton = document.getElementById('load-data-btn');
                
                if (selectedProject) {
                    loadButton.disabled = false;
                    loadButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    loadButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    loadButton.disabled = true;
                    loadButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    loadButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            });
        });
</script>

    <!-- Footer -->
    {% include 'footer.html' %}
</body>
</html>